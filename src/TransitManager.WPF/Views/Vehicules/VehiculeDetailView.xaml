<UserControl x:Class="TransitManager.WPF.Views.Vehicules.VehiculeDetailView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:helpers="clr-namespace:TransitManager.WPF.Helpers"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1200">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- En-tête -->
        <materialDesign:Card Grid.Row="0" Padding="20" Margin="10">
            <Grid>
                <TextBlock Text="{Binding Title}" Style="{StaticResource MaterialDesignHeadline5TextBlock}" VerticalAlignment="Center"/>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button Content="Enregistrer" Command="{Binding SaveCommand}" Style="{StaticResource MaterialDesignRaisedButton}" Margin="0,0,10,0"/>
                    <Button Content="Annuler" Command="{Binding CancelCommand}" Style="{StaticResource MaterialDesignOutlinedButton}"/>
                </StackPanel>
            </Grid>
        </materialDesign:Card>

        <!-- Contenu -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <Grid Margin="10">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="1.5*"/>
                </Grid.ColumnDefinitions>

                <!-- Colonne de gauche : Formulaire -->
                <StackPanel Grid.Column="0" Margin="0,0,10,0">
                    <materialDesign:Card Padding="20" Margin="0,0,0,10">
                        <StackPanel>
                            <TextBlock Text="Informations du Véhicule" Style="{StaticResource MaterialDesignHeadline6TextBlock}" Margin="0,0,0,20"/>
                            <ComboBox materialDesign:HintAssist.Hint="Client Propriétaire *" 
                                      ItemsSource="{Binding Clients}" 
                                      SelectedItem="{Binding SelectedClient}" 
                                      DisplayMemberPath="NomComplet" 
                                      Style="{StaticResource MaterialDesignOutlinedComboBox}" 
                                      IsEditable="True"
                                      Text="{Binding ClientSearchText, UpdateSourceTrigger=PropertyChanged}"
                                      Margin="0,0,0,15"/>
                            <TextBox Text="{Binding Vehicule.Immatriculation, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Immatriculation *" Style="{StaticResource MaterialDesignOutlinedTextBox}" Margin="0,0,0,15"/>
                            <Grid>
                                <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/><ColumnDefinition/></Grid.ColumnDefinitions>
                                <TextBox Grid.Column="0" Text="{Binding Vehicule.Marque, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Marque *" Style="{StaticResource MaterialDesignOutlinedTextBox}" Margin="0,0,5,15"/>
                                <TextBox Grid.Column="1" Text="{Binding Vehicule.Modele, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Modèle *" Style="{StaticResource MaterialDesignOutlinedTextBox}" Margin="5,0,5,15"/>
                                <TextBox Grid.Column="2" Text="{Binding Vehicule.Annee, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Année" Style="{StaticResource MaterialDesignOutlinedTextBox}" Margin="5,0,0,15"/>
                            </Grid>
                             <TextBox Text="{Binding Vehicule.Kilometrage, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Kilométrage" Style="{StaticResource MaterialDesignOutlinedTextBox}" Margin="0,0,0,15"/>
                            <TextBox Text="{Binding Vehicule.DestinationFinale, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Destination Finale *" Style="{StaticResource MaterialDesignOutlinedTextBox}" Margin="0,0,0,15"/>
                        </StackPanel>
                    </materialDesign:Card>

                    <!-- SECTION DESTINATAIRE AJOUTÉE -->
                    <materialDesign:Card Padding="20" Margin="0,0,0,10">
                        <StackPanel>
                            <TextBlock Text="Destinataire" Style="{StaticResource MaterialDesignHeadline6TextBlock}" Margin="0,0,0,10"/>
                            <CheckBox Content="Destinataire identique au propriétaire" IsChecked="{Binding DestinataireEstProprietaire}" Margin="0,0,0,15"/>

                            <TextBox Text="{Binding Vehicule.Destinataire, UpdateSourceTrigger=PropertyChanged}"
                                     IsEnabled="{Binding DestinataireEstProprietaire, Converter={StaticResource InvertedBooleanConverter}}"
                                     materialDesign:HintAssist.Hint="Nom du destinataire final"
                                     Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                     Margin="0,0,0,15"/>
                            <TextBox Text="{Binding Vehicule.TelephoneDestinataire, UpdateSourceTrigger=PropertyChanged}"
                                     IsEnabled="{Binding DestinataireEstProprietaire, Converter={StaticResource InvertedBooleanConverter}}"
                                     materialDesign:HintAssist.Hint="Téléphone du destinataire"
                                     Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                     Margin="0,0,0,15"/>
                        </StackPanel>
                    </materialDesign:Card>

                    <materialDesign:Card Padding="20">
                        <StackPanel>
                             <TextBlock Text="Détails &amp; Finances" Style="{StaticResource MaterialDesignHeadline6TextBlock}" Margin="0,0,0,20"/>
                             <ComboBox materialDesign:HintAssist.Hint="Conteneur" 
                                       ItemsSource="{Binding ConteneursDisponibles}"
                                       SelectedItem="{Binding SelectedConteneur}"
                                       DisplayMemberPath="NumeroDossier"
                                       Style="{StaticResource MaterialDesignOutlinedComboBox}" 
                                       Margin="0,0,0,15"/>
                             <ComboBox materialDesign:HintAssist.Hint="Type de Véhicule" ItemsSource="{Binding Source={x:Static helpers:EnumValues.TypeVehiculeValues}}" SelectedItem="{Binding Vehicule.Type, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource MaterialDesignOutlinedComboBox}" Margin="0,0,0,15"/>
                             <TextBox Text="{Binding Vehicule.ValeurDeclaree, UpdateSourceTrigger=PropertyChanged, StringFormat=N2}" materialDesign:TextFieldAssist.SuffixText="€" materialDesign:HintAssist.Hint="Valeur Déclarée" Style="{StaticResource MaterialDesignOutlinedTextBox}" Margin="0,0,0,15"/>
                             <Grid>
                                 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/><ColumnDefinition/></Grid.ColumnDefinitions>
                                 <TextBox Grid.Column="0" Text="{Binding Vehicule.PrixTotal, UpdateSourceTrigger=PropertyChanged, StringFormat=N2}" materialDesign:TextFieldAssist.SuffixText="€" materialDesign:HintAssist.Hint="Prix Total" Style="{StaticResource MaterialDesignOutlinedTextBox}" Margin="0,0,5,0" FontWeight="Bold" Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                                 <TextBox Grid.Column="1" Text="{Binding Vehicule.SommePayee, UpdateSourceTrigger=PropertyChanged, StringFormat=N2}" materialDesign:TextFieldAssist.SuffixText="€" materialDesign:HintAssist.Hint="Somme Payée" Style="{StaticResource MaterialDesignOutlinedTextBox}" Margin="5,0,5,0" FontWeight="Bold" Foreground="{StaticResource SuccessBrush}"/>
                                 <TextBox Grid.Column="2" Text="{Binding Vehicule.RestantAPayer, Mode=OneWay, StringFormat=N2}" materialDesign:TextFieldAssist.SuffixText="€" materialDesign:HintAssist.Hint="Restant à Payer" Style="{StaticResource MaterialDesignOutlinedTextBox}" IsReadOnly="True" Margin="5,0,0,0" FontWeight="Bold" Foreground="{StaticResource ErrorBrush}"/>
                             </Grid>
                             <TextBox Text="{Binding Vehicule.Commentaires, UpdateSourceTrigger=PropertyChanged}"
                                      materialDesign:HintAssist.Hint="Commentaires / Instructions spéciales"
                                      Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                      TextWrapping="Wrap" AcceptsReturn="True" Height="80"
                                      Margin="0,15,0,0"/>
                        </StackPanel>
                    </materialDesign:Card>
                </StackPanel>

				<!-- Colonne de droite : État des lieux -->
				<materialDesign:Card Grid.Column="1" Margin="10,0,0,0" Padding="20">
					<StackPanel>
						<Grid>
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="Auto"/>
							</Grid.ColumnDefinitions>
							
							<TextBlock Grid.Column="0" Text="État des Lieux" Style="{StaticResource MaterialDesignHeadline6TextBlock}" VerticalAlignment="Center"/>

							<!-- SÉLECTEUR D'OUTIL (DESSIN / GOMME) -->
							<StackPanel Grid.Column="1" Orientation="Horizontal">
								<RadioButton x:Name="DrawModeButton" Style="{StaticResource MaterialDesignToolRadioButton}" Margin="5,0" IsChecked="True" ToolTip="Dessiner (Clic gauche)">
									<materialDesign:PackIcon Kind="Pencil" />
								</RadioButton>
								<RadioButton Style="{StaticResource MaterialDesignToolRadioButton}" Margin="5,0" IsChecked="{Binding ElementName=DrawModeButton, Path=IsChecked, Converter={StaticResource InvertedBooleanConverter}}" ToolTip="Gommer (Clic gauche)">
									<materialDesign:PackIcon Kind="Eraser" />
								</RadioButton>
							</StackPanel>
						</Grid>
						
						<TextBlock Text="Cliquez pour un impact, dessinez pour une rayure, utilisez la gomme pour effacer." Opacity="0.7" TextWrapping="Wrap" Margin="0,10,0,15"/>
						 
						<Border BorderBrush="Gray" BorderThickness="1">
							<InkCanvas x:Name="InkCanvasEtatDesLieux"
									   Strokes="{Binding Rayures}"
									   Background="Transparent"
									   MouseLeftButtonDown="InkCanvas_MouseLeftButtonDown"
									   MouseLeftButtonUp="InkCanvas_MouseLeftButtonUp">
								
								<!-- Le mode d'édition est maintenant lié aux RadioButtons -->
								<InkCanvas.EditingMode>
									<Binding ElementName="DrawModeButton" Path="IsChecked">
										<Binding.Converter>
											<helpers:BoolToInkCanvasEditingModeConverter Ink="Ink" Erase="EraseByStroke"/>
										</Binding.Converter>
									</Binding>
								</InkCanvas.EditingMode>
								
								<InkCanvas.DefaultDrawingAttributes>
									<DrawingAttributes Color="Red" Width="3" Height="3" IsHighlighter="False"/>
								</InkCanvas.DefaultDrawingAttributes>

								<Image Source="{Binding PlanImagePath}" Stretch="Uniform"/>
								
								<ItemsControl ItemsSource="{Binding DamagePoints}">
									<ItemsControl.ItemsPanel><ItemsPanelTemplate><Canvas /></ItemsPanelTemplate></ItemsControl.ItemsPanel>
									<ItemsControl.ItemContainerStyle>
										<Style TargetType="ContentPresenter">
											<Setter Property="Canvas.Left" Value="{Binding X}"/>
											<Setter Property="Canvas.Top" Value="{Binding Y}"/>
										</Style>
									</ItemsControl.ItemContainerStyle>
									<ItemsControl.ItemTemplate>
										<DataTemplate>
											<Ellipse Width="15" Height="15" Fill="#A0FF0000" Stroke="Red" StrokeThickness="1" ToolTip="Impact">
												<Ellipse.RenderTransform><TranslateTransform X="-7.5" Y="-7.5"/></Ellipse.RenderTransform>
												<Ellipse.InputBindings>
													<MouseBinding MouseAction="LeftClick" Command="{Binding DataContext.RemoveDamagePointCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}" CommandParameter="{Binding}"/>
												</Ellipse.InputBindings>
											</Ellipse>
										</DataTemplate>
									</ItemsControl.ItemTemplate>
								</ItemsControl>
							</InkCanvas>
						</Border>
					</StackPanel>
				</materialDesign:Card>
            </Grid>
        </ScrollViewer>
    </Grid>
</UserControl>