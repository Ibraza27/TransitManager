@inherits LayoutComponentBase
@implements IAsyncDisposable
@inject CustomAuthenticationStateProvider AuthStateProvider

@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<div class="glass-container">
    <!-- Floating Glass Sidebar -->
    <aside class="glass-panel sidebar-glass @(_isCollapsed ? "collapsed" : "") @(_isMobileMenuOpen ? "show" : "")">
        <!-- Fixed Logo Header -->
        <div class="sidebar-header">
            <!-- Mobile Close Button -->
            <button class="btn btn-sm mobile-close-btn rounded-circle shadow d-md-none" 
                    @onclick="() => _isMobileMenuOpen = false">
                <i class="bi bi-x-lg"></i>
            </button>
            
            <!-- Company Branding -->
            <div class="text-center py-2">
                <img src="images/logo.jpg" alt="Logo" class="sidebar-logo img-fluid rounded shadow-sm mb-2" />
                <h6 class="fw-bold mb-0 sidebar-brand-name">HIPPOCAMPE</h6>
                <small class="sidebar-brand-sub">Import-Export</small>
            </div>
            
            <!-- App Title -->
            <div class="d-flex align-items-center gap-2 mt-3 app-title">
                <i class="bi bi-box-seam-fill app-icon"></i>
                <span class="fw-bold">TRANSIT MANAGER</span>
            </div>
        </div>
        <!-- Scrollable Nav Body -->
        <div class="sidebar-body">
            <NavMenu />
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="content-area">
        <!-- Floating Glass Header -->
        <div class="glass-panel top-bar-glass">
            <div class="d-flex align-items-center gap-3">
                <!-- Mobile Toggler -->
                <button class="btn btn-light mobile-toggler d-md-none shadow-sm" @onclick="ToggleMobileMenu">
                    <i class="bi @(_isMobileMenuOpen ? "bi-x-lg" : "bi-list") transition-icon"></i>
                </button>
                
                <!-- Desktop Toggler -->
                <button class="btn btn-light bg-white border-0 shadow-sm rounded-circle d-none d-md-flex align-items-center justify-content-center" 
                        style="width: 32px; height: 32px;"
                        @onclick="ToggleSidebar">
                    <i class="bi @(_isCollapsed ? "bi-list" : "bi-text-indent-right") transition-icon"></i>
                </button>

                <h5 class="m-0 fw-bold text-gradient d-none d-md-block" style="outline: none;">HIPPOCAMPE IMPORT-EXPORT</h5>
            </div>

            <!-- User Actions -->
            <div class="d-flex align-items-center gap-3">
                 <!-- Theme Toggle -->
                 <button class="btn btn-sm btn-light rounded-circle shadow-sm d-flex align-items-center justify-content-center" 
                         style="width: 32px; height: 32px;"
                         onclick="toggleTheme()"
                         title="Changer de thème">
                    <i class="bi bi-circle-half"></i>
                 </button>

                 <AuthorizeView>
                    <Authorized Context="AuthContext">
                        <NotificationCenter @rendermode="RenderMode.InteractiveServer" />
                        
                        <div class="username-pill d-flex align-items-center gap-2 px-3 py-1 rounded-pill">
                            <span class="fw-medium small">
                                @AuthContext.User.Identity?.Name
                            </span>
                        </div>

                        <form action="/account/logout" method="post">
                            <AntiforgeryToken />
                            <button type="submit" class="btn btn-sm btn-light text-danger rounded-circle shadow-sm" title="Déconnexion" style="width: 32px; height: 32px; display: flex; align-items-center; justify-content: center;">
                                <i class="bi bi-power"></i>
                            </button>
                        </form>
                    </Authorized>
                    <NotAuthorized>
                        <a href="/login" class="btn btn-primary btn-sm rounded-pill px-4">Connexion</a>
                    </NotAuthorized>
                </AuthorizeView>
            </div>
        </div>

        <!-- Content Body -->
        <article class="content">
            @Body
        </article>
    </main>
</div>

@code {
    [Inject] private IApiService ApiService { get; set; } = default!;
    
    private bool _isCollapsed = false;
    private bool _isMobileMenuOpen = false;
    private bool _initialized = false;

    private IJSObjectReference? _jsModule;
    private DotNetObjectReference<MainLayout>? _objRef;

    protected override async Task OnInitializedAsync()
    {
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var storedState = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "sidebar_collapsed_state");
                if (!string.IsNullOrEmpty(storedState) && bool.TryParse(storedState, out bool isCollapsed))
                {
                    _isCollapsed = isCollapsed;
                    StateHasChanged();
                }

                // Initialize Resize Listener
                 _objRef = DotNetObjectReference.Create(this);
                 await JSRuntime.InvokeVoidAsync("window.registerResizeListener", _objRef);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error init main layout: {ex.Message}");
            }
            finally
            {
                _initialized = true;
            }
        }
    }

    [JSInvokable]
    public void OnResize(int width)
    {
        // Si on passe en mobile (< 768px), on désactive le mode collapsed desktop pour éviter les bugs
        if (width < 768 && _isCollapsed)
        {
            _isCollapsed = false;
            StateHasChanged();
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        if (_isMobileMenuOpen)
        {
            _isMobileMenuOpen = false;
            StateHasChanged();
        }
    }

    private void ToggleMobileMenu()
    {
        _isMobileMenuOpen = !_isMobileMenuOpen;
    }

    private async Task ToggleSidebar()
    {
        _isCollapsed = !_isCollapsed;
        try 
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "sidebar_collapsed_state", _isCollapsed.ToString());
        }
        catch (Exception ex)
        {
             Console.WriteLine($"Error saving sidebar state: {ex.Message}");
        }
    }

    private async Task Logout()
    {
        await ApiService.LogoutAsync();
        await AuthStateProvider.MarkUserAsLoggedOut();
        NavigationManager.NavigateTo("/login", forceLoad: true);
    }

    public async ValueTask DisposeAsync()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        if (_objRef != null)
        {
             _objRef.Dispose();
        }
         
        try {
             await JSRuntime.InvokeVoidAsync("window.unregisterResizeListener");
        } catch {}
    }
}