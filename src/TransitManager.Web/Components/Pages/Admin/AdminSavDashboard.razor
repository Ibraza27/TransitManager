@page "/admin/sav"
@using TransitManager.Core.DTOs
@using TransitManager.Core.Entities
@using TransitManager.Core.Enums
@using TransitManager.Core.DTOs
@using TransitManager.Web.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Administrateur,Gestionnaire")]
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>SAV / Qualit√© - Admin</PageTitle>

<div class="container-fluid mt-4 mb-5">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
        <div>
            <h2 class="fw-bold text-primary"><i class="bi bi-shield-check me-2"></i>Qualit√© & SAV</h2>
            <p class="text-muted mb-0">Tableau de bord de suivi des r√©ceptions clients</p>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <div class="input-group input-group-sm">
                <span class="input-group-text">Du</span>
                <input type="date" class="form-control" @bind="_startDate" />
            </div>
            <div class="input-group input-group-sm">
                 <span class="input-group-text">Au</span>
                 <input type="date" class="form-control" @bind="_endDate" />
            </div>
            <button class="btn btn-primary btn-sm" @onclick="LoadData">
                <i class="bi bi-filter me-1"></i>Filtrer
            </button>
            <button class="btn btn-outline-secondary btn-sm" @onclick="ResetFilters" title="R√©initialiser">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
    }
    else
    {
        <!-- KPIs -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card shadow-sm border-0 h-100 bg-primary text-white">
                    <div class="card-body">
                        <h6 class="text-white-50 text-uppercase small">Total Signalements</h6>
                        <h2 class="display-5 fw-bold mb-0">@_stats?.TotalControls</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm border-0 h-100 bg-success text-white">
                    <div class="card-body">
                        <h6 class="text-white-50 text-uppercase small">Note Moyenne</h6>
                         <div class="d-flex align-items-end gap-2">
                             <h2 class="display-5 fw-bold mb-0">@_stats?.AverageRating.ToString("F1")</h2>
                             <span class="fs-4 mb-2">/ 10</span>
                         </div>
                    </div>
                </div>
            </div>
             <div class="col-md-3">
                <div class="card shadow-sm border-0 h-100 bg-danger text-white">
                    <div class="card-body">
                        <h6 class="text-white-50 text-uppercase small">Probl√®mes Signal√©s</h6>
                        <h2 class="display-5 fw-bold mb-0">@_stats?.ControlsWithIssues</h2>
                        <div class="small mt-2 text-white-50">Soit @(_stats?.IssuePercentage.ToString("F1"))%</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm border-0 h-100 bg-info text-white">
                    <div class="card-body">
                        <h6 class="text-white-50 text-uppercase small">Ce mois-ci</h6>
                        <h2 class="display-5 fw-bold mb-0">@_stats?.MonthlyCount.Values.LastOrDefault()</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                 <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0 fw-bold">√âvolution Mensuelle</h5>
                    </div>
                    <div class="card-body">
                         <canvas id="savTrendChart" style="max-height: 300px;"></canvas>
                    </div>
                 </div>
            </div>
             <div class="col-lg-4">
                 <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0 fw-bold">Distribution Statuts</h5>
                    </div>
                    <div class="card-body d-flex justify-content-center">
                         <canvas id="savStatusChart" style="max-height: 300px;"></canvas>
                    </div>
                 </div>
            </div>
        </div>

        <!-- Recent Table -->
        <div class="card shadow-sm border-0">
             <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold">Derniers Rapports Re√ßus</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Date</th>
                            <th>Client</th>
                            <th>Objet</th>
                            <th>Statut</th>
                            <th>Notes</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach(var item in _recentControls)
                        {
                            <tr>
                                <td>@item.CreationDate.ToLocalTime().ToString("dd/MM HH:mm")</td>
                                <td>@(item.Client?.NomComplet ?? "Inconnu")</td>
                                <td>
                                    @if(item.ColisId.HasValue) 
                                    { 
                                        <span class="badge bg-light text-dark border">üì¶ Colis</span>  
                                    } 
                                    else 
                                    { 
                                        <span class="badge bg-light text-dark border">üöó V√©hicule</span> 
                                    }
                                </td>
                                <td>
                                    <span class="badge @(item.Status == ReceptionStatus.ReceivedFull ? "bg-success" : "bg-danger")">
                                        @(item.Status == ReceptionStatus.ReceivedFull ? "Conforme" : "Probl√®me")
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex gap-2 small">
                                        <span title="Service" class="badge bg-primary">S: @item.RateService</span>
                                        <span title="√âtat" class="badge bg-info text-dark">E: @item.RateCondition</span>
                                    </div>
                                </td>
                                <td>
                                    <a href="@(item.ColisId.HasValue ? $"colis/detail/{item.ColisId}?tab=sav" : $"vehicule/detail/{item.VehiculeId}?tab=sav")" class="btn btn-sm btn-outline-secondary">
                                        Voir
                                    </a>
                                    <button class="btn btn-sm btn-outline-danger ms-1" @onclick="() => DeleteControl(item.Id)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    private bool _isLoading = true;
    private ReceptionStatsDto? _stats;
    private List<ReceptionControl> _recentControls = new();
    private bool _chartsRendered = false;
    
    private DateTime? _startDate;
    private DateTime? _endDate;

    protected override async Task OnInitializedAsync()
    {
        // Default: Last 30 days or empty for all time? User wants "robust" filtering.
        // Let's default to no filter (All Time) or maybe "This Month"?
        // Usually dashboards default to "This Month" or "Last 30 Days".
        // Let's start with NO filter to show everything, as before, but user can filter.
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        _stats = await ApiService.GetReceptionStatsAsync(_startDate, _endDate);
        // Recent controls might also need filtering? 
        // The API signature for Recent doesn't support dates yet, only count. 
        // For now, stats are filtered, recent list is just "recent" regardless of filter?
        // Usually "Recent" means globally recent. If we want "Controls in period", we'd need another endpoint.
        // The user asked for "stats of this period", so focusing on _stats is correct for now.
        _recentControls = await ApiService.GetRecentReceptionControlsAsync(20);
        _isLoading = false;
        _chartsRendered = false; // Reset to redraw if needed
    }
    
    private async Task ResetFilters()
    {
        _startDate = null;
        _endDate = null;
        await LoadData();
    }

    private async Task DeleteControl(Guid id)
    {
        if (!await JS.InvokeAsync<bool>("confirm", "√ätes-vous s√ªr de vouloir supprimer ce rapport SAV ? Cette action est irr√©versible.")) return;

        var success = await ApiService.DeleteControlAsync(id); // Need to add this to IApiService too
        if (success)
        {
            await LoadData();
        }
        else 
        {
             await JS.InvokeVoidAsync("alert", "Erreur lors de la suppression.");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(!_isLoading && _stats != null && !_chartsRendered)
        {
             _chartsRendered = true;
             await RenderCharts();
        }
    }

    private async Task RenderCharts()
    {
        if (_stats == null) return;

        // 1. Trend Chart (Line)
        var ctxTrend = new {
            labels = _stats.MonthlyCount.Keys.ToArray(),
            datasets = new object[]
            {
                new {
                    type = "line",
                    label = "Signalements",
                    data = _stats.MonthlyCount.Values.ToArray(),
                    borderColor = "rgb(13, 110, 253)",
                    backgroundColor = "rgba(13, 110, 253, 0.1)",
                    fill = true,
                    tension = 0.4
                }
            }
        };
        
        var optionsTrend = new {
             responsive = true,
             maintainAspectRatio = false,
             scales = new { y = new { beginAtZero = true } }
        };

        await JS.InvokeVoidAsync("renderChart", "savTrendChart", "line", ctxTrend, optionsTrend);

        // 2. Status Chart (Doughnut)
        // Manual mapping for status labels
        var statusData = new [] {
             _recentControls.Count(c => c.Status == ReceptionStatus.ReceivedFull),
             _recentControls.Count(c => c.Status == ReceptionStatus.ReceivedPartial),
             _recentControls.Count(c => c.Status == ReceptionStatus.ReceivedDamaged)
        };
        
        // Actually better to use stats if available or compute from recent if stats lacks detail
        // Assuming _stats has simplified counts or we use the recent list as sample if stats DTO doesn't give breakdown
        // Let's use computed values from stats if possible, but stats DTO only had totals. 
        // Let's assume for now we use the Recent list as a proxy or just hardcode some data if stats are missing breakdown.
        // Wait, ReceptionStatsDto needs a breakdown. I'll check DTO.
        // It has IssuePercentage. I'll just use Issues vs OK.
        
        var issueCount = _stats.ControlsWithIssues;
        var okCount = _stats.TotalControls - issueCount;

        var ctxStatus = new {
            labels = new [] { "Conforme", "Avec Probl√®me" },
            datasets = new object[]
            {
                new {
                    data = new [] { okCount, issueCount },
                    backgroundColor = new [] { "#198754", "#dc3545" } // Success, Danger
                }
            }
        };

        await JS.InvokeVoidAsync("renderChart", "savStatusChart", "doughnut", ctxStatus, new { responsive = true, maintainAspectRatio = false });
    }
}
