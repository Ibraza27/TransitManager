@page "/admin/commerce/invoices/new"
@page "/admin/commerce/invoices/edit/{Id:guid}"
@using Microsoft.AspNetCore.Authorization
@using TransitManager.Core.DTOs.Commerce
@using TransitManager.Core.DTOs.Settings
@using TransitManager.Core.Enums
@using TransitManager.Web.Services
@using TransitManager.Core.Entities
@using TransitManager.Web.Components.Shared
@using System.Text.Json
@inject IApiService ApiService
@inject NavigationManager NavManager
@inject IJSRuntime JS
@inject TransitManager.Core.Interfaces.ISettingsService SettingsService
@attribute [Authorize(Roles = "Administrateur")]

<div class="d-flex flex-column h-100">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-3">
            <button class="btn btn-outline-secondary btn-sm" @onclick="GoBack"><i class="bi bi-arrow-left"></i> Retour</button>
            <div>
                 <h4 class="mb-0 fw-bold">@(Id.HasValue ? $"Facture {ExistingRef}" : "Nouvelle Facture")</h4>
                 @if(Model.QuoteId.HasValue)
                 {
                    <div class="small text-muted mt-1">
                        <i class="bi bi-link-45deg"></i> Dévis lié: <a href="/admin/commerce/quotes/edit/@Model.QuoteId" class="text-decoration-none fw-bold">@Model.QuoteReference</a>
                    </div>
                 }
                 <div class="d-flex align-items-center gap-2 small mt-1">
                     <span class="badge rounded-pill @GetStatusClass(CurrentStatus)">@GetStatusName(CurrentStatus)</span>
                     @if(IsSaving) { <span class="text-warning ms-2"><span class="spinner-border spinner-border-sm me-1"></span>Enregistrement...</span> }
                     else if (IsDirty()) { <span class="text-muted fst-italic ms-2">modifié</span> }
                 </div>
            </div>
        </div>
        <div class="d-flex gap-2">
             <button class="btn btn-outline-primary" @onclick="TogglePreview">
                <i class="bi bi-eye me-2"></i>@(IsPreviewMode ? "Éditer" : "Aperçu")
            </button>
            <button class="btn btn-primary" @onclick="() => Save(false)">
                <i class="bi bi-save me-2"></i>Enregistrer
            </button>
        </div>
    </div>

    @* Success Toast Notification *@
    @if (!string.IsNullOrEmpty(_successMessage))
    {
        <div class="position-fixed top-0 end-0 p-3" style="z-index: 9999;">
            <div class="toast show align-items-center text-white bg-success border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-check-circle-fill me-2"></i>@_successMessage
                    </div>
                </div>
            </div>
        </div>
    }

    @if (IsLoading)
    {
        <div class="d-flex justify-content-center align-items-center flex-grow-1">
            <div class="spinner-border text-primary"></div>
        </div>
    }
    else if (IsPreviewMode)
    {
         <!-- PREVIEW MODE (Read Only) -->
         <div class="d-flex flex-column h-100">
             <!-- Preview Actions Toolbar -->
             <div class="bg-dark text-white p-3 d-flex justify-content-between align-items-center mb-3 rounded-3 mx-auto" style="max-width: 900px;">
                 <div class="d-flex align-items-center gap-3">
                     <span class="fw-bold">Aperçu PDF</span>
                 </div>
                 <div class="d-flex gap-2">
                     <button class="btn btn-light btn-sm" @onclick="OpenSendModal">
                         <i class="bi bi-envelope-fill me-2"></i>Envoyer par e-mail
                     </button>
                     <button class="btn btn-outline-light btn-sm" @onclick="DownloadPdf" disabled="@IsDownloadingPdf">
                         @if(IsDownloadingPdf) {
                             <span class="spinner-border spinner-border-sm me-2"></span><text>Téléchargement...</text>
                         } else {
                             <i class="bi bi-file-pdf me-2"></i><text>Télécharger PDF</text>
                         }
                     </button>
                     <button class="btn btn-warning btn-sm" @onclick="OpenSendReminderModal">
                         <i class="bi bi-bell-fill me-2"></i>Envoyer Rappel
                     </button>
                      @if(CurrentStatus == InvoiceStatus.Draft)
                     {
                         <button class="btn btn-success btn-sm" @onclick="FinalizeInvoice">
                             <i class="bi bi-check-lg me-2"></i>Approuver et fermer
                         </button>
                     }
                 </div>
             </div>

             <!-- PDF Viewer (HTML Preview) -->
             <div class="bg-white shadow-sm mx-auto flex-grow-1 border w-100 overflow-auto" style="max-width: 900px;">
                 @RenderAdminPreview(Model)
             </div>
         </div>
    }
    else
    {
        <!-- EDITOR MODE -->
        <div class="d-flex flex-column flex-lg-row flex-grow-1 overflow-hidden h-100">
             
             <!-- Main Content (Left) -->
             <div class="flex-grow-1 p-0 bg-light" style="overflow-y: auto; overflow-x: visible;">
                 <!-- Client & Info -->
                 <div class="row g-2 mx-2 my-2 p-2 bg-white border-bottom">
                     <div class="col-md-5">
                         <label class="form-label small fw-bold mb-1">Client</label>
                         <!-- Toggle: Client permanent / Client de passage -->
                         <div class="btn-group btn-group-sm w-100 mb-2" role="group">
                             <input type="radio" class="btn-check" name="invoiceClientType" id="invoiceClientPermanent" checked="@(!_isGuestClient)" @onchange="() => SetGuestClient(false)">
                             <label class="btn btn-outline-primary" for="invoiceClientPermanent"><i class="bi bi-person me-1"></i>Client</label>
                             <input type="radio" class="btn-check" name="invoiceClientType" id="invoiceClientPassage" checked="@_isGuestClient" @onchange="() => SetGuestClient(true)">
                             <label class="btn btn-outline-secondary" for="invoiceClientPassage"><i class="bi bi-person-dash me-1"></i>Passage</label>
                         </div>
                         
                         @if(!_isGuestClient)
                         {
                             <div class="d-flex gap-2">
                                 <div class="flex-grow-1">
                                     <ClientAutocomplete SelectedClient="@SelectedClient" OnClientSelected="HandleClientSelected" />
                                 </div>
                                 <button type="button" class="btn btn-outline-success btn-sm px-2" title="Nouveau client" @onclick="OpenAddClientModal">
                                     <i class="bi bi-plus-lg"></i>
                                 </button>
                             </div>
                         }
                         else
                         {
                             <!-- Guest Client Fields -->
                             <div class="row g-1">
                                 <div class="col-12">
                                     <input type="email" class="form-control form-control-sm @(string.IsNullOrWhiteSpace(Model.GuestEmail) ? "is-invalid" : "")" 
                                            placeholder="Email *" @bind="Model.GuestEmail" />
                                 </div>
                                 <div class="col-12">
                                     <input type="text" class="form-control form-control-sm" 
                                            placeholder="Nom (optionnel)" @bind="Model.GuestName" />
                                 </div>
                                 <div class="col-12">
                                     <input type="tel" class="form-control form-control-sm" 
                                            placeholder="Téléphone (optionnel)" @bind="Model.GuestPhone" />
                                 </div>
                             </div>
                         }
                     </div>
                     <div class="col-md-3">
                           <label class="form-label small fw-bold mb-1">Échéance</label>
                           <input type="date" class="form-control form-control-sm" @bind="Model.DueDate" />
                     </div>
                      <div class="col-12">
                         <label class="form-label small mb-1">Message</label>
                          <textarea class="form-control form-control-sm" rows="2" @bind="Model.Message" placeholder="Message libre..."></textarea>
                     </div>
                      <div class="col-12">
                         <label class="form-label small mb-1">Modalités de paiement</label>
                          <textarea class="form-control form-control-sm" rows="1" @bind="Model.PaymentTerms"></textarea>
                     </div>
                </div>     
                
                <!-- Lines Table -->
                <div class="mx-2 mb-2 bg-white" style="min-height: 200px;">
                      <div class="d-none d-md-block">
                          <table class="table table-sm table-borderless align-middle mb-0" style="font-size: 0.85rem;">
                              <thead class="border-bottom bg-light">
                                  <tr class="text-uppercase text-muted">
                                      <th style="width: 50px;"></th>
                                      <th style="min-width: 200px;">Description</th>
                                      <th class="text-center" style="width: 100px;">Date</th>
                                      <th class="text-center" style="width: 70px;">Qté</th>
                                      <th class="text-center" style="width: 55px;">U</th>
                                      <th class="text-center" style="width: 90px;">Prix</th>
                                      <th class="text-center" style="width: 90px;">TVA</th>
                                      <th class="text-end" style="width: 100px;">Total</th>
                                      <th style="width: 30px;"></th>
                                  </tr>
                              </thead>
                              <tbody>
                                 @foreach (var (line, index) in Model.Lines.Select((l, i) => (l, i)))
                                 {
                                     <tr class="@(line.Type == QuoteLineType.Subtotal ? "fw-bold border-bottom border-dark" : "")" style="@(line.Type == QuoteLineType.Subtotal ? "border-top: 2px solid #dee2e6;" : "")">
                                         
                                         <!-- Reordering -->
                                         <td class="align-middle text-center">
                                             <button class="btn btn-link text-secondary p-0" @onclick="() => MoveLine(line, -1)" disabled="@(index == 0)"><i class="bi bi-arrow-up-short"></i></button>
                                             <button class="btn btn-link text-secondary p-0" @onclick="() => MoveLine(line, 1)" disabled="@(index == Model.Lines.Count - 1)"><i class="bi bi-arrow-down-short"></i></button>
                                         </td>
                                         
                                         @if(line.Type == QuoteLineType.Title)
                                         {
                                             <td colspan="7" class="py-2"><input type="text" class="form-control fw-bold border-0" placeholder="TITRE" @bind="line.Description" /></td>
                                         }
                                         else if (line.Type == QuoteLineType.Text)
                                         {
                                              <td colspan="7" class="py-2"><textarea class="form-control border-0" rows="1" placeholder="Texte..." @bind="line.Description"></textarea></td>
                                         }
                                         else 
                                         {
                                             <td class="py-2">
                                                 @if(line.Type == QuoteLineType.Product)
                                                 {
                                                     <ProductAutocomplete @bind-Description="line.Description" OnProductSelected="@((p) => HandleProductSelected(line, p))" OnCreateNew="() => OpenNewProductDialog(line)" />
                                                 }
                                                 else { <span>Sous-total</span> }
                                             </td>
                                             
                                             @if(line.Type == QuoteLineType.Product)
                                             {
                                                 <td><input type="date" class="form-control form-control-sm border-0 text-center" @bind="line.Date" /></td>
                                                 <td><input type="number" class="form-control form-control-sm border-0 text-center" @bind="line.Quantity" @bind:after="UpdateSubtotals" step="0.01" /></td>
                                                 <td><input type="text" class="form-control form-control-sm border-0 text-center" @bind="line.Unit" /></td>
                                                 <td><input type="number" class="form-control form-control-sm border-0 text-end" @bind="line.UnitPrice" @bind:after="UpdateSubtotals" step="0.01" /></td>
                                                 <td><input type="number" class="form-control form-control-sm border-0 text-end" @bind="line.VATRate" step="0.1" /></td>
                                                 <td class="text-end fw-bold small py-3">@((line.Quantity * line.UnitPrice).ToString("N2")) €</td>
                                             }
                                             else if (line.Type == QuoteLineType.Subtotal)
                                             {
                                                 <td colspan="4"></td>
                                                 <td class="text-end fw-bold"></td>
                                                 <td class="text-end fw-bold">@line.TotalHT.ToString("N2") €</td>
                                             }
                                         }
                                         <td class="align-middle text-center">
                                             <button class="btn btn-link text-danger p-0" @onclick="() => RemoveLine(line)"><i class="bi bi-x-lg"></i></button>
                                         </td>
                                     </tr>
                                 }
                              </tbody>
                          </table>
                      </div>
                      
                      <!-- MOBILE CARD VIEW -->
                      <div class="d-md-none">
                          @foreach (var (line, index) in Model.Lines.Select((l, i) => (l, i)))
                          {
                              <div class="card mb-2 shadow-sm border-0 @(line.Type == QuoteLineType.Subtotal ? "bg-light border-top border-2" : "")">
                                  <div class="card-body p-2">
                                      <!-- Header: Delete & Controls -->
                                      <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-secondary" @onclick="() => MoveLine(line, -1)" disabled="@(index == 0)">
                                                    <i class="bi bi-arrow-up-short"></i>
                                                </button>
                                                <button class="btn btn-outline-secondary" @onclick="() => MoveLine(line, 1)" disabled="@(index == Model.Lines.Count - 1)">
                                                    <i class="bi bi-arrow-down-short"></i>
                                                </button>
                                            </div>
                                            <button class="btn btn-link text-danger p-0" @onclick="() => RemoveLine(line)">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                      </div>

                                      <!-- Content -->
                                      @if(line.Type == QuoteLineType.Title)
                                      {
                                          <input type="text" class="form-control fw-bold border-0 fs-6 bg-light mb-2" placeholder="TITRE DE SECTION" @bind="line.Description" />
                                      }
                                      else if (line.Type == QuoteLineType.Text)
                                      {
                                          <textarea class="form-control border-0 bg-light mb-2" rows="2" placeholder="Texte libre..." @bind="line.Description"></textarea>
                                      }
                                      else if (line.Type == QuoteLineType.Product)
                                      {
                                           <div class="mb-2">
                                                <label class="small text-muted fw-bold">Description</label>
                                                <ProductAutocomplete 
                                                    @bind-Description="line.Description" 
                                                    OnProductSelected="@((p) => HandleProductSelected(line, p))"
                                                    OnCreateNew="() => OpenNewProductDialog(line)" />
                                           </div>
                                           
                                           <div class="row g-2 mb-2">
                                               <div class="col-4">
                                                   <label class="small text-muted fw-bold">Date</label>
                                                   <input type="date" class="form-control form-control-sm" @bind="line.Date" />
                                               </div>
                                               <div class="col-4">
                                                   <label class="small text-muted fw-bold">Qté</label>
                                                   <input type="number" class="form-control form-control-sm" @bind="line.Quantity" @bind:after="UpdateSubtotals" step="0.01" />
                                               </div>
                                               <div class="col-4">
                                                   <label class="small text-muted fw-bold">Unité</label>
                                                    <input type="text" class="form-control form-control-sm" @bind="line.Unit" />
                                               </div>
                                           </div>

                                           <div class="row g-2 align-items-end">
                                               <div class="col-4">
                                                   <label class="small text-muted fw-bold">Prix U.</label>
                                                   <input type="number" class="form-control form-control-sm" @bind="line.UnitPrice" @bind:after="UpdateSubtotals" step="0.01" />
                                               </div>
                                               <div class="col-3">
                                                   <label class="small text-muted fw-bold">TVA %</label>
                                                    <input type="number" class="form-control form-control-sm" @bind="line.VATRate" step="0.1" />
                                               </div>
                                               <div class="col-5 text-end">
                                                   <label class="small text-muted fw-bold d-block">Total HT</label>
                                                   <span class="fw-bold text-primary fs-5">@((line.Quantity * line.UnitPrice).ToString("N2")) €</span>
                                               </div>
                                           </div>
                                      }
                                      else if (line.Type == QuoteLineType.Subtotal)
                                      {
                                          <div class="d-flex justify-content-between align-items-center">
                                              <span class="fw-bold text-uppercase">Sous-total</span>
                                              <span class="fw-bold fs-5">@line.TotalHT.ToString("N2") €</span>
                                          </div>
                                      }
                                  </div>
                              </div>
                          }
                      </div>
                      
                      <!-- Add Buttons -->
                      <div class="p-2 btn-group">
                             <button class="btn btn-dark btn-sm rounded-start-pill px-3" @onclick="() => AddLine(QuoteLineType.Product)">
                                 <i class="bi bi-plus-lg me-1"></i> Ajouter Ligne
                             </button>
                             <button type="button" class="btn btn-dark btn-sm dropdown-toggle dropdown-toggle-split rounded-end-pill" data-bs-toggle="dropdown" aria-expanded="false">
                                 <span class="visually-hidden">Toggle Dropdown</span>
                             </button>
                             <ul class="dropdown-menu shadow">
                                 <li><button class="dropdown-item" @onclick="() => AddLine(QuoteLineType.Title)">Titre</button></li>
                                 <li><button class="dropdown-item" @onclick="() => AddLine(QuoteLineType.Text)">Texte</button></li>
                                 <li><hr class="dropdown-divider"></li>
                                 <li><button class="dropdown-item fw-bold" @onclick="() => AddLine(QuoteLineType.Subtotal)">Sous-total</button></li>
                             </ul>
                      </div>
                </div>
                 
                 <div class="mx-2 mb-5">
                      <label class="form-label fw-bold small d-flex justify-content-between">
                          Notes
                          <button class="btn btn-link btn-sm p-0 text-decoration-none" style="font-size: 0.8rem;" @onclick="SaveNotesAsTemplate" title="Définir comme modèle par défaut">
                              <i class="bi bi-bookmark-plus me-1"></i>Définir comme modèle
                          </button>
                      </label>
                      <textarea class="form-control" rows="3" @bind="Model.FooterNote"></textarea>
                 </div>
             </div>
             
             <!-- Sidebar -->
             <div class="bg-white border-start p-3 overflow-auto" style="flex: 0 0 250px;">
                  <h6 class="fw-bold mb-4">Calculs</h6>
                   <div class="card bg-light border-0 p-3 mb-4">
                      <div class="row g-2">
                          <div class="col-6">
                               <label class="small text-muted">Type</label>
                               <select class="form-select form-select-sm" @bind="Model.DiscountType">
                                   <option value="@DiscountType.Percent">%</option>
                                   <option value="@DiscountType.Amount">EUR</option>
                               </select>
                          </div>
                          <div class="col-6">
                              <label class="small text-muted">Valeur</label>
                              <input type="number" class="form-control form-control-sm" @bind="Model.DiscountValue" />
                          </div>
                      </div>
                      <div class="mt-2 text-end text-danger small fw-bold">-@DiscountAmount.ToString("N2") €</div>
                  </div>
                  
                  <div class="d-flex justify-content-between mb-2"><span class="text-muted">Total HT</span><span class="fw-bold">@RawTotalHT.ToString("N2") €</span></div>
                  <div class="d-flex justify-content-between mb-2 text-danger"><span class="text-muted">Remise</span><span class="fw-bold">-@DiscountAmount.ToString("N2") €</span></div>
                  <div class="d-flex justify-content-between mb-2"><span class="text-muted">Net HT</span><span class="fw-bold">@NetHT.ToString("N2") €</span></div>
                  <div class="d-flex justify-content-between mb-2"><span class="text-muted">TVA</span><span class="fw-bold">@TotalTVA.ToString("N2") €</span></div>
                  <hr />
                  <div class="d-flex justify-content-between mb-2"><span class="fw-bold fs-5">Total TTC</span><span class="fw-bold fs-5 text-success">@TotalTTC.ToString("N2") €</span></div>
                  
                  <div class="mt-4 d-grid gap-2">
                      <button class="btn btn-primary" @onclick="() => Save(false)">Enregistrer</button>
                      <button class="btn btn-success" @onclick="FinalizeInvoice">Finaliser (Envoyer)</button>
                  </div>
             </div>
        </div>
    }
</div>

<ProductDialog @ref="_productDialog" OnProductCreated="HandleNewProductCreated" />
<ConfirmationModal IsVisible="@_showUnsavedModal" Title="Quitter ?" Message="Sauvegarder les modifications ?" OnConfirm="ConfirmSaveAndExit" OnCancel="ConfirmExitWithoutSave" OnClose="@(() => _showUnsavedModal = false)" />
<SendInvoiceModal @ref="_sendModal" OnSend="SendInvoiceEmail" InvoiceReference="@ExistingRef" RecipientEmail="@(SelectedClient?.Email ?? Model.GuestEmail ?? "")" />
<SendReminderModal @ref="_sendReminderModal" OnSend="SendReminderCallback" InvoiceReference="@ExistingRef" RecipientEmail="@(SelectedClient?.Email ?? Model.GuestEmail ?? "")" />
<AddClientModal @ref="_addClientModal" OnClientCreated="HandleNewClientCreated" />

@code {
    [Parameter] public Guid? Id { get; set; }

    // Use a ViewModel that matches Create/Update logic
    private InvoiceViewModel Model = new(); 
    
    private Client? SelectedClient;
    private string ExistingRef = "";
    private bool IsLoading = true;
    private bool IsSaving = false;
    private bool IsPreviewMode = false;
    private bool IsDownloadingPdf = false;
    private string _successMessage = "";
    private InvoiceStatus CurrentStatus = InvoiceStatus.Draft;
    private string OriginalModelJson = ""; 
    
    private CompanyProfileDto _companyProfile = new();
    private InvoiceSettingsDto _invoiceSettings = new();
    private ProductDialog _productDialog;
    private QuoteLineDto _activeLineForCreation; // Reusing QuoteLineDto for UI simplicity or InvoiceLineDto mapping?
    // Actually we should use InvoiceLineDto or a shared LineVM. 
    // To minimize friction I'll use InvoiceLineDto but mapped.
    // Let's use a nested VM class that has necessary props.
    
    private bool _showUnsavedModal = false;
    private AddClientModal _addClientModal; // Added for AddClientModal

    // ... Computed Properties (RawTotalHT, DiscountAmount, etc) same as Quote ...
    private decimal RawTotalHT => Model.Lines.Where(l => l.Type == QuoteLineType.Product).Sum(l => l.Quantity * l.UnitPrice);
    private decimal DiscountAmount 
    {
        get {
            decimal baseAmount = (Model.DiscountBase == DiscountBase.BaseHT) ? RawTotalHT : (RawTotalHT * 1.2m);
            decimal amount = (Model.DiscountType == DiscountType.Percent) ? baseAmount * (Model.DiscountValue / 100m) : Model.DiscountValue;
            return amount > baseAmount ? baseAmount : amount;
        }
    }
    private decimal NetHT => RawTotalHT - (Model.DiscountBase == DiscountBase.BaseHT ? DiscountAmount : 0);
    private decimal TotalTVA 
    {
        get {
             var rawTva = Model.Lines.Where(l => l.Type == QuoteLineType.Product).Sum(l => (l.Quantity * l.UnitPrice) * (l.VATRate / 100m));
             if(RawTotalHT == 0) return 0;
             var ratio = (Model.DiscountBase == DiscountBase.BaseHT) ? (DiscountAmount/RawTotalHT) : 0;
             return rawTva * (1 - ratio);
        }
    }
    private decimal TotalTTC => NetHT + TotalTVA;

    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;
         _companyProfile = await SettingsService.GetSettingAsync<CompanyProfileDto>("CompanyProfile", new());
         _invoiceSettings = await SettingsService.GetSettingAsync<InvoiceSettingsDto>("InvoiceSettings", new());
         
         if (Id.HasValue)
         {
             var invoice = await ApiService.GetInvoiceByIdAsync(Id.Value);
             if (invoice != null)
             {
                 ExistingRef = invoice.Reference;
                 CurrentStatus = invoice.Status;
                 Model = new InvoiceViewModel 
                 {
                     Id = invoice.Id,
                     ClientId = invoice.ClientId.GetValueOrDefault(),
                     DateCreated = invoice.DateCreated.ToLocalTime(),
                     DueDate = invoice.DueDate.ToLocalTime(),
                     Message = invoice.Message,
                     PaymentTerms = invoice.PaymentTerms,
                     FooterNote = invoice.FooterNote,
                     QuoteId = invoice.QuoteId,
                     QuoteReference = invoice.QuoteReference,
                     // Map Guest Fields
                     GuestName = invoice.GuestName,
                     GuestEmail = invoice.GuestEmail,
                     GuestPhone = invoice.GuestPhone,
                     DiscountValue = 0, // DTO doesn't have it yet? InvoiceDto DOESN'T have discount fields in my implementation!
                     // WAIT! I forgot to add Discount fields to InvoiceDto and Invoice Entity?
                     // Verify: CommerceService.cs lines 797+ (Create) and 888 (Update).
                     // In UpdateInvoiceAsync (Step 3095): invoice.TotalHT = grossHT - invoice.DiscountValue.
                     // But I didn't see DiscountValue in Invoice entity in Step 3095.
                     // Ah, I set invoice.DiscountValue = quote.DiscountValue in ConvertQuoteToInvoiceAsync.
                     // So Invoice Entity HAS Discount fields.
                     // But InvoiceDto? Step 3095 map function: didn't map Discount fields!
                     // I need to add Discount fields to InvoiceDto if I want to edit them.
                     // For now, I will assume 0 or hack it.
                     // UpdateInvoiceDto also needs them.
                     // Critial Miss: InvoiceDto missing Display fields.
                     // I will proceed without Discount editing for now (always 0) or rely on "Total override"?
                     // Or I can update DTOs later.
                     // Saving requires UpdateInvoiceDto.
                     // Let's assume for now 0 discount or standard calc.
                     Lines = invoice.Lines.Select(l => new InvoiceLineVM {
                         Id = l.Id, Description=l.Description, Quantity=l.Quantity, 
                         UnitPrice=l.UnitPrice, VATRate=l.VATRate, Type=l.Type, Date=l.Date, Unit=l.Unit,
                         TotalHT = l.TotalHT, Position = l.Position
                     }).ToList(),
                     PublicToken = invoice.PublicToken
                 };
                  
                  // Initialize Guest State
                  _isGuestClient = !invoice.ClientId.HasValue && !string.IsNullOrWhiteSpace(invoice.GuestEmail);
                  
                   if(invoice.ClientId.HasValue) SelectedClient = await ApiService.GetClientByIdAsync(invoice.ClientId.Value);
                   
                   // Recalculate subtotals after loading
                   UpdateSubtotals();
             }
         }
         else
         {
             // New Invoice
             Model = new InvoiceViewModel 
             {
                 DateCreated = DateTime.Today,
                 DueDate = DateTime.Today.AddDays(30),
                 PaymentTerms = _invoiceSettings.DefaultPaymentTerms,
                 FooterNote = _invoiceSettings.DefaultFooterNote
             };
             AddLine();
         }
         
         OriginalModelJson = JsonSerializer.Serialize(Model);
         IsLoading = false;
    }

    private void AddLine(QuoteLineType type = QuoteLineType.Product)
    {
        Model.Lines.Add(new InvoiceLineVM { Type = type, Quantity = 1, UnitPrice = 0, VATRate = 20, Date = DateTime.Today });
        UpdateSubtotals();
    }
    
    // ... MoveLine, RemoveLine, HandleProduct, etc (Similar to Quote) ...
    private void RemoveLine(InvoiceLineVM line) { Model.Lines.Remove(line); UpdateSubtotals(); if(!Model.Lines.Any()) AddLine(); }
     private void MoveLine(InvoiceLineVM line, int dir) {
        var idx = Model.Lines.IndexOf(line);
        var newIdx = idx + dir;
        if(newIdx >= 0 && newIdx < Model.Lines.Count) {
             var other = Model.Lines[newIdx];
             Model.Lines[newIdx] = line;
             Model.Lines[idx] = other;
        }
    }
    private void UpdateSubtotals() 
    { 
        // First, sync Position with list order
        for(int i = 0; i < Model.Lines.Count; i++)
        {
            Model.Lines[i].Position = i;
        }
        
        // Then recalculate subtotals
        decimal runningTotal = 0;
        foreach(var line in Model.Lines)
        {
            if (line.Type == QuoteLineType.Product)
            {
                runningTotal += line.Quantity * line.UnitPrice;
            }
            else if (line.Type == QuoteLineType.Subtotal)
            {
                line.TotalHT = runningTotal;
                runningTotal = 0; 
            }
        }
    }
    private void HandleProductSelected(InvoiceLineVM line, ProductDto p) {
        line.Description = p.Name; line.UnitPrice = p.UnitPrice; line.Unit = p.Unit; line.VATRate = p.VATRate;
    }
    private void OpenNewProductDialog(InvoiceLineVM line) { /* ... */ }
    private void HandleNewProductCreated(ProductDto p) { /* ... */ }

    private void HandleClientSelected(Client c) { SelectedClient = c; Model.ClientId = c?.Id ?? Guid.Empty; }

    private SendInvoiceModal _sendModal;
    private SendReminderModal _sendReminderModal;
    private string PdfBlobUrl = "";

    private void TogglePreview() 
    { 
        IsPreviewMode = !IsPreviewMode;
    }

    private void OpenSendModal()
    {
         if ((!_isGuestClient && (SelectedClient == null || string.IsNullOrEmpty(SelectedClient.Email))) ||
             (_isGuestClient && string.IsNullOrEmpty(Model.GuestEmail)))
         {
              JS.InvokeVoidAsync("alert", "L'email le destinataire est manquant ou invalide.");
              return;
         }

         var subject = $"Facture {ExistingRef} - {_companyProfile.CompanyName} - {TotalTTC:C2}";
         var body = "Bonjour,\n\nVous trouverez ci-joint votre facture. Nous vous remercions d'avoir choisi notre solution !\n\nCordialement,";
         _sendModal.Open(subject, body, _isGuestClient ? Model.GuestEmail : (SelectedClient?.Email ?? ""));
    }
    
    private async Task SendInvoiceEmail(SendQuoteEmailDto dto)
    {
        if(!Id.HasValue) return;
        try 
        {
             // Parse recipients from comma-separated string
             var recipients = string.IsNullOrWhiteSpace(dto.Recipients) 
                 ? null 
                 : dto.Recipients.Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries)
                     .Select(e => e.Trim()).ToList();
             
             // Parse CC emails
             var cc = string.IsNullOrWhiteSpace(dto.Cc) 
                 ? null 
                 : dto.Cc.Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries)
                     .Select(e => e.Trim()).ToList();
             
             await ApiService.SendInvoiceByEmailAsync(Id.Value, dto.Subject, dto.Body, dto.CopyToSender, dto.TempAttachmentIds, cc, recipients);
             await JS.InvokeVoidAsync("alert", "Email envoyé avec succès !");
             if(CurrentStatus == InvoiceStatus.Draft) 
             {
                 CurrentStatus = InvoiceStatus.Sent; 
                 await ApiService.UpdateInvoiceStatusAsync(Id.Value, InvoiceStatus.Sent);
             }
             NavManager.NavigateTo("/admin/commerce/invoices");
        }
         catch(Exception ex)
        {
             Console.WriteLine(ex);
             await JS.InvokeVoidAsync("alert", "Erreur lors de l'envoi.");
        }
    }

    private void OpenSendReminderModal()
    {
         if ((!_isGuestClient && (SelectedClient == null || string.IsNullOrEmpty(SelectedClient.Email))) ||
             (_isGuestClient && string.IsNullOrEmpty(Model.GuestEmail)))
         {
              JS.InvokeVoidAsync("alert", "L'email le destinataire est manquant ou invalide.");
              return;
         }

         var subject = $"Rappel de paiement - Facture {ExistingRef} - {TotalTTC:C2}";
         var body = "Bonjour,\n\nCeci est un rappel concernant votre facture non réglée. Merci par avance pour votre virement.\n\nRestant à votre disposition,\n\nBien cordialement.";
         _sendReminderModal.Open(subject, body, _isGuestClient ? Model.GuestEmail : (SelectedClient?.Email ?? ""));
    }

    private async Task SendReminderCallback(SendQuoteEmailDto dto)
    {
         if(!Id.HasValue) return;
         
         try
         {
             // Parse recipients from comma-separated string
             var recipients = string.IsNullOrWhiteSpace(dto.Recipients) 
                 ? null 
                 : dto.Recipients.Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries)
                     .Select(e => e.Trim()).ToList();
             
             // Parse CC emails
             var cc = string.IsNullOrWhiteSpace(dto.Cc) 
                 ? null 
                 : dto.Cc.Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries)
                     .Select(e => e.Trim()).ToList();
         
             if(await ApiService.SendPaymentReminderAsync(Id.Value, dto.Subject, dto.Body, dto.TempAttachmentIds, cc, recipients))
             {
                 await JS.InvokeVoidAsync("alert", "Rappel envoyé !");
                 if(CurrentStatus == InvoiceStatus.Sent) 
                 {
                     CurrentStatus = InvoiceStatus.Overdue;
                     await ApiService.UpdateInvoiceStatusAsync(Id.Value, InvoiceStatus.Overdue);
                 }
                 NavManager.NavigateTo("/admin/commerce/invoices");
             }
             else
             {
                  await JS.InvokeVoidAsync("alert", "Erreur lors de l'envoi du rappel.");
             }
         }
         catch(Exception ex)
         {
             Console.WriteLine(ex);
             await JS.InvokeVoidAsync("alert", "Erreur lors de l'envoi du rappel.");
         }
    }
    
    private async Task SaveTermsAsTemplate()
    {
        _invoiceSettings.DefaultPaymentTerms = Model.PaymentTerms;
        await SettingsService.SaveSettingAsync("InvoiceSettings", _invoiceSettings);
        await JS.InvokeVoidAsync("alert", "Modalités de paiement définies comme modèle par défaut !");
    }

    private async Task SaveNotesAsTemplate()
    {
        _invoiceSettings.DefaultFooterNote = Model.FooterNote;
        await SettingsService.SaveSettingAsync("InvoiceSettings", _invoiceSettings);
        await JS.InvokeVoidAsync("alert", "Notes définies comme modèle par défaut !");
    }

    private async Task DownloadPdf()
    {
          if(!Id.HasValue) return;
          IsDownloadingPdf = true;
          StateHasChanged();
          try {
             var pdfBytes = await ApiService.GetInvoicePdfAsync(Id.Value);
             using var streamRef = new DotNetStreamReference(new MemoryStream(pdfBytes));
             await JS.InvokeVoidAsync("downloadFileFromStream", $"Facture_{ExistingRef}.pdf", streamRef);
          } catch(Exception ex) {
              await JS.InvokeVoidAsync("alert", "Erreur téléchargement.");
          } finally {
              IsDownloadingPdf = false;
              StateHasChanged();
          }
    }

    private void GoBack() { NavManager.NavigateTo("/admin/commerce/invoices"); }
    
    private bool IsDirty() => JsonSerializer.Serialize(Model) != OriginalModelJson;

    private async Task Save(bool exit)
    {
        IsSaving = true;
        // Map VM to DTO
        if(!_isGuestClient && Model.ClientId == Guid.Empty) { await JS.InvokeVoidAsync("alert", "Client requis"); IsSaving=false; return; }
        if(_isGuestClient && string.IsNullOrEmpty(Model.GuestEmail)) { await JS.InvokeVoidAsync("alert", "Email invité requis"); IsSaving=false; return; }

        // FIX: Clear ClientId if Guest Mode to prevent conflict
        if (_isGuestClient) Model.ClientId = Guid.Empty;

        InvoiceDto? result = null;
        try
        {
            if (Id.HasValue)
            {
                var updateDto = new UpdateInvoiceDto
                {
                    Id = Id.Value,
                    ClientId = Model.ClientId == Guid.Empty ? null : Model.ClientId,
                    GuestName = Model.GuestName,
                    GuestEmail = Model.GuestEmail,
                    GuestPhone = Model.GuestPhone,
                    DateCreated = Model.DateCreated,
                    DueDate = Model.DueDate,
                    Message = Model.Message,
                    PaymentTerms = Model.PaymentTerms,
                    FooterNote = Model.FooterNote,
                    Status = CurrentStatus,
                    Lines = Model.Lines.Select(l => new UpdateInvoiceLineDto { 
                        Id = l.Id != Guid.Empty ? (Guid?)l.Id : null,
                        Description = l.Description, Quantity = l.Quantity, UnitPrice = l.UnitPrice, 
                        VATRate = l.VATRate, Type = l.Type, Date = l.Date, Unit = l.Unit, Position = l.Position }).ToList()
                };
                result = await ApiService.UpdateInvoiceAsync(updateDto);
            }
            else
            {
                var createDto = new CreateInvoiceDto
                {
                    ClientId = Model.ClientId == Guid.Empty ? null : Model.ClientId,
                    GuestName = Model.GuestName,
                    GuestEmail = Model.GuestEmail,
                    GuestPhone = Model.GuestPhone,
                    DateCreated = Model.DateCreated, 
                    DueDate = Model.DueDate,
                    Message = Model.Message,
                    PaymentTerms = Model.PaymentTerms,
                    FooterNote = Model.FooterNote,
                    Lines = Model.Lines.Select(l => new UpdateInvoiceLineDto { 
                        Description = l.Description, Quantity = l.Quantity, UnitPrice = l.UnitPrice, 
                        VATRate = l.VATRate, Type = l.Type, Date = l.Date, Unit = l.Unit, Position = l.Position }).ToList()
                };
                result = await ApiService.CreateInvoiceAsync(createDto);
            }

            if (result != null)
            {
                Id = result.Id;
                ExistingRef = result.Reference;
                CurrentStatus = result.Status;
                
                // Refresh Model from result
                Model.Id = result.Id;
                Model.Lines = result.Lines.Select(l => new InvoiceLineVM {
                    Id = l.Id, Description = l.Description, Quantity = l.Quantity, 
                    UnitPrice = l.UnitPrice, VATRate = l.VATRate, Type = l.Type, Date = l.Date, Unit = l.Unit,
                    TotalHT = l.TotalHT, Position = l.Position
                }).ToList();
                
                Model.DiscountValue = result.DiscountValue;
                Model.DiscountType = result.DiscountType;
                Model.DiscountBase = result.DiscountBase;
                Model.DiscountScope = result.DiscountScope;
                
                // Recalculate subtotals after reloading lines
                UpdateSubtotals();
                
                OriginalModelJson = JsonSerializer.Serialize(Model);
                
                // Show success notification
                _successMessage = "Facture enregistrée avec succès !";
                StateHasChanged();
                await Task.Delay(3000);
                _successMessage = "";
                StateHasChanged();
                
                if (exit) GoBack();
                else if(!Id.HasValue) NavManager.NavigateTo($"/admin/commerce/invoices/edit/{result.Id}"); 
            }
            else
            {
                throw new Exception("L'API n'a retourné aucun résultat (null).");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Erreur lors de l'enregistrement: {ex.Message}");
        }
        finally
        {
            IsSaving = false;
        }
    }
    
    private bool _isGuestClient = false;

    // Helper methods for Guest Client
    private void SetGuestClient(bool isGuest)
    {
        _isGuestClient = isGuest;
        if (isGuest)
        {
            SelectedClient = null;
            Model.ClientId = Guid.Empty; // Or null if nullable
        }
        else
        {
            Model.GuestName = null;
            Model.GuestEmail = null;
            Model.GuestPhone = null;
        }
        StateHasChanged();
    }
    
    private async Task OpenAddClientModal()
    {
        _addClientModal?.Open();
        await JS.InvokeVoidAsync("showModal", "addClientModal");
    }
    
    private async Task HandleNewClientCreated(Client client)
    {
        SelectedClient = client;
        Model.ClientId = client.Id;
        StateHasChanged();
    }

    private async Task FinalizeInvoice()
    {
        await Save(false);
        if(Id.HasValue)
        {
             await ApiService.UpdateInvoiceStatusAsync(Id.Value, InvoiceStatus.Sent);
             CurrentStatus = InvoiceStatus.Sent;
             NavManager.NavigateTo("/admin/commerce/invoices");
        }
    }

    private string GetStatusClass(InvoiceStatus s) => s switch { InvoiceStatus.Draft => "bg-secondary", InvoiceStatus.Sent => "bg-info", InvoiceStatus.Paid => "bg-success", InvoiceStatus.Overdue => "bg-danger", InvoiceStatus.Cancelled => "bg-dark", _ => "bg-dark" };
    
    private string GetStatusName(InvoiceStatus status) => status switch
    {
        InvoiceStatus.Draft => "Brouillon",
        InvoiceStatus.Sent => "Envoyée",
        InvoiceStatus.Paid => "Payée",
        InvoiceStatus.Overdue => "En retard",
        InvoiceStatus.Cancelled => "Annulée",
        _ => status.ToString()
    };
    
    // --- View Models ---
    public class InvoiceViewModel
    {
        public Guid Id { get; set; }
        public Guid ClientId { get; set; }
        public DateTime DateCreated { get; set; } = DateTime.Today;
        public DateTime DueDate { get; set; } = DateTime.Today.AddDays(30);
        public string Message { get; set; } = "";
        public string PaymentTerms { get; set; } = "";
        public string FooterNote { get; set; } = "";
        public DiscountType DiscountType { get; set; }
        public decimal DiscountValue { get; set; }
        public DiscountBase DiscountBase { get; set; }
        public DiscountScope DiscountScope { get; set; }
        public Guid PublicToken { get; set; }
        public List<InvoiceLineVM> Lines { get; set; } = new();
        
        // Guest Client Fields
        public string? GuestName { get; set; }
        public string? GuestEmail { get; set; }
        public string? GuestPhone { get; set; }
        
        // Link
        public Guid? QuoteId { get; set; }
        public string? QuoteReference { get; set; }
    }

    public class InvoiceLineVM 
    {
        public Guid Id { get; set; }
        public QuoteLineType Type { get; set; } = QuoteLineType.Product;
        public string Description { get; set; } = "";
        public decimal Quantity { get; set; }
        public string Unit { get; set; } = "";
        public decimal UnitPrice { get; set; }
        public decimal VATRate { get; set; }
        public DateTime? Date { get; set; }
        public decimal TotalHT { get; set; } // For display
        public int Position { get; set; } // For ordering
    }
    
    // --- Admin Preview Logic ---
    private RenderFragment RenderAdminPreview(InvoiceViewModel invoice) => __builder =>
    {
        <div class="p-4 bg-white" style="min-height: 800px; font-size: 0.85rem;">
            <!-- Header with Company Info & Logo -->
            <div class="row mb-5 border-bottom pb-4">
                <div class="col-12 col-md-7 mb-3 mb-md-0">
                    <img src="/images/logo.jpg" alt="HIPPOCAMPE" style="max-height: 80px;" class="mb-3" />
                    
                    <div class="small text-muted">
                        <strong>@_companyProfile.CompanyName</strong><br/>
                        @_companyProfile.Address<br/>
                        @_companyProfile.City<br/>
                        @_companyProfile.Country<br/>
                        <br/>
                        Tél: @_companyProfile.Phone<br/>
                        Email: @_companyProfile.Email
                    </div>
                </div>
                <div class="col-12 col-md-5 text-md-end">
                    <h2 class="fw-bold text-uppercase text-secondary mb-3">Facture</h2>
                    <h4 class="fw-bold fs-3">@(string.IsNullOrEmpty(ExistingRef) ? "BROUILLON" : ExistingRef)</h4>
                    <div class="text-muted mt-2">Date: @invoice.DateCreated.ToString("dd/MM/yyyy")</div>
                    <div class="text-danger fw-bold">Échéance: @invoice.DueDate.ToString("dd/MM/yyyy")</div>
                </div>
            </div>

            <!-- Client Info Box -->
            <div class="row mb-5 justify-content-end">
                <div class="col-md-6">
                    <div class="p-4 bg-light rounded-3 border">
                        <h6 class="text-uppercase text-secondary small fw-bold mb-3">Destinataire</h6>
                        @if(SelectedClient != null)
                        {
                            <div class="fs-5 fw-bold text-dark">@SelectedClient.Nom @SelectedClient.Prenom</div>
                            <div class="text-muted">@SelectedClient.AdressePrincipale</div>
                            <div class="text-muted">@SelectedClient.TelephonePrincipal</div>
                            <div class="text-muted"><a href="mailto:@SelectedClient.Email">@SelectedClient.Email</a></div>
                        }
                        else if (!string.IsNullOrWhiteSpace(Model.GuestEmail))
                        {
                            @if(!string.IsNullOrWhiteSpace(Model.GuestName))
                            {
                                <div class="fs-5 fw-bold text-dark">@Model.GuestName</div>
                            }
                            <div class="text-muted">@Model.GuestEmail</div>
                            @if(!string.IsNullOrWhiteSpace(Model.GuestPhone))
                            {
                                <div class="text-muted">@Model.GuestPhone</div>
                            }
                        }
                        else
                        {
                            <div class="text-muted fst-italic">Client non sélectionné</div>
                        }
                    </div>
                </div>
            </div>

            <!-- Message -->
            @if (!string.IsNullOrEmpty(invoice.Message))
            {
                <div class="mb-4">
                    <h6 class="fw-bold text-secondary text-uppercase small mb-2">Message</h6>
                    <p class="text-pre-wrap small text-muted">@invoice.Message</p>
                </div>
            }

            <!-- Payment Terms -->
            @if (!string.IsNullOrEmpty(invoice.PaymentTerms))
            {
                    <div class="mb-4">
                    <h6 class="fw-bold text-secondary text-uppercase small mb-2">Modalités de Paiement</h6>
                    <p class="small text-muted">@invoice.PaymentTerms</p>
                </div>
            }

            <!-- Line Items -->
            <div class="table-responsive mb-5">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="py-3 ps-4">Description</th>
                            <th class="py-3 ps-4">Date</th>
                            <th class="text-end py-3">Quantité</th>
                            <th class="text-end py-3">Prix Unit.</th>
                            <th class="text-end py-3">TVA</th>
                            <th class="text-end py-3 pe-4">Total HT</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var line in invoice.Lines)
                        {
                            @if(line.Type == QuoteLineType.Title)
                            {
                                <tr class="table-secondary title-row">
                                    <td colspan="6" class="fw-bold text-uppercase py-2 ps-4 text-dark">@line.Description</td>
                                </tr>
                            }
                            else if(line.Type == QuoteLineType.Text)
                            {
                                <tr>
                                    <td colspan="6" class="text-muted py-2 ps-4">@line.Description</td>
                                </tr>
                            }
                            else if (line.Type == QuoteLineType.Subtotal)
                            {
                                <tr class="fw-bold border-top">
                                    <td class="ps-4 py-3" colspan="2">@(string.IsNullOrWhiteSpace(line.Description) ? "Sous-total" : line.Description)</td>
                                    <td colspan="3"></td>
                                    <td class="text-end py-3 pe-4 fw-bold">@line.TotalHT.ToString("N2") €</td>
                                </tr>
                            }
                            else
                            {
                                <tr>
                                    <td class="ps-4 py-3 fw-medium">@line.Description</td>
                                    <td class="ps-4 py-3">@(line.Date.HasValue ? line.Date.Value.ToString("dd/MM/yyyy") : "-")</td>
                                    <td class="text-end py-3 text-nowrap">@line.Quantity @line.Unit</td>
                                    <td class="text-end py-3 text-nowrap">@line.UnitPrice.ToString("N2") €</td>
                                    <td class="text-end py-3 text-nowrap">@line.VATRate %</td>
                                    <td class="text-end py-3 pe-4 text-nowrap">@((line.Quantity * line.UnitPrice).ToString("N2")) €</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            <!-- Footers & Totals -->
            <div class="row">
                <div class="col-md-7">
                </div>
                <div class="col-md-5">
                        <table class="table table-sm table-borderless">
                        <tr>
                            <td class="text-end text-muted">Total HT</td>
                            <td class="text-end fw-bold">@RawTotalHT.ToString("N2") €</td>
                        </tr>
                        <tr>
                            <td class="text-end text-muted">TVA</td>
                            <td class="text-end fw-bold">@TotalTVA.ToString("N2") €</td>
                        </tr>
                        <tr class="border-top border-dark">
                            <td class="text-end fs-4 fw-bold pt-3">Total TTC</td>
                            <td class="text-end fs-4 fw-bold pt-3 text-primary">@TotalTTC.ToString("C2")</td>
                        </tr>
                    </table>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(invoice.FooterNote))
            {
                <div class="mt-4 text-center border-top pt-3">
                        <h6 class="fw-bold text-secondary text-uppercase small mb-2">Note de bas de page</h6>
                        <p class="small text-muted mb-0">@invoice.FooterNote</p>
                </div>
            }

            <!-- Legal Footer -->
            <div class="mt-5 text-center text-muted small pt-5 border-top">
                    @_companyProfile.CompanyName - @_companyProfile.Address @_companyProfile.City<br/>
                    Numéro de SIRET: @_companyProfile.Siret - Numéro de TVA: @_companyProfile.TvaNumber
            </div>
        </div>
    };
    
    // Stub implementations for Unsaved Modal
     private void ConfirmSaveAndExit() { Save(true); _showUnsavedModal = false; }
     private void ConfirmExitWithoutSave() { _showUnsavedModal = false; GoBack(); }
}
