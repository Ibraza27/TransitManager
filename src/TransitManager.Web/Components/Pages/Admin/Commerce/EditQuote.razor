@page "/admin/commerce/quotes/new"
@page "/admin/commerce/quotes/edit/{Id:guid}"
@using Microsoft.AspNetCore.Authorization
@using TransitManager.Core.DTOs.Commerce
@using TransitManager.Core.DTOs
@using TransitManager.Web.Services
@using TransitManager.Core.Enums
@using TransitManager.Web.Components.Shared
@using TransitManager.Core.Entities 
@using Microsoft.JSInterop
@using System.Text.Json

@inject IApiService ApiService
@inject NavigationManager NavManager
@inject IJSRuntime JS
@attribute [Authorize(Roles = "Administrateur")]

<div class="d-flex h-100 flex-column" style="height: calc(100vh - 60px);">
    
    <!-- Action Bar -->
    <div class="d-flex flex-wrap justify-content-between align-items-center p-3 border-bottom bg-white gap-3">
        <div class="d-flex align-items-center gap-3">
            <button class="btn btn-outline-secondary rounded-circle p-2" @onclick="Cancel" title="Retour">
                <i class="bi bi-x-lg"></i>
            </button>
            <h4 class="mb-0 fw-bold text-truncate" style="max-width: 200px;">@(Id == null ? "Nouveau" : $"{ExistingRef}")</h4>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            @if (IsPreviewMode)
            {
                <button class="btn btn-secondary btn-sm" @onclick="TogglePreview">
                    <i class="bi bi-arrow-left me-2"></i>Éditer
                </button>
                 <button class="btn btn-primary btn-sm" @onclick="SendEmail">
                    <i class="bi bi-envelope-fill me-2"></i>Envoyer
                </button>
                <button class="btn btn-outline-secondary btn-sm" @onclick="DownloadPdf" disabled="@IsLoadingPdf">
                    @if(IsLoadingPdf) { <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> }
                    else { <i class="bi bi-download"></i> }
                </button>
            }
            else
            {
                 <button class="btn btn-outline-secondary btn-sm d-none d-md-inline-block" @onclick="Cancel">Annuler</button>
                 <button class="btn btn-info text-white btn-sm" @onclick="TogglePreview">
                    <i class="bi bi-eye me-2"></i>Aperçu
                </button>
                 <button class="btn btn-secondary btn-sm" @onclick="SaveDraft">
                    <i class="bi bi-save me-2"></i>@(Id.HasValue && !IsAutoDraft ? "Enregistrer" : "Brouillon")
                </button>
            }
        </div>
    </div>

    @if (IsLoading)
    {
        <div class="d-flex justify-content-center align-items-center flex-grow-1">
             <div class="spinner-border text-primary"></div>
        </div>
    }
    else if (IsPreviewMode)
    {
        <!-- PREVIEW MODE - Responsive Wrapper -->
        <div class="p-0 p-md-4 bg-light flex-grow-1 overflow-auto pb-5 mb-5">
            <div class="card border-0 shadow-lg mx-auto mb-5" style="max-width: 900px; min-height: 800px;">
             <!-- ... existing preview content ... -->
             <!-- Reuse RenderQuoteDetail logic if I extracted it, but for now just ensure container is ok -->
             <!-- I will assume the Preview logic inside is ok via scroll, but let's check the container -->
                <div class="card-body p-3 p-md-5">
                    <!-- Reuse the same Preview Content structure but adjusted padding -->
                     <!-- Header -->
                    <div class="row mb-5 border-bottom pb-4">
                        <div class="col-12 col-md-7 mb-3 mb-md-0">
                                <img src="/images/logo.jpg" alt="HIPPOCAMPE" style="max-height: 80px;" class="mb-3" />
                                <!-- ... -->
                                <div class="small text-muted">
                                    <strong>HIPPOCAMPE IMPORT EXPORT - SAS</strong><br/>
                                    7 Rue Pascal, 33370 TRESSES<br/>
                                    Email: contact@hippocampeimportexport.com
                                </div>
                        </div>
                        <div class="col-12 col-md-5 text-md-end">
                            <h2 class="fw-bold text-uppercase text-secondary mb-3">Devis</h2>
                            <h4 class="fw-bold fs-3">@(Model.Reference ?? "BROUILLON")</h4>
                            <div class="text-muted mt-2">Date : @(Model.DateCreated?.ToString("dd/MM/yyyy") ?? DateTime.Now.ToString("dd/MM/yyyy"))</div>
                             <div class="text-danger fw-bold">Valide jusqu'au : @Model.DateValidity.ToString("dd/MM/yyyy")</div>
                        </div>
                    </div>

                    <!-- Client Info -->
                     <div class="row mb-5 justify-content-end">
                        <div class="col-md-6">
                            <div class="p-4 bg-light rounded-3 border">
                                <h6 class="text-uppercase text-secondary small fw-bold mb-3">Destinataire</h6>
                                 @if(SelectedClient != null)
                                {
                                    <div class="fs-5 fw-bold text-dark">@SelectedClient.Nom @SelectedClient.Prenom</div>
                                    <div class="text-muted">@SelectedClient.AdressePrincipale @SelectedClient.CodePostal @SelectedClient.Ville</div>
                                    <div class="text-muted">@SelectedClient.Email</div>
                                }
                                else
                                {
                                    <div class="text-muted fst-italic">Aucun client sélectionné</div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Payment Terms (Moved) -->
                    @if(!string.IsNullOrEmpty(Model.PaymentTerms))
                    {
                        <div class="mb-4">
                                <h6 class="fw-bold text-secondary text-uppercase small mb-2">Modalités de Paiement</h6>
                                <p class="small text-muted">@Model.PaymentTerms</p>
                        </div>
                    }

                     <!-- Line Items (Responsive Table) -->
                    <div class="table-responsive mb-5">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th class="py-3 ps-4" style="width: 50%;">Description</th>
                                    <th class="py-3 text-center" style="width: 100px;">Date</th>
                                    <th class="text-end py-3" style="width: 80px;">Qté</th>
                                    <th class="text-center py-3" style="width: 60px;">Unité</th>
                                    <th class="text-end py-3" style="width: 100px;">Prix</th>
                                    <th class="text-end py-3" style="width: 80px;">TVA</th>
                                    <th class="text-end py-3 pe-4" style="width: 100px;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var line in Model.Lines)
                                {
                                    <tr class="@(line.Type == QuoteLineType.Subtotal ? "fw-bold border-bottom border-dark" : "")" style="@(line.Type == QuoteLineType.Subtotal ? "border-top: 2px solid #dee2e6;" : "")">
                                        @if(line.Type == QuoteLineType.Title)
                                        {
                                            <td colspan="7" class="ps-4 py-3 text-uppercase fw-bold table-secondary">@line.Description</td>
                                        }
                                        else if (line.Type == QuoteLineType.Text)
                                        {
                                            <td colspan="7" class="ps-4 py-3 text-wrap">@line.Description</td>
                                        }
                                        else if (line.Type == QuoteLineType.Subtotal)
                                        {
                                            <td class="ps-4 py-3 fw-bold">Sous-total</td>
                                            <td colspan="5"></td> <!-- Empty columns -->
                                            <td class="text-end py-3 pe-4 fw-bold">@line.TotalHT.ToString("N2") €</td>
                                        }
                                        else
                                        {
                                            <td class="ps-4 py-3 fw-medium">@line.Description</td>
                                            <td class="text-center py-3">@line.Date?.ToString("dd/MM")</td>
                                            <td class="text-end py-3">@line.Quantity.ToString("0.##")</td>
                                            <td class="text-center py-3">@line.Unit</td>
                                            <td class="text-end py-3">@line.UnitPrice.ToString("N2")</td>
                                            <td class="text-end py-3">@line.VATRate%</td>
                                            <td class="text-end py-3 pe-4">@((line.Quantity * line.UnitPrice).ToString("N2"))</td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between mb-1">
                        <span>Total TVA</span>
                        <span>@TotalTVA.ToString("N2") €</span>
                    </div>
                    <div class="d-flex justify-content-between py-2 border-top bg-light fw-bold fs-5 px-2 mt-2">
                         <span>Total TTC</span>
                        <span>@TotalTTC.ToString("N2") €</span>
                    </div>
                    
                    <!-- Footer -->
                    <div class="mt-auto pt-5">

                         @if(!string.IsNullOrEmpty(Model.FooterNote))
                        {
                            <div class="small text-muted border-top pt-2 text-center">
                                @Model.FooterNote
                            </div>
                        }
                            
                         <!-- Address Block (Added) -->
                         <div class="mt-4 pt-3 text-center small text-muted border-top">
                             <div class="fw-bold text-dark" style="font-size: 1em;">HIPPOCAMPE IMPORT EXPORT - SAS</div>
                             <div>7 Rue Pascal 33370 Tresses</div>
                             <div>Numéro de SIRET: 891909772 - Numéro de TVA: FR42891909772 - BORDEAUX</div>
                         </div>
                    </div>
                </div>
            </div>
            
             <!-- Modal Actions (Mobile Optimized - Floating Fixed Bottom) -->
             <div class="fixed-bottom bg-white border-top p-3 shadow-lg d-print-none animation-slide-up action-bar-floating" style="z-index: 1040;">
                 <h6 class="fw-bold mb-3 d-none d-md-block">Actions</h6>
                 <div class="d-grid gap-2 d-md-block">
                     <button class="btn btn-success mb-2 mb-md-0 me-md-2" @onclick="() => Finalize(QuoteStatus.Accepted)">Approuver (Simul)</button>
                     <div class="d-flex gap-2 d-md-inline-flex">
                         <button class="btn btn-outline-dark flex-grow-1" @onclick="DownloadPdf" disabled="@IsLoadingPdf">
                            @if(IsLoadingPdf) { <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span><span>PDF...</span> }
                            else { <i class="bi bi-download"></i><span> PDF</span> }
                         </button>
                         <button class="btn btn-outline-dark flex-grow-1" @onclick="PrintPdf" disabled="@IsLoadingPdf">
                            <i class="bi bi-printer"></i> Imprimer
                         </button>
                     </div>
                     <button class="btn btn-outline-primary mt-2 mt-md-0 ms-md-2" @onclick="SendEmail"><i class="bi bi-envelope me-2"></i>Envoyer</button>
                 </div>
             </div>
             <div style="height: 180px;"></div>
        </div>
    }
    else
    {
        <!-- Editor Mode - Responsive Layout -->
        <div class="d-flex flex-column flex-lg-row flex-grow-1 overflow-hidden h-100">
             
             <!-- Main Content (Left) -->
             <div class="flex-grow-1 p-0 bg-light" style="overflow-y: auto; overflow-x: visible;">
                 <!-- Client & Info (Inline, No Card) -->
                 <div class="row g-2 mx-2 my-2 p-2 bg-white border-bottom">
                     <div class="col-md-5">
                         <label class="form-label small fw-bold mb-1">Client</label>
                         <ClientAutocomplete 
                             SelectedClient="@SelectedClient" 
                             OnClientSelected="HandleClientSelected" />
                     </div>
                     <div class="col-md-3">
                           <label class="form-label small fw-bold mb-1">Validité</label>
                           <input type="date" class="form-control form-control-sm" @bind="Model.DateValidity" />
                     </div>
                     <div class="col-12">
                        <label class="form-label small mb-1">Modalités de paiement</label>
                         <textarea class="form-control form-control-sm" rows="1" @bind="Model.PaymentTerms"></textarea>
                    </div>
                </div>     
                     <!-- Lines -->
                     <div class="mx-2 mb-2 bg-white" style="min-height: 200px;">
                          <!-- DESKTOP TABLE VIEW -->
                          <div class="d-none d-md-block">
                              <table class="table table-sm table-borderless align-middle mb-0" style="font-size: 0.85rem;">
                                  <thead class="border-bottom bg-light" style="font-size: 0.75rem;">
                                      <tr class="text-uppercase text-muted">
                                          <th style="width: 50px;"></th><!-- ↑/↓ -->
                                          <th style="min-width: 200px;">Description</th>
                                          <th class="text-center" style="width: 100px;">Date</th>
                                          <th class="text-center" style="width: 70px;">Qté</th>
                                          <th class="text-center" style="width: 55px;">U</th>
                                          <th class="text-center" style="width: 90px;">Prix</th>
                                          <th class="text-center" style="width: 90px;">TVA</th>
                                          <th class="text-end" style="width: 100px;">Total</th>
                                          <th style="width: 30px;"></th><!-- ✕ -->
                                      </tr>
                                  </thead>
                                  <tbody class="sortable-list">
                                     @foreach (var (line, index) in Model.Lines.Select((l, i) => (l, i)))
                                     {
                                         var localIndex = index;
                                         <tr class="@(line.Type == QuoteLineType.Subtotal ? "fw-bold border-bottom border-dark" : "")" 
                                             style="@(line.Type == QuoteLineType.Subtotal ? "border-top: 2px solid #dee2e6;" : "")"
                                             draggable="true"
                                             @ondragstart="@(() => HandleDragStart(localIndex))"
                                             @ondragover:preventDefault
                                             @ondrop="@(() => HandleDrop(localIndex))">
                                             
                                             <!-- Move Buttons -->
                                             <td class="align-middle text-center" style="white-space: nowrap;">
                                                 <button class="btn btn-link text-secondary p-0" title="Monter" @onclick="() => MoveLine(line, -1)" disabled="@(index == 0)"><i class="bi bi-arrow-up-short"></i></button>
                                                 <button class="btn btn-link text-secondary p-0" title="Descendre" @onclick="() => MoveLine(line, 1)" disabled="@(index == Model.Lines.Count - 1)"><i class="bi bi-arrow-down-short"></i></button>
                                             </td>
                                             
                                             <!-- Description Column -->
                                             @if(line.Type == QuoteLineType.Title)
                                             {
                                                 <td colspan="7" class="py-2">
                                                     <input type="text" class="form-control fw-bold border-0 fs-6" placeholder="TITRE DE SECTION" @bind="line.Description" style="background: transparent;" />
                                                 </td>
                                             }
                                             else if (line.Type == QuoteLineType.Text)
                                             {
                                                  <td colspan="7" class="py-2">
                                                     <textarea class="form-control border-0" rows="1" placeholder="Texte libre..." @bind="line.Description" style="height: auto; resize: none; overflow: hidden; background: transparent;"></textarea>
                                                 </td>
                                             }
                                             else 
                                             {
                                                 /* Product or Subtotal */
                                                 <td class="py-2">
                                                     @if(line.Type == QuoteLineType.Product)
                                                     {
                                                         <ProductAutocomplete 
                                                             @bind-Description="line.Description" 
                                                             OnProductSelected="@((p) => HandleProductSelected(line, p))"
                                                             OnCreateNew="() => OpenNewProductDialog(line)" />
                                                     }
                                                     else // Subtotal
                                                     {
                                                         <div class="d-flex align-items-center h-100 fw-bold">
                                                             <span>Sous-total</span>
                                                         </div>
                                                     }
                                                 </td>
                                                 
                                                 @if(line.Type == QuoteLineType.Product)
                                                 {
                                                     <td><input type="date" class="form-control form-control-sm border-0 text-center" @bind="line.Date" /></td>
                                                     <td><input type="number" class="form-control form-control-sm border-0 text-center" @bind="line.Quantity" @bind:after="UpdateSubtotals" step="0.01" /></td>
                                                     <td><input type="text" class="form-control form-control-sm border-0 text-center" @bind="line.Unit" /></td>
                                                     <td><input type="number" class="form-control form-control-sm border-0 text-end" @bind="line.UnitPrice" @bind:after="UpdateSubtotals" step="0.01" /></td>
                                                     <td>
                                                         <input type="number" class="form-control form-control-sm border-0 text-end" style="-moz-appearance: textfield;" @bind="line.VATRate" step="0.1" />
                                                         <style>input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }</style>
                                                     </td>
                                                     <!-- FORCE RECALC DISPLAY -->
                                                     <td class="text-end fw-bold small py-3">@((line.Quantity * line.UnitPrice).ToString("N2")) €</td>
                                                 }
                                                 else if (line.Type == QuoteLineType.Subtotal)
                                                 {
                                                     <td colspan="4"></td> <!-- Empty Date/Qté/U/Prix -->
                                                     <td class="text-end fw-bold py-2"></td> <!-- TVA empty -->
                                                     <td class="text-end fw-bold fs-6 py-2">@line.TotalHT.ToString("N2") €</td>
                                                 }
                                             }
                                             <!-- Delete button -->
                                             <td class="align-middle text-center">
                                                 <button class="btn btn-link text-danger p-0" title="Supprimer" @onclick="() => RemoveLine(line)"><i class="bi bi-x-lg"></i></button>
                                             </td>
     
                                         </tr>
                                         <!-- End of Row -->
                                     }
                                  </tbody>
                              </table>
                          </div>

                          <!-- MOBILE CARD VIEW -->
                          <div class="d-md-none">
                              @foreach (var (line, index) in Model.Lines.Select((l, i) => (l, i)))
                              {
                                  <div class="card mb-2 shadow-sm border-0 @(line.Type == QuoteLineType.Subtotal ? "bg-light border-top border-2" : "")">
                                      <div class="card-body p-2">
                                          <!-- Header: Delete & Controls -->
                                          <div class="d-flex justify-content-between align-items-center mb-2">
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-secondary" @onclick="() => MoveLine(line, -1)" disabled="@(index == 0)">
                                                        <i class="bi bi-arrow-up-short"></i>
                                                    </button>
                                                    <button class="btn btn-outline-secondary" @onclick="() => MoveLine(line, 1)" disabled="@(index == Model.Lines.Count - 1)">
                                                        <i class="bi bi-arrow-down-short"></i>
                                                    </button>
                                                </div>
                                                <button class="btn btn-link text-danger p-0" @onclick="() => RemoveLine(line)">
                                                    <i class="bi bi-x-lg"></i>
                                                </button>
                                          </div>

                                          <!-- Content -->
                                          @if(line.Type == QuoteLineType.Title)
                                          {
                                              <input type="text" class="form-control fw-bold border-0 fs-6 bg-light mb-2" placeholder="TITRE DE SECTION" @bind="line.Description" />
                                          }
                                          else if (line.Type == QuoteLineType.Text)
                                          {
                                              <textarea class="form-control border-0 bg-light mb-2" rows="2" placeholder="Texte libre..." @bind="line.Description"></textarea>
                                          }
                                          else if (line.Type == QuoteLineType.Product)
                                          {
                                               <div class="mb-2">
                                                    <label class="small text-muted fw-bold">Description</label>
                                                    <ProductAutocomplete 
                                                        @bind-Description="line.Description" 
                                                        OnProductSelected="@((p) => HandleProductSelected(line, p))"
                                                        OnCreateNew="() => OpenNewProductDialog(line)" />
                                               </div>
                                               
                                               <div class="row g-2 mb-2">
                                                   <div class="col-4">
                                                       <label class="small text-muted fw-bold">Date</label>
                                                       <input type="date" class="form-control form-control-sm" @bind="line.Date" />
                                                   </div>
                                                   <div class="col-4">
                                                       <label class="small text-muted fw-bold">Qté</label>
                                                       <input type="number" class="form-control form-control-sm" @bind="line.Quantity" @bind:after="UpdateSubtotals" step="0.01" />
                                                   </div>
                                                   <div class="col-4">
                                                       <label class="small text-muted fw-bold">Unité</label>
                                                        <input type="text" class="form-control form-control-sm" @bind="line.Unit" />
                                                   </div>
                                               </div>

                                               <div class="row g-2 align-items-end">
                                                   <div class="col-4">
                                                       <label class="small text-muted fw-bold">Prix U.</label>
                                                       <input type="number" class="form-control form-control-sm" @bind="line.UnitPrice" @bind:after="UpdateSubtotals" step="0.01" />
                                                   </div>
                                                   <div class="col-3">
                                                       <label class="small text-muted fw-bold">TVA %</label>
                                                        <input type="number" class="form-control form-control-sm" @bind="line.VATRate" step="0.1" />
                                                   </div>
                                                   <div class="col-5 text-end">
                                                       <label class="small text-muted fw-bold d-block">Total HT</label>
                                                       <span class="fw-bold text-primary fs-5">@((line.Quantity * line.UnitPrice).ToString("N2")) €</span>
                                                   </div>
                                               </div>
                                          }
                                          else if (line.Type == QuoteLineType.Subtotal)
                                          {
                                              <div class="d-flex justify-content-between align-items-center">
                                                  <span class="fw-bold text-uppercase">Sous-total</span>
                                                  <span class="fw-bold fs-5">@line.TotalHT.ToString("N2") €</span>
                                              </div>
                                          }
                                      </div>
                                  </div>
                              }
                          </div>
                         
                         <!-- Add Line Dropdown -->
                         <div class="p-2 dropdown">
                            <button class="btn btn-dark btn-sm rounded-pill dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-plus-lg me-1"></i> Ajouter une ligne
                            </button>
                            <ul class="dropdown-menu shadow">
                                <li><button class="dropdown-item" @onclick="() => AddLine(QuoteLineType.Product)"><i class="bi bi-box-seam me-2"></i>Produit</button></li>
                                <li><button class="dropdown-item" @onclick="() => AddLine(QuoteLineType.Title)"><i class="bi bi-type-h1 me-2"></i>Titre de section</button></li>
                                <li><button class="dropdown-item" @onclick="() => AddLine(QuoteLineType.Text)"><i class="bi bi-file-text me-2"></i>Texte libre</button></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item fw-bold" @onclick="() => AddLine(QuoteLineType.Subtotal)"><i class="bi bi-calculator me-2"></i>Sous-total</button></li>
                            </ul>
                         </div>
                     </div>
                     
                     <!-- Footer Notes -->
                     <div class="mt-5">
                         <div class="mb-3">
                             <div class="d-flex justify-content-between">
                                 <label class="form-label fw-bold small">Notes</label>
                                 <span class="text-muted small">@((Model.FooterNote?.Length ?? 0))/1000</span>
                             </div>
                             <textarea class="form-control" rows="3" @bind="Model.FooterNote"></textarea>
                         </div>
                     </div>

                 </div>
             
             <!-- Right Sidebar (Totals & Discount) - Stacked on Mobile -->
             <div class="bg-white border-start-lg border-bottom border-lg-0-bottom p-3 overflow-auto sidebar-totals" style="flex: 0 0 250px; min-width: 250px;">
                 <!-- Wrapper for Desktop width constraint -->
                 <div class="d-lg-block">
                     
                     <!-- On Desktop, we want this to be fixed width. On mobile, full width. -->
                     <!-- Since we are in a flex-row container on desktop, we can force width via style media query or simple class utility if available. 
                          But style attribute logic is easier here. -->
                     <!-- Actually, the parent div handles the flex sizing. Let's make this inner content clean. -->
                     
                     <h6 class="fw-bold mb-4">Calculs et Remises</h6>
                     
                     <div class="card bg-light border-0 p-3 mb-4">
                         <div class="row g-2">
                             <div class="col-6">
                                  <label class="small text-muted">Type</label>
                                  <select class="form-select form-select-sm" @bind="Model.DiscountType">
                                      <option value="@DiscountType.Percent">%</option>
                                      <option value="@DiscountType.Amount">EUR</option>
                                  </select>
                             </div>
                             <div class="col-6">
                                 <label class="small text-muted">Valeur</label>
                                 <input type="number" class="form-control form-control-sm" @bind="Model.DiscountValue" />
                             </div>
                         </div>
                         <div class="mt-2 text-end text-danger small fw-bold">
                             -@DiscountAmount.ToString("N2") €
                         </div>
                     </div>
                     
                     <!-- Totals Display -->
                     <div class="d-flex justify-content-between mb-2">
                         <span class="text-muted">Total HT</span>
                         <span class="fw-bold">@RawTotalHT.ToString("N2") €</span>
                     </div>
                      <div class="d-flex justify-content-between mb-2 text-danger">
                         <span class="text-muted">Remise</span>
                         <span class="fw-bold">-@DiscountAmount.ToString("N2") €</span>
                     </div>
                     <div class="d-flex justify-content-between mb-2">
                         <span class="text-muted">Net HT</span>
                         <span class="fw-bold">@NetHT.ToString("N2") €</span>
                     </div>
                     <div class="d-flex justify-content-between mb-2">
                         <span class="text-muted">TVA</span>
                         <span class="fw-bold">@TotalTVA.ToString("N2") €</span>
                     </div>
                     
                     <hr />
                     
                     <div class="d-flex justify-content-between mb-2">
                         <span class="fw-bold fs-5">Total TTC</span>
                         <span class="fw-bold fs-5 text-success">@TotalTTC.ToString("N2") €</span>
                     </div>
                     
                      <div class="mt-4">
                         <label class="form-label small fw-bold text-muted">Paiement</label>
                         <select class="form-select form-select-sm mb-2" @bind="Model.PaymentTerms">
                             <option value="">Choisir...</option>
                             <option value="Comptant">Comptant</option>
                             <option value="30 jours net">30 jours net</option>
                             <option value="A réception">À réception</option>
                             <option value="50% acompte, solde à la livraison">50% acompte, solde à la livraison</option>
                         </select>
                     </div>
                 </div>
             </div>
        </div>
    }
</div>

<ProductDialog @ref="_productDialog" OnProductCreated="HandleNewProductCreated" />

@code {
    private ProductDialog _productDialog;
    private QuoteLineDto _activeLineForCreation;

    private void OpenNewProductDialog(QuoteLineDto line)
    {
        _activeLineForCreation = line;
        _productDialog.Open(line.Description); // Pre-fill with what user typed
    }

    private void HandleNewProductCreated(ProductDto product)
    {
        if (_activeLineForCreation != null)
        {
            _activeLineForCreation.Description = product.Name;
            HandleProductSelected(_activeLineForCreation, product);
            _activeLineForCreation = null;
        }
    }
    [Parameter] public Guid? Id { get; set; }
    
    private UpsertQuoteDto Model = new() 
    { 
        DateValidity = DateTime.Today.AddDays(30),
        FooterNote = "SOUS RESERVE DU VOLUME FINAL RECEPTIONNE A QUAI -\nSOUS RESERVE DU PRIX FINAL LORS DES ACHATS EN MAGASIN -\nSOUS RESERVE DE PLACE SUR LE NAVIRE ET DES CONTENEURS DISPONIBLES -\nNOS DEVIS SONT SOUMIS A L'EVOLUTION MENSUEL DU PRIX DU GASOIL",
        DiscountType = DiscountType.Percent,
        DiscountBase = DiscountBase.BaseHT,
        DiscountScope = DiscountScope.Total
    };
    
    private Client? SelectedClient;
    
    private string ExistingRef = "";
    private bool IsLoading = true;
    private bool IsSaving = false;
    private bool IsPreviewMode = false;
    private bool IsLoadingPdf = false; // New state
    private QuoteStatus CurrentStatus = QuoteStatus.Draft;
    private string OriginalModelJson = ""; // Snapshot for Revert

    // --- Computed Properties for UI ---
    
    private decimal RawTotalHT => Model.Lines.Sum(l => l.Quantity * l.UnitPrice);
    
    private decimal DiscountAmount 
    {
        get 
        {
            decimal baseAmount = (Model.DiscountBase == DiscountBase.BaseHT) ? RawTotalHT : (RawTotalHT * 1.2m);
            decimal amount = 0;
            
            if (Model.DiscountType == DiscountType.Percent)
                amount = baseAmount * (Model.DiscountValue / 100m);
            else
                amount = Model.DiscountValue;
                
            return amount > baseAmount ? baseAmount : amount;
        }
    }
    
    private decimal NetHT => RawTotalHT - (Model.DiscountBase == DiscountBase.BaseHT ? DiscountAmount : 0);
    
    private decimal TotalTVA 
    {
        get 
        {
            var rawTva = Model.Lines.Sum(l => (l.Quantity * l.UnitPrice) * (l.VATRate / 100m));
            if (RawTotalHT == 0) return 0;
            var ratio = (Model.DiscountBase == DiscountBase.BaseHT) ? (DiscountAmount / RawTotalHT) : 0; 
            return rawTva * (1 - ratio);
        }
    }
    
    private decimal TotalTTC => NetHT + TotalTVA;

    private bool IsAutoDraft = false; // Track if we auto-created this

    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;
        try 
        {
            if (Id.HasValue)
            {
                var quote = await ApiService.GetQuoteByIdAsync(Id.Value);
                if (quote != null)
                {
                    ExistingRef = quote.Reference;
                    Model = new UpsertQuoteDto
                    {
                        Id = quote.Id,
                        ClientId = quote.ClientId,
                        DateValidity = quote.DateValidity,
                        Message = quote.Message,
                        PaymentTerms = quote.PaymentTerms,
                        FooterNote = quote.FooterNote,
                        DiscountValue = quote.DiscountValue,
                        DiscountType = quote.DiscountType,
                        DiscountBase = quote.DiscountBase,
                        DiscountScope = quote.DiscountScope,
                        Lines = quote.Lines.OrderBy(l => l.Position).ToList()
                    };
                    
                    if (quote.ClientId.HasValue && quote.ClientId != Guid.Empty)
                        SelectedClient = await ApiService.GetClientByIdAsync(quote.ClientId.Value);
                    
                    CurrentStatus = quote.Status;

                    // Date Fix: Ensure dates are Local/Unspecified to avoid J-1 on display
                    if (quote.DateValidity.Kind == DateTimeKind.Utc) Model.DateValidity = quote.DateValidity.ToLocalTime();
                    foreach(var line in Model.Lines) 
                    {
                        if (line.Date.HasValue && line.Date.Value.Kind == DateTimeKind.Utc)
                        {
                            line.Date = line.Date.Value.ToLocalTime();
                        }
                    }

                    // SNAPSHOT
                    OriginalModelJson = JsonSerializer.Serialize(Model);
                    
                    // Force subtotal recalculation for UI
                    UpdateSubtotals();
                }
            }
            else
            {
                // NEW QUOTE: Auto-save as Draft immediately to get an ID
                Model = new UpsertQuoteDto
                {
                    DateValidity = DateTime.UtcNow.AddDays(30),
                    DateCreated = DateTime.UtcNow
                };
                AddLine();
                // Model.ClientId is null by default
                
                try 
                {
                     // Create minimal draft in DB
                     var result = await ApiService.CreateOrUpdateQuoteAsync(Model);
                     Model.Id = result.Id;
                     Id = result.Id;
                     IsAutoDraft = true;
                     CurrentStatus = result.Status;
                     
                     // Fix Date for AutoDraft
                     if (Model.DateCreated.HasValue) Model.DateCreated = Model.DateCreated.Value.ToLocalTime();

                     // SNAPSHOT (After auto-draft creation)
                     OriginalModelJson = JsonSerializer.Serialize(Model);
                }
                catch (Exception ex)
                {
                    Console.WriteLine("Auto-draft creation warning: " + ex.Message);
                }
            }
        }
        finally
        {
            IsLoading = false;
        }
    }

    // ... (AddLine/RemoveLine/etc unchanged)



    private void AddLine(QuoteLineType type = QuoteLineType.Product)
    {
        int nextPos = Model.Lines.Any() ? Model.Lines.Max(l => l.Position) + 1 : 0;
        var newLine = new QuoteLineDto 
        { 
            Type = type,
            Position = nextPos,
            Date = (type == QuoteLineType.Product) ? DateTime.Today : null,
            Quantity = (type == QuoteLineType.Product) ? 1 : 0,
            Unit = (type == QuoteLineType.Product) ? "pce" : "",
            VATRate = (type == QuoteLineType.Product) ? 20 : 0,
            Description = ""
        };
        
        if (type == QuoteLineType.Subtotal) newLine.Description = "Sous-total";

        Model.Lines.Add(newLine);
        UpdateSubtotals();
    }

    private void RemoveLine(QuoteLineDto line)
    {
        Model.Lines.Remove(line);
        UpdateSubtotals();
        if (!Model.Lines.Any()) AddLine();
    }
    
    private void MoveLine(QuoteLineDto line, int direction) // -1 up, +1 down
    {
        var currentIndex = Model.Lines.IndexOf(line);
        var newIndex = currentIndex + direction;
        
        if (newIndex < 0 || newIndex >= Model.Lines.Count) return;
        
        var otherLine = Model.Lines[newIndex];
        
        // Swap positions
        (line.Position, otherLine.Position) = (otherLine.Position, line.Position); 
        
        // Swap in list
        Model.Lines[currentIndex] = otherLine;
        Model.Lines[newIndex] = line;
        
        UpdateSubtotals();
    }
    
    private void UpdateSubtotals()
    {
        // ALWAYS sync Position with list order first!
        RenumberLines();
        
        // Re-calculate all Subtotal lines - iterate in list order (now synced with Position)
        decimal runningTotal = 0;
        foreach(var line in Model.Lines)
        {
            if (line.Type == QuoteLineType.Product)
            {
                runningTotal += line.Quantity * line.UnitPrice;
            }
            else if (line.Type == QuoteLineType.Subtotal)
            {
                line.TotalHT = runningTotal;
                runningTotal = 0; // Reset after subtotal
            }
        }
    }
    
    private void HandleClientSelected(Client client)
    {
        SelectedClient = client;
        Model.ClientId = client?.Id ?? Guid.Empty;
    }



    private void HandleProductSelected(QuoteLineDto line, ProductDto product)
    {
        line.Description = product.Name; // Redundant but safe
        line.Unit = product.Unit;
        line.UnitPrice = product.UnitPrice;
        line.VATRate = product.VATRate;
        // Optionally update description with more details if needed
    }

    private async Task TogglePreview()
    {
        if (Model.ClientId == Guid.Empty)
        {
             await JS.InvokeVoidAsync("alert", "Veuillez d'abord sélectionner un client.");
             return;
        }

        if (!IsPreviewMode)
        {
            // Enter Preview -> Save to ensure PDF generation works
            if (!await Save()) return;
        }

        IsPreviewMode = !IsPreviewMode;
    }
    
    private string GetDiscountLabel()
    {
        return Model.DiscountType == DiscountType.Percent ? $"{Model.DiscountValue}%" : "Forfait";
    }

    private int _draggedIndex = -1;

    private void HandleDragStart(int index)
    {
        _draggedIndex = index;
    }

    private void HandleDrop(int dropIndex)
    {
        if (_draggedIndex < 0 || _draggedIndex >= Model.Lines.Count || dropIndex < 0 || dropIndex >= Model.Lines.Count || _draggedIndex == dropIndex)
        {
            _draggedIndex = -1;
            return;
        }

        var item = Model.Lines[_draggedIndex];
        Model.Lines.RemoveAt(_draggedIndex);
        Model.Lines.Insert(dropIndex, item);
        
        RenumberLines();
        UpdateSubtotals();
        _draggedIndex = -1;
    }

    private void RenumberLines()
    {
        for(int i=0; i < Model.Lines.Count; i++)
        {
            Model.Lines[i].Position = i;
        }
    }

    private async Task SaveDraft()
    {
        if (await Save())
        {
             // Model.Id is guaranteed by Save()
             await ApiService.UpdateQuoteStatusAsync(Model.Id!.Value, QuoteStatus.Draft);
             NavManager.NavigateTo("/admin/commerce/quotes");
        }
    }
    
    private async Task Finalize(QuoteStatus status)
    {
        // Enforce Client for Finalization
        if (Model.ClientId == null || Model.ClientId == Guid.Empty)
        {
             await JS.InvokeVoidAsync("alert", "Veuillez sélectionner un client pour finaliser.");
             return;
        }

        if (await Save())
        {
            try 
            {
                await ApiService.UpdateQuoteStatusAsync(Model.Id!.Value, status);
                NavManager.NavigateTo("/admin/commerce/quotes");
            }
             catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"Erreur lors de la mise à jour du statut: {ex.Message}");
            }
        }
    }

    private async Task<bool> Save()
    {
        // Allowed to save without Client (Draft mode)
        
        if (!Model.Lines.Any())
        {
             await JS.InvokeVoidAsync("alert", "Veuillez ajouter au moins une ligne.");
             return false;
        }

        IsSaving = true;
        try
        {
            // Ensure positions are consistent 0,1,2...
            RenumberLines();
            
            var result = await ApiService.CreateOrUpdateQuoteAsync(Model);
            Model.Id = result.Id;
            if(!Id.HasValue) { Id = result.Id; } // Update local ID binding
            CurrentStatus = result.Status;
            return true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Save Error: {ex}");
            await JS.InvokeVoidAsync("alert", $"Erreur lors de l'enregistrement: {ex.Message}");
            return false;
        }
        finally
        {
             IsSaving = false;
        }
    }
    
     private async Task SendEmail()
    {
         if (await Save())
         {
             try
             {
                 await ApiService.SendQuoteByEmailAsync(Model.Id!.Value);
                 await ApiService.UpdateQuoteStatusAsync(Model.Id!.Value, QuoteStatus.Sent);
                 
                 await JS.InvokeVoidAsync("alert", "Email envoyé avec succès !");
                 NavManager.NavigateTo("/admin/commerce/quotes");
             }
             catch(Exception ex)
             {
                 await JS.InvokeVoidAsync("alert", $"Erreur lors de l'envoi: {ex.Message}");
             }
         }
    }

    private async Task DownloadPdf()
    {
         if (!Id.HasValue || Model.Id == null) 
         {
             // Try to save first
             if(!await Save()) return;
         }
         
         if (Model.Id == null) return;
         
         IsLoadingPdf = true;
         StateHasChanged();
         try
         {
             var pdfBytes = await ApiService.GetQuotePdfAsync(Model.Id!.Value);
             using var streamRef = new DotNetStreamReference(new System.IO.MemoryStream(pdfBytes));
             await JS.InvokeVoidAsync("downloadFileFromStream", $"Devis_{Model.Reference ?? "Brouillon"}.pdf", streamRef);
         }
         catch (Exception ex)
         {
             await JS.InvokeVoidAsync("alert", "Erreur lors du téléchargement du PDF: " + ex.Message);
         }
         finally
         {
             IsLoadingPdf = false;
             StateHasChanged();
         }
    }

    private async Task PrintPdf()
    {
         if (!Id.HasValue || Model.Id == null) 
         {
             if(!await Save()) return;
         }
         
         if (Model.Id == null) return;
         
         IsLoadingPdf = true; // Use same spinner state for now
         StateHasChanged();
         try
         {
             var pdfBytes = await ApiService.GetQuotePdfAsync(Model.Id!.Value);
             using var streamRef = new DotNetStreamReference(new System.IO.MemoryStream(pdfBytes));
             await JS.InvokeVoidAsync("openPdfInNewTab", streamRef);
         }
         catch (Exception ex)
         {
             await JS.InvokeVoidAsync("alert", "Erreur lors de l'impression: " + ex.Message);
         }
         finally
         {
             IsLoadingPdf = false;
             StateHasChanged();
         }
    }

    private async Task Cancel()
    {
        // If it looks like a new draft (auto-draft or just created), delete it on cancel
        if (IsAutoDraft || (Id.HasValue && CurrentStatus == QuoteStatus.Draft && (Model.DateCreated ?? DateTime.MinValue) > DateTime.UtcNow.AddMinutes(-30))) // Heuristic: Created recently
        {
             try 
             {
                 if (Id.HasValue) await ApiService.DeleteQuoteAsync(Id.Value);
             }
             catch {} // Ignore errors on cleanup
        }
        else if (!string.IsNullOrEmpty(OriginalModelJson))
        {
            // REVERT Logic: If we modified an existing quote (or draft) and saved intermediate changes (e.g. for preview)
            // we should revert to the original state.
            try 
            {
                var original = JsonSerializer.Deserialize<UpsertQuoteDto>(OriginalModelJson);
                if (original != null)
                {
                    // Restore original state to DB
                    await ApiService.CreateOrUpdateQuoteAsync(original);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine("Error reverting quote: " + ex.Message);
            }
        }

        NavManager.NavigateTo("/admin/commerce/quotes");
    }
    
    private string GetStatusName(QuoteStatus status) => status switch
    {
        QuoteStatus.Draft => "Brouillon",
        QuoteStatus.Sent => "Envoyé",
        QuoteStatus.Viewed => "Vu",
        QuoteStatus.Accepted => "Accepté",
        QuoteStatus.Rejected => "Refusé",
        QuoteStatus.Converted => "Converti",
        QuoteStatus.Deleted => "Supprimé",
        _ => status.ToString()
    };
}

<style>
    /* Responsive Sidebar Width */
    .sidebar-totals { width: 100%; }
    @@media (min-width: 992px) {
        .sidebar-totals { width: 350px; }
        /* Floating Action Bar Offset for Desktop Sidebar (approx 250px) */
        .action-bar-floating {
            margin-left: 250px; /* Adjust based on actual sidebar width */
            width: calc(100% - 250px) !important;
        }
    }
</style>
