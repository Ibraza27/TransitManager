@page "/admin/commerce/products"
@using Microsoft.AspNetCore.Authorization
@using TransitManager.Core.DTOs.Commerce
@using TransitManager.Core.Enums
@using TransitManager.Web.Services
@using TransitManager.Web.Components.Shared
@inject IApiService ApiService
@inject NavigationManager NavManager
@inject IJSRuntime JS
@attribute [Authorize(Roles = "Administrateur")]

<div class="d-flex flex-column" style="height: calc(100vh - 3.5rem);">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0 fw-bold">Produits et services</h3>
        <div class="d-flex gap-2">
            <div class="input-group input-group-sm" style="max-width: 300px;">
                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control border-start-0 ps-0" placeholder="Rechercher dans la liste" @bind="SearchTerm" @bind:event="oninput" @onkeyup="LoadProducts" />
            </div>
            <button class="btn btn-dark btn-sm rounded-pill px-3 fw-bold" @onclick="CreateNew">Nouveau produit</button>
        </div>
    </div>

    <!-- Actions Bar (Bulk) -->
    @if (SelectedIds.Any())
    {
        <div class="bg-light p-2 mb-3 rounded d-flex gap-3 align-items-center border">
            <div class="fw-bold text-primary">@SelectedIds.Count sélectionné(s)</div>
            <button class="btn btn-link text-decoration-none text-dark fw-bold p-0" @onclick="BulkDelete">Supprimer sélection</button>
            <button class="btn btn-link text-decoration-none text-dark fw-bold p-0" @onclick="ClearSelection">Annuler</button>
        </div>
    }
    else 
    {
         <div class="d-flex justify-content-end mb-2">
             <button class="btn btn-link text-muted text-decoration-none p-0 me-3" @onclick="TriggerImport">Importer produits</button>
             <button class="btn btn-link text-muted text-decoration-none p-0" @onclick="TriggerExport">Exporter produits</button>
             <InputFile id="importInput" OnChange="UploadFiles" hidden />
         </div>
    }

    <!-- Main Content: Split View -->
    <div class="row g-0 flex-grow-1 overflow-hidden h-100 position-relative">
        <!-- Grid -->
        <div class="col-12 col-md-8 h-100 overflow-auto border-end pe-0">
             <table class="table table-hover align-middle mb-0">
                 <thead class="table-light sticky-top">
                     <tr>
                         <th style="width: 40px;" class="ps-3">
                             <input type="checkbox" class="form-check-input" @onchange="ToggleAll" checked="@AllSelected" />
                         </th>
                         <th>PRODUIT</th>
                         <th class="text-end d-none d-md-table-cell">PRIX HT</th>
                         <th class="text-end d-none d-md-table-cell">TVA</th>
                         <th class="text-end pe-3">PRIX TTC</th>
                         <th style="width: 40px;"></th>
                     </tr>
                 </thead>
                 <tbody>
                     @if (IsLoading)
                     {
                         <tr><td colspan="6" class="text-center p-5"><div class="spinner-border text-primary"></div></td></tr>
                     }
                     else if (!ProductList.Any())
                     {
                         <tr><td colspan="6" class="text-center p-5 text-muted">Aucun produit trouvé.</td></tr>
                     }
                     else
                     {
                         @foreach (var p in ProductList)
                         {
                             <tr class="@(EditedProduct?.Id == p.Id ? "table-active" : "") cursor-pointer" @onclick="() => Edit(p)">
                                 <td class="ps-3" @onclick:stopPropagation>
                                     <input type="checkbox" class="form-check-input" checked="@SelectedIds.Contains(p.Id)" @onchange="(e) => ToggleSelection(p.Id, e)" />
                                 </td>
                                 <td class="fw-bold">
                                     @p.Name
                                     <div class="small text-muted d-md-none">@p.UnitPrice.ToString("N2") € HT</div>
                                 </td>
                                 <td class="text-end d-none d-md-table-cell">@p.UnitPrice.ToString("N2") €</td>
                                 <td class="text-end d-none d-md-table-cell">@p.VATRate %</td>
                                 <td class="text-end pe-3 fw-bold">@GetTtc(p).ToString("N2") €</td>
                                 <td class="text-center text-muted"><i class="bi bi-chevron-right" style="font-size: 0.8rem;"></i></td>
                             </tr>
                         }
                     }
                 </tbody>
             </table>
        </div>

        <!-- Sidebar Editor (Desktop) -->
        <div class="d-none d-md-flex col-md-4 bg-white border-start shadow-sm h-100 flex-column" style="display: @(EditedProduct != null ? "flex" : "none") !important;">
            @if (EditedProduct != null)
            {
                <ProductEditor 
                    Product="EditedProduct" 
                    OnSave="Save" 
                    OnClose="CloseEditor" 
                    OnDelete="Delete"
                />
            }
        </div>
        
        <!-- Mobile Modal Editor -->
        @if (EditedProduct != null)
        {
            <div class="d-md-none modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                    <div class="modal-content h-100">
                        <ProductEditor 
                            Product="EditedProduct" 
                            OnSave="Save" 
                            OnClose="CloseEditor" 
                            OnDelete="Delete"
                        />
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .cursor-pointer { cursor: pointer; }
    .table-active { background-color: #f0f8ff !important; border-left: 4px solid #0d6efd; }
</style>

@code {
    private List<ProductDto> ProductList = new();
    private HashSet<Guid> SelectedIds = new();
    private string SearchTerm = "";
    private bool IsLoading = true;
    private ProductDto? EditedProduct;

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        IsLoading = true;
        try 
        {
            var result = await ApiService.GetProductsAsync(SearchTerm, 1, 100); 
            ProductList = result.Items.ToList();
        }
        finally { IsLoading = false; }
    }

    private void CreateNew()
    {
        EditedProduct = new ProductDto 
        { 
            Name = "", 
            Unit = "pce", 
            UnitPrice = 0, 
            VATRate = 20, 
            Type = ProductType.Goods 
        };
    }

    private void Edit(ProductDto p)
    {
        // Clone to avoid live editing
        EditedProduct = new ProductDto 
        { 
            Id = p.Id, 
            Name = p.Name, 
            Description = p.Description,
            Unit = p.Unit, 
            UnitPrice = p.UnitPrice, 
            VATRate = p.VATRate,
            Type = p.Type
        };
    }

    private void CloseEditor()
    {
        EditedProduct = null;
    }

    private async Task Save(ProductDto p)
    {
        try
        {
            if (p.Id == Guid.Empty)
            {
                var created = await ApiService.CreateProductAsync(p);
                ProductList.Add(created);
            }
            else
            {
                var updated = await ApiService.UpdateProductAsync(p);
                var index = ProductList.FindIndex(x => x.Id == updated.Id);
                if (index >= 0) ProductList[index] = updated;
            }
            CloseEditor();
            await JS.InvokeVoidAsync("alert", "Enregistré !");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", "Erreur: " + ex.Message);
        }
    }

    private async Task Delete(ProductDto p)
    {
        if (await JS.InvokeAsync<bool>("confirm", "Supprimer ce produit ?"))
        {
            await ApiService.DeleteProductAsync(p.Id);
            ProductList.RemoveAll(x => x.Id == p.Id);
            CloseEditor();
        }
    }

    private async Task BulkDelete()
    {
         if (await JS.InvokeAsync<bool>("confirm", $"Supprimer {SelectedIds.Count} produits ?"))
         {
             await ApiService.DeleteProductsManyAsync(SelectedIds.ToList());
             await LoadProducts();
             SelectedIds.Clear();
         }
    }

    private void ToggleSelection(Guid id, ChangeEventArgs e)
    {
        if ((bool?)e.Value == true) SelectedIds.Add(id);
        else SelectedIds.Remove(id);
    }

    private void ToggleAll(ChangeEventArgs e)
    {
        if ((bool?)e.Value == true) SelectedIds = ProductList.Select(p => p.Id).ToHashSet();
        else SelectedIds.Clear();
    }
    private bool AllSelected => ProductList.Any() && SelectedIds.Count == ProductList.Count;
    private void ClearSelection() => SelectedIds.Clear();
    
    private decimal GetTtc(ProductDto p) => p.UnitPrice * (1 + p.VATRate / 100m);
    
    // --- Import/Export ---
    private async Task TriggerImport()
    {
        await JS.InvokeVoidAsync("eval", "document.getElementById('importInput').click()");
    }
    
    private async Task UploadFiles(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            try 
            {
                var count = await ApiService.ImportProductsCsvAsync(file);
                await LoadProducts();
                await JS.InvokeVoidAsync("alert", $"{count} produits importés !");
            }
            catch(Exception ex)
            {
                await JS.InvokeVoidAsync("alert", "Erreur import: " + ex.Message);
            }
        }
    }

    private async Task TriggerExport()
    {
         try 
        {
            var bytes = await ApiService.ExportProductsCsvAsync();
            using var streamRef = new DotNetStreamReference(new MemoryStream(bytes));
            await JS.InvokeVoidAsync("downloadFileFromStream", "Produits.csv", streamRef);
        }
        catch(Exception ex)
        {
            await JS.InvokeVoidAsync("alert", "Erreur export: " + ex.Message);
        }
    }
}
