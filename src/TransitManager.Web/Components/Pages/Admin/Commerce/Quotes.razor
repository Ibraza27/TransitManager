@page "/admin/commerce/quotes"
@using Microsoft.AspNetCore.Authorization
@using TransitManager.Core.DTOs.Commerce
@using TransitManager.Core.Enums
@using TransitManager.Web.Services
@inject IApiService ApiService
@inject NavigationManager NavManager
@inject IJSRuntime JS
@attribute [Authorize(Roles = "Administrateur")]

    <div class="bg-light p-2 border-bottom d-flex align-items-center gap-3">
        <div class="btn-group">
            <button class="btn btn-link text-decoration-none fw-bold @(FilterStatus == null ? "text-success" : "text-muted")" @onclick="() => FilterBy(null)">Tout</button>
            <button class="btn btn-link text-decoration-none @(FilterStatus == QuoteStatus.Accepted.ToString() ? "text-success fw-bold" : "text-muted")" @onclick="() => FilterBy(QuoteStatus.Accepted.ToString())">Acceptés</button>
            <button class="btn btn-link text-decoration-none @(FilterStatus == QuoteStatus.Draft.ToString() ? "text-success fw-bold" : "text-muted")" @onclick="() => FilterBy(QuoteStatus.Draft.ToString())">Brouillons</button>
            <button class="btn btn-link text-decoration-none @(FilterStatus == QuoteStatus.Rejected.ToString() ? "text-danger fw-bold" : "text-muted")" @onclick="() => FilterBy(QuoteStatus.Rejected.ToString())">Refusés</button>
             <button class="btn btn-link text-decoration-none @(FilterStatus == QuoteStatus.Deleted.ToString() ? "text-secondary fw-bold" : "text-muted")" @onclick="() => FilterBy(QuoteStatus.Deleted.ToString())">Corbeille</button>
        </div>
        <div class="input-group" style="max-width: 300px;">
            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control border-start-0 ps-0" placeholder="Rechercher..." @bind="SearchTerm" @bind:after="() => LoadList(false)" />
        </div>
        <div class="ms-auto">
            <button class="btn btn-success fw-bold shadow-sm" @onclick="CreateNew"><i class="bi bi-plus-lg me-2"></i>Nouveau Devis</button>
        </div>
    </div>

    <!-- Split View Content -->
    <div class="d-flex flex-grow-1 overflow-hidden">
        
        <!-- Left List -->
        <div class="border-end bg-white overflow-auto" style="width: 400px; min-width: 350px;">
            @if (IsLoadingList)
            {
                <div class="text-center p-4"><div class="spinner-border text-primary"></div></div>
            }
            else
            {
        <div class="list-group list-group-flush">
                    @foreach (var quote in QuoteList)
                    {
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action @(SelectedQuote?.Id == quote.Id ? "active-quote" : "")" @onclick="() => SelectQuote(quote)">
                            <div class="d-flex w-100 justify-content-between mb-1">
                                <h6 class="mb-0 fw-bold">@quote.ClientName @quote.ClientFirstname</h6>
                                <span class="badge @GetStatusClass(quote.Status)">@quote.StatusName</span>
                            </div>
                            <div class="small text-muted mb-1">
                                <div><i class="bi bi-telephone me-1"></i> @quote.ClientPhone</div>
                                <div class="text-truncate"><i class="bi bi-geo-alt me-1"></i> @quote.ClientAddress</div>
                            </div>
                            <div class="d-flex w-100 justify-content-between align-items-center mt-2 border-top pt-2">
                                <small class="text-muted">@quote.Reference • @quote.DateCreated.ToString("dd.MM")</small>
                                <span class="fw-bold text-primary">@quote.TotalTTC.ToString("C2")</span>
                            </div>
                        </a>
                    }
                    
                    <!-- Pagination Load More -->
                    @if (CurrentPage < TotalPages)
                    {
                         <button class="btn btn-light w-100 mt-2" @onclick="LoadMore">Charger plus...</button>
                    }
                </div>
            }
        </div>

        <!-- Right Preview/Edit Area -->
        <div class="flex-grow-1 bg-light overflow-auto p-4 d-flex justify-content-center">
            @if (SelectedQuote != null)
            {
                <div class="bg-white shadow-sm rounded w-100" style="max-width: 900px; min-height: 800px;">
                    <!-- Action Bar -->
                    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                         <div>
                             <span class="badge @GetStatusClass(SelectedQuote.Status) me-2">@SelectedQuote.StatusName</span>
                             <span class="text-muted small">Créé le @SelectedQuote.DateCreated.ToString("dd.MM.yyyy")</span>
                         </div>
                         <div class="d-flex gap-2">
                             @if (SelectedQuote.Status == QuoteStatus.Draft)
                             {
                                 <button class="btn btn-primary btn-sm" @onclick="EditQuote"><i class="bi bi-pencil me-1"></i> Modifier</button>
                                 <button class="btn btn-outline-primary btn-sm" @onclick="SendEmail"><i class="bi bi-envelope me-1"></i> Envoyer</button>
                             }
                             
                             @if (SelectedQuote.Status != QuoteStatus.Draft)
                             {
                                 <a href="@SelectedQuote.PublicUrl" target="_blank" class="btn btn-outline-secondary btn-sm"><i class="bi bi-eye me-1"></i> Voir Public</a>
                             }
                             else
                             {
                                  <button class="btn btn-outline-secondary btn-sm" @onclick="EditQuote"><i class="bi bi-eye me-1"></i> Visualiser</button>
                             }
                             <button class="btn btn-outline-dark btn-sm" @onclick="DownloadPdf"><i class="bi bi-file-earmark-pdf me-1"></i> PDF</button>
                             <div class="dropdown">
                                 <button class="btn btn-link text-dark p-0 ms-2" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                 <ul class="dropdown-menu dropdown-menu-end">
                                     <li><button class="dropdown-item" @onclick="CreateCopy">Créer une copie</button></li>
                                     <li><hr class="dropdown-divider"></li>
                                     @if(SelectedQuote.Status == QuoteStatus.Draft)
                                     {
                                        <li><button class="dropdown-item text-danger" @onclick="DeleteQuote">Supprimer</button></li>
                                     }
                                     else 
                                     {
                                         <li><button class="dropdown-item" @onclick="() => MarkStatus(QuoteStatus.Accepted)">Marquer Accepté</button></li>
                                         <li><button class="dropdown-item" @onclick="() => MarkStatus(QuoteStatus.Rejected)">Marquer Refusé</button></li>
                                     }
                                 </ul>
                             </div>
                         </div>
                    </div>

                    <!-- Quote Content Preview -->
                    <div class="p-5">
                        <div class="row mb-5">
                            <div class="col-6">
                                <h4 class="fw-bold text-uppercase mb-4">Devis</h4>
                                <div class="fw-bold fs-5">@SelectedQuote.ClientName</div>
                                <div class="text-muted">@SelectedQuote.ClientEmail</div>
                            </div>
                            <div class="col-6 text-end">
                                <div class="fw-bold fs-4">@SelectedQuote.Reference</div>
                                <div class="text-muted mt-2">Date: @SelectedQuote.DateCreated.ToString("dd.MM.yyyy")</div>
                                <div class="text-muted">Valide jusqu'au: @SelectedQuote.DateValidity.ToString("dd.MM.yyyy")</div>
                            </div>
                        </div>

                        <table class="table table-borderless mb-4">
                            <thead class="border-bottom">
                                <tr class="text-uppercase small text-muted">
                                    <th style="width: 40%">Description</th>
                                    <th class="text-end">Qté</th>
                                    <th class="text-end">Prix Unitaire</th>
                                    <th class="text-end">TVA</th>
                                    <th class="text-end">Montant HT</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var line in SelectedQuote.Lines)
                                {
                                    <tr>
                                        <td>
                                            <div class="fw-bold">@line.Description</div>
                                        </td>
                                        <td class="text-end">@line.Quantity.ToString("G29") @line.Unit</td>
                                        <td class="text-end">@line.UnitPrice.ToString("N2") €</td>
                                        <td class="text-end">@line.VATRate.ToString("G29") %</td>
                                        <td class="text-end">@line.TotalHT.ToString("N2") €</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="border-top">
                                <tr>
                                    <td colspan="4" class="text-end pt-3">Total HT</td>
                                    <td class="text-end pt-3">@SelectedQuote.TotalHT.ToString("N2") €</td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-end border-0">TVA</td>
                                    <td class="text-end border-0">@SelectedQuote.TotalTVA.ToString("N2") €</td>
                                </tr>
                                <tr class="fs-5 fw-bold">
                                    <td colspan="4" class="text-end border-0 pt-3">Total TTC</td>
                                    <td class="text-end border-0 pt-3">@SelectedQuote.TotalTTC.ToString("N2") €</td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        @if (!string.IsNullOrEmpty(SelectedQuote.Message))
                        {
                            <div class="mb-4">
                                <h6 class="fw-bold text-muted text-uppercase small">Message</h6>
                                <p class="text-pre-wrap">@SelectedQuote.Message</p>
                            </div>
                        }
                        
                         @if (!string.IsNullOrEmpty(SelectedQuote.PaymentTerms))
                        {
                            <div class="mb-4">
                                <h6 class="fw-bold text-muted text-uppercase small">Modalités de Paiement</h6>
                                <p>@SelectedQuote.PaymentTerms</p>
                            </div>
                        }

                        <!-- History -->
                        <div class="mt-5 pt-4 border-top">
                            <h6 class="text-muted small text-uppercase mb-3">Historique</h6>
                            <ul class="timeline small">
                                <li class="text-success">Créé le @SelectedQuote.DateCreated.ToString("g")</li>
                                @if(SelectedQuote.Status == QuoteStatus.Sent) { <li class="text-primary">Envoyé le @SelectedQuote.DateCreated.ToString("g") (Simulé)</li> } <!-- Using Created date as fallback if Sent is null -->
                            </ul>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                    <i class="bi bi-file-earmark-text display-1 mb-3"></i>
                    <h5>Sélectionnez un devis pour voir les détails</h5>
                </div>
            }
        </div>
    </div>

<style>
    .active-quote {
        background-color: #f0f7ff !important;
        border-left: 4px solid #0d6efd !important;
    }
    .text-pre-wrap { white-space: pre-wrap; }
    .timeline { list-style: none; padding-left: 0; }
    .timeline li { position: relative; padding-left: 20px; margin-bottom: 10px; }
    .timeline li:before { content: '•'; position: absolute; left: 0; font-weight: bold; }
</style>

@code {
    private List<QuoteDto> QuoteList = new();
    private QuoteDto? SelectedQuote;
    private bool IsLoadingList = true;
    
    private string SearchTerm = "";
    private string? FilterStatus = null;
    private int CurrentPage = 1;
    private int TotalPages = 1;
    private int TotalCount = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadList();
    }

    private async Task LoadList(bool append = false)
    {
        if (!append) IsLoadingList = true;
        try
        {
            var result = await ApiService.GetQuotesAsync(SearchTerm, null, FilterStatus, CurrentPage);
            if (append) QuoteList.AddRange(result.Items);
            else QuoteList = result.Items.ToList();
            
            TotalCount = result.TotalCount;
            TotalPages = result.TotalPages;

            // Auto-select first if none selected
            if (!append && SelectedQuote == null && QuoteList.Any())
            {
                SelectedQuote = QuoteList.First();
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "LoadList Error:", ex.Message);
            await JS.InvokeVoidAsync("alert", $"Erreur chargement devis: {ex.Message}");
        }
        finally
        {
            IsLoadingList = false;
        }
    }

    private async Task FilterBy(string? status)
    {
        FilterStatus = status;
        CurrentPage = 1;
        SelectedQuote = null;
        await LoadList();
    }
    
    private async Task LoadMore()
    {
        CurrentPage++;
        await LoadList(true);
    }

    private void SelectQuote(QuoteDto quote)
    {
        SelectedQuote = quote;
        // In real app, fetch full details here if needed
    }
    
    private void CreateNew()
    {
        NavManager.NavigateTo("/admin/commerce/quotes/new");
    }

    private void EditQuote()
    {
        if (SelectedQuote != null)
            NavManager.NavigateTo($"/admin/commerce/quotes/edit/{SelectedQuote.Id}");
    }

    private async Task SendEmail()
    {
        // For now, toggle status and show the link
        if (SelectedQuote != null)
        {
            await ApiService.UpdateQuoteStatusAsync(SelectedQuote.Id, QuoteStatus.Sent);
            SelectedQuote.Status = QuoteStatus.Sent;
            // Refresh list item
            var index = QuoteList.FindIndex(q => q.Id == SelectedQuote.Id);
            if (index >= 0) QuoteList[index] = SelectedQuote;
        }
    }

    private async Task DownloadPdf()
    {
        if (SelectedQuote == null) return;
        try
        {
             var pdfBytes = await ApiService.GetQuotePdfAsync(SelectedQuote.Id);
             using var streamRef = new DotNetStreamReference(new System.IO.MemoryStream(pdfBytes));
             await JS.InvokeVoidAsync("downloadFileFromStream", $"Devis_{SelectedQuote.Reference}.pdf", streamRef);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Erreur lors du téléchargement: {ex.Message}");
        }
    }

    private async Task CreateCopy()
    {
        // TODO implementation
    }
    
    private async Task DeleteQuote()
    {
        if (SelectedQuote != null && await JS.InvokeAsync<bool>("confirm", "Supprimer ce devis ?"))
        {
            await ApiService.DeleteQuoteAsync(SelectedQuote.Id);
            QuoteList.Remove(SelectedQuote);
            SelectedQuote = null;
            if (QuoteList.Any()) SelectedQuote = QuoteList.First();
        }
    }
    
    private async Task MarkStatus(QuoteStatus status)
    {
        if (SelectedQuote != null)
        {
             await ApiService.UpdateQuoteStatusAsync(SelectedQuote.Id, status);
             SelectedQuote.Status = status;
        }
    }

    private string GetStatusClass(QuoteStatus status) => status switch
    {
        QuoteStatus.Draft => "bg-secondary-subtle text-secondary",
        QuoteStatus.Sent => "bg-primary-subtle text-primary",
        QuoteStatus.Accepted => "bg-success-subtle text-success",
        QuoteStatus.Rejected => "bg-danger-subtle text-danger",
        _ => "bg-light text-dark"
    };
}
