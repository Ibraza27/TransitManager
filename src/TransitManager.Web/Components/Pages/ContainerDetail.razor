@page "/conteneur/detail/{Id:guid}"
@page "/conteneur/create"
@using TransitManager.Core.Entities
@using TransitManager.Core.Enums
@using TransitManager.Core.DTOs
@using TransitManager.Web.Components.Shared
@using System.IO
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@attribute [Authorize(Roles = "Administrateur")]

<PageTitle>@(IsNew ? "Nouveau Dossier" : "Dossier Conteneur")</PageTitle>

<div class="container-fluid mt-4 mb-5">
    
    <!-- EN-T√äTE -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
        <div>
            <h2 class="fw-bold text-primary">
                <i class="bi bi-box-fill me-2"></i>
                @(IsNew ? "Nouveau Dossier" : $"Dossier {_dto.NumeroDossier}")
            </h2>
        </div>
        <div class="d-flex flex-wrap gap-2 position-relative w-100 w-md-auto">
            <!-- MENU D'EXPORTATION -->
            <div class="dropdown">
                <button class="btn btn-outline-danger dropdown-toggle" type="button" @onclick="ToggleExportMenu">
                    <i class="bi bi-file-earmark-pdf me-2"></i>Exporter PDF
                </button>

                <ul class="dropdown-menu @(_isExportMenuOpen ? "show" : "")" 
                    style="right: auto; left: 0; margin-top: 5px;">
                    <li>
                        <button class="dropdown-item" @onclick="() => ExportPdf(false)">
                            üìÑ Manifeste Simple (Sans prix)
                        </button>
                    </li>
                    <li>
                        <button class="dropdown-item" @onclick="() => ExportPdf(true)">
                            üí∞ Rapport Complet (Avec prix)
                        </button>
                    </li>
                </ul>
                
                @if (_isExportMenuOpen)
                {
                    <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 900;" 
                         @onclick="ToggleExportMenu"></div>
                }
            </div>

            <button class="btn btn-outline-primary" @onclick="LoadData">
                <i class="bi bi-arrow-clockwise me-2"></i>Actualiser
            </button>
            
            <button class="btn btn-primary" @onclick="SaveContainer">
                <i class="bi bi-save me-2"></i> Enregistrer
            </button>
            <a href="/my-containers" class="btn btn-outline-secondary">
                Retour
            </a>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2 text-muted">Chargement du dossier...</p>
        </div>
    }
    else
    {
        <!-- NAVIGATION ONGLETS -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <button class="nav-link @(_activeTab == "infos" ? "active fw-bold" : "")" @onclick='() => _activeTab = "infos"'>
                    <i class="bi bi-info-circle me-2"></i>Informations G√©n√©rales
                </button>
            </li>
            
            <!-- ONGLET DISCUSSION (NOUVEAU) -->
            @if (!IsNew)
            {
                <li class="nav-item">
                    <button class="nav-link @(_activeTab == "discussion" ? "active fw-bold" : "")" @onclick='() => _activeTab = "discussion"'>
                        <i class="bi bi-chat-dots me-2"></i>
                        Discussion
                        @if(_unreadMessagesCount > 0 && _activeTab != "discussion")
                        {
                            <span class="badge bg-danger rounded-pill ms-2">@_unreadMessagesCount</span>
                        }
                    </button>
                </li>
            }

            @if (!IsNew)
            {
                <li class="nav-item">
                    <button class="nav-link @(_activeTab == "documents" ? "active fw-bold" : "")" @onclick='() => _activeTab = "documents"'>
                        <i class="bi bi-folder2-open me-2"></i>Documents
                         @if (_dto.MissingDocumentsCount > 0)
                        {
                            <span class="badge bg-danger rounded-pill ms-2">@_dto.MissingDocumentsCount</span>
                        }
                    </button>
                </li>
            }
        </ul>

        <div class="tab-content">
            
            <!-- ONGLET 1 : INFORMATIONS -->
            <div class="tab-pane fade @(_activeTab == "infos" ? "show active" : "")">

                <!-- STATISTIQUES GLOBALES -->
                @if (!IsNew)
                {
                    <div class="row mb-4 g-3">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white shadow-sm h-100">
                                <div class="card-body text-center">
                                    <h3 class="mb-0">@_dto.PrixTotalGlobal.ToString("C0")</h3>
                                    <small class="text-white-50 fw-bold">PRIX TOTAL GLOBAL</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white shadow-sm h-100">
                                <div class="card-body text-center">
                                    <h3 class="mb-0">@_dto.TotalPayeGlobal.ToString("C0")</h3>
                                    <small class="text-white-50 fw-bold">TOTAL PAY√â</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-white shadow-sm h-100">
                                <div class="card-body text-center">
                                    <h3 class="mb-0">@_dto.TotalRestantGlobal.ToString("C0")</h3>
                                    <small class="text-white-50 fw-bold">TOTAL RESTANT</small>
                                </div>
                            </div>
                        </div>
                         <div class="col-md-3">
                            <div class="card bg-secondary text-white shadow-sm h-100">
                                <div class="card-body text-center">
                                    <h3 class="mb-0">@(_dto.Colis.Count + _dto.Vehicules.Count)</h3>
                                    <small class="text-white-50 fw-bold">√âL√âMENTS</small>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <!-- FORMULAIRE INFORMATIONS G√âN√âRALES -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light fw-bold">Informations G√©n√©rales</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Num√©ro Dossier *</label>
                                <input type="text" class="form-control fw-bold" @bind="_conteneur.NumeroDossier" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Num√©ro Plomb</label>
                                <input type="text" class="form-control" @bind="_conteneur.NumeroPlomb" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Compagnie</label>
                                <select class="form-select @(string.IsNullOrEmpty(_conteneur.NomCompagnie) ? "text-muted" : "fw-bold")" 
                                        @bind="_conteneur.NomCompagnie">
                                    <option value="">-- S√©lectionner --</option>
                                    <option value="CMA CGM">CMA CGM</option>
                                    <option value="MSC">MSC</option>
                                </select>
                            </div>
                             <div class="col-md-3">
                                <label class="form-label">Transitaire</label>
                                <input type="text" class="form-control" @bind="_conteneur.NomTransitaire" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Destination *</label>
                                <input type="text" class="form-control" @bind="_conteneur.Destination" />
                            </div>
                             <div class="col-md-3">
                                <label class="form-label">Pays</label>
                                <input type="text" class="form-control" @bind="_conteneur.PaysDestination" />
                            </div>
                             <div class="col-md-3">
                                <label class="form-label">Statut</label>
                                <select class="form-select" @bind="_conteneur.Statut">
                                     @foreach(var s in Enum.GetValues<StatutConteneur>()) {<option value="@s">@s</option>}
                                </select>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Commentaires</label>
                                <textarea class="form-control" rows="2" @bind="_conteneur.Commentaires"></textarea>
                            </div>
                        </div>
                        
                        <hr class="my-4"/>
                        <h6 class="text-muted mb-3 text-uppercase small fw-bold">Dates Cl√©s</h6>
                        <div class="row g-3">
                             <div class="col-md-2">
                                <label class="form-label small">R√©ception</label>
                                <input type="date" class="form-control form-control-sm" @bind="_conteneur.DateReception" />
                            </div>
                             <div class="col-md-2">
                                <label class="form-label small">Chargement</label>
                                <input type="date" class="form-control form-control-sm" @bind="_conteneur.DateChargement" />
                            </div>
                             <div class="col-md-2">
                                <label class="form-label small">D√©part</label>
                                <input type="date" class="form-control form-control-sm" @bind="_conteneur.DateDepart" />
                            </div>
                             <div class="col-md-2">
                                <label class="form-label small">Arriv√©e</label>
                                <input type="date" class="form-control form-control-sm" @bind="_conteneur.DateArriveeDestination" />
                            </div>
                             <div class="col-md-2">
                                <label class="form-label small">Cl√¥ture</label>
                                <input type="date" class="form-control form-control-sm" @bind="_conteneur.DateCloture" />
                            </div>
                        </div>
                    </div>
                </div>

                @if (!IsNew)
                {
                    <div class="row g-4">
                        
                        <!-- R√âCAPITULATIF PAR CLIENT -->
                        <div class="col-lg-12">
                            <div class="card shadow-sm">
                                <div class="card-header bg-light fw-bold">R√©capitulatif par Client</div>
                                <div class="table-responsive" style="max-height: 300px;">
                                    <table class="table table-hover mb-0 table-sm">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th>Client</th>
                                                <th>T√©l√©phone</th>
                                                <th class="text-center">Colis</th>
                                                <th class="text-center">V√©hicules</th>
                                                <th class="text-end">Total</th>
                                                <th class="text-end">Pay√©</th>
                                                <th class="text-end">Restant</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var stat in _dto.StatsParClient)
                                            {
                                                <tr>
                                                    <td class="fw-bold">@stat.NomClient</td>
                                                    <td class="small text-muted">@stat.Telephone</td>
                                                    <td class="text-center">@stat.NombreColis</td>
                                                    <td class="text-center">@stat.NombreVehicules</td>
                                                    <td class="text-end">@stat.TotalPrix.ToString("C0")</td>
                                                    <td class="text-end text-success">@stat.TotalPaye.ToString("C0")</td>
                                                    <td class="text-end text-danger fw-bold">@stat.ResteAPayer.ToString("C0")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- GESTION COLIS -->
                        <div class="col-lg-12">
                            <div class="card shadow-sm border-primary">
                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="fw-bold"><i class="bi bi-box-seam me-2"></i>Colis Affect√©s (@_dto.Colis.Count)</span>
                                        @if (!string.IsNullOrEmpty(_conteneur.NomCompagnie) && !string.IsNullOrEmpty(_conteneur.NumeroDossier))
                                        {
                                            <a href="@GetTrackingUrl()" target="_blank" class="btn btn-sm btn-info text-white border-white shadow-sm ms-3" title="Suivre le conteneur">
                                                <i class="bi bi-radar me-1"></i>Suivi @_conteneur.NomCompagnie
                                            </a>
                                        }
                                    </div>
                                    <button class="btn btn-sm btn-light text-primary fw-bold shadow-sm" @onclick="() => _showAddParcel = true">
                                        ‚ûï Ajouter
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>R√©f</th>
                                                <th>Client</th>
                                                <th>D√©signation</th>
                                                <th>Destination</th>
                                                <th class="text-end">Prix</th>
                                                <th class="text-end">Pay√©</th>
                                                <th class="text-end">Restant</th>
                                                <th class="text-center">Statut</th>
                                                <th class="text-center" title="Cocher pour exclure de l'export PDF">Exclure</th>
                                                <th class="text-end pe-3">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var c in _dto.Colis)
                                            {
                                                <tr>
                                                    <td class="font-monospace text-primary">@c.NumeroReference</td>
                                                    <td>
                                                        <div class="fw-bold">@c.ClientNomComplet</div>
                                                    </td>
                                                    <td>@c.Designation</td>
                                                    <td>@c.DestinationFinale</td>
                                                    <td class="text-end fw-bold">@c.PrixTotal.ToString("C0")</td>
                                                    <td class="text-end text-success">@c.SommePayee.ToString("C0")</td>
                                                    <td class="text-end">
                                                         @if (c.RestantAPayer > 0)
                                                         {
                                                             <span class="text-danger fw-bold">@c.RestantAPayer.ToString("C0")</span>
                                                         }
                                                         else
                                                         {
                                                             <span class="text-success"><i class="bi bi-check-all"></i></span>
                                                         }
                                                    </td>
                                                    <td class="text-center"><span class="badge bg-secondary">@c.Statut</span></td>
                                                    <td class="text-center">
                                                         <input type="checkbox" class="form-check-input" checked="@c.IsExcludedFromExport" 
                                                                @onchange="@(async (args) => await ToggleExportExclusion(c, args.Value))" />
                                                    </td>
                                                    <td class="text-end pe-3">
                                                        <div class="d-flex justify-content-end gap-2">
                                                            <a href="colis/edit/@c.Id" target="_blank" class="btn btn-outline-primary btn-sm" title="Voir/Modifier">
                                                                ‚úèÔ∏è
                                                            </a>
                                                            <button class="btn btn-outline-danger btn-sm" @onclick="() => UnassignColis(c)" title="Retirer">
                                                                ‚ùå
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- GESTION V√âHICULES -->
                        <div class="col-lg-12">
                            <div class="card shadow-sm border-success">
                                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                    <span class="fw-bold"><i class="bi bi-car-front-fill me-2"></i>V√©hicules Affect√©s (@_dto.Vehicules.Count)</span>
                                     <button class="btn btn-sm btn-light text-success fw-bold shadow-sm" @onclick="() => _showAddVehicle = true">
                                        ‚ûï Ajouter
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Immatriculation</th>
                                                <th>Client</th>
                                                <th>Mod√®le</th>
                                                <th>Destination</th>
                                                <th class="text-end">Prix</th>
                                                <th class="text-end">Pay√©</th>
                                                <th class="text-end">Restant</th>
                                                <th class="text-center">Statut</th>
                                                <th class="text-end pe-3">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var v in _dto.Vehicules)
                                            {
                                                <tr>
                                                    <td class="font-monospace text-success fw-bold">@v.Immatriculation</td>
                                                    <td>
                                                        <div class="fw-bold">@v.ClientNomComplet</div>
                                                    </td>
                                                    <td>@v.Marque @v.Modele</td>
                                                    <td>@v.DestinationFinale</td>
                                                    <td class="text-end fw-bold">@v.PrixTotal.ToString("C0")</td>
                                                    <td class="text-end text-success">@v.SommePayee.ToString("C0")</td>
                                                    <td class="text-end">
                                                         @if (v.RestantAPayer > 0)
                                                         {
                                                             <span class="text-danger fw-bold">@v.RestantAPayer.ToString("C0")</span>
                                                         }
                                                         else
                                                         {
                                                             <span class="text-success"><i class="bi bi-check-all"></i></span>
                                                         }
                                                    </td>                                            
                                                    <td class="text-center"><span class="badge bg-secondary">@v.Statut</span></td>
                                                    <td class="text-end pe-3">
                                                        <div class="d-flex justify-content-end gap-2">
                                                            <a href="vehicule/edit/@v.Id" target="_blank" class="btn btn-outline-primary btn-sm" title="Voir/Modifier">
                                                                ‚úèÔ∏è
                                                            </a>
                                                            <button class="btn btn-outline-danger btn-sm" @onclick="() => UnassignVehicle(v)" title="Retirer">
                                                                ‚ùå
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- ONGLET 2 : DISCUSSION (NOUVEAU) -->
            @if (!IsNew)
            {
                <div class="tab-pane fade @(_activeTab == "discussion" ? "show active" : "")">
                    <div class="row justify-content-center">
                        <div class="col-lg-10">
                            <!-- CHAT pour Conteneur -->
                            <ChatBox EntityId="@_conteneur.Id" 
                                     EntityType="Conteneur" 
                                     OnUnreadCountChanged="UpdateUnreadBadge" 
                                     IsVisible="@(_activeTab == "discussion")" />
                        </div>
                    </div>
                </div>
            }

            <!-- ONGLET 3 : DOCUMENTS -->
            @if (!IsNew)
            {
                <div class="tab-pane fade @(_activeTab == "documents" ? "show active" : "")">
                    <DocumentManager EntityId="@_conteneur.Id" EntityType="Conteneur" />
                </div>
            }

        </div>
    }

    <!-- MODALES -->
    <ParcelSelector IsVisible="_showAddParcel" OnClose="() => _showAddParcel = false" OnSelectionConfirmed="AddParcels" />
    <VehicleSelector IsVisible="_showAddVehicle" OnClose="() => _showAddVehicle = false" OnSelectionConfirmed="AddVehicles" />

</div>

@code {
    [Parameter] public Guid? Id { get; set; }

    private ConteneurDetailDto _dto = new();
    private Conteneur _conteneur = new() { DateReception = DateTime.Now };
    
    private bool _isLoading = true;
    private bool IsNew => Id == null;
    private bool _showAddParcel = false;
    private bool _showAddVehicle = false;
    
    private string _activeTab = "infos";
    
    // Gestion Badge
    private int _unreadMessagesCount = 0;
    private async Task UpdateUnreadBadge(int count)
    {
        _unreadMessagesCount = count;
        await InvokeAsync(StateHasChanged);
    }
    
    private bool _isExportMenuOpen = false;
    private void ToggleExportMenu() => _isExportMenuOpen = !_isExportMenuOpen;

    protected override async Task OnInitializedAsync()
    {
        if (!IsNew) await LoadData();
        else _isLoading = false;
    }

    private async Task LoadData()
    {
        var resultDto = await ApiService.GetConteneurDetailAsync(Id.Value);
        if (resultDto != null) _dto = resultDto;

        try 
        {
            _conteneur = new Conteneur 
            {
                Id = _dto.Id,
                NumeroDossier = _dto.NumeroDossier,
                NumeroPlomb = _dto.NumeroPlomb,
                NomCompagnie = _dto.NomCompagnie,
                NomTransitaire = _dto.NomTransitaire,
                Destination = _dto.Destination,
                PaysDestination = _dto.PaysDestination,
                Statut = _dto.Statut,
                Commentaires = _dto.Commentaires,
                DateReception = _dto.DateReception,
                DateChargement = _dto.DateChargement,
                DateDepart = _dto.DateDepart,
                DateArriveeDestination = _dto.DateArriveeDestination,
                DateDedouanement = _dto.DateDedouanement,
                DateCloture = _dto.DateCloture
            };
        }
        catch {} 
        
        _isLoading = false;
        StateHasChanged();
    }

    private async Task SaveContainer()
    {
        if (string.IsNullOrWhiteSpace(_conteneur.NumeroDossier)) return;

        if (IsNew)
        {
            var created = await ApiService.CreateConteneurAsync(_conteneur);
            if (created != null) Navigation.NavigateTo($"/conteneur/detail/{created.Id}");
        }
        else
        {
            await ApiService.UpdateConteneurAsync(_conteneur.Id, _conteneur);
            await LoadData();
        }
    }

    private async Task AddParcels(List<Guid> ids)
    {
        await ApiService.AssignColisToConteneurListAsync(_conteneur.Id, ids);
        await LoadData();
    }

    private async Task UnassignColis(ColisListItemDto c)
    {
        bool confirm = await JSRuntime.InvokeAsync<bool>("confirm", $"Retirer le colis {c.NumeroReference} du conteneur ?");
        if (confirm)
        {
            await ApiService.UnassignColisFromConteneurListAsync(_conteneur.Id, new List<Guid> { c.Id });
            await LoadData();
        }
    }

    private async Task AddVehicles(List<Guid> ids)
    {
        await ApiService.AssignVehiculesToConteneurListAsync(_conteneur.Id, ids);
        await LoadData();
    }

    private async Task UnassignVehicle(VehiculeListItemDto v)
    {
        bool confirm = await JSRuntime.InvokeAsync<bool>("confirm", $"Retirer le v√©hicule {v.Immatriculation} du conteneur ?");
        if (confirm)
        {
            await ApiService.UnassignVehiculesFromConteneurListAsync(_conteneur.Id, new List<Guid> { v.Id });
            await LoadData();
        }
    }

    private async Task ToggleExportExclusion(ColisListItemDto c, object? isChecked)
    {
        if (isChecked is bool value)
        {
            c.IsExcludedFromExport = value;
            var success = await ApiService.ToggleColisExportExclusionAsync(c.Id, value);
            if(success) await LoadData(); // Recharger pour mettre √† jour le r√©capitulatif
        }
    }
	
    private async Task ExportPdf(bool includeFinancials)
    {
        _isExportMenuOpen = false;
        _isLoading = true;
        StateHasChanged();

        try
        {
            var pdfData = await ApiService.ExportConteneurPdfAsync(_conteneur.Id, includeFinancials);
            
            if (pdfData != null && pdfData.Length > 0)
            {
                var safeDossier = _conteneur.NumeroDossier?
                    .Replace("/", "-")
                    .Replace("\\", "-") 
                    .Replace(":", "-") ?? "Inconnu";
                
                var fileName = $"Dossier_{safeDossier}_{(includeFinancials ? "Complet" : "Manifeste")}.pdf";

                using var stream = new MemoryStream(pdfData);
                using var streamRef = new DotNetStreamReference(stream);
                
                await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Erreur : Le fichier re√ßu est vide.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Exception Vue : {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
    private string GetTrackingUrl()
    {
        if (string.IsNullOrEmpty(_conteneur.NomCompagnie) || string.IsNullOrEmpty(_conteneur.NumeroDossier)) return "#";

        var refNum = _conteneur.NumeroDossier.Trim();
        // Optionnel : Si le num√©ro dossier n'est pas le num√©ro de tracking, utiliser NumeroPlomb ou autre ?
        // On suppose ici que NumeroDossier (ou un autre champ) sert de r√©f√©rence.
        // Si c'est NumeroPlomb : var refNum = _conteneur.NumeroPlomb;
        
        return _conteneur.NomCompagnie.ToUpper() switch
        {
            "CMA CGM" => $"https://www.cma-cgm.com/ebusiness/tracking/search?searchBy=BL&searchValue={refNum}",
            "MSC" => $"https://www.msc.com/en/track-a-shipment?reference={refNum}",
            _ => "#"
        };
    }
}