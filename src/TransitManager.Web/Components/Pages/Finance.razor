@page "/finance"
@using TransitManager.Core.DTOs
@using TransitManager.Core.Enums
@using TransitManager.Core.Entities
@using System.Security.Claims
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime

<PageTitle>Finance - Hippocampe</PageTitle>

<div class="container mt-4 mb-5">
    
    <AuthorizeView Roles="Administrateur">
        <Authorized>
            <!-- TABS -->
            <ul class="nav nav-pills mb-4 gap-2">
                <li class="nav-item">
                    <button class="nav-link @(_activeTab == "dashboard" ? "active" : "")" @onclick='() => SwitchTab("dashboard")'>
                        <i class="bi bi-speedometer2 me-2"></i>Dashboard
                    </button>
                </li>
                <li class="nav-item">
                     <button class="nav-link @(_activeTab == "documents" ? "active" : "")" @onclick='() => SwitchTab("documents")'>
                        <i class="bi bi-file-earmark-text me-2"></i>Documents Financiers
                    </button>
                </li>
            </ul>

            @if (_activeTab == "dashboard")
            {
                <!-- HEADER & ACTIONS -->
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
                    <h2 class="fw-bold text-primary"><i class="bi bi-graph-up-arrow me-2"></i>Tableau de Bord Financier</h2>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-primary shadow-sm" @onclick="OpenNewPaymentModal">
                             <i class="bi bi-plus-lg me-2"></i>Nouveau Paiement
                        </button>
                        <button class="btn btn-outline-success shadow-sm" @onclick="ExportToExcel">
                             <i class="bi bi-file-earmark-excel me-2"></i>Exporter
                        </button>
                    </div>
                </div>

                <!-- FILTRES -->
                <div class="card shadow-sm border-0 mb-4 bg-light">
                    <div class="card-body py-2">
                         <div class="d-flex flex-wrap gap-2 align-items-center">
                            <label class="fw-bold small text-muted">Période:</label>
                            <input type="date" class="form-control form-control-sm" style="width: auto;" @bind="filterStart" @bind:after="LoadAdminData" />
                            <span class="text-muted">-</span>
                            <input type="date" class="form-control form-control-sm" style="width: auto;" @bind="filterEnd" @bind:after="LoadAdminData" />
                            
                            <div class="vr mx-2 d-none d-md-block"></div>
                            
                            <label class="fw-bold small text-muted">Client:</label>
                            <div style="width: 300px;">
                                <ClientSearch OnClientSelected="HandleAdminClientSelect" />
                            </div>

                            <button class="btn btn-sm btn-primary ms-auto" @onclick="LoadAdminData">
                                 <i class="bi bi-filter me-1"></i>Actualiser
                            </button>
                        </div>
                    </div>
                </div>

                @if (adminStats != null)
                {
                    <!-- KPI CARDS -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-3">
                            <div class="card shadow-sm border-0 bg-primary text-white h-100">
                                <div class="card-body text-center">
                                    <h2 class="display-6 fw-bold">@adminStats.ChiffreAffairesMensuel.ToString("C0")</h2>
                                    <p class="mb-0 text-white-50">CA ce mois</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card shadow-sm border-0 bg-success text-white h-100">
                                <div class="card-body text-center">
                                    <h2 class="display-6 fw-bold">@adminStats.TotalEncaisse.ToString("C0")</h2>
                                    <p class="mb-0 text-white-50">Total Encaissé</p>
                                </div>
                            </div>
                        </div>
                         <div class="col-md-3">
                            <div class="card shadow-sm border-0 bg-danger text-white h-100">
                                <div class="card-body text-center">
                                    <h2 class="display-6 fw-bold">@adminStats.TotalRestantDu.ToString("C0")</h2>
                                    <p class="mb-0 text-white-50">Total Restant Dû</p>
                                </div>
                            </div>
                        </div>
                         <div class="col-md-3">
                            <div class="card shadow-sm border-0 bg-warning text-dark h-100" style="cursor: pointer; transition: transform 0.2s;" @onclick="ShowUnpricedItemsModal" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
                                <div class="card-body text-center">
                                    <h2 class="display-6 fw-bold">@adminStats.NombrePaiementsRetard</h2>
                                    <p class="mb-0 text-muted">Articles sans Prix</p>
                                    <small class="text-danger fw-bold">(Action Requise)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- GRAPHIQUE -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white py-3">
                            <h5 class="mb-0 fw-bold">Évolution du Chiffre d'Affaires</h5>
                        </div>
                        <div class="card-body" style="height: 300px;">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>

                    <!-- PROGRESS BAR: Encaissé vs Restant -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-body">
                             <h6 class="fw-bold mb-3">Répartition Financière Globale</h6>
                             @{
                                 var total = adminStats.TotalEncaisse + adminStats.TotalRestantDu;
                                 var pEncaisse = total > 0 ? (adminStats.TotalEncaisse / total) * 100 : 0;
                                 var pRestant = total > 0 ? (adminStats.TotalRestantDu / total) * 100 : 0;
                             }
                             <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: @pEncaisse.ToString("0")%" aria-valuenow="@pEncaisse" aria-valuemin="0" aria-valuemax="100">Encaissé (@pEncaisse.ToString("0")%)</div>
                                <div class="progress-bar bg-danger" role="progressbar" style="width: @pRestant.ToString("0")%" aria-valuenow="@pRestant" aria-valuemin="0" aria-valuemax="100">Restant Dû (@pRestant.ToString("0")%)</div>
                            </div>
                        </div>
                    </div>
                }

                <!-- TRANSACTIONS TABLE -->
                <div class="card shadow-sm">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">Historique des Transactions</h5>
                        <span class="badge bg-secondary">@transactions?.Count() opérations</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                             <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Référence</th>
                                    <th>Client</th>
                                    <th>Concerne</th>
                                    <th class="text-end">Montant</th>
                                    <th>Mode</th>
                                    <th class="text-center">Statut</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (transactions != null)
                                {
                                    @foreach (var t in transactions)
                                    {
                                        <tr>
                                            <td>@t.Date.ToShortDateString()</td>
                                            <td class="font-monospace small">@t.ReferenceRecu</td>
                                            <td>@t.ClientName</td>
                                            <td>
                                                @if(t.EntityId.HasValue)
                                                {
                                                    var link = t.EntityType == "Colis" ? $"colis/detail/{t.EntityId}" :
                                                               t.EntityType == "Vehicule" ? $"vehicule/detail/{t.EntityId}" : 
                                                               t.EntityType == "Conteneur" ? $"conteneur/detail/{t.EntityId}" : "#";
                                                    <a href="@link" class="text-decoration-none fw-bold">
                                                        <span class="badge bg-light text-dark border">@t.EntityType</span> @t.EntityReference
                                                    </a>
                                                }
                                                else
                                                {
                                                    <span>-</span>
                                                }
                                            </td>
                                            <td class="text-end fw-bold">@t.Montant.ToString("C0")</td>
                                            <td>@t.ModePaiement</td>
                                            <td class="text-center"><span class="badge bg-success">@t.Statut</span></td>
                                            <td class="text-end">
                                                 <button class="btn btn-sm btn-light text-danger" title="Télécharger Reçu" @onclick="() => DownloadReceipt(t.Id, t.ReferenceRecu)">
                                                    <i class="bi bi-file-earmark-pdf-fill"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr><td colspan="8" class="text-center py-4">Chargement...</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
            else if (_activeTab == "documents")
            {
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold text-primary"><i class="bi bi-archive me-2"></i>Documents Financiers</h2>
                    <button class="btn btn-primary shadow-sm" @onclick="OpenDocUploadModal">
                         <i class="bi bi-cloud-upload me-2"></i>Uploader Document
                    </button>
                </div>

                <div class="card shadow-sm border-0 mb-4 bg-light">
                    <div class="card-body py-2">
                        <div class="d-flex flex-wrap gap-2 align-items-center">
                            <label class="fw-bold small text-muted">Année:</label>
                            <select class="form-select form-select-sm" style="width: auto;" @bind="_docYear" @bind:after="LoadFinancialDocs">
                                @for(int y = DateTime.Now.Year; y >= 2023; y--)
                                {
                                    <option value="@y">@y</option>
                                }
                            </select>

                            <label class="fw-bold small text-muted">Mois:</label>
                            <select class="form-select form-select-sm" style="width: auto;" @bind="_docMonth" @bind:after="LoadFinancialDocs">
                                <option value="">Tous</option>
                                @for(int m=1; m<=12; m++)
                                {
                                    <option value="@m">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)</option>
                                }
                            </select>

                            <label class="fw-bold small text-muted">Type:</label>
                            <select class="form-select form-select-sm" style="width: auto;" @bind="_docType" @bind:after="LoadFinancialDocs">
                                <option value="">Tous</option>
                                <option value="@TypeDocument.Facture">Facture</option>
                                <option value="@TypeDocument.Recu">Reçu</option>
                                <option value="@TypeDocument.Devis">Devis</option>
                                <option value="@TypeDocument.Contrat">Contrat</option>
                            </select>
                            
                            <label class="fw-bold small text-muted">Client:</label>
                            <div style="width: 250px;">
                                <ClientSearch OnClientSelected="HandleDocClientSelect" />
                            </div>

                            <button class="btn btn-sm btn-primary ms-auto" @onclick="LoadFinancialDocs">
                                 <i class="bi bi-search me-1"></i>Filtrer
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="50"></th>
                                    <th>Nom</th>
                                    <th>Type</th>
                                    <th>Client</th>
                                    <th>Date</th>
                                    <th>Taille</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (_financialDocs != null)
                                {
                                    @if (!_financialDocs.Any())
                                    {
                                         <tr><td colspan="7" class="text-center py-4 text-muted">Aucun document trouvé.</td></tr>
                                    }
                                    @foreach(var doc in _financialDocs)
                                    {
                                        <tr>
                                            <td class="text-center text-primary fs-4"><i class="bi bi-file-earmark-pdf"></i></td> <!-- Simplification icon -->
                                            <td>
                                                <div class="fw-bold">@doc.Nom</div>
                                                <div class="small text-muted">@doc.NomFichierOriginal</div>
                                            </td>
                                            <td><span class="badge bg-secondary">@doc.Type</span></td>
                                            <td>@(doc.Client?.NomComplet ?? "-")</td>
                                            <td>@doc.DateCreation.ToString("dd/MM/yyyy HH:mm")</td>
                                            <td>@doc.TailleFormatee</td>
                                            <td class="text-end">
                                                <a href="api/documents/@doc.Id/preview" target="_blank" class="btn btn-sm btn-light" title="Visualiser">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                <a href="api/documents/@doc.Id/download" download target="_blank" class="btn btn-sm btn-light" title="Télécharger">
                                                    <i class="bi bi-download"></i>
                                                </a>
                                                <button class="btn btn-sm btn-outline-danger ms-1" @onclick="() => DeleteFinancialDoc(doc)" title="Supprimer">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                     <tr><td colspan="7" class="text-center py-4"><div class="spinner-border spinner-border-sm"></div> Chargement...</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }

        </Authorized>
    </AuthorizeView>

    <AuthorizeView Roles="Client">
        <Authorized>
             <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold text-primary"><i class="bi bi-wallet2 me-2"></i>Mes Finances</h2>
                 <button class="btn btn-primary" @onclick="ReloadClientData">
                     <i class="bi bi-arrow-clockwise me-1"></i> Actualiser
                 </button>
            </div>
            
            @if(clientSummary != null)
            {
                 <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <div class="card shadow-sm border-0 @(clientSummary.SoldeTotalAPayer > 0 ? "bg-danger" : "bg-success") text-white h-100">
                             <div class="card-body text-center">
                                <h1 class="display-4 fw-bold">@clientSummary.SoldeTotalAPayer.ToString("C0")</h1>
                                <p class="lead mb-0">Reste à Payer (Total)</p>
                            </div>
                        </div>
                    </div>
                     <div class="col-md-6">
                        <div class="card shadow-sm border-0 bg-info text-white h-100">
                             <div class="card-body text-center">
                                <h1 class="display-4 fw-bold">@clientSummary.RestantAPayerColis.ToString("C0")</h1>
                                <p class="lead mb-0">Restant à Payer (Colis)</p>
                            </div>
                        </div>
                    </div>
                     <div class="col-md-6">
                        <div class="card shadow-sm border-0 bg-warning text-dark h-100">
                             <div class="card-body text-center">
                                <h1 class="display-4 fw-bold">@clientSummary.RestantAPayerVehicule.ToString("C0")</h1>
                                <p class="lead mb-0">Restant à Payer (Véhicules)</p>
                            </div>
                        </div>
                    </div>
                </div>

                @if(clientSummary.Impayes.Any())
                {
                    <div class="card shadow-sm border-danger mb-4">
                        <div class="card-header bg-danger text-white fw-bold">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>Régularisations Requises (@clientSummary.Impayes.Count)
                        </div>
                        <div class="list-group list-group-flush">
                            @foreach(var item in clientSummary.Impayes)
                            {
                                var link = item.EntityType == "Colis" ? $"colis/detail/{item.EntityId}" : $"vehicule/detail/{item.EntityId}";
                                <div class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center p-3">
                                    <div class="mb-2 mb-md-0">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-secondary">@item.EntityType</span>
                                            <h5 class="mb-0 fw-bold">@item.Reference</h5>
                                        </div>
                                        <div class="text-muted small">@item.Description</div>
                                        <div class="text-danger small fw-bold">Reste: @item.RestantAPayer.ToString("C0") / @item.MontantTotal.ToString("C0")</div>
                                    </div>
                                    <a href="@link" class="btn btn-outline-danger fw-bold">
                                        <i class="bi bi-credit-card me-2"></i>Régulariser
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                }

                <div class="card shadow-sm">
                    <div class="card-header bg-light fw-bold">Derniers Paiements</div>
                    <div class="table-responsive">
                         <table class="table table-hover align-middle mb-0">
                            <tbody>
                                @foreach(var p in clientSummary.DerniersPaiements)
                                {
                                     <tr>
                                        <td class="text-nowrap">@p.Date.ToShortDateString()</td>
                                        <td><span class="badge bg-light text-dark border">@p.EntityType</span> @p.EntityReference</td>
                                        <td class="text-end fw-bold text-success">@p.Montant.ToString("C0")</td>
                                        <td class="text-center"><span class="badge bg-success">Validé</span></td>
                                         <td class="text-end">
                                             <button class="btn btn-sm btn-outline-secondary" title="Reçu" @onclick="() => DownloadReceipt(p.Id, p.ReferenceRecu)">
                                                <i class="bi bi-download"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

            }
            else if (loadError)
            {
                 <div class="alert alert-danger text-center">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Impossible de charger les données financières.
                    @if(!string.IsNullOrEmpty(errorMessage))
                    {
                        <br/>
                        <small class="fw-bold">@errorMessage</small>
                    }
                </div>
            }
            else
            {
                 <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
            }

        </Authorized>
    </AuthorizeView>
</div>

<!-- MODAL UNPRICED ITEMS -->
@if (_showUnpricedItemsModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5); z-index: 1060;">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">⚠️ Articles sans Prix (Cotation Requise)</h5>
                    <button type="button" class="btn-close" @onclick="() => _showUnpricedItemsModal = false"></button>
                </div>
                <div class="modal-body">
                    @if (_unpricedItems == null)
                    {
                        <div class="text-center p-3"><div class="spinner-border text-dark"></div></div>
                    }
                    else if (!_unpricedItems.Any())
                    {
                        <p class="text-center text-muted py-3">Aucun article sans prix.</p>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Référence</th>
                                        <th>Client</th>
                                        <th>Date Création</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in _unpricedItems)
                                    {
                                        <tr>
                                            <td><span class="badge @(item.Type == "Colis" ? "bg-primary" : "bg-success")">@item.Type</span></td>
                                            <td>
                                                <strong>@item.Reference</strong><br/>
                                                <small class="text-muted">@item.Description</small>
                                            </td>
                                            <td>@item.ClientName</td>
                                            <td>@item.DateCreation.ToLocalTime().ToShortDateString()</td>
                                            <td>
                                                <a href="@(item.Type == "Colis" ? $"/colis/edit/{item.Id}" : $"/vehicule/edit/{item.Id}")" class="btn btn-sm btn-outline-warning text-dark fw-bold">
                                                    <i class="bi bi-pencil"></i> Fixer Prix
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

<!-- MODAL NOUVEAU PAIEMENT -->
@if (showPaymentModal)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Encaisser un Paiement</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <!-- Client Selection with Search -->
                        <div class="col-md-12">
                            <label class="form-label">Client</label>
                            @if(newPaiementClientId == Guid.Empty)
                            {
                                <ClientSearch OnClientSelected="HandlePaymentClientSelect" />
                            }
                            else
                            {
                                <div class="d-flex align-items-center gap-2">
                                    <div class="form-control bg-light">@paymentClientName</div>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="ResetPaymentClient">Changer</button>
                                </div>
                            }
                        </div>

                         <div class="col-md-6">
                            <label class="form-label">Type d'Entité</label>
                            <select class="form-select" @bind="selectedEntityType">
                                <option value="Colis">Colis</option>
                                <option value="Vehicule">Véhicule</option>
                                <option value="Conteneur">Conteneur</option>
                            </select>
                        </div>
                         <div class="col-md-12">
                            <label class="form-label">Entité (ID)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" @bind="newPaiementEntityId" placeholder="Cliquez pour chercher..." readonly @onclick="OpenEntitySelector" />
                                <button class="btn btn-outline-secondary" type="button" @onclick="OpenEntitySelector"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                         <div class="col-md-6">
                            <label class="form-label">Montant</label>
                            <input type="number" class="form-control" @bind="newPaiement.Montant" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Mode de Paiement</label>
                            <select class="form-select" @bind="newPaiement.ModePaiement">
                                @foreach (var mode in Enum.GetValues<TypePaiement>())
                                {
                                    <option value="@mode">@mode</option>
                                }
                            </select>
                        </div>
                         <div class="col-md-12">
                            <label class="form-label">Commentaire</label>
                            <textarea class="form-control" rows="2" @bind="newPaiement.Commentaires"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Annuler</button>
                    <button type="button" class="btn btn-primary" @onclick="SubmitPayment">Encaisser</button>
                </div>
            </div>
        </div>
    </div>
}

<EntitySelector Show="showEntitySelector" EntityType="@selectedEntityType" OnSelected="HandleEntitySelected" OnClose="CloseEntitySelector" />

<!-- MODAL UPLOAD DOCUMENT -->
@if (_showDocModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Uploader un Document Financier</h5>
                    <button type="button" class="btn-close" @onclick="CloseDocModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Client (Optionnel)</label>
                        @if(_newDocClientId == null)
                        {
                            <ClientSearch OnClientSelected="c => _newDocClientId = c.Id" />
                        }
                        else
                        {
                             <div class="d-flex gap-2">
                                <input type="text" class="form-control" value="Client sélectionné (ID: @_newDocClientId)" readonly />
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => _newDocClientId = null">X</button>
                             </div>
                        }
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <select class="form-select" @bind="_newDocType">
                            <option value="@TypeDocument.Facture">Facture</option>
                            <option value="@TypeDocument.Recu">Reçu</option>
                            <option value="@TypeDocument.Devis">Devis</option>
                            <option value="@TypeDocument.Contrat">Contrat</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Fichier</label>
                        <InputFile OnChange="HandleFileSelected" class="form-control" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDocModal">Annuler</button>
                    <button type="button" class="btn btn-primary" @onclick="UploadDocument" disabled="@(_selectedFile == null)">Uploader</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private FinanceStatsDto? adminStats;
    private IEnumerable<FinancialTransactionDto>? transactions;
    private ClientFinanceSummaryDto? clientSummary;
    
    // Filters
    private DateTime? filterStart = DateTime.Now.AddMonths(-1);
    private DateTime? filterEnd = DateTime.Now;
    
    // Admin Client Filter
    private Guid? filterClientId = null;

    private bool isAdmin = false;
    private string _activeTab = "dashboard"; // dashboard, documents
    private bool showPaymentModal = false;
    private bool loadError = false;
    private string? errorMessage = null;
    private bool showEntitySelector = false;

    // Unpriced Items Modal
    private bool _showUnpricedItemsModal = false;
    private List<DashboardEntityDto> _unpricedItems;

    private async Task ShowUnpricedItemsModal()
    {
        _showUnpricedItemsModal = true;
        try 
        {
            _unpricedItems = await ApiService.GetUnpricedItemsAsync();
        }
        catch(Exception ex)
        {
             Console.WriteLine($"Error loading unpriced items: {ex.Message}");
            _unpricedItems = new List<DashboardEntityDto>();
        }
    }

    // New Payment Form
    private Paiement newPaiement = new Paiement();
    
    // Document Section
    private int _docYear = DateTime.Now.Year;
    private int? _docMonth = DateTime.Now.Month;
    private TypeDocument? _docType;
    private Guid? _docClientId;
    private IEnumerable<Document>? _financialDocs;
    private bool _showDocModal = false;
    private IBrowserFile? _selectedFile;
    private Guid? _newDocClientId;
    private TypeDocument _newDocType = TypeDocument.Facture;

    private Guid newPaiementClientId = Guid.Empty;
    private string paymentClientName = "";
    private string selectedEntityType = "Colis";
    private string newPaiementEntityId = "";
    
    // Cached ID for refresh
    private Guid _clientId = Guid.Empty; // Renamed from currentClientId

    [SupplyParameterFromQuery]
    public string? Tab { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity != null && user.Identity.IsAuthenticated)
            {
                if (user.IsInRole("Administrateur") || user.IsInRole("SuperAdmin") || user.IsInRole("Gestionnaire"))
                {
                    isAdmin = true;
                    // Check Query Parameter for Tab
                    if (!string.IsNullOrEmpty(Tab) && Tab.ToLower() == "documents")
                    {
                        await SwitchTab("documents");
                    }
                    else 
                    {
                        await LoadAdminData();
                    }
                }
                else
                {
                    isAdmin = false;
                    if (user.Identity is System.Security.Claims.ClaimsIdentity claimsIdentity)
                    {
                        // Check for both "ClientId" (Legacy/Manual) and "client_id" (Standard/API)
                        var clientIdClaim = claimsIdentity.Claims.FirstOrDefault(c => c.Type == "ClientId" || c.Type == "client_id");
                        if (clientIdClaim != null && Guid.TryParse(clientIdClaim.Value, out var cid))
                        {
                            _clientId = cid;
                            await LoadClientData(cid);
                        }
                        else
                        {
                            loadError = true;
                            errorMessage = "Erreur: Impossible d'identifier le client associé à ce compte. Veuillez contacter l'administrateur.";
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur init Finance: {ex.Message}");
            loadError = true;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (isAdmin && adminStats != null && adminStats.RevenueChartData != null)
        {
            await JSRuntime.InvokeVoidAsync("chartHelper.createRevenueChart", "revenueChart", 
                adminStats.RevenueChartData.Select(x => x.MonthLabel).ToArray(), 
                adminStats.RevenueChartData.Select(x => x.Revenue).ToArray());
        }
    }

    private async Task SwitchTab(string tabName)
    {
        _activeTab = tabName;
        await LoadAdminData();
    }

    private async Task LoadAdminData()
    {
        if (_activeTab == "dashboard")
        {
            adminStats = await ApiService.GetFinanceStatsAsync(filterStart, filterEnd, filterClientId);
            transactions = await ApiService.GetTransactionsAsync(filterStart, filterEnd, filterClientId);
        }
        else if (_activeTab == "documents")
        {
            await LoadFinancialDocs();
        }
        StateHasChanged(); // Force update for chart
    }
    
    private async Task LoadFinancialDocs()
    {
        _financialDocs = null;
        StateHasChanged();
        _financialDocs = await ApiService.GetFinancialDocumentsAsync(_docYear, _docMonth, _docType, _docClientId);
        StateHasChanged();
    }
    
    private void HandleDocClientSelect(Client c)
    {
        _docClientId = c?.Id;
        _ = LoadFinancialDocs(); 
    }
    
    private void OpenDocUploadModal() => _showDocModal = true;
    private void CloseDocModal() => _showDocModal = false;
    
    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
    }
    
    private async Task UploadDocument()
    {
        if (_selectedFile == null) return;
        
        // Upload logic
        // Need to update IApiService to support separate params or just file
        // IApiService currently has: UploadDocumentAsync(IBrowserFile file, TypeDocument type, Guid? clientId...)
        await ApiService.UploadDocumentAsync(_selectedFile, _newDocType, _newDocClientId, null, null, null);
        
        CloseDocModal();
        await LoadFinancialDocs();
    }
    
    private async Task DeleteFinancialDoc(Document doc)
    {
        if (doc == null) return;
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Voulez-vous vraiment supprimer le document '{doc.Nom}' ?");
        if (confirmed)
        {
            var success = await ApiService.DeleteDocumentAsync(doc.Id);
            if (success)
            {
                await LoadFinancialDocs();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Erreur lors de la suppression du document.");
            }
        }
    }

    private async Task LoadClientData(Guid clientId)
    {
        loadError = false;
        errorMessage = null;
        try
        {
            clientSummary = await ApiService.GetClientFinanceSummaryAsync(clientId);
            if (clientSummary == null) throw new Exception("Données reçues vides (null)");
        }
        catch(Exception ex)
        {
            // Log to server console (Blazor Server)
            Console.WriteLine($"Error loading client data: {ex.Message}"); 
            loadError = true;
            errorMessage = ex.Message;
        }
    }
    
    private void HandleAdminClientSelect(Client client)
    {
        filterClientId = client?.Id;
        _ = LoadAdminData();
    }

    private void HandlePaymentClientSelect(Client client)
    {
        if (client != null) 
        {
            newPaiement.ClientId = client.Id;
            newPaiementClientId = client.Id;
            paymentClientName = $"{client.Prenom} {client.Nom}";
        }
    }
    
    private void ResetPaymentClient()
    {
        newPaiementClientId = Guid.Empty;
        newPaiement.ClientId = Guid.Empty;
        paymentClientName = "";
    }

    private void OpenEntitySelector() => showEntitySelector = true;
    private void CloseEntitySelector() => showEntitySelector = false;

    private void HandleEntitySelected(EntitySelector.SelectionItem item)
    {
        newPaiementEntityId = item.Id.ToString();
    }

    private async Task DownloadReceipt(Guid id, string refRecu)
    {
        await ApiService.DownloadReceiptAsync(id, $"Recu_{refRecu}.pdf");
    }

    private async Task ExportToExcel()
    {
        await ApiService.ExportTransactionsAsync(filterStart, filterEnd);
    }
    
    private void OpenNewPaymentModal()
    {
        newPaiement = new Paiement() { Devise = "EUR", TauxChange = 1 };
        newPaiementEntityId = "";
        ResetPaymentClient();
        showPaymentModal = true;
    }
    
    private void CloseModal() => showPaymentModal = false;

    private async Task SubmitPayment()
    {
        if(Guid.TryParse(newPaiementEntityId, out var entityGuid))
        {
            if (selectedEntityType == "Colis") newPaiement.ColisId = entityGuid;
            else if (selectedEntityType == "Vehicule") newPaiement.VehiculeId = entityGuid;
             else if (selectedEntityType == "Conteneur") newPaiement.ConteneurId = entityGuid;
        }

        var result = await ApiService.CreatePaymentAsync(newPaiement);
        if(result != null)
        {
            CloseModal();
            await LoadAdminData(); 
        }
    }
    private async Task ReloadClientData()
    {
        if (_clientId != Guid.Empty)
        {
            await LoadClientData(_clientId);
        }
    }
}
