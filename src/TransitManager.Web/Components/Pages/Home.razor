
@page "/"
@using TransitManager.Core.DTOs
@using TransitManager.Core.Entities
@using TransitManager.Core.Enums
@using TransitManager.Web.Services
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject IApiService ApiService
@inject NavigationManager nav
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS

<PageTitle>Accueil - Hippocampe Import-Export</PageTitle>

<AuthorizeView>
    <Authorized Context="AuthContext">
        <div class="container-fluid mt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold text-primary">Tableau de Bord</h2>
                    <p class="text-muted">Bienvenue, @AuthContext.User.Identity?.Name</p>
                </div>
                <div class="d-flex align-items-center gap-3">
                     <span class="badge bg-light text-dark border p-2">
                        <i class="bi bi-clock me-1"></i> @DateTime.Now.ToString("dd MMMM yyyy")
                    </span>
                </div>
            </div>

            @if (isLoading)
            {
                <div class="d-flex justify-content-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>
            }
            else
            {
                <AuthorizeView Roles="Administrateur,Gestionnaire" Context="AdminCtx">
                    <!-- DASHBOARD ADMIN -->
                    <div class="row g-4 mb-4">
                        <!-- KPI Colis -->
                        <div class="col-md-3">
                            <div class="card shadow-sm border-0 h-100 bg-primary text-white">
                                <div class="card-body">
                                    <h6 class="text-uppercase opacity-75">Colis en Transit</h6>
                                    <h2 class="display-6 fw-bold mb-0">@adminStats?.ColisEnTransit</h2>
                                    <div class="mt-2 text-white-50 small">
                                        <i class="bi bi-box-seam"></i> Actuellement actifs
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- KPI Documents -->
                        <div class="col-md-3">
                            <div class="card shadow-sm border-0 h-100 bg-warning text-dark">
                                <div class="card-body">
                                    <h6 class="text-uppercase opacity-75">Docs à Valider</h6>
                                    <h2 class="display-6 fw-bold mb-0">@adminStats?.DocsAValider</h2>
                                    <div class="mt-2 text-dark-50 small">
                                        <i class="bi bi-file-earmark-check"></i> En attente
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- KPI Clients -->
                        <div class="col-md-3">
                            <div class="card shadow-sm border-0 h-100 bg-info text-white">
                                <div class="card-body">
                                    <h6 class="text-uppercase opacity-75">Nouveaux Clients</h6>
                                    <h2 class="display-6 fw-bold mb-0">@adminStats?.NouveauxClientsMois</h2>
                                    <div class="mt-2 text-white-50 small">
                                        <i class="bi bi-person-plus"></i> Ce mois-ci
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- KPI Volume -->
                        <div class="col-md-3">
                            <div class="card shadow-sm border-0 h-100 bg-success text-white">
                                <div class="card-body">
                                    <h6 class="text-uppercase opacity-75">Volume Mensuel</h6>
                                    <h2 class="display-6 fw-bold mb-0">@((adminStats?.VolumeMensuel ?? 0).ToString("N2")) m³</h2>
                                    <div class="mt-2 text-white-50 small">
                                        <i class="bi bi-graph-up-arrow"></i> Volume global
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CHARTS Section -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-8">
                             <div class="card shadow-sm border-0 h-100">
                                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0 fw-bold"><i class="bi bi-bar-chart-line me-2"></i>Revenus & Volume (6 mois)</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="revenueChart" style="max-height: 300px;"></canvas>
                                </div>
                           </div>
                        </div>
                        <div class="col-md-4">
                             <div class="card shadow-sm border-0 h-100">
                                <div class="card-header bg-white py-3">
                                    <h5 class="mb-0 fw-bold"><i class="bi bi-pie-chart me-2"></i>Distribution Statuts</h5>
                                </div>
                                <div class="card-body d-flex justify-content-center align-items-center">
                                    <canvas id="statusChart" style="max-height: 300px;"></canvas>
                                </div>
                           </div>
                        </div>
                    </div>

                    <!-- Activity & Actions -->
                    <div class="row g-4">
                        <div class="col-md-8">
                             <div class="card shadow-sm border-0">
                                <div class="card-header bg-white py-3">
                                    <h5 class="mb-0 fw-bold">Activité Récente</h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush">
                                        @foreach(var notif in recentNotifications)
                                        {
                                            <div class="list-group-item d-flex align-items-start py-3">
                                                <div class="me-3">
                                                     <i class="@notif.Icone @notif.Couleur p-2 rounded bg-light fs-4"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="d-flex justify-content-between">
                                                        <h6 class="mb-1 fw-bold">@notif.Title</h6>
                                                        <small class="text-muted">@notif.DateCreation.ToLocalTime().ToString("dd/MM HH:mm")</small>
                                                    </div>
                                                    <p class="mb-1 small text-secondary">@notif.Message</p>
                                                    @if(!string.IsNullOrEmpty(notif.ActionUrl))
                                                    {
                                                        <a href="@notif.ActionUrl" class="btn btn-sm btn-link p-0 text-decoration-none">Voir détails &rarr;</a>
                                                    }
                                                </div>
                                            </div>
                                        }
                                        @if(!recentNotifications.Any())
                                        {
                                            <div class="text-center p-4 text-muted">Aucune activité récente.</div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card shadow-sm border-0 mb-4">
                                <div class="card-header bg-white py-3">
                                    <h5 class="mb-0 fw-bold">Actions Rapides</h5>
                                </div>
                                <div class="list-group list-group-flush">
                                    <a href="clients" class="list-group-item list-group-item-action py-3">
                                        <i class="bi bi-people me-2 text-primary"></i> Gérer les Clients
                                    </a>
                                    <a href="colis/create" class="list-group-item list-group-item-action py-3">
                                        <i class="bi bi-plus-circle me-2 text-success"></i> Nouveau Colis
                                    </a>
                                    <a href="vehicules/create" class="list-group-item list-group-item-action py-3">
                                        <i class="bi bi-car-front me-2 text-info"></i> Nouveau Véhicule
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </AuthorizeView>

                <AuthorizeView Roles="Client" Context="ClientCtx">
                    <!-- DASHBOARD CLIENT -->
                     <div class="row g-4 mb-4">
                        <!-- ALERTES (Call to Action) -->
                        <div class="col-md-8">
                            <h5 class="mb-3 fw-bold text-secondary">À Faire (Call to Action)</h5>
                            
                            @if (missingDocsCount > 0)
                            {
                                <div class="alert alert-danger shadow-sm border-0 d-flex align-items-center" role="alert">
                                    <i class="bi bi-exclamation-triangle-fill fs-2 me-3"></i>
                                    <div class="flex-grow-1">
                                        <h5 class="alert-heading fw-bold mb-1">Documents Manquants</h5>
                                        <p class="mb-0">Vous avez <strong>@missingDocsCount document(s) à fournir</strong> pour valider vos dossiers.</p>
                                    </div>
                                    <a href="@regularizeUrl" class="btn btn-light text-danger fw-bold shadow-sm">
                                        Régulariser
                                    </a>
                                </div>
                            }

                            <!-- Solde à régler -->
                             <div class="alert alert-warning shadow-sm border-0 d-flex align-items-center" role="alert">
                                <i class="bi bi-wallet2 fs-2 me-3"></i>
                                <div class="flex-grow-1">
                                    <h5 class="alert-heading fw-bold mb-1">Solde à régler</h5>
                                    @if(pendingPaymentAmount > 0)
                                    {
                                         <p class="mb-0">Vous avez un solde impayé de <strong>@pendingPaymentAmount.ToString("C")</strong>.</p>
                                    }
                                    else
                                    {
                                         <p class="mb-0">Vos comptes sont à jour. Merci de vérifier vos factures.</p>
                                    }
                                </div>
                                <a href="my-parcels" class="btn btn-light text-warning fw-bold shadow-sm">Voir Détails</a>
                            </div>
                           
                            
                        </div>

                        <!-- Résumé -->
                         <div class="col-md-4">
                            <a href="my-parcels" class="text-decoration-none">
                                <div class="card shadow-sm border-0 bg-primary text-white mb-3 hover-scale">
                                    <div class="card-body">
                                        <h3>@myColis.Count()</h3>
                                        <p class="mb-0">Colis en cours</p>
                                    </div>
                                </div>
                            </a>
                            <a href="my-vehicles" class="text-decoration-none">
                                 <div class="card shadow-sm border-0 bg-info text-white hover-scale">
                                    <div class="card-body">
                                        <h3>@myVehicules.Count()</h3>
                                        <p class="mb-0">Véhicules en transit</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>

                    <h5 class="mb-3 fw-bold text-secondary">Mes Derniers Colis</h5>
                    <div class="row g-4">
                        @foreach(var colis in myColis.Take(3))
                        {
                             <div class="col-md-4">
                                 <div class="card shadow-sm border-0 h-100">
                                     <div class="card-body">
                                         <div class="d-flex justify-content-between mb-2">
                                             <span class="badge bg-light text-dark border">@colis.NumeroReference</span>
                                             <span class="badge bg-primary">@colis.Statut</span>
                                         </div>
                                         <h5 class="card-title fw-bold">@colis.Designation</h5>
                                         <p class="text-muted small mb-3">
                                             <i class="bi bi-geo-alt"></i> Destinations: @colis.DestinationFinale
                                         </p>
                                         <a href="colis/detail/@colis.Id" class="btn btn-outline-primary btn-sm w-100">Voir Détail</a>
                                     </div>
                                 </div>
                             </div>
                        }
                    </div>

                </AuthorizeView>
            }
        </div>
    </Authorized>
    <NotAuthorized>
              <!-- Contenu NON CONNECTE -->
              <div class="container mt-5">
                   <div class="text-center mb-5">
                        <img src="images/logo.jpg" alt="Logo Hippocampe" style="max-height: 120px;" class="mb-4 rounded shadow-sm" />
                        <h1 class="display-5 fw-bold text-primary">Hippocampe Import-Export</h1>
                        <p class="lead text-muted">Votre partenaire logistique international.</p>
                   </div>
                   <div class="row justify-content-center">
                       <div class="col-md-6">
                           <div class="card shadow-lg border-0 rounded-4">
                               <div class="card-body p-5 text-center">
                                   <h3 class="mb-4">Espace Client</h3>
                                   <p class="mb-4">Connectez-vous pour suivre vos colis, véhicules et gérer vos documents.</p>
                                   <a href="login" class="btn btn-primary btn-lg w-100 rounded-pill shadow-sm">
                                       <i class="bi bi-box-arrow-in-right me-2"></i> Se Connecter
                                   </a>
                               </div>
                           </div>
                       </div>
                   </div>

                   <!-- Informations de contact -->
                    <div class="row text-center mt-5">
                        <div class="col-md-6 mb-4">
                            <div class="mb-2">
                                <i class="bi bi-geo-alt-fill text-primary fs-2"></i>
                            </div>
                            <h5 class="fw-bold">Adresse de l'entrepôt</h5>
                            <p class="text-muted">
                                7 RUE PASCAL<br />
                                33370 TRESSES<br />
                                FRANCE
                            </p>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <div class="mb-2">
                                <i class="bi bi-envelope-fill text-primary fs-2"></i>
                            </div>
                            <h5 class="fw-bold">Contact</h5>
                            <p class="mb-1">
                                <a href="mailto:bordeaux@h-import-export.com" class="text-decoration-none text-dark">
                                    bordeaux@h-import-export.com
                                </a>
                            </p>
                        </div>
                    </div>

                    <div class="row text-center border-top pt-4">
                        <div class="col-md-6 mb-3">
                            <h6 class="fw-bold text-uppercase text-secondary">Téléphone Mobile</h6>
                            <p class="fs-5">06 99 56 93 58</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="fw-bold text-uppercase text-secondary">Téléphone Fixe</h6>
                            <p class="fs-5">09.81.72.45.40</p>
                        </div>
                    </div>
              </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool isLoading = true;
    private UserProfileDto? userProfile;
    
    // Stats Admin
    private AdminDashboardStatsDto? adminStats;
    private List<Notification> recentNotifications = new();

    // Stats Client
    private int missingDocsCount = 0;
    private decimal pendingPaymentAmount = 0; // Ajout
    private IEnumerable<ColisListItemDto> myColis = new List<ColisListItemDto>();

    private IEnumerable<VehiculeListItemDto> myVehicules = new List<VehiculeListItemDto>();
    private string regularizeUrl = "/";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                userProfile = await ApiService.GetUserProfileAsync();
                
                if (user.IsInRole("Administrateur") || user.IsInRole("Gestionnaire"))
                {
                    // Charger Stats Admin
                    recentNotifications = (await ApiService.GetMyNotificationsAsync())?.Take(5).ToList() ?? new();
                    adminStats = await ApiService.GetAdminDashboardStatsAsync();
                }
                else if (user.IsInRole("Client"))
                {
                    // Charger Données Client
                    if (userProfile?.ClientId != null && userProfile.ClientId != Guid.Empty)
                    {
                        missingDocsCount = await ApiService.GetMissingDocumentsCountAsync(userProfile.ClientId);
                        myColis = await ApiService.GetMyColisAsync() ?? new List<ColisListItemDto>();
                        myVehicules = await ApiService.GetVehiculesAsync() ?? new List<VehiculeListItemDto>();
                        pendingPaymentAmount = await ApiService.GetClientBalanceAsync(userProfile.ClientId);
                        
                        // Calcul URL Régularisation
                        if(missingDocsCount > 0)
                        {
                            var missing = await ApiService.GetFirstMissingDocumentAsync(userProfile.ClientId);
                            if(missing != null)
                            {
                                if(missing.ColisId.HasValue) regularizeUrl = $"colis/detail/{missing.ColisId}";
                                else if(missing.VehiculeId.HasValue) regularizeUrl = $"vehicule/detail/{missing.VehiculeId}";
                            }
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur Dashboard: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (adminStats != null)
        {
            // Initialiser les Charts via JS
            // On utilise un petit délai pour être sûr que le rendu DOM est fini si besoin (normalement OnAfterRender suffit)
            
            // Chart Revenus & Volume (Mixed Chart)
            var ctxRevenue = new {
                labels = adminStats.RevenueLast6Months.Select(x => x.Month).ToArray(),
                datasets = new object[]
                {
                    new {
                        type = "bar",
                        label = "Revenu (€)",
                        data = adminStats.RevenueLast6Months.Select(x => x.Value).ToArray(),
                        backgroundColor = "rgba(13, 110, 253, 0.5)",
                        borderColor = "rgb(13, 110, 253)",
                        borderWidth = 1
                    },
                    new {
                        type = "line",
                        label = "Volume (m³)",
                        data = adminStats.VolumeLast6Months.Select(x => x.Value).ToArray(),
                        borderColor = "rgb(25, 135, 84)", // Success color
                        backgroundColor = "rgba(25, 135, 84, 0.1)",
                        yAxisID = "y1",
                        fill = true
                    }
                }
            };
            
            var optionsRevenue = new {
                responsive = true,
                scales = new {
                    y = new { beginAtZero = true, type = "linear", position = "left" },
                    y1 = new { beginAtZero = true, type = "linear", position = "right", grid = new { drawOnChartArea = false } }
                }
            };

            await JS.InvokeVoidAsync("renderChart", "revenueChart", "bar", ctxRevenue, optionsRevenue);

            // Chart Status (Doughnut)
            var ctxStatus = new {
                labels = adminStats.StatusDistribution.Keys.ToArray(),
                datasets = new object[]
                {
                    new {
                        data = adminStats.StatusDistribution.Values.ToArray(),
                        backgroundColor = new [] {
                            "#0d6efd", "#ffc107", "#0dcaf0", "#198754", "#dc3545", "#6c757d"
                        }
                    }
                }
            };

             await JS.InvokeVoidAsync("renderChart", "statusChart", "doughnut", ctxStatus, new { responsive = true });
        }
    }
}