
@page "/"
@using TransitManager.Core.DTOs
@using TransitManager.Core.Entities
@using TransitManager.Core.Enums
@using TransitManager.Web.Services
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject IApiService ApiService
@inject NavigationManager nav
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS

<PageTitle>Accueil - Hippocampe Import-Export</PageTitle>

<AuthorizeView>
    <Authorized Context="AuthContext">
        <div class="container-fluid p-0">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold text-gradient mb-1">Tableau de Bord</h2>
                    <p class="text-muted mb-0">Bienvenue, @AuthContext.User.Identity?.Name</p>
                </div>
                <div class="d-flex align-items-center gap-3">
                     <button class="btn btn-light shadow-sm text-primary" @onclick="LoadData">
                        <i class="bi bi-arrow-clockwise me-1"></i> Actualiser
                    </button>
                     <span class="glass-panel px-3 py-2 text-secondary small fw-medium">
                        <i class="bi bi-clock me-1"></i> @DateTime.Now.ToString("dd MMMM yyyy")
                    </span>
                </div>
            </div>

            @if (isLoading)
            {
                <div class="d-flex justify-content-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>
            }
            else
            {
                <AuthorizeView Roles="Administrateur,Gestionnaire" Context="AdminCtx">
                    <!-- DASHBOARD ADMIN -->
                    <div class="row g-4 mb-4">
                        <!-- KPI Colis En Retard -->
                         <div class="col-md-3">
                             <div @onclick="ShowDelayedItemsModal" style="cursor: pointer;">
                                <DashboardCard Title="Retard > 5j" Value="@adminStats?.ColisEnTransit.ToString()" Icon="bi bi-clock-history" Color="warning">
                                    <div class="mt-2 text-muted small">
                                        Non affectés
                                    </div>
                                </DashboardCard>
                             </div>
                        </div>

                        <!-- KPI Documents Manquants -->
                         <div class="col-md-3">
                             <div @onclick="ShowMissingDocsAdmin" style="cursor: pointer;">
                                <DashboardCard Title="Docs. Manquants" Value="@adminStats?.MissingDocumentsCount.ToString()" Icon="bi bi-file-earmark-x" Color="danger">
                                    <div class="mt-2 text-danger small fw-bold">
                                        Action requise
                                    </div>
                                </DashboardCard>
                             </div>
                        </div>

                        <!-- KPI Nouveaux Clients -->
                         <div class="col-md-3">
                             <div @onclick="ShowNewClientsModal" style="cursor: pointer;">
                                <DashboardCard Title="Nouveaux Clients" Value="@adminStats?.NouveauxClientsMois.ToString()" Icon="bi bi-person-plus" Color="info">
                                    <div class="mt-2 text-success small">
                                        <i class="bi bi-arrow-up-short"></i> Ce mois-ci
                                    </div>
                                </DashboardCard>
                             </div>
                        </div>

                        <!-- KPI Volume -->
                         <div class="col-md-3">
                            <DashboardCard Title="Volume Mensuel" Value="@((adminStats?.VolumeMensuel ?? 0).ToString("N2") + " m³")" Icon="bi bi-graph-up-arrow" Color="success">
                                <div class="mt-2 text-muted small">
                                    Volume global
                                </div>
                            </DashboardCard>
                        </div>
                    </div>

                    <!-- CHARTS Section -->
                    <!-- CHARTS Section -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-8">
                             <div class="glass-panel h-100 p-4">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h5 class="mb-0 fw-bold text-gradient"><i class="bi bi-bar-chart-line me-2"></i>Revenus & Volume (6 mois)</h5>
                                </div>
                                <div>
                                    <canvas id="revenueChart" style="max-height: 300px;"></canvas>
                                </div>
                           </div>
                        </div>
                        <div class="col-md-4">
                             <div class="glass-panel h-100 p-4">
                                <div class="mb-4">
                                    <h5 class="mb-0 fw-bold text-gradient"><i class="bi bi-pie-chart me-2"></i>Distribution Statuts</h5>
                                </div>
                                <div class="d-flex justify-content-center align-items-center">
                                    <canvas id="statusChart" style="max-height: 300px;"></canvas>
                                </div>
                           </div>
                        </div>
                    </div>

                    <!-- Activity & Actions -->
                    <div class="row g-4">
                        <div class="col-md-8">
                             <div class="glass-panel p-4">
                                <div class="mb-4">
                                    <h5 class="mb-0 fw-bold text-gradient">Activité Récente</h5>
                                </div>
                                <div class="list-group list-group-flush rounded-3">
                                    @foreach(var notif in recentNotifications)
                                    {
                                        <div class="list-group-item d-flex align-items-start py-3 border-0 border-bottom" style="background: transparent;">
                                            <div class="me-3">
                                                 <div class="rounded-circle p-2 d-flex align-items-center justify-content-center shadow-sm" style="width: 40px; height: 40px; background: white;">
                                                    <i class="@notif.Icone @notif.Couleur"></i>
                                                 </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between">
                                                    <h6 class="mb-1 fw-bold text-dark">@notif.Title</h6>
                                                    <small class="text-muted">@notif.DateCreation.ToLocalTime().ToString("dd/MM HH:mm")</small>
                                                </div>
                                                <p class="mb-1 small text-secondary">@notif.Message</p>
                                                @if(!string.IsNullOrEmpty(notif.ActionUrl))
                                                {
                                                    <a href="@notif.ActionUrl" class="btn btn-sm btn-link p-0 text-decoration-none fw-medium">Voir détails &rarr;</a>
                                                }
                                            </div>
                                        </div>
                                    }
                                    @if(!recentNotifications.Any())
                                    {
                                        <div class="text-center p-4 text-muted">Aucune activité récente.</div>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="glass-panel p-4 mb-4">
                                <div class="mb-4">
                                    <h5 class="mb-0 fw-bold text-gradient">Actions Rapides</h5>
                                </div>
                                <div class="d-grid gap-2">
                                    <a href="clients" class="btn btn-light shadow-sm text-start py-3 px-3 d-flex align-items-center hover-scale">
                                        <i class="bi bi-people me-3 text-primary fs-5"></i> <span class="fw-medium">Gérer les Clients</span>
                                    </a>
                                    <a href="colis/create" class="btn btn-light shadow-sm text-start py-3 px-3 d-flex align-items-center hover-scale">
                                        <i class="bi bi-plus-circle me-3 text-success fs-5"></i> <span class="fw-medium">Nouveau Colis</span>
                                    </a>
                                    <a href="vehicule/create" class="btn btn-light shadow-sm text-start py-3 px-3 d-flex align-items-center hover-scale">
                                        <i class="bi bi-car-front me-3 text-info fs-5"></i> <span class="fw-medium">Nouveau Véhicule</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </AuthorizeView>

                @if(showAdminMissingDocsModal)
                {
                    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5); z-index: 1055;" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-danger text-white">
                                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>Documents Manquants (Global)</h5>
                                    <button type="button" class="btn-close btn-close-white" @onclick="CloseAdminMissingDocsModal"></button>
                                </div>
                                <div class="modal-body p-0">
                                    <div class="list-group list-group-flush">
                                        @foreach(var doc in adminMissingDocsList)
                                        {
                                            string link = "#";
                                            if(doc.ColisId.HasValue) link = $"colis/detail/{doc.ColisId}?tab=docs";
                                            else if(doc.VehiculeId.HasValue) link = $"vehicule/detail/{doc.VehiculeId}?tab=docs";
                                            
                                            <a href="@link" class="list-group-item list-group-item-action p-3">
                                                <div class="d-flex w-100 justify-content-between">
                                                    <div>
                                                        <h6 class="mb-1 fw-bold text-danger">@doc.Type</h6>
                                                        <small class="text-muted"><i class="bi bi-person me-1"></i>Client: <strong>@doc.Client?.NomComplet</strong></small>
                                                    </div>
                                                    <div class="d-flex flex-column align-items-end gap-2">
                                                        <small class="text-danger fw-bold">Manquant</small>
                                                        <button class="btn btn-sm btn-outline-danger" @onclick:preventDefault @onclick="@(() => SendReminder(doc))" title="Relancer le client">
                                                            <i class="bi bi-envelope-exclamation"></i> Relancer
                                                        </button>
                                                    </div>
                                                </div>
                                                <p class="mb-1 text-muted small mt-1">@doc.CommentaireAdmin</p>
                                                <div class="d-flex justify-content-between align-items-center mt-2">
                                                    <small class="text-primary badge bg-light border">
                                                        @(doc.ColisId.HasValue ? $"Colis: {doc.Colis?.NumeroReference}" : (doc.VehiculeId.HasValue ? $"Véhicule: {doc.Vehicule?.Immatriculation}" : "Dossier"))
                                                    </small>
                                                    <small class="text-muted">@doc.DateCreation.ToString("dd/MM/yyyy")</small>
                                                </div>
                                            </a>
                                        }
                                        @if(!adminMissingDocsList.Any())
                                        {
                                            <div class="p-4 text-center text-muted">Aucun document manquant.</div>
                                        }
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" @onclick="CloseAdminMissingDocsModal">Fermer</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <AuthorizeView Roles="Client" Context="ClientCtx">
                    <!-- DASHBOARD CLIENT -->
                     <div class="row g-4 mb-4">
                        <!-- ALERTES (Call to Action) -->
                        <div class="col-md-8">
                            <div class="glass-panel p-4 h-100">
                                <h5 class="mb-4 fw-bold text-gradient">À Faire (Call to Action)</h5>
                                
                                @if (missingDocsCount > 0)
                                {
                                    <div class="d-flex align-items-center p-3 mb-3 rounded-3 shadow-sm bg-white border-start border-4 border-danger">
                                        <div class="rounded-circle p-2 bg-danger bg-opacity-10 text-danger me-3">
                                            <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="fw-bold mb-1 text-danger">Documents Manquants</h6>
                                            <p class="mb-0 small text-muted">Vous avez <strong>@missingDocsCount document(s) à fournir</strong>.</p>
                                        </div>
                                        <button @onclick="OpenRegularizeModal" class="btn btn-sm btn-danger rounded-pill px-3 shadow-sm">
                                            Régulariser
                                        </button>
                                    </div>
                                }
                                else
                                {
                                     <div class="d-flex align-items-center p-3 mb-3 rounded-3 shadow-sm bg-white border-start border-4 border-success">
                                        <div class="rounded-circle p-2 bg-success bg-opacity-10 text-success me-3">
                                            <i class="bi bi-check-circle-fill fs-4"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="fw-bold mb-1 text-success">Tout est à jour</h6>
                                            <p class="mb-0 small text-muted">Aucun document manquant pour vos dossiers en cours.</p>
                                        </div>
                                    </div>
                                }

                                <!-- Solde à régler -->
                                 <div class="d-flex align-items-center p-3 rounded-3 shadow-sm bg-white border-start border-4 border-warning">
                                    <div class="rounded-circle p-2 bg-warning bg-opacity-10 text-warning me-3">
                                        <i class="bi bi-wallet2 fs-4"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold mb-1 text-dark">Solde à régler</h6>
                                        @if(pendingPaymentAmount > 0)
                                        {
                                             <p class="mb-0 small text-muted">Solde impayé : <strong>@pendingPaymentAmount.ToString("C")</strong></p>
                                        }
                                        else
                                        {
                                             <p class="mb-0 small text-muted">Vos comptes sont à jour.</p>
                                        }
                                    </div>
                                     <a href="finance" class="btn btn-sm btn-warning text-dark rounded-pill px-3 shadow-sm fw-medium">Voir Détails</a>
                                </div>
                            </div>
                        </div>

                        <!-- Résumé Cards -->
                         <div class="col-md-4">
                             <div class="d-flex flex-column gap-3 h-100">
                                <a href="my-parcels" class="text-decoration-none">
                                    <DashboardCard Title="Colis en cours" Value="@myColis.Count().ToString()" Icon="bi bi-box-seam" Color="primary" />
                                </a>
                                <a href="my-vehicles" class="text-decoration-none">
                                    <DashboardCard Title="Véhicules en transit" Value="@myVehicules.Count().ToString()" Icon="bi bi-car-front" Color="info" />
                                </a>
                             </div>
                        </div>
                    </div>

                    <div class="row g-4">
                        <!-- COLIS -->
                        <div class="col-md-6">
                            <div class="glass-panel p-4 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="fw-bold text-gradient mb-0"><i class="bi bi-box-seam me-2"></i>Mes Derniers Colis</h5>
                                    <a href="my-parcels" class="small text-muted text-decoration-none hover-underline">Tout voir &rarr;</a>
                                </div>
                                <div class="list-group list-group-flush rounded-3">
                                    @foreach(var colis in myColis.Take(3))
                                    {
                                         <a href="colis/detail/@colis.Id" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3 border-0 border-bottom bg-transparent">
                                            <div>
                                                <div class="fw-bold text-dark">@colis.Designation</div>
                                                <div class="small text-muted">@colis.NumeroReference • @colis.DestinationFinale</div>
                                            </div>
                                            <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill border border-primary border-opacity-10">@colis.Statut</span>
                                        </a>
                                    }
                                    @if(!myColis.Any())
                                    {
                                        <div class="text-center text-muted p-4">Aucun colis récent.</div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- VEHICULES -->
                        <div class="col-md-6">
                             <div class="glass-panel p-4 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="fw-bold text-gradient mb-0"><i class="bi bi-car-front me-2"></i>Mes Derniers Véhicules</h5>
                                    <a href="my-vehicles" class="small text-muted text-decoration-none hover-underline">Tout voir &rarr;</a>
                                </div>
                                 <div class="list-group list-group-flush rounded-3">
                                    @foreach(var v in myVehicules.Take(3))
                                    {
                                         <a href="vehicule/detail/@v.Id" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3 border-0 border-bottom bg-transparent">
                                            <div>
                                                <div class="fw-bold text-dark">@v.Marque @v.Modele</div>
                                                <div class="small text-muted">@v.Immatriculation</div>
                                            </div>
                                            <span class="badge bg-info bg-opacity-10 text-info rounded-pill border border-info border-opacity-10">@v.Statut</span>
                                        </a>
                                    }
                                    @if(!myVehicules.Any())
                                    {
                                        <div class="text-center text-muted p-4">Aucun véhicule récent.</div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                </AuthorizeView>
            }
        </div>
        
        <!-- MODAL DOCUMENTS MANQUANTS -->
        @if(showMissingDocsModal)
        {
            <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>Documents Manquants</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CloseRegularizeModal"></button>
                    </div>
                    <div class="modal-body p-0">
                            <div class="list-group list-group-flush">
                                @foreach(var doc in missingDocsList)
                                {
                                    string link = "#";
                                    if(doc.ColisId.HasValue) link = $"colis/detail/{doc.ColisId}?tab=docs";
                                    else if(doc.VehiculeId.HasValue) link = $"vehicule/detail/{doc.VehiculeId}?tab=docs";
                                    
                                    <a href="@link" class="list-group-item list-group-item-action p-3">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1 fw-bold">@doc.Type</h6>
                                            <small class="text-danger fw-bold">Manquant</small>
                                        </div>
                                        <p class="mb-1 text-muted small">@doc.CommentaireAdmin</p>
                                        <small class="text-primary">
                                            @(doc.ColisId.HasValue ? "Colis" : (doc.VehiculeId.HasValue ? "Véhicule" : "Dossier"))
                                        </small>
                                    </a>
                                }
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseRegularizeModal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if(_showDelayedItemsModal)
        {
            <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title">📦 Éléments en Retard (> 5 jours)</h5>
                            <button type="button" class="btn-close" @onclick="() => _showDelayedItemsModal = false"></button>
                        </div>
                        <div class="modal-body p-0">
                            @if(_delayedItems == null)
                            {
                                <div class="p-4 text-center"><div class="spinner-border text-warning"></div></div>
                            }
                            else
                            {
                                <div class="list-group list-group-flush">
                                    @foreach(var item in _delayedItems)
                                    {
                                         var link = item.Type == "Colis" ? $"colis/detail/{item.Id}" : $"vehicule/detail/{item.Id}";
                                         <a href="@link" class="list-group-item list-group-item-action p-3">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1 fw-bold">@item.Reference - @item.Description</h6>
                                                <small class="text-danger fw-bold">@item.DaysDelay j</small>
                                            </div>
                                            <p class="mb-1 text-muted small">@item.ClientName</p>
                                            <small class="text-muted">@item.Type • Créé le @item.DateCreation.ToString("dd/MM/yyyy")</small>
                                         </a>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        @if(_showNewClientsModal)
        {
            <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">👥 Nouveaux Clients (Ce mois)</h5>
                            <button type="button" class="btn-close btn-close-white" @onclick="() => _showNewClientsModal = false"></button>
                        </div>
                         <div class="modal-body p-0">
                            @if(_newClientsList == null)
                            {
                                <div class="p-4 text-center"><div class="spinner-border text-info"></div></div>
                            }
                            else
                            {
                                <div class="list-group list-group-flush">
                                    @foreach(var client in _newClientsList)
                                    {
                                         <a href="client/edit/@client.Id" class="list-group-item list-group-item-action p-3">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1 fw-bold">@client.NomComplet</h6>
                                                <small class="text-muted">@client.DateCreation.ToString("dd/MM")</small>
                                            </div>
                                            <p class="mb-1 text-muted small">@client.Email • @client.TelephonePrincipal</p>
                                         </a>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </Authorized>
    <NotAuthorized>
        <PublicHomepage />
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool isLoading = true;
    private UserProfileDto? userProfile;
    
    // Stats Admin
    private AdminDashboardStatsDto? adminStats;
    private List<Notification> recentNotifications = new();

    // Stats Client
    private int missingDocsCount = 0;
    private decimal pendingPaymentAmount = 0; // Ajout
    private IEnumerable<ColisListItemDto> myColis = new List<ColisListItemDto>();

    private IEnumerable<VehiculeListItemDto> myVehicules = new List<VehiculeListItemDto>();
    // private string regularizeUrl = "/"; // REMOVED
    
    // Missing Docs Modal
    private bool showMissingDocsModal = false;

    private IEnumerable<Document> missingDocsList = new List<Document>();

    // Admin Missing Docs Modal
    private bool showAdminMissingDocsModal = false;
    private IEnumerable<Document> adminMissingDocsList = new List<Document>();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                userProfile = await ApiService.GetUserProfileAsync();
                
                if (user.IsInRole("Administrateur") || user.IsInRole("Gestionnaire"))
                {
                    // Charger Stats Admin
                    recentNotifications = (await ApiService.GetMyNotificationsAsync())?.Take(5).ToList() ?? new();
                    adminStats = await ApiService.GetAdminDashboardStatsAsync();
                }
                else if (user.IsInRole("Client"))
                {
                    // Charger Données Client
                    if (userProfile?.ClientId != null && userProfile.ClientId != Guid.Empty)
                    {
                        missingDocsCount = await ApiService.GetMissingDocumentsCountAsync(userProfile.ClientId);
                        myColis = await ApiService.GetMyColisAsync() ?? new List<ColisListItemDto>();
                        myVehicules = await ApiService.GetVehiculesAsync() ?? new List<VehiculeListItemDto>();
                        pendingPaymentAmount = await ApiService.GetClientBalanceAsync(userProfile.ClientId);
                        
                        // Pre-load missing docs list if any
                        if(missingDocsCount > 0)
                        {
                            missingDocsList = await ApiService.GetMissingDocumentsAsync(userProfile.ClientId);
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur Dashboard: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadData()
    {
        isLoading = true;
        await OnInitializedAsync();
    }

    private void OpenRegularizeModal()
    {
        if(missingDocsList.Count() == 1)
        {
            // Direct redirect if only 1
            var doc = missingDocsList.First();
            if(doc.ColisId.HasValue) nav.NavigateTo($"colis/detail/{doc.ColisId}?tab=docs");
            else if(doc.VehiculeId.HasValue) nav.NavigateTo($"vehicule/detail/{doc.VehiculeId}?tab=docs");
            else showMissingDocsModal = true;
        }
        else
        {
            showMissingDocsModal = true;
        }
    }

    private async Task SendReminder(Document doc)
    {
        if(doc == null) return;
        
        bool confirmed = await JS.InvokeAsync<bool>("confirm", $"Relancer {doc.Client?.NomComplet} pour le document {doc.Type} ?");
        if(confirmed)
        {
            try
            {
                await ApiService.SendDocumentReminderAsync(doc.Id);
                await JS.InvokeVoidAsync("alert", "Relance envoyée par email.");
            }
            catch(Exception ex)
            {
                 await JS.InvokeVoidAsync("alert", "Erreur lors de l'envoi de la relance.");
                 Console.WriteLine(ex.Message);
            }
        }
    }
    
    private void CloseRegularizeModal() => showMissingDocsModal = false;

    private async Task ShowMissingDocsAdmin()
    {
        adminMissingDocsList = await ApiService.GetAllMissingDocumentsAsync();
        
        if (adminMissingDocsList.Count() == 1)
        {
             var doc = adminMissingDocsList.First();
             if(doc.ColisId.HasValue) nav.NavigateTo($"colis/detail/{doc.ColisId}?tab=docs");
             else if(doc.VehiculeId.HasValue) nav.NavigateTo($"vehicule/detail/{doc.VehiculeId}?tab=docs");
             else showAdminMissingDocsModal = true;
        }
        else if (adminMissingDocsList.Any())
        {
            showAdminMissingDocsModal = true;
        }
    }

    private void CloseAdminMissingDocsModal() => showAdminMissingDocsModal = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (adminStats != null && !isLoading)
        {
            // Initialiser les Charts via JS
            // On utilise un petit délai pour être sûr que le rendu DOM est fini si besoin (normalement OnAfterRender suffit)
            
            // Chart Revenus & Volume (Mixed Chart)
            var ctxRevenue = new {
                labels = adminStats.RevenueLast6Months.Select(x => x.Month).ToArray(),
                datasets = new object[]
                {
                    new {
                        type = "bar",
                        label = "Revenu (€)",
                        data = adminStats.RevenueLast6Months.Select(x => x.Value).ToArray(),
                        backgroundColor = "rgba(13, 110, 253, 0.5)",
                        borderColor = "rgb(13, 110, 253)",
                        borderWidth = 1
                    },
                    new {
                        type = "line",
                        label = "Volume (m³)",
                        data = adminStats.VolumeLast6Months.Select(x => x.Value).ToArray(),
                        borderColor = "rgb(25, 135, 84)", // Success color
                        backgroundColor = "rgba(25, 135, 84, 0.1)",
                        yAxisID = "y1",
                        fill = true
                    }
                }
            };
            
            var optionsRevenue = new {
                responsive = true,
                scales = new {
                    y = new { beginAtZero = true, type = "linear", position = "left" },
                    y1 = new { beginAtZero = true, type = "linear", position = "right", grid = new { drawOnChartArea = false } }
                }
            };

            await JS.InvokeVoidAsync("renderChart", "revenueChart", "bar", ctxRevenue, optionsRevenue);

            // Chart Status (Doughnut)
            var ctxStatus = new {
                labels = adminStats.StatusDistribution.Keys.ToArray(),
                datasets = new object[]
                {
                    new {
                        data = adminStats.StatusDistribution.Values.ToArray(),
                        backgroundColor = new [] {
                            "#0d6efd", "#ffc107", "#0dcaf0", "#198754", "#dc3545", "#6c757d"
                        }
                    }
                }
            };

             await JS.InvokeVoidAsync("renderChart", "statusChart", "doughnut", ctxStatus, new { responsive = true });
        }
    }
    private bool _showDelayedItemsModal = false;
    private List<DashboardEntityDto> _delayedItems;
    private bool _showNewClientsModal = false;
    private List<Client> _newClientsList;

    private async Task ShowDelayedItemsModal()
    {
        _showDelayedItemsModal = true;
        try
        {
            _delayedItems = await ApiService.GetDelayedItemsAsync();
        }
        catch(Exception ex)
        {
            Console.WriteLine($"Error loading delayed items: {ex.Message}");
            _delayedItems = new List<DashboardEntityDto>(); // Empty list to stop spinner
        }
    }

    private async Task ShowNewClientsModal()
    {
        _showNewClientsModal = true;
        try
        {
            _newClientsList = await ApiService.GetNewClientsListAsync();
        }
        catch(Exception ex)
        {
             Console.WriteLine($"Error loading new clients: {ex.Message}");
            _newClientsList = new List<Client>(); 
        }
    }
}