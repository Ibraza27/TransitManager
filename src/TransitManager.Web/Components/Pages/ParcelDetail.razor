@page "/colis/edit/{Id:guid}"
@page "/colis/create"
@using System.Text.Json
@using TransitManager.Core.DTOs
@using TransitManager.Core.Entities
@using TransitManager.Core.Enums
@using System.Security.Claims
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@using TransitManager.Web.Components.Shared

<PageTitle>@(IsNew ? "Nouveau Colis" : "Détail Colis") - Hippocampe</PageTitle>

<div class="container mt-4 mb-5">
    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary">
                <i class="bi @(IsNew ? "bi-plus-circle" : "bi-box-seam") me-2"></i>
                @(IsNew ? "Nouveau Colis" : "Détail du Colis")
            </h2>
            @if (!IsNew)
            {
                <span class="badge @GetStatusBadgeClass(_colis.Statut)">@_colis.Statut</span>
                <span class="text-muted ms-2 small">Ref: @_colis.NumeroReference</span>
            }
        </div>
        <div class="d-flex gap-2">
             <!-- Boutons d'actions transverses -->
            <button class="btn btn-outline-secondary" @onclick="ShowInventory">
                <i class="bi bi-clipboard-list me-2"></i>Inventaire
            </button>
            
            @if (!IsNew) // Paiement seulement si le colis existe
            {
                <button class="btn btn-outline-success" @onclick="ShowPayments">
                    <i class="bi bi-cash-coin me-2"></i>Paiements
                </button>
            }

            <button class="btn btn-primary" @onclick="SaveParcel" disabled="@(!CanEditGlobal)">
                <i class="bi bi-save me-2"></i>Enregistrer
            </button>
            <a href="/my-parcels" class="btn btn-outline-dark">Retour</a>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
    }
    else
    {
        <div class="row g-4">
            <!-- COLONNE GAUCHE : INFO GÉNÉRALES -->
            <div class="col-lg-8">
                <!-- Carte Client & Infos -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white py-3"><h5 class="mb-0 text-primary"><i class="bi bi-person-badge me-2"></i>Propriétaire & Infos</h5></div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Client : Auto-rempli pour client, Recherche pour Admin -->
                            <div class="col-12">
                                <label class="form-label fw-bold">Client Propriétaire</label>
                                @if (IsAdmin)
                                {
                                    <!-- Recherche Client Admin -->
                                    <div class="input-group">
                                        <input type="text" class="form-control" placeholder="Rechercher un client..." 
                                               @bind="_clientSearch" @bind:event="oninput" @onkeyup="FilterClients" />
                                        @if(_filteredClients.Any())
                                        {
                                            <div class="dropdown-menu show w-100" style="max-height: 200px; overflow-y: auto;">
                                                @foreach(var c in _filteredClients)
                                                {
                                                    <button class="dropdown-item" @onclick="() => SelectClient(c)">
                                                        @c.NomComplet <small class="text-muted">(@c.TelephonePrincipal)</small>
                                                    </button>
                                                }
                                            </div>
                                        }
                                    </div>
                                    <div class="form-text text-primary mt-1">Actuel : <strong>@_clientNameDisplay</strong></div>
                                }
                                else
                                {
                                    <input type="text" class="form-control" value="@_clientNameDisplay" disabled />
                                }
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Désignation <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" @bind="_colis.Designation" disabled="@(!CanEditFields)" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Destination Finale <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" @bind="_colis.DestinationFinale" disabled="@(!CanEditFields)" />
                            </div>

                             <div class="col-12">
                                <label class="form-label">Code-barres</label>
                                <div class="input-group">
                                    <input type="text" class="form-control font-monospace" value="@_firstBarcode" readonly />
                                    @if (IsAdmin || IsNew)
                                    {
                                        <button class="btn btn-outline-secondary" @onclick="GenerateBarcode" disabled="@(!string.IsNullOrEmpty(_firstBarcode))">
                                            <i class="bi bi-upc-scan me-2"></i>Générer
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Carte Destinataire -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white py-3"><h5 class="mb-0 text-primary"><i class="bi bi-geo-alt me-2"></i>Destinataire</h5></div>
                    <div class="card-body">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="sameRecipient" 
                                   @bind="_sameAsClient" @onclick="ToggleSameAsClient" disabled="@(!CanEditFields)">
                            <label class="form-check-label" for="sameRecipient">Destinataire identique au propriétaire</label>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nom Destinataire</label>
                                <input type="text" class="form-control" @bind="_colis.Destinataire" disabled="@(_sameAsClient || !CanEditFields)" />
                            </div>
                             <div class="col-md-6">
                                <label class="form-label">Téléphone Destinataire</label>
                                <input type="text" class="form-control" @bind="_colis.TelephoneDestinataire" disabled="@(_sameAsClient || !CanEditFields)" />
                            </div>
                        </div>

                        <hr />

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="homeDelivery" @bind="_colis.LivraisonADomicile" disabled="@(!CanEditFields)">
                            <label class="form-check-label" for="homeDelivery">Livraison à domicile</label>
                        </div>

                         <div class="mb-3">
                            <label class="form-label">Adresse de Livraison</label>
                            <textarea class="form-control" rows="2" @bind="_colis.AdresseLivraison" disabled="@(!_colis.LivraisonADomicile || !CanEditFields)"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Options & Instructions -->
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white py-3"><h5 class="mb-0 text-primary"><i class="bi bi-sliders me-2"></i>Options</h5></div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Type de Colis</label>
                                <select class="form-select" @bind="_colis.Type" disabled="@(!CanEditFields)">
                                    @foreach (var type in Enum.GetValues<TypeColis>()) { <option value="@type">@type</option> }
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Option d'envoi</label>
                                <select class="form-select" @bind="_colis.TypeEnvoi" disabled="@(!CanEditFields)">
                                    @foreach (var type in Enum.GetValues<TypeEnvoi>()) { <option value="@type">@type</option> }
                                </select>
                            </div>
                            <div class="col-12 mt-3">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="fragile" @bind="_colis.EstFragile" disabled="@(!CanEditFields)">
                                    <label class="form-check-label text-danger fw-bold" for="fragile"><i class="bi bi-exclamation-triangle me-1"></i>Fragile</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="special" @bind="_colis.ManipulationSpeciale" disabled="@(!CanEditFields)">
                                    <label class="form-check-label" for="special">Manipulation Spéciale</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Instructions Spécifiques</label>
                                <textarea class="form-control" rows="2" @bind="_colis.InstructionsSpeciales" disabled="@(!CanEditFields)"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLONNE DROITE : ADMIN & FINANCES -->
            <div class="col-lg-4">
                <!-- Statut (Admin Only ou ReadOnly) -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white py-3"><h5 class="mb-0 text-secondary">Administration</h5></div>
                    <div class="card-body bg-light">
                        <label class="form-label small fw-bold">STATUT</label>
                        <select class="form-select mb-3" @bind="_colis.Statut" disabled="@(!IsAdmin)">
                             @foreach (var s in Enum.GetValues<StatutColis>()) { <option value="@s">@s</option> }
                        </select>
                        
                        <!-- Conteneur (Admin Only) -->
                        <label class="form-label small fw-bold">CONTENEUR</label>
                        @if (IsAdmin)
                        {
                             <select class="form-select" @bind="_colis.ConteneurId">
                                 <option value="">-- Non assigné --</option>
                                 @foreach(var c in _containers) { <option value="@c.Id">@c.NumeroDossier</option> }
                             </select>
                        }
                        else
                        {
                             <input type="text" class="form-control" value="@(_containers.FirstOrDefault(c => c.Id == _colis.ConteneurId)?.NumeroDossier ?? "Non assigné")" disabled />
                        }
                    </div>
                </div>

                <!-- Finances & Calculateur -->
                <div class="card shadow-sm border-0 border-top border-3 border-success">
                    <div class="card-header bg-white py-3"><h5 class="mb-0 text-success"><i class="bi bi-currency-euro me-2"></i>Finances</h5></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Nombre de pièces</label>
                            <input type="number" class="form-control" value="@_colis.NombrePieces" disabled /> <!-- Calculé via Inventaire -->
                        </div>
						
						<div class="mb-3">
							<label class="form-label">Valeur Déclarée (€)</label>
							<input type="number" class="form-control" @bind="_colis.ValeurDeclaree" disabled />
							<div class="form-text small">Calculée via l'inventaire</div>
						</div>
                        
                        <div class="mb-3">
                            <label class="form-label">Volume (m³)</label>
                            <input type="number" class="form-control" @bind="_colis.Volume" disabled="@(!IsAdmin)" />
                        </div>
                        
                        <hr class="text-muted" />
                        
                        @if (IsAdmin)
                        {
                            <!-- Calculateur Rapide -->
                             <div class="input-group mb-3">
                                <span class="input-group-text bg-light">Prix/m³</span>
                                <input type="number" class="form-control" @bind="_pricePerM3" @bind:after="CalculatePrice" placeholder="0.00" />
                            </div>
                        }

                        <div class="mb-3">
                            <label class="form-label fw-bold text-primary">PRIX TOTAL (€)</label>
                            <input type="number" class="form-control form-control-lg fw-bold text-primary" @bind="_colis.PrixTotal" disabled="@(!IsAdmin)" />
                        </div>
                        
                         <div class="d-flex justify-content-between small mb-2">
                             <span>Payé :</span>
                             <span class="text-success fw-bold">@_colis.SommePayee.ToString("C2")</span>
                         </div>
                         <div class="d-flex justify-content-between fw-bold fs-5">
                             <span>Reste :</span>
                             <span class="text-danger">@_colis.RestantAPayer.ToString("C2")</span>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    }
    
    <!-- MODALS -->
    <InventoryModal IsVisible="_showInventory" 
                    IsReadOnly="@(!CanEditFields)"
                    JsonData="@_colis.InventaireJson" 
                    OnSave="SaveInventory"
                    OnClose="() => _showInventory = false" />

    <PaymentModal IsVisible="_showPayments"
                  IsAdmin="@IsAdmin"
                  ColisId="@_colis.Id"
                  ClientId="@_colis.ClientId"
                  TotalAmount="@_colis.PrixTotal"
                  OnPaymentsChanged="UpdatePaidAmount"
                  OnClose="() => _showPayments = false" />

</div>

@code {
    [Parameter] public Guid? Id { get; set; }

    private Colis _colis = new() { DateArrivee = DateTime.UtcNow, Statut = StatutColis.EnAttente };
    private bool _isLoading = true;
    private bool IsNew => Id == null;
    
    // Contexte Utilisateur
    private bool IsAdmin = false;
    private Guid CurrentUserId;
    
    // UI State
    private string _clientNameDisplay = "";
    private string _firstBarcode = "";
    private bool _sameAsClient = false;
    private bool _showInventory = false;
    private bool _showPayments = false;
    private decimal _pricePerM3 = 0;
    
    // Admin Search
    private string _clientSearch = "";
    private List<Client> _filteredClients = new();
    private List<Conteneur> _containers = new();

    // Logic Permissions
    // Admin peut tout faire.
    // Client peut éditer SI c'est son colis ET statut EnAttente.
    private bool CanEditGlobal => IsAdmin || (IsNew || _colis.Statut == StatutColis.EnAttente);
    private bool CanEditFields => IsAdmin || (CanEditGlobal); // Ici, c'est pareil pour les champs autorisés au client

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        IsAdmin = user.IsInRole("Administrateur");
        var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);
        if (userIdClaim != null) Guid.TryParse(userIdClaim.Value, out CurrentUserId);

        if (IsAdmin)
        {
             _containers = (await ApiService.GetConteneursAsync())?.ToList() ?? new();
        }

        if (!IsNew)
        {
            // Mode Édition
            var dto = await ApiService.GetColisByIdAsync(Id.Value);
            if (dto != null) _colis = dto;
            
            // Check si user a le droit de voir ce colis (sécurité front)
            // Note: l'API doit aussi sécuriser cela.
            
            _clientNameDisplay = _colis.Client?.NomComplet ?? "Inconnu";
            _firstBarcode = _colis.Barcodes.FirstOrDefault()?.Value ?? "";
        }
        else
        {
            // Mode Création
            if (!IsAdmin)
            {
                // Client : Auto-assignation
                // Il faut récupérer le ClientId via l'API profile ou stocké
                var profile = await ApiService.GetUserProfileAsync();
                if (profile != null)
                {
                    _colis.ClientId = profile.ClientId;
                    _clientNameDisplay = $"{profile.Nom} {profile.Prenom}";
                    await GenerateBarcode(); // Auto-générer pour le client
                    _sameAsClient = true;
                    ToggleSameAsClient(); // Pré-remplir destinataire
                }
            }
        }
        
        _isLoading = false;
    }

    // Gestion Client Admin
    private async Task FilterClients(KeyboardEventArgs e)
    {
        if (string.IsNullOrEmpty(_clientSearch) || _clientSearch.Length < 2) 
        {
            _filteredClients.Clear(); return;
        }
        // Note: Idéalement faire une recherche API serveur, ici on simule si on a pas l'endpoint search
        // Si vous avez GetClientsAsync() qui renvoie tout, on filtre en mémoire (ok pour < 1000 clients)
        var allClients = await ApiService.GetClientsAsync();
        if (allClients != null)
        {
            _filteredClients = allClients.Where(c => c.NomComplet.Contains(_clientSearch, StringComparison.OrdinalIgnoreCase)).Take(5).ToList();
        }
    }

    private void SelectClient(Client client)
    {
        _colis.ClientId = client.Id;
        _clientNameDisplay = client.NomComplet;
        _filteredClients.Clear();
        _clientSearch = "";
    }

    // Logique Métier
    private async Task GenerateBarcode()
    {
        var code = await ApiService.GenerateBarcodeAsync();
        if (!string.IsNullOrEmpty(code))
        {
            _firstBarcode = code;
            // On l'ajoute à la liste des barcodes du colis au moment de la sauvegarde
        }
    }

    private void ToggleSameAsClient()
    {
        if (_sameAsClient)
        {
            // Si Admin, on ne peut pas deviner les infos client si on ne les a pas chargées complètement
            // Si Client connecté, on les a via le profil.
            // Pour simplifier, on copie juste le nom affiché
            _colis.Destinataire = _clientNameDisplay;
            // _colis.TelephoneDestinataire = ... (nécessiterait l'objet Client complet)
        }
    }
    
    private void CalculatePrice()
    {
        if(_colis.Volume > 0 && _pricePerM3 > 0)
        {
            _colis.PrixTotal = _colis.Volume * _pricePerM3;
        }
    }

    // Gestion Modals
    private void ShowInventory() => _showInventory = true;
	private void SaveInventory(string json)
    {
        _colis.InventaireJson = json;
        _showInventory = false;

        // --- AJOUT : Calcul automatique des totaux ---
        if (!string.IsNullOrEmpty(json))
        {
            try
            {
                var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                var items = JsonSerializer.Deserialize<List<InventaireItem>>(json, options);

                if (items != null && items.Any())
                {
                    // Mise à jour des champs du colis
                    _colis.NombrePieces = items.Sum(i => i.Quantite);
                    
                    // On suppose que la "Valeur" dans l'inventaire est la valeur totale de la ligne
                    // Si votre logique métier est "Valeur Unitaire", faites : Sum(i => i.Quantite * i.Valeur)
                    // Ici on fait une somme simple des valeurs déclarées par ligne
                    _colis.ValeurDeclaree = items.Sum(i => i.Valeur);
                }
            }
            catch 
            { 
                // Ignorer si erreur de calcul, on garde les anciennes valeurs
            }
        }
    }

    private void ShowPayments() => _showPayments = true;
    private void UpdatePaidAmount(decimal totalPaid)
    {
        _colis.SommePayee = totalPaid;
    }

    // Sauvegarde
    private async Task SaveParcel()
    {
        // Préparation DTO
        var barcodesList = new List<string>();
        if(!string.IsNullOrEmpty(_firstBarcode)) barcodesList.Add(_firstBarcode);
        
        // Mapping manuel vers Create/Update DTO
        if (IsNew)
        {
            var createDto = new CreateColisDto
            {
                ClientId = _colis.ClientId,
                Designation = _colis.Designation,
                DestinationFinale = _colis.DestinationFinale,
                Barcodes = barcodesList,
                // ... mapper autres champs
                Type = _colis.Type,
                TypeEnvoi = _colis.TypeEnvoi,
                EstFragile = _colis.EstFragile,
                ManipulationSpeciale = _colis.ManipulationSpeciale,
                InstructionsSpeciales = _colis.InstructionsSpeciales,
                Destinataire = _colis.Destinataire,
                TelephoneDestinataire = _colis.TelephoneDestinataire,
                LivraisonADomicile = _colis.LivraisonADomicile,
                AdresseLivraison = _colis.AdresseLivraison,
                InventaireJson = _colis.InventaireJson,
                // Admin fields
                Volume = IsAdmin ? _colis.Volume : 0,
                PrixTotal = IsAdmin ? _colis.PrixTotal : 0,
                ConteneurId = IsAdmin ? _colis.ConteneurId : null
            };
            await ApiService.CreateColisAsync(createDto);
        }
        else
        {
            var updateDto = new UpdateColisDto
            {
                Id = _colis.Id,
                ClientId = _colis.ClientId,
                Designation = _colis.Designation,
                DestinationFinale = _colis.DestinationFinale,
                Barcodes = _colis.Barcodes.Select(b => b.Value).ToList(), // Garder existants
                Statut = _colis.Statut, // Admin peut changer
                // ... mapper reste comme create
                 Type = _colis.Type,
                TypeEnvoi = _colis.TypeEnvoi,
                EstFragile = _colis.EstFragile,
                ManipulationSpeciale = _colis.ManipulationSpeciale,
                InstructionsSpeciales = _colis.InstructionsSpeciales,
                Destinataire = _colis.Destinataire,
                TelephoneDestinataire = _colis.TelephoneDestinataire,
                LivraisonADomicile = _colis.LivraisonADomicile,
                AdresseLivraison = _colis.AdresseLivraison,
                InventaireJson = _colis.InventaireJson,
                Volume = _colis.Volume,
                PrixTotal = _colis.PrixTotal,
                ConteneurId = _colis.ConteneurId,
                SommePayee = _colis.SommePayee
            };
            // Si nouveau barcode généré en edit
            if(!string.IsNullOrEmpty(_firstBarcode) && !updateDto.Barcodes.Contains(_firstBarcode))
            {
                updateDto.Barcodes.Add(_firstBarcode);
            }
            
            await ApiService.UpdateColisAsync(_colis.Id, updateDto);
        }
        
        Navigation.NavigateTo("/my-parcels");
    }
	
	private string GetStatusBadgeClass(StatutColis status)
	{
		return status switch
		{
			StatutColis.EnAttente => "bg-warning text-dark",
			StatutColis.Affecte => "bg-info text-dark",
			StatutColis.EnTransit => "bg-primary",
			StatutColis.Arrive => "bg-info",
			StatutColis.EnDedouanement => "bg-secondary",
			StatutColis.Livre => "bg-success",
			StatutColis.Probleme => "bg-danger",
			StatutColis.Perdu => "bg-dark",
			_ => "bg-secondary"
		};
	}
	
}