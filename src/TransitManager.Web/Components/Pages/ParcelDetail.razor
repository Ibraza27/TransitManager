@page "/colis/edit/{Id:guid}"
@page "/colis/detail/{Id:guid}"
@page "/colis/create"
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using System.Text.Json
@using TransitManager.Core.Enums
@using TransitManager.Core.Interfaces
@using System.Security.Claims
@using TransitManager.Web.Components.Shared
@using System.Linq

@inject TransitManager.Web.Services.IApiService ApiService
@inject TransitManager.Infrastructure.Services.ISettingsService SettingsService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime

<PageTitle>@(IsNew ? "Nouveau Colis" : "D√©tail Colis") - Hippocampe</PageTitle>

<div class="container mt-4 mb-5">
    <!-- En-t√™te -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
        <div>
            <h2 class="fw-bold text-primary">
                <i class="bi @(IsNew ? "bi-plus-circle" : "bi-box-seam") me-2"></i>
                @(IsNew ? "Nouveau Colis" : "D√©tail du Colis")
            </h2>
            @if (!IsNew)
            {
                <span class="badge @GetStatusBadgeClass(_colis.Statut)">@_colis.Statut</span>
                <span class="text-muted ms-2 small">Ref: @_colis.NumeroReference</span>
            }
        </div>
		<div class="d-flex flex-wrap gap-2 position-relative w-100 w-md-auto">
            
             <!-- MENU EXPORT -->
            <div class="dropdown">
                <button class="btn btn-outline-danger dropdown-toggle" type="button" @onclick="ToggleExportMenu">
                    <i class="bi bi-file-earmark-pdf me-2"></i>PDF
                </button>
                <ul class="dropdown-menu @(_isExportMenuOpen ? "show" : "")" 
                    style="right: auto; left: 0; margin-top: 5px;">
                    <li>
                        <button class="dropdown-item" @onclick="() => ExportPdf(false, false)">
                            üìÑ Fiche Colis (Simple)
                        </button>
                    </li>
                    <li>
                        <button class="dropdown-item" @onclick="() => ExportPdf(true, false)">
                            üí∞ Re√ßu Financier (+ Prix)
                        </button>
                    </li>
                    <li>
                        <!-- NOUVELLE OPTION -->
                        <button class="dropdown-item" @onclick="() => ExportPdf(true, true)">
                            üì∏ Dossier Complet (+ Photos)
                        </button>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <button class="dropdown-item" @onclick='() => ExportTicket("thermal")'>
                            üè∑Ô∏è √âtiquette (Thermique)
                        </button>
                    </li>
                    <li>
                        <button class="dropdown-item" @onclick='() => ExportTicket("a4")'>
                            üñ®Ô∏è √âtiquette (Format A4)
                        </button>
                    </li>
                </ul>
                @if (_isExportMenuOpen)
                {
                    <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 900;" 
                         @onclick="ToggleExportMenu"></div>
                }
            </div>

             <!-- Boutons actions -->
            <button class="btn @(GetInventoryItemCount() == 0 ? "btn-outline-danger position-relative" : "btn-outline-secondary")" @onclick="ShowInventory">
                <i class="bi bi-clipboard-list me-2"></i>Inventaire
                @if(GetInventoryItemCount() == 0)
                {
                    <span class="position-absolute top-0 start-100 translate-middle p-2 bg-danger border border-light rounded-circle">
                        <span class="visually-hidden">Vide</span>
                    </span>
                }
            </button>
            
            @if (!IsNew)
            {
                <button class="btn btn-outline-success" @onclick="ShowPayments">
                    <i class="bi bi-cash-coin me-2"></i>Paiements
                </button>
            }
            <button class="btn btn-primary" @onclick="CheckInventoryAndSave" disabled="@(!CanEditGlobal)">
                <i class="bi bi-save me-2"></i>Enregistrer
            </button>
            <a href="/my-parcels" class="btn btn-outline-dark">Retour</a>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
    }
    else
    {
        <!-- TABS NAVIGATION -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <button class="nav-link @(_activeTab == "infos" ? "active fw-bold" : "")" @onclick='() => _activeTab = "infos"'>
                    Informations & Finances
                </button>
            </li>
             @if (!IsNew)
             {
                <li class="nav-item">
                    <button class="nav-link @(_activeTab == "documents" ? "active fw-bold" : "")" @onclick='() => _activeTab = "documents"'>
                        <i class="bi bi-folder2-open me-2"></i>Documents & Photos
                         @if (GetMissingDocumentsCount() > 0)
                        {
                            <span class="badge bg-danger rounded-pill ms-2">@GetMissingDocumentsCount()</span>
                        }
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(_activeTab == "suivi" ? "active fw-bold" : "")" @onclick='() => _activeTab = "suivi"'>
                         <i class="bi bi-clock-history me-2"></i>Suivi
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(_activeTab == "discussion" ? "active fw-bold" : "")" @onclick='() => _activeTab = "discussion"'>
                        <i class="bi bi-chat-left-text me-2"></i>Discussion
                        @if(_unreadMessagesCount > 0 && _activeTab != "discussion")
                        {
                            <span class="badge bg-danger rounded-pill ms-2">@_unreadMessagesCount</span>
                        }
                    </button>
                </li>
             }
            @if(!IsNew)
            {
                 <li class="nav-item">
                    <button class="nav-link @(_activeTab == "sav" ? "active fw-bold" : "")" @onclick='() => _activeTab = "sav"'>
                        <i class="bi bi-shield-check me-2"></i>SAV / Signalement
                         @if (_receptionControl != null)
                        {
                            <span class="badge rounded-pill ms-2 @(_receptionControl.Status == ReceptionStatus.ReceivedFull ? "bg-success" : "bg-danger")">
                                @(_receptionControl.Status == ReceptionStatus.ReceivedFull ? "OK" : "!")
                            </span>
                        }
                    </button>
                </li>
            }
        </ul>

        <div class="tab-content">
            
            <!-- ONGLET 1 : INFOS & FINANCES -->
            <div class="tab-pane fade @(_activeTab == "infos" ? "show active" : "")">
                <div class="row g-4">
                    <!-- COLONNE GAUCHE -->
                    <div class="col-lg-8">
                        <!-- Carte Client & Infos -->
                        <div class="card shadow-sm border-0 mb-4">
                            <div class="card-header bg-white py-3"><h5 class="mb-0 text-primary"><i class="bi bi-person-badge me-2"></i>Propri√©taire & Infos</h5></div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <!-- Client -->
                                    <div class="col-12">
                                        <label class="form-label fw-bold">Client Propri√©taire</label>
                                        @if (IsAdmin)
                                        {
                                            <div class="input-group">
                                                <input type="text" class="form-control" placeholder="Rechercher un client..." 
                                                       @bind="_clientSearch" @bind:event="oninput" @onkeyup="FilterClients" />
                                                @if(_filteredClients.Any())
                                                {
                                                    <div class="dropdown-menu show w-100" style="max-height: 200px; overflow-y: auto;">
                                                        @foreach(var c in _filteredClients)
                                                        {
                                                            <button class="dropdown-item" @onclick="() => SelectClient(c)">
                                                                @c.NomComplet <small class="text-muted">(@c.TelephonePrincipal)</small>
                                                            </button>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                            <div class="form-text text-primary mt-1">Actuel : <strong>@_clientNameDisplay</strong></div>
                                        }
                                        else
                                        {
                                            <div class="input-group">
                                                <input type="text" class="form-control" value="@_clientNameDisplay" disabled />
                                                <button class="btn btn-outline-secondary" type="button" @onclick="SearchClientByPhone">
                                                    <i class="bi bi-telephone-inbound"></i>
                                                </button>
                                            </div>
                                            <!-- NEW: Recherche invers√©e par t√©l√©phone pour admin/employ√© si besoin -->
                                        }
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">D√©signation <span class="text-danger">*</span> <small class="text-muted fst-italic ms-1">(Description g√©n√©rale : D√©m√©nagement, Effets personnels...)</small></label>
                                        <input type="text" class="form-control" @bind="_colis.Designation" disabled="@(!CanEditFields)" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Destination Finale <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" value="@_colis.DestinationFinale" @oninput="OnDestinationChanged" disabled="@(!CanEditFields)" />
                                    </div>
                                     <div class="col-12">
                                        <label class="form-label">Code-barres</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control font-monospace" value="@_firstBarcode" readonly />
                                            @if (IsAdmin || IsNew)
                                            {
                                                <button class="btn btn-outline-secondary" @onclick="GenerateBarcode" disabled="@(!string.IsNullOrEmpty(_firstBarcode))">
                                                    <i class="bi bi-upc-scan me-2"></i>G√©n√©rer
                                                </button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Carte Destinataire -->
                        <div class="card shadow-sm border-0 mb-4">
                            <div class="card-header bg-white py-3"><h5 class="mb-0 text-primary"><i class="bi bi-geo-alt me-2"></i>Destinataire</h5></div>
                            <div class="card-body">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="sameRecipient" 
                                           checked="@_sameAsClient" @onchange="OnSameAsClientCheckedChanged" disabled="@(!CanEditFields)">
                                    <label class="form-check-label" for="sameRecipient">Destinataire identique au propri√©taire</label>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Nom Destinataire</label>
                                        <input type="text" class="form-control" @bind="_colis.Destinataire" disabled="@(_sameAsClient || !CanEditFields)" />
                                    </div>
                                     <div class="col-md-6">
                                        <label class="form-label">T√©l√©phone Destinataire</label>
                                        <input type="text" class="form-control" @bind="_colis.TelephoneDestinataire" disabled="@(_sameAsClient || !CanEditFields)" />
                                    </div>
                                    
                                    <!-- ADRESSE FRANCE -->
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">Adresse en France</label>
                                            @if (CanEditFields)
                                            {
                                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="CopyAddressFrance" title="Copier l'adresse du profil">
                                                    <i class="bi bi-box-arrow-in-down me-1"></i>Copier du profil
                                                </button>
                                            }
                                        </div>
                                        <textarea class="form-control" rows="3" style="field-sizing: content; min-height: 80px;" @bind="_colis.AdresseFrance" disabled="@(!CanEditFields)"></textarea>
                                    </div>

                                    <!-- ADRESSE DESTINATION -->
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">@DestinationLabel</label>
                                            @if (CanEditFields)
                                            {
                                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="CopyAddressDestination" title="Copier l'adresse du profil">
                                                    <i class="bi bi-box-arrow-in-down me-1"></i>Copier du profil
                                                </button>
                                            }
                                        </div>
                                        <textarea class="form-control" rows="3" style="field-sizing: content; min-height: 80px;" @bind="_colis.AdresseDestination" disabled="@(!CanEditFields)"></textarea>
                                    </div>
                                </div>

                                <hr />
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="homeDelivery" @bind="_colis.LivraisonADomicile" disabled="@(!CanEditFields)">
                                    <label class="form-check-label" for="homeDelivery">Livraison √† domicile</label>
                                </div>
                                 <div class="mb-3">

                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <label class="form-label mb-0">Adresse de Livraison</label>
                                        @if (CanEditFields && _colis.LivraisonADomicile)
                                         {
                                             <button type="button" class="btn btn-sm btn-outline-primary" @onclick="CopyAddressDelivery" title="Copier l'adresse du profil pour l'√©tiquette">
                                                 <i class="bi bi-box-arrow-in-down me-1"></i>Copier du profil
                                             </button>
                                         }
                                    </div>
                                    <textarea class="form-control" rows="2" @bind="_colis.AdresseLivraison" disabled="@(!_colis.LivraisonADomicile || !CanEditFields)" placeholder="Limit√© √† 2 lignes"></textarea>
                                    @if(_colis.LivraisonADomicile)
                                    {
                                        <div class="form-text text-warning"><i class="bi bi-exclamation-circle me-1"></i>Id√©alement max 2 lignes pour l'√©tiquette.</div>
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <!-- Options -->
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-white py-3"><h5 class="mb-0 text-primary"><i class="bi bi-sliders me-2"></i>Options</h5></div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Type de Colis</label>
                                        <select class="form-select" @bind="_colis.Type" disabled="@(!CanEditFields)">
                                            @foreach (var type in Enum.GetValues<TypeColis>()) { <option value="@type">@type</option> }
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Option d'envoi</label>
                                        <select class="form-select" value="@_colis.TypeEnvoi" @onchange="OnTypeEnvoiChanged" disabled="@(!CanEditFields)">
                                            @foreach (var type in Enum.GetValues<TypeEnvoi>()) 
                                            { 
                                                // Exclure Express et Economique
                                                if (type != TypeEnvoi.Express && type != TypeEnvoi.Economique)
                                                {
                                                    <option value="@type">@type</option>
                                                }
                                            }
                                        </select>
                                    </div>
                                    <div class="col-12 mt-3">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="fragile" @bind="_colis.EstFragile" disabled="@(!CanEditFields)">
                                            <label class="form-check-label text-danger fw-bold" for="fragile"><i class="bi bi-exclamation-triangle me-1"></i>Fragile</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="special" @bind="_colis.ManipulationSpeciale" disabled="@(!CanEditFields)">
                                            <label class="form-check-label" for="special">Manipulation Sp√©ciale</label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Instructions Sp√©cifiques</label>
                                        <textarea class="form-control" rows="2" @bind="_colis.InstructionsSpeciales" disabled="@(!CanEditFields)"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- COLONNE DROITE : ADMIN & FINANCES -->
                    <div class="col-lg-4">
                        <!-- Statut -->
                        <div class="card shadow-sm border-0 mb-4">
                            <div class="card-header bg-white py-3"><h5 class="mb-0 text-secondary">Administration</h5></div>
                            <div class="card-body bg-light">
                                <label class="form-label small fw-bold">STATUT</label>
                                <select class="form-select mb-3" @bind="_colis.Statut" disabled="@(!IsAdmin)">
                                     @foreach (var s in Enum.GetValues<StatutColis>()) { <option value="@s">@s</option> }
                                </select>
                                
                                <label class="form-label small fw-bold">CONTENEUR</label>
                                @if (IsAdmin)
                                {
                                     <select class="form-select" @bind="_colis.ConteneurId">
                                         <option value="">-- Non assign√© --</option>
                                         @foreach(var c in _containers) { <option value="@c.Id">@c.NumeroDossier</option> }
                                     </select>
                                }
                                else
                                {
                                     <input type="text" class="form-control" value="@(_containers.FirstOrDefault(c => c.Id == _colis.ConteneurId)?.NumeroDossier ?? "Non assign√©")" disabled />
                                }
                            </div>
                        </div>

                        <!-- Finances -->
                        <div class="card shadow-sm border-0 border-top border-3 border-success">
                            <div class="card-header bg-white py-3"><h5 class="mb-0 text-success"><i class="bi bi-currency-euro me-2"></i>Finances</h5></div>
                            <div class="card-body">
                                <div class="mb-3" style="cursor: pointer;" @onclick="ShowComputedFieldInfo">
                                    <label class="form-label">Nombre de pi√®ces</label>
                                    <input type="number" class="form-control" value="@_colis.NombrePieces" readonly />
                                </div>
                                
                                <div class="mb-3" style="cursor: pointer;" @onclick="ShowComputedFieldInfo">
                                    <label class="form-label">Valeur D√©clar√©e (‚Ç¨)</label>
                                    <input type="number" class="form-control" @bind="_colis.ValeurDeclaree" readonly />
                                    <div class="form-text small">Calcul√©e via l'inventaire</div>
                                </div>
                                
                                <div class="mb-3" style="cursor: pointer;" @onclick="ShowComputedFieldInfo">
                                    <label class="form-label text-info fw-bold">Valeur Douane (20%)</label>
                                    <input type="text" class="form-control bg-light text-info fw-bold" value="@_colis.ValeurDouane.ToString("C2")" readonly />
                                    <div class="form-text small">Calcul√©e automatiquement : 20% de la valeur d√©clar√©e.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Volume (m¬≥)</label>
                                    <input type="number" class="form-control" value="@_colis.Volume.ToString(System.Globalization.CultureInfo.InvariantCulture)" @onchange="OnVolumeChanged" disabled="@(!CanEditFields)" step="any" />
                                    <div class="form-text text-muted small">Mettre le volume total pour obtenir le prix total.</div>
                                </div>
                                
                                <hr class="text-muted" />
                                

                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-primary">PRIX TOTAL (HORS DOUANE) (‚Ç¨)</label>
                                    <input type="number" class="form-control form-control-lg fw-bold text-primary" value="@_colis.PrixTotal.ToString(System.Globalization.CultureInfo.InvariantCulture)" @onchange="OnTotalPriceChanged" disabled="@(!IsAdmin)" step="any" />
                                    <div class="form-text text-muted small">Li√© √† l'option d'envoi.</div>
                                </div>

                                @if(_colis.TypeEnvoi == TypeEnvoi.AvecDedouanement)
                                {
                                     <div class="mb-3 bg-primary p-2 rounded text-white">
                                        <label class="form-label fw-bold mb-0">TOTAL + DOUANE (‚Ç¨)</label>
                                        <div class="fs-4 fw-bold">@((_colis.PrixTotal + _colis.ValeurDouane).ToString("C2"))</div>
                                        <div class="small fst-italic">Prix total (@_colis.PrixTotal.ToString("C0")) + Douane (@_colis.ValeurDouane.ToString("C0"))</div>
                                    </div>
                                }
                                

                                
                                 <div class="d-flex justify-content-between small mb-2">
                                     <span>Pay√© :</span>
                                     <span class="text-success fw-bold">@_colis.SommePayee.ToString("C2")</span>
                                 </div>
                                 <div class="d-flex justify-content-between fw-bold fs-5">
                                     <span>Reste :</span>
                                     <span class="text-danger">@_colis.RestantAPayer.ToString("C2")</span>
                                 </div>
                                 <div class="mt-2 text-muted small">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Moyens de paiement accept√©s : Esp√®ces, CB, Virement, Paiement en ligne
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ONGLET 2 : DOCUMENTS (Nouveau) -->
            @if (!IsNew)
            {
                <div class="tab-pane fade @(_activeTab == "documents" ? "show active" : "")">
                    <DocumentManager EntityId="@_colis.Id" EntityType="Colis" />
                </div>
            }

            <!-- ONGLET 3 : SUIVI -->
            @if (!IsNew)
            {
                <div class="tab-pane fade @(_activeTab == "suivi" ? "show active" : "")">
                     <div class="row">
                        <div class="col-12">
                             <Timeline EntityId="@_colis.Id" EntityType="Colis" />
                        </div>
                    </div>
                </div>
            }

             <!-- ONGLET 4 : DISCUSSION -->
            @if (!IsNew)
            {
                <div class="tab-pane fade @(_activeTab == "discussion" ? "show active" : "")">
                     <div class="row">
                        <div class="col-12">
                            <!-- On passe _activeTab == "discussion" pour dire au chat s'il est affich√© -->
							<ChatBox EntityId="@_colis.Id" 
									 EntityType="Colis" 
									 OnUnreadCountChanged="UpdateUnreadBadge" 
									 IsVisible="@(_activeTab == "discussion")" />
                        </div>
                    </div>
                </div>
            }
            <!-- ONGLET 5 : SAV -->
            @if (!IsNew)
            {
                <div class="tab-pane fade @(_activeTab == "sav" ? "show active" : "")">
                    <!-- Galerie Photos SAV -->
                    <SavPhotoGallery @ref="_savGallery" EntityId="@_colis.Id" EntityType="Colis" />

                    @if (_receptionControl == null)
                    {
                        <div class="text-center py-5">
                            <i class="bi bi-box-seam fs-1 text-muted mb-3 d-block"></i>
                            <h4 class="fw-bold mb-3">R√©ception du Colis</h4>
                            <p class="text-muted mb-4" style="max-width: 500px; margin: 0 auto;">
                                Avez-vous bien re√ßu ce colis ? Signalez-nous la bonne r√©ception ou un √©ventuel probl√®me (manquant, casse) pour nous aider √† am√©liorer notre service.
                            </p>
                            <button class="btn btn-primary px-5 py-3 rounded-pill shadow-sm" @onclick="() => _showSavWizard = true">
                                <i class="bi bi-ui-checks me-2"></i>Faire l'√©tat des lieux
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                                <h5 class="mb-0 text-primary">Rapport de R√©ception</h5>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge @(_receptionControl.Status == ReceptionStatus.ReceivedFull ? "bg-success" : "bg-danger") fs-6">
                                        @(_receptionControl.Status == ReceptionStatus.ReceivedFull ? "Conforme" : "Probl√®me Signal√©")
                                    </span>
                                    @if(IsAdmin)
                                    {
                                        <button class="btn btn-sm btn-outline-danger" @onclick="DeleteSavReport" title="Supprimer le rapport">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    }
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row g-4">
                                     <div class="col-md-6">
                                         <h6 class="fw-bold text-muted text-uppercase small">√âvaluations</h6>
                                         <div class="d-flex flex-column gap-2 mb-3">
                                             <div class="d-flex justify-content-between align-items-center p-2 rounded bg-light">
                                                 <span>Service Global</span>
                                                 <span class="fw-bold text-primary">@_receptionControl.RateService/10</span>
                                             </div>
                                             <div class="d-flex justify-content-between align-items-center p-2 rounded bg-light">
                                                 <span>√âtat Colis</span>
                                                  <span class="fw-bold text-primary">@_receptionControl.RateCondition/10</span>
                                             </div>
                                         </div>
                                         @if (!string.IsNullOrEmpty(_receptionControl.GlobalComment))
                                         {
                                             <div class="alert alert-light border">
                                                 <i class="bi bi-chat-quote me-2 text-primary"></i>
                                                 <span class="fst-italic">"@_receptionControl.GlobalComment"</span>
                                             </div>
                                         }
                                     </div>
                                     <div class="col-md-6">
                                         @if (_receptionControl.Issues.Any())
                                         {
                                             <h6 class="fw-bold text-danger text-uppercase small">Probl√®mes Signal√©s</h6>
                                             <ul class="list-group list-group-flush">
                                                 @foreach(var issue in _receptionControl.Issues)
                                                 {
                                                     <li class="list-group-item px-0">
                                                         <div class="fw-bold text-danger"><i class="bi bi-exclamation-circle me-2"></i>@GetTranslatedIssueType(issue.Type)</div>
                                                         @if (!string.IsNullOrEmpty(issue.InventoryItemName))
                                                         {
                                                             <div class="small"><strong>Article:</strong> @issue.InventoryItemName</div>
                                                         }
                                                         <div class="small text-muted">@issue.Description</div>
                                                     </li>
                                                 }
                                             </ul>
                                         }
                                         else
                                         {
                                             <div class="alert alert-success d-flex align-items-center">
                                                 <i class="bi bi-check-circle-fill fs-4 me-3"></i>
                                                 <div>
                                                     <strong>Aucun probl√®me signal√©.</strong>
                                                     <div class="small">Le client a confirm√© la r√©ception conforme.</div>
                                                 </div>
                                             </div>
                                         }
                                     </div>
                                </div>
                                <div class="text-end mt-4 text-muted small">
                                    Soumis le @_receptionControl.CreationDate.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }

</div>
    }
    
    <!-- MODALS -->
	<InventoryModal IsVisible="_showInventory" 
					IsReadOnly="@(!CanEditFields)"
					JsonData="@_colis.InventaireJson"
					Signature="@_colis.SignatureClientInventaire"
					Lieu="@_colis.LieuSignatureInventaire"
					Date="@_colis.DateSignatureInventaire"
					OnSave="SaveInventory"
					OnClose="() => _showInventory = false" />
    <PaymentModal IsVisible="_showPayments"
                  IsAdmin="@IsAdmin"
                  ColisId="@_colis.Id"
                  ClientId="@_colis.ClientId"
                  TotalAmount="@_colis.PrixTotal"
                  OnPaymentsChanged="UpdatePaidAmount"
                  OnClose="() => _showPayments = false" />
                  
    @if (!IsNew)
    {
        <SavWizard Show="_showSavWizard"
                   ShowChanged="@((v) => { _showSavWizard = v; if(!v) ReloadSav(); })"
                   EntityType="Colis"
                   EntityId="@_colis.Id"
                   ClientId="@_colis.ClientId"
                   InventoryItems="@(TryParseInventory())" />
    }
    
    <!-- Modal Warning: Computed Fields -->
    @if(_showComputedInfo)
    {
         <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-info-circle me-2"></i>Champ Calcul√©</h5>
                        <button type="button" class="btn-close" @onclick="() => _showComputedInfo = false"></button>
                    </div>
                    <div class="modal-body">
                        Ce champ est calcul√© automatiquement √† partir de l'inventaire.
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="() => _showComputedInfo = false">Fermer</button>
                        <button type="button" class="btn btn-primary" @onclick="() => { _showComputedInfo = false; ShowInventory(); }">Ouvrir l'Inventaire</button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Modal Warning: Empty Inventory -->
    @if(_showEmptyInventoryWarning)
    {
         <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Inventaire Vide</h5>
                    </div>
                    <div class="modal-body">
                        L'inventaire est vide. Pour l'√©tude de votre dossier, il est recommand√© de le remplir.
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="ConfirmSaveWithEmptyInventory">Enregistrer et Quitter</button>
                        <button type="button" class="btn btn-primary" @onclick="() => { _showEmptyInventoryWarning = false; ShowInventory(); }">Remplir l'Inventaire</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>












@code {
    [Parameter] public Guid? Id { get; set; }
    
    [SupplyParameterFromQuery]
    public string? Tab { get; set; }

    [SupplyParameterFromQuery]
    public string? Action { get; set; }

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrEmpty(Tab))
        {
            _activeTab = Tab.ToLower();
        }

        if (!string.IsNullOrEmpty(Action))
        {
            if (Action.ToLower() == "inventory") _showInventory = true;
            if (Action.ToLower() == "payment") _showPayments = true;
        }
    }
    private Colis _colis = new() { DateArrivee = DateTime.UtcNow, Statut = StatutColis.EnAttente };
    private bool _isLoading = true;
    private bool IsNew => Id == null;
    
    // Navigation Tabs
    private string _activeTab = "infos";
    // Contexte Utilisateur
    private bool IsAdmin = false;
    private Guid CurrentUserId;
    
    // UI State
    private string _clientNameDisplay = "";
    private string _firstBarcode = "";
    private bool _sameAsClient = false;
    private bool _showInventory = false;
    private bool _showPayments = false;
    private bool _showSavWizard = false;
    private ReceptionControl? _receptionControl;
    private decimal _pricePerM3 = 0;
    private decimal _defaultRate = 0; // Stockage du taux par d√©faut
    private bool _isExportMenuOpen = false;
    
    // UI Warnings
    private bool _showComputedInfo = false;
    private bool _showEmptyInventoryWarning = false;
    
    // Admin Search
    private string _clientSearch = "";
    private List<Client> _clients = new(); // Used for direct lookup
    private List<Client> _filteredClients = new();
    private List<Conteneur> _containers = new();
    
    private int _unreadMessagesCount = 0;
    private SavPhotoGallery _savGallery;

    // Logic Permissions
    private bool CanEditGlobal => IsAdmin || (IsNew || _colis.Statut == StatutColis.EnAttente);
    private bool CanEditFields => IsAdmin || (CanEditGlobal); 
    
    private string DestinationLabel => string.IsNullOrWhiteSpace(_colis.DestinationFinale) 
    ? "Adresse Destination" 
    : $"Adresse √† {_colis.DestinationFinale}";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        // 1. Fetch Default Rate (Directement depuis le service pour √©viter le cache HTTP)
        var rateStr = await SettingsService.GetSettingAsync("PricePerCubicMeter");
        Console.WriteLine($"[DEBUG] Rate Fetched: '{rateStr}'");
        if (decimal.TryParse(rateStr, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var r))
        {
            _defaultRate = r;
            Console.WriteLine($"[DEBUG] _defaultRate parsed: {_defaultRate}");
        }
        else
        {
            Console.WriteLine($"[DEBUG] Failed to parse rate, using fallback 150");
            _defaultRate = 150;
        }


        IsAdmin = user.IsInRole("Administrateur");
        var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);
        if (userIdClaim != null) Guid.TryParse(userIdClaim.Value, out CurrentUserId);
        
        if (IsAdmin)
        {
             _containers = (await ApiService.GetConteneursAsync())?.ToList() ?? new();
        }
        
        if (!IsNew)
        {
            var dto = await ApiService.GetColisByIdAsync(Id.Value);
            if (dto != null) 
            {
                _colis = dto;
                _clientNameDisplay = _colis.Client?.NomComplet ?? "Inconnu";
                _firstBarcode = _colis.Barcodes.FirstOrDefault()?.Value ?? "";
                
                if (_colis.Client != null)
                {
                    var destNom = _colis.Destinataire?.Trim().ToLower() ?? "";
                    var clientNom = _colis.Client.NomComplet.Trim().ToLower();
                    if (!string.IsNullOrEmpty(destNom) && destNom == clientNom)
                    {
                        _sameAsClient = true;
                    }
                }
                
                _receptionControl = await ApiService.GetReceptionControlAsync("Colis", Id.Value);
                if(_savGallery != null) await _savGallery.ReloadAsync(); 

                // --- LOGIC TARIFAIRE (APRES CHARGEMENT) ---
                 // Si Modif, on tente de d√©duire le taux historique
                 if (_colis.Volume > 0 && _colis.PrixTotal > 0)
                 {
                      _pricePerM3 = Math.Round(_colis.PrixTotal / _colis.Volume, 2);
                 }
                 else
                 {
                     _pricePerM3 = 0; 
                 }
                 // ------------------------------------------
            }
        }
        else
        {
            // --- LOGIC TARIFAIRE (NOUVEAU) ---
            if (_pricePerM3 == 0) _pricePerM3 = _defaultRate;
            
            if (!IsAdmin)
            {
                UserProfileDto? profile = await ApiService.GetUserProfileAsync();
                if (profile != null)
                {
                    _colis.ClientId = profile.ClientId;
                    _clientNameDisplay = $"{profile.Nom} {profile.Prenom}";
                    _colis.Destinataire = _clientNameDisplay; // Auto-fill Client Name
                    _colis.TelephoneDestinataire = profile.Telephone; // Auto-fill Phone
                    await GenerateBarcode();
                    _sameAsClient = true;
                    // ApplySameAsClient(); // Removed as we set it manually above matches. 
                }
            }
        }
        
        _isLoading = false;
    }
    
    private void ToggleExportMenu()
    {
        _isExportMenuOpen = !_isExportMenuOpen;
        StateHasChanged();
    }
    
    // --- METHODES COPIESES ---
    private async Task FilterClients(KeyboardEventArgs e)
    {
        if (string.IsNullOrEmpty(_clientSearch) || _clientSearch.Length < 2) 
        {
            _filteredClients.Clear(); return;
        }
        if (!_clients.Any()) _clients = (await ApiService.GetClientsAsync())?.ToList() ?? new();

        _filteredClients = _clients.Where(c => 
            c.NomComplet.Contains(_clientSearch, StringComparison.OrdinalIgnoreCase) ||
            (c.TelephonePrincipal != null && c.TelephonePrincipal.Contains(_clientSearch)) ||
            (c.Email != null && c.Email.Contains(_clientSearch, StringComparison.OrdinalIgnoreCase))
        ).Take(10).ToList();
    }
    private void SelectClient(Client client)
    {
        _colis.ClientId = client.Id;
        _colis.Client = client; // Fix pour avoir le num tel
        _clientNameDisplay = client.NomComplet;
        _filteredClients.Clear();
        _clientSearch = "";
        
        if (_sameAsClient) ApplySameAsClient();
    }
    private async Task GenerateBarcode()
    {
        var code = await ApiService.GenerateBarcodeAsync();
        if (!string.IsNullOrEmpty(code)) _firstBarcode = code;
    }
    private void OnSameAsClientCheckedChanged(ChangeEventArgs e)
    {
        _sameAsClient = (bool)(e.Value ?? false);
        if (_sameAsClient) ApplySameAsClient();
    }
    private void ApplySameAsClient()
    {
        _colis.Destinataire = _clientNameDisplay;
        if (_colis.Client != null)
        {
            _colis.TelephoneDestinataire = _colis.Client.TelephonePrincipal;
        }
        else if (IsAdmin && _colis.ClientId != Guid.Empty && _clients.Any())
        {
             var localClient = _clients.FirstOrDefault(c => c.Id == _colis.ClientId);
             if (localClient != null)
             {
                  _colis.TelephoneDestinataire = localClient.TelephonePrincipal;
             }
        }
    }
    
    private void OnRateChanged(ChangeEventArgs e)
     {
         if (decimal.TryParse(e.Value?.ToString(), System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var newRate))
         {
             _pricePerM3 = newRate;
             if (_colis.Volume > 0)
             {
                 _colis.PrixTotal = Math.Round(_colis.Volume * _pricePerM3, 2);
             }
         }
     }

     private void OnVolumeChanged(ChangeEventArgs e)
     {
         var val = e.Value?.ToString(); 
         // Remplacement manuel pour supporter la virgule si le navigateur envoie '1,5'
         if (!string.IsNullOrEmpty(val)) val = val.Replace(",", ".");
         
         if (decimal.TryParse(val, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var vol))
         {
             _colis.Volume = vol;
             Console.WriteLine($"[DEBUG] Volume Set to: {_colis.Volume}");

             if (_pricePerM3 == 0 && _defaultRate > 0) _pricePerM3 = _defaultRate;
             
             if (_pricePerM3 > 0)
             {
                 _colis.PrixTotal = Math.Round(vol * _pricePerM3, 2);
             }
         }
     }

     private void OnTotalPriceChanged(ChangeEventArgs e)
     {
          var val = e.Value?.ToString(); 
         if (!string.IsNullOrEmpty(val)) val = val.Replace(",", ".");
         
         if (decimal.TryParse(val, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var total))
         {
             _colis.PrixTotal = total;
              if (_pricePerM3 == 0 && _defaultRate > 0) _pricePerM3 = _defaultRate;
             
             if (_pricePerM3 > 0)
             {
                 _colis.Volume = Math.Round(total / _pricePerM3, 3);
             }
         }
     }
     
    private int GetInventoryItemCount()
    {
        var items = TryParseInventory();
        return items.Count;
    }
    
    private List<TransitManager.Core.Entities.InventaireItem> TryParseInventory()
    {
        if (string.IsNullOrEmpty(_colis.InventaireJson)) return new List<TransitManager.Core.Entities.InventaireItem>();
        try
        {
            return JsonSerializer.Deserialize<List<TransitManager.Core.Entities.InventaireItem>>(_colis.InventaireJson) ?? new List<TransitManager.Core.Entities.InventaireItem>();
        }
        catch { return new List<TransitManager.Core.Entities.InventaireItem>(); }    
    }
    
    private void ShowInventory() => _showInventory = true;
    private void ShowPayments() => _showPayments = true;
    
    private void SaveInventory(InventoryModal.InventoryResult result)
    {
        _colis.InventaireJson = result.Json;
        _colis.LieuSignatureInventaire = result.Lieu;
        _colis.DateSignatureInventaire = result.Date;
        _colis.SignatureClientInventaire = result.Signature;
        
        var items = TryParseInventory();
        _colis.NombrePieces = items.Sum(i => i.Quantite);
        _colis.ValeurDeclaree = items.Sum(i => i.Valeur);
        
        _showInventory = false;
        StateHasChanged(); // Force update UI Computed Fields
    }
    
    private void ShowComputedFieldInfo() { _showComputedInfo = true; }
    
    private async Task CheckInventoryAndSave()
    {
        if (GetInventoryItemCount() == 0)
        {
            _showEmptyInventoryWarning = true;
        }
        else
        {
            await SaveColis();
        }
    }
    
    private async Task ConfirmSaveWithEmptyInventory()
    {
        _showEmptyInventoryWarning = false;
        await SaveColis();
    }

    private async Task SaveColis()
    {
        if (IsNew)
        {
            var createDto = new CreateColisDto
            {
                ClientId = _colis.ClientId,
                Designation = _colis.Designation,
                DestinationFinale = _colis.DestinationFinale,
                Barcodes = new List<string> { _firstBarcode },
                NombrePieces = _colis.NombrePieces,
                ValeurDeclaree = _colis.ValeurDeclaree,
                Type = _colis.Type,
                TypeEnvoi = _colis.TypeEnvoi,
                FraisDouane = _colis.TypeEnvoi == TypeEnvoi.AvecDedouanement ? _colis.ValeurDouane : 0,
                EstFragile = _colis.EstFragile,
                ManipulationSpeciale = _colis.ManipulationSpeciale,
                InstructionsSpeciales = _colis.InstructionsSpeciales,
                Destinataire = _colis.Destinataire,
                TelephoneDestinataire = _colis.TelephoneDestinataire,
                LivraisonADomicile = _colis.LivraisonADomicile,
                AdresseLivraison = _colis.AdresseLivraison,
                AdresseFrance = _colis.AdresseFrance,
                AdresseDestination = _colis.AdresseDestination,
                InventaireJson = _colis.InventaireJson,
                LieuSignatureInventaire = _colis.LieuSignatureInventaire,
                DateSignatureInventaire = _colis.DateSignatureInventaire,
                SignatureClientInventaire = _colis.SignatureClientInventaire,
                // FIXED: Allow everyone to save Volume/Price
                Volume = _colis.Volume,
                PrixTotal = _colis.PrixTotal,
                ConteneurId = IsAdmin ? _colis.ConteneurId : null
            };
            await ApiService.CreateColisAsync(createDto);
        }
        else
        {
            var updateDto = new UpdateColisDto
            {
                Id = _colis.Id,
                ClientId = _colis.ClientId,
                Designation = _colis.Designation,
                DestinationFinale = _colis.DestinationFinale,
                Barcodes = _colis.Barcodes.Select(b => b.Value).ToList(),
                Statut = _colis.Statut,
                Type = _colis.Type,
                TypeEnvoi = _colis.TypeEnvoi,
                FraisDouane = _colis.TypeEnvoi == TypeEnvoi.AvecDedouanement ? _colis.ValeurDouane : 0,
                EstFragile = _colis.EstFragile,
                ManipulationSpeciale = _colis.ManipulationSpeciale,
                InstructionsSpeciales = _colis.InstructionsSpeciales,
                Destinataire = _colis.Destinataire,
                TelephoneDestinataire = _colis.TelephoneDestinataire,
                LivraisonADomicile = _colis.LivraisonADomicile,
                AdresseLivraison = _colis.AdresseLivraison,
                AdresseFrance = _colis.AdresseFrance,
                AdresseDestination = _colis.AdresseDestination,
                InventaireJson = _colis.InventaireJson,
                Volume = _colis.Volume,
                PrixTotal = _colis.PrixTotal,
                ConteneurId = _colis.ConteneurId,
                SommePayee = _colis.SommePayee,
                LieuSignatureInventaire = _colis.LieuSignatureInventaire,
                DateSignatureInventaire = _colis.DateSignatureInventaire,
                SignatureClientInventaire = _colis.SignatureClientInventaire
            };
            if(!string.IsNullOrEmpty(_firstBarcode) && !updateDto.Barcodes.Contains(_firstBarcode))
            {
                updateDto.Barcodes.Add(_firstBarcode);
            }
            
            await ApiService.UpdateColisAsync(_colis.Id, updateDto);
        }
        Navigation.NavigateTo("/my-parcels");
    }
    
    private void UpdatePaidAmount(decimal amount)
    {
        _colis.SommePayee = amount; // Mise √† jour locale pour affichage imm√©diat
        StateHasChanged();
    }
    
    // Address Copies
    private async Task CopyAddressFrance()
    {
        await LoadProfileAndCopy((p) => _colis.AdresseFrance = $"{p.Adresse}".ToUpper());
    }
    private async Task CopyAddressDestination()
    {
        await LoadProfileAndCopy((p) => _colis.AdresseDestination = $"{p.Ville}, {p.Pays}".ToUpper());
    }

    

    
    private void OnTypeEnvoiChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<TypeEnvoi>(e.Value?.ToString(), out var type))
        {
            _colis.TypeEnvoi = type;
            
            // Logic: Update the FraisDouane property in memory to reflect the potential change
            if (type == TypeEnvoi.AvecDedouanement)
            {
                 _colis.FraisDouane = _colis.ValeurDouane;
            }
            else
            {
                 _colis.FraisDouane = 0;
            }

            // Force refresh of computed properties for UI
            StateHasChanged();
        }
    }

    private void OnFraisDouaneChanged(ChangeEventArgs e)
    {
        if (decimal.TryParse(e.Value?.ToString(), System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var frais))
        {
            _colis.FraisDouane = frais;
        }
    }

    private async Task SearchClientByPhone()
    {
       // D√©clenche simplement l'affichage du dropdown s'il y a du contenu pr√©c√©dent ou focus
       // Ici on pourrait impl√©menter une logique plus complexe si besoin
       await JSRuntime.InvokeVoidAsync("console.log", "Search by phone requested");
    }

    private async Task CopyAddressDelivery()
    {
        await LoadProfileAndCopy((p) => {
            _colis.AdresseLivraison = $"{p.Adresse}, {p.Ville} {p.CodePostal}".ToUpper();
        });
    }
    
    private async Task LoadProfileAndCopy(Action<UserProfileDto> copyAction)
    {
        var profile = await ApiService.GetUserProfileAsync();
        if (profile != null)
        {
            copyAction(profile);
            StateHasChanged();
        }
    }
    
    private string GetStatusBadgeClass(StatutColis statut)
    {
        return statut switch
        {
            StatutColis.EnAttente => "bg-warning text-dark",
            StatutColis.Affecte => "bg-info text-dark",
            StatutColis.EnTransit => "bg-primary",
            StatutColis.Arrive => "bg-info",
            StatutColis.EnDedouanement => "bg-secondary",
            StatutColis.Livre => "bg-success",
            StatutColis.Probleme => "bg-danger",
            StatutColis.Perdu => "bg-dark",
            StatutColis.Retourne => "bg-secondary",
            _ => "bg-secondary"
        };
    }
    
    private void OnDestinationChanged(ChangeEventArgs e)
    {
        _colis.DestinationFinale = e.Value?.ToString() ?? "";
    }
    
    private async Task DeleteSavReport()
    {
        if (_receptionControl != null)
        {
            bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "√ätes-vous s√ªr de vouloir supprimer ce rapport SAV ?");
            if (confirmed)
            {
                bool success = await ApiService.DeleteControlAsync(_receptionControl.Id);
                if (success)
                {
                    _receptionControl = null;
                    StateHasChanged();
                }
            }
        }
    }
    
    private async Task ReloadSav()
    {
         if (!IsNew && Id.HasValue)
         {
             _receptionControl = await ApiService.GetReceptionControlAsync("Colis", Id.Value);
             if(_savGallery != null) await _savGallery.ReloadAsync();
             StateHasChanged();
         }
    }
    
    private void UpdateUnreadBadge(int count)
    {
        _unreadMessagesCount = count;
        StateHasChanged();
    }
    
    private string GetTranslatedIssueType(IssueType type)
    {
        return type switch
        {
            IssueType.MissingItem => "Objet Manquant",
            IssueType.Damage => "Objet/Emballage Ab√Æm√©",
            IssueType.Other => "Autre Probl√®me",
            _ => type.ToString()
        };
    }
    
    private async Task ExportPdf(bool includeFinancials, bool includePhotos)
    {
        if (Id.HasValue)
        {
            var pdfBytes = await ApiService.ExportColisPdfAsync(Id.Value, includeFinancials, includePhotos);
            var title = includePhotos ? "dossier_complet" : (includeFinancials ? "recu_financier" : "fiche_colis");
            var fileName = $"colis_{_colis.NumeroReference}_{title}.pdf";
            
            using var streamRef = new DotNetStreamReference(new MemoryStream(pdfBytes));
            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
        }
    }
    
    private async Task ExportTicket(string format)
    {
        if (Id.HasValue)
        {
            var pdfBytes = await ApiService.ExportTicketPdfAsync(Id.Value, format);
            var fileName = $"ticket_{_colis.NumeroReference}.pdf";
            
            using var streamRef = new DotNetStreamReference(new MemoryStream(pdfBytes));
            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
        }
    }
    
    private int GetMissingDocumentsCount()
    {
        return 0; 
    }

}





