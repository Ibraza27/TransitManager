@page "/colis/edit/{Id:guid}"
@page "/colis/create"
@using System.Text.Json
@using TransitManager.Core.DTOs
@using TransitManager.Core.Entities
@using TransitManager.Core.Enums
@using System.Security.Claims
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime
@using TransitManager.Web.Components.Shared
<PageTitle>@(IsNew ? "Nouveau Colis" : "D√©tail Colis") - Hippocampe</PageTitle>
<div class="container mt-4 mb-5">
    <!-- En-t√™te -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary">
                <i class="bi @(IsNew ? "bi-plus-circle" : "bi-box-seam") me-2"></i>
                @(IsNew ? "Nouveau Colis" : "D√©tail du Colis")
            </h2>
            @if (!IsNew)
            {
                <span class="badge @GetStatusBadgeClass(_colis.Statut)">@_colis.Statut</span>
                <span class="text-muted ms-2 small">Ref: @_colis.NumeroReference</span>
            }
        </div>
		<div class="d-flex gap-2 position-relative">
            
             <!-- MENU EXPORT -->
            <div class="dropdown">
                <button class="btn btn-outline-danger dropdown-toggle" type="button" @onclick="ToggleExportMenu">
                    <i class="bi bi-file-earmark-pdf me-2"></i>PDF
                </button>
                <ul class="dropdown-menu @(_isExportMenuOpen ? "show" : "")" 
                    style="right: auto; left: 0; margin-top: 5px;">
                    <li>
                        <button class="dropdown-item" @onclick="() => ExportPdf(false, false)">
                            üìÑ Fiche Colis (Simple)
                        </button>
                    </li>
                    <li>
                        <button class="dropdown-item" @onclick="() => ExportPdf(true, false)">
                            üí∞ Re√ßu Financier (+ Prix)
                        </button>
                    </li>
                    <li>
                        <!-- NOUVELLE OPTION -->
                        <button class="dropdown-item" @onclick="() => ExportPdf(true, true)">
                            üì∏ Dossier Complet (+ Photos)
                        </button>
                    </li>
                </ul>
                @if (_isExportMenuOpen)
                {
                    <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 900;" 
                         @onclick="ToggleExportMenu"></div>
                }
            </div>
             <!-- Boutons actions -->
            <button class="btn btn-outline-secondary" @onclick="ShowInventory">
                <i class="bi bi-clipboard-list me-2"></i>Inventaire
            </button>
            
            @if (!IsNew)
            {
                <button class="btn btn-outline-success" @onclick="ShowPayments">
                    <i class="bi bi-cash-coin me-2"></i>Paiements
                </button>
            }
            <button class="btn btn-primary" @onclick="SaveParcel" disabled="@(!CanEditGlobal)">
                <i class="bi bi-save me-2"></i>Enregistrer
            </button>
            <a href="/my-parcels" class="btn btn-outline-dark">Retour</a>
        </div>
    </div>
    @if (_isLoading)
    {
        <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
    }
    else
    {
        <!-- TABS NAVIGATION -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <button class="nav-link @(_activeTab == "infos" ? "active fw-bold" : "")" @onclick='() => _activeTab = "infos"'>
                    Informations & Finances
                </button>
            </li>
             @if (!IsNew)
             {
                <li class="nav-item">
                    <button class="nav-link @(_activeTab == "documents" ? "active fw-bold" : "")" @onclick='() => _activeTab = "documents"'>
                        Documents & Photos
                    </button>
                </li>
                <li class="nav-item">
					<button class="nav-link @(_activeTab == "suivi" ? "active fw-bold" : "")" @onclick='() => _activeTab = "suivi"'>
                        <i class="bi bi-chat-left-text me-2"></i>
                        Suivi & Discussion
                        @if(_unreadMessagesCount > 0 && _activeTab != "suivi")
                        {
                            <span class="badge bg-danger rounded-pill ms-2">@_unreadMessagesCount</span>
                        }
                    </button>
                </li>
             }
        </ul>
        <div class="tab-content">
            
            <!-- ONGLET 1 : INFOS & FINANCES -->
            <div class="tab-pane fade @(_activeTab == "infos" ? "show active" : "")">
                <div class="row g-4">
                    <!-- COLONNE GAUCHE -->
                    <div class="col-lg-8">
                        <!-- Carte Client & Infos -->
                        <div class="card shadow-sm border-0 mb-4">
                            <div class="card-header bg-white py-3"><h5 class="mb-0 text-primary"><i class="bi bi-person-badge me-2"></i>Propri√©taire & Infos</h5></div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <!-- Client -->
                                    <div class="col-12">
                                        <label class="form-label fw-bold">Client Propri√©taire</label>
                                        @if (IsAdmin)
                                        {
                                            <div class="input-group">
                                                <input type="text" class="form-control" placeholder="Rechercher un client..." 
                                                       @bind="_clientSearch" @bind:event="oninput" @onkeyup="FilterClients" />
                                                @if(_filteredClients.Any())
                                                {
                                                    <div class="dropdown-menu show w-100" style="max-height: 200px; overflow-y: auto;">
                                                        @foreach(var c in _filteredClients)
                                                        {
                                                            <button class="dropdown-item" @onclick="() => SelectClient(c)">
                                                                @c.NomComplet <small class="text-muted">(@c.TelephonePrincipal)</small>
                                                            </button>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                            <div class="form-text text-primary mt-1">Actuel : <strong>@_clientNameDisplay</strong></div>
                                        }
                                        else
                                        {
                                            <input type="text" class="form-control" value="@_clientNameDisplay" disabled />
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">D√©signation <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" @bind="_colis.Designation" disabled="@(!CanEditFields)" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Destination Finale <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" @bind="_colis.DestinationFinale" disabled="@(!CanEditFields)" />
                                    </div>
                                     <div class="col-12">
                                        <label class="form-label">Code-barres</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control font-monospace" value="@_firstBarcode" readonly />
                                            @if (IsAdmin || IsNew)
                                            {
                                                <button class="btn btn-outline-secondary" @onclick="GenerateBarcode" disabled="@(!string.IsNullOrEmpty(_firstBarcode))">
                                                    <i class="bi bi-upc-scan me-2"></i>G√©n√©rer
                                                </button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Carte Destinataire -->
                        <div class="card shadow-sm border-0 mb-4">
                            <div class="card-header bg-white py-3"><h5 class="mb-0 text-primary"><i class="bi bi-geo-alt me-2"></i>Destinataire</h5></div>
                            <div class="card-body">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="sameRecipient" 
                                           @bind="_sameAsClient" @onclick="ToggleSameAsClient" disabled="@(!CanEditFields)">
                                    <label class="form-check-label" for="sameRecipient">Destinataire identique au propri√©taire</label>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Nom Destinataire</label>
                                        <input type="text" class="form-control" @bind="_colis.Destinataire" disabled="@(_sameAsClient || !CanEditFields)" />
                                    </div>
                                     <div class="col-md-6">
                                        <label class="form-label">T√©l√©phone Destinataire</label>
                                        <input type="text" class="form-control" @bind="_colis.TelephoneDestinataire" disabled="@(_sameAsClient || !CanEditFields)" />
                                    </div>
                                </div>
                                <hr />
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="homeDelivery" @bind="_colis.LivraisonADomicile" disabled="@(!CanEditFields)">
                                    <label class="form-check-label" for="homeDelivery">Livraison √† domicile</label>
                                </div>
                                 <div class="mb-3">
                                    <label class="form-label">Adresse de Livraison</label>
                                    <textarea class="form-control" rows="2" @bind="_colis.AdresseLivraison" disabled="@(!_colis.LivraisonADomicile || !CanEditFields)"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Options -->
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-white py-3"><h5 class="mb-0 text-primary"><i class="bi bi-sliders me-2"></i>Options</h5></div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Type de Colis</label>
                                        <select class="form-select" @bind="_colis.Type" disabled="@(!CanEditFields)">
                                            @foreach (var type in Enum.GetValues<TypeColis>()) { <option value="@type">@type</option> }
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Option d'envoi</label>
                                        <select class="form-select" @bind="_colis.TypeEnvoi" disabled="@(!CanEditFields)">
                                            @foreach (var type in Enum.GetValues<TypeEnvoi>()) { <option value="@type">@type</option> }
                                        </select>
                                    </div>
                                    <div class="col-12 mt-3">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="fragile" @bind="_colis.EstFragile" disabled="@(!CanEditFields)">
                                            <label class="form-check-label text-danger fw-bold" for="fragile"><i class="bi bi-exclamation-triangle me-1"></i>Fragile</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="special" @bind="_colis.ManipulationSpeciale" disabled="@(!CanEditFields)">
                                            <label class="form-check-label" for="special">Manipulation Sp√©ciale</label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Instructions Sp√©cifiques</label>
                                        <textarea class="form-control" rows="2" @bind="_colis.InstructionsSpeciales" disabled="@(!CanEditFields)"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- COLONNE DROITE : ADMIN & FINANCES -->
                    <div class="col-lg-4">
                        <!-- Statut -->
                        <div class="card shadow-sm border-0 mb-4">
                            <div class="card-header bg-white py-3"><h5 class="mb-0 text-secondary">Administration</h5></div>
                            <div class="card-body bg-light">
                                <label class="form-label small fw-bold">STATUT</label>
                                <select class="form-select mb-3" @bind="_colis.Statut" disabled="@(!IsAdmin)">
                                     @foreach (var s in Enum.GetValues<StatutColis>()) { <option value="@s">@s</option> }
                                </select>
                                
                                <label class="form-label small fw-bold">CONTENEUR</label>
                                @if (IsAdmin)
                                {
                                     <select class="form-select" @bind="_colis.ConteneurId">
                                         <option value="">-- Non assign√© --</option>
                                         @foreach(var c in _containers) { <option value="@c.Id">@c.NumeroDossier</option> }
                                     </select>
                                }
                                else
                                {
                                     <input type="text" class="form-control" value="@(_containers.FirstOrDefault(c => c.Id == _colis.ConteneurId)?.NumeroDossier ?? "Non assign√©")" disabled />
                                }
                            </div>
                        </div>
                        <!-- Finances -->
                        <div class="card shadow-sm border-0 border-top border-3 border-success">
                            <div class="card-header bg-white py-3"><h5 class="mb-0 text-success"><i class="bi bi-currency-euro me-2"></i>Finances</h5></div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Nombre de pi√®ces</label>
                                    <input type="number" class="form-control" value="@_colis.NombrePieces" disabled />
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Valeur D√©clar√©e (‚Ç¨)</label>
                                    <input type="number" class="form-control" @bind="_colis.ValeurDeclaree" disabled />
                                    <div class="form-text small">Calcul√©e via l'inventaire</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Volume (m¬≥)</label>
                                    <input type="number" class="form-control" @bind="_colis.Volume" disabled="@(!IsAdmin)" />
                                </div>
                                
                                <hr class="text-muted" />
                                
                                @if (IsAdmin)
                                {
                                    <!-- Calculateur Rapide (Informatif) -->
                                     <div class="bg-light p-2 rounded mb-3 border">
                                        <label class="form-label small fw-bold text-muted">Calculateur de prix</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">Prix/m¬≥</span>
                                            <!-- On ne lie plus √† CalculatePrice, juste un binding simple -->
                                            <input type="number" class="form-control" @bind="_pricePerM3" @bind:event="oninput" placeholder="0.00" />
                                        </div>
                                        <div class="text-end mt-1">
                                            <small class="text-muted">
                                                Prix estim√© : <strong>@((_colis.Volume * _pricePerM3).ToString("C2"))</strong>
                                            </small>
                                        </div>
                                    </div>
                                }
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-primary">PRIX TOTAL (‚Ç¨)</label>
                                    <input type="number" class="form-control form-control-lg fw-bold text-primary" @bind="_colis.PrixTotal" disabled="@(!IsAdmin)" />
                                </div>
                                
                                 <div class="d-flex justify-content-between small mb-2">
                                     <span>Pay√© :</span>
                                     <span class="text-success fw-bold">@_colis.SommePayee.ToString("C2")</span>
                                 </div>
                                 <div class="d-flex justify-content-between fw-bold fs-5">
                                     <span>Reste :</span>
                                     <span class="text-danger">@_colis.RestantAPayer.ToString("C2")</span>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ONGLET 2 : DOCUMENTS (Nouveau) -->
            @if (!IsNew)
            {
                <div class="tab-pane fade @(_activeTab == "documents" ? "show active" : "")">
                    <DocumentManager EntityId="@_colis.Id" EntityType="Colis" />
                </div>
            }
            <!-- ONGLET 3 : SUIVI & DISCUSSION -->
            @if (!IsNew)
            {
                <div class="tab-pane fade @(_activeTab == "suivi" ? "show active" : "")">
                    <div class="row g-4">
                        <div class="col-lg-5">
                            <!-- TIMELINE -->
                            <Timeline EntityId="@_colis.Id" EntityType="Colis" />
                        </div>
                        <div class="col-lg-7">
                            <!-- CHAT -->
							<!-- On passe _activeTab == "suivi" pour dire au chat s'il est affich√© -->
							<ChatBox EntityId="@_colis.Id" 
									 EntityType="Colis" 
									 OnUnreadCountChanged="UpdateUnreadBadge" 
									 IsVisible="@(_activeTab == "suivi")" />
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    
    <!-- MODALS -->
	<InventoryModal IsVisible="_showInventory" 
					IsReadOnly="@(!CanEditFields)"
					JsonData="@_colis.InventaireJson"
					Signature="@_colis.SignatureClientInventaire"
					Lieu="@_colis.LieuSignatureInventaire"
					Date="@_colis.DateSignatureInventaire"
					OnSave="SaveInventory"
					OnClose="() => _showInventory = false" />
    <PaymentModal IsVisible="_showPayments"
                  IsAdmin="@IsAdmin"
                  ColisId="@_colis.Id"
                  ClientId="@_colis.ClientId"
                  TotalAmount="@_colis.PrixTotal"
                  OnPaymentsChanged="UpdatePaidAmount"
                  OnClose="() => _showPayments = false" />
</div>
@code {
    [Parameter] public Guid? Id { get; set; }
    private Colis _colis = new() { DateArrivee = DateTime.UtcNow, Statut = StatutColis.EnAttente };
    private bool _isLoading = true;
    private bool IsNew => Id == null;
    
    // Navigation Tabs
    private string _activeTab = "infos";
    // Contexte Utilisateur
    private bool IsAdmin = false;
    private Guid CurrentUserId;
    
    // UI State
    private string _clientNameDisplay = "";
    private string _firstBarcode = "";
    private bool _sameAsClient = false;
    private bool _showInventory = false;
    private bool _showPayments = false;
    private decimal _pricePerM3 = 0;
    
    // Admin Search
    private string _clientSearch = "";
    private List<Client> _filteredClients = new();
    private List<Conteneur> _containers = new();
    // Logic Permissions
    private bool CanEditGlobal => IsAdmin || (IsNew || _colis.Statut == StatutColis.EnAttente);
    private bool CanEditFields => IsAdmin || (CanEditGlobal); 
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        IsAdmin = user.IsInRole("Administrateur");
        var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);
        if (userIdClaim != null) Guid.TryParse(userIdClaim.Value, out CurrentUserId);
        if (IsAdmin)
        {
             _containers = (await ApiService.GetConteneursAsync())?.ToList() ?? new();
        }
        if (!IsNew)
        {
            var dto = await ApiService.GetColisByIdAsync(Id.Value);
            if (dto != null) 
            {
                _colis = dto;
                _clientNameDisplay = _colis.Client?.NomComplet ?? "Inconnu";
                _firstBarcode = _colis.Barcodes.FirstOrDefault()?.Value ?? "";
                // V√©rification automatique de la case √† cocher "Destinataire identique"
                if (_colis.Client != null)
                {
                    var destNom = _colis.Destinataire?.Trim().ToLower() ?? "";
                    var clientNom = _colis.Client.NomComplet.Trim().ToLower();
                    // Pour √™tre s√ªr, on v√©rifie que le nom n'est pas vide
                    if (!string.IsNullOrEmpty(destNom) && destNom == clientNom)
                    {
                        _sameAsClient = true;
                    }
                }
            }
        }
        else
        {
            if (!IsAdmin)
            {
                var profile = await ApiService.GetUserProfileAsync();
                if (profile != null)
                {
                    _colis.ClientId = profile.ClientId;
                    _clientNameDisplay = $"{profile.Nom} {profile.Prenom}";
                    await GenerateBarcode();
                    _sameAsClient = true;
                    ToggleSameAsClient(); 
                }
            }
        }
        
        _isLoading = false;
    }
    private async Task FilterClients(KeyboardEventArgs e)
    {
        if (string.IsNullOrEmpty(_clientSearch) || _clientSearch.Length < 2) 
        {
            _filteredClients.Clear(); return;
        }
        var allClients = await ApiService.GetClientsAsync();
        if (allClients != null)
        {
            _filteredClients = allClients.Where(c => c.NomComplet.Contains(_clientSearch, StringComparison.OrdinalIgnoreCase)).Take(5).ToList();
        }
    }
    private void SelectClient(Client client)
    {
        _colis.ClientId = client.Id;
        _clientNameDisplay = client.NomComplet;
        _filteredClients.Clear();
        _clientSearch = "";
        
        // Si "Identique" est coch√©, on met √† jour le destinataire imm√©diatement
        if (_sameAsClient) ToggleSameAsClient();
    }
    private async Task GenerateBarcode()
    {
        var code = await ApiService.GenerateBarcodeAsync();
        if (!string.IsNullOrEmpty(code)) _firstBarcode = code;
    }
    private void ToggleSameAsClient()
    {
        if (_sameAsClient)
        {
            _colis.Destinataire = _clientNameDisplay;
            // Si on avait le client complet, on mettrait aussi le t√©l√©phone
        }
    }
    
    // Gestion Modals
    private void ShowInventory() => _showInventory = true;
	
	private async Task SaveInventory(InventoryModal.InventoryResult result)
    {
        // 1. Mise √† jour locale (pour affichage imm√©diat)
        _colis.InventaireJson = result.Json;
        _colis.SignatureClientInventaire = result.Signature;
        _colis.LieuSignatureInventaire = result.Lieu;
        _colis.DateSignatureInventaire = result.Date;
        
        // Fermeture de la modale uniquement
        _showInventory = false;
        // 2. Calculs locaux
        int newPieces = 0;
        decimal newValeur = 0;
        if (!string.IsNullOrEmpty(result.Json))
        {
            try
            {
                var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true, PropertyNamingPolicy = JsonNamingPolicy.CamelCase };
                var items = JsonSerializer.Deserialize<List<InventaireItem>>(result.Json, options);
                if (items != null && items.Any())
                {
                    newPieces = items.Sum(i => i.Quantite);
                    newValeur = items.Sum(i => i.Valeur); 
                }
                
                _colis.NombrePieces = newPieces;
                _colis.ValeurDeclaree = newValeur;
            }
            catch { }
        }
        // 3. Sauvegarde via l'API d√©di√©e (SANS REDIRECTION)
        try
        {
            var dto = new UpdateInventaireDto
            {
                ColisId = _colis.Id,
                InventaireJson = _colis.InventaireJson,
                TotalPieces = newPieces,
                TotalValeurDeclaree = newValeur,
                // Ajout des signatures
                LieuSignatureInventaire = _colis.LieuSignatureInventaire,
                DateSignatureInventaire = _colis.DateSignatureInventaire,
                SignatureClientInventaire = _colis.SignatureClientInventaire
            };
            var success = await ApiService.UpdateInventaireAsync(dto);
            
            if (success)
            {
                // Feedback discret (optionnel) ou rien
                StateHasChanged(); // Rafra√Æchir la vue pour afficher les nouvelles valeurs (pi√®ces, prix)
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Erreur lors de la sauvegarde de l'inventaire.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur SaveInventory: {ex.Message}");
        }
    }
    private void ShowPayments() => _showPayments = true;
    private void UpdatePaidAmount(decimal totalPaid)
    {
        _colis.SommePayee = totalPaid;
    }
    private async Task SaveParcel()
    {
        var barcodesList = new List<string>();
        if(!string.IsNullOrEmpty(_firstBarcode)) barcodesList.Add(_firstBarcode);
        
        if (IsNew)
        {
            var createDto = new CreateColisDto
            {
                ClientId = _colis.ClientId,
                Designation = _colis.Designation,
                DestinationFinale = _colis.DestinationFinale,
                Barcodes = barcodesList,
                Type = _colis.Type,
                TypeEnvoi = _colis.TypeEnvoi,
                EstFragile = _colis.EstFragile,
                ManipulationSpeciale = _colis.ManipulationSpeciale,
                InstructionsSpeciales = _colis.InstructionsSpeciales,
                Destinataire = _colis.Destinataire,
                TelephoneDestinataire = _colis.TelephoneDestinataire,
                LivraisonADomicile = _colis.LivraisonADomicile,
                AdresseLivraison = _colis.AdresseLivraison,
                InventaireJson = _colis.InventaireJson,
                Volume = IsAdmin ? _colis.Volume : 0,
                PrixTotal = IsAdmin ? _colis.PrixTotal : 0,
                ConteneurId = IsAdmin ? _colis.ConteneurId : null
            };
            await ApiService.CreateColisAsync(createDto);
        }
        else
        {
            var updateDto = new UpdateColisDto
            {
                Id = _colis.Id,
                ClientId = _colis.ClientId,
                Designation = _colis.Designation,
                DestinationFinale = _colis.DestinationFinale,
                Barcodes = _colis.Barcodes.Select(b => b.Value).ToList(),
                Statut = _colis.Statut,
                Type = _colis.Type,
                TypeEnvoi = _colis.TypeEnvoi,
                EstFragile = _colis.EstFragile,
                ManipulationSpeciale = _colis.ManipulationSpeciale,
                InstructionsSpeciales = _colis.InstructionsSpeciales,
                Destinataire = _colis.Destinataire,
                TelephoneDestinataire = _colis.TelephoneDestinataire,
                LivraisonADomicile = _colis.LivraisonADomicile,
                AdresseLivraison = _colis.AdresseLivraison,
                InventaireJson = _colis.InventaireJson,
                Volume = _colis.Volume,
                PrixTotal = _colis.PrixTotal,
                ConteneurId = _colis.ConteneurId,
                SommePayee = _colis.SommePayee,
                LieuSignatureInventaire = _colis.LieuSignatureInventaire,
                DateSignatureInventaire = _colis.DateSignatureInventaire,
                SignatureClientInventaire = _colis.SignatureClientInventaire
            };
            if(!string.IsNullOrEmpty(_firstBarcode) && !updateDto.Barcodes.Contains(_firstBarcode))
            {
                updateDto.Barcodes.Add(_firstBarcode);
            }
            await ApiService.UpdateColisAsync(_colis.Id, updateDto);
        }
        
        Navigation.NavigateTo("/my-parcels");
    }
	
	private string GetStatusBadgeClass(StatutColis status)
	{
		return status switch
		{
			StatutColis.EnAttente => "bg-warning text-dark",
			StatutColis.Affecte => "bg-info text-dark",
			StatutColis.EnTransit => "bg-primary",
			StatutColis.Arrive => "bg-info",
			StatutColis.EnDedouanement => "bg-secondary",
			StatutColis.Livre => "bg-success",
			StatutColis.Probleme => "bg-danger",
			StatutColis.Perdu => "bg-dark",
			_ => "bg-secondary"
		};
	}
	
    private bool _isExportMenuOpen = false;
    private void ToggleExportMenu() => _isExportMenuOpen = !_isExportMenuOpen;
	private async Task ExportPdf(bool includeFinancials, bool includePhotos)
    {
        _isExportMenuOpen = false;
        _isLoading = true;
        StateHasChanged();
        try
        {
            // Appel avec les deux bool√©ens
            var pdfData = await ApiService.ExportColisPdfAsync(_colis.Id, includeFinancials, includePhotos);
            if (pdfData != null && pdfData.Length > 0)
            {
                var safeRef = _colis.NumeroReference.Replace("/", "-");
                var fileName = $"Colis_{safeRef}.pdf";
                using var stream = new MemoryStream(pdfData);
                using var streamRef = new DotNetStreamReference(stream);
                await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Erreur: Fichier vide re√ßu.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Erreur: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
		
    }
	
	private int _unreadMessagesCount = 0;
    
    private async Task UpdateUnreadBadge(int count)
    {
        _unreadMessagesCount = count;
        // CORRECTION : On utilise InvokeAsync pour revenir sur le thread UI
        await InvokeAsync(StateHasChanged);
    }
	
}
