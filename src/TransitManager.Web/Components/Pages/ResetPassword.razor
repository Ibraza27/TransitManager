@page "/reset-password"
@layout TransitManager.Web.Components.Layout.EmptyLayout
@using System.ComponentModel.DataAnnotations
@using TransitManager.Core.DTOs
@using TransitManager.Web.Services
@inject IApiService ApiService
@inject NavigationManager Navigation

<PageTitle>Réinitialisation du mot de passe</PageTitle>

<div class="container d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="card shadow-lg border-0 p-4" style="width: 100%; max-width: 450px;">
        <div class="text-center mb-4">
            <h3 class="fw-bold text-primary">Nouveau mot de passe</h3>
            <p class="text-muted">Définissez votre nouveau mot de passe sécurisé.</p>
        </div>

        @if (_success)
        {
            <div class="alert alert-success text-center">
                <i class="bi bi-check-circle-fill fs-1 d-block mb-2"></i>
                <strong>Mot de passe modifié !</strong><br/>
                Vous pouvez maintenant vous connecter.
            </div>
            <div class="d-grid">
                <a href="login" class="btn btn-primary">Aller à la connexion</a>
            </div>
        }
        else if (_invalidLink)
        {
            <div class="alert alert-danger text-center">
                <i class="bi bi-x-circle-fill fs-1 d-block mb-2"></i>
                <strong>Lien invalide ou expiré</strong><br/>
                Veuillez refaire une demande de réinitialisation.
            </div>
            <div class="d-grid">
                <a href="forgot-password" class="btn btn-outline-secondary">Renvoyer une demande</a>
            </div>
        }
        else
        {
            <EditForm Model="@_model" OnValidSubmit="HandleReset">
                <DataAnnotationsValidator />
                
                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <div class="alert alert-danger">@_errorMessage</div>
                }

                <div class="mb-3">
                    <label class="form-label">Nouveau mot de passe</label>
                    <InputText type="password" class="form-control" @bind-Value="_model.NewPassword" placeholder="******" />
                    <ValidationMessage For="@(() => _model.NewPassword)" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Confirmer le mot de passe</label>
                    <InputText type="password" class="form-control" @bind-Value="_model.ConfirmPassword" placeholder="******" />
                    <ValidationMessage For="@(() => _model.ConfirmPassword)" />
                </div>

                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-primary" disabled="@_isBusy">
                        @if (_isBusy)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span> <span>Traitement...</span>
                        }
                        else
                        {
                            <span>Valider le changement</span>
                        }
                    </button>
                    <a href="login" class="btn btn-link text-decoration-none text-muted">Annuler</a>
                </div>
            </EditForm>
        }
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    public string? Token { get; set; }

    [SupplyParameterFromQuery]
    public string? Email { get; set; }

    private ResetPasswordDto _model = new();
    private bool _isBusy = false;
    private bool _success = false;
    private bool _invalidLink = false;
    private string? _errorMessage;

    protected override void OnInitialized()
    {
        // Vérification basique des paramètres d'URL
        if (string.IsNullOrEmpty(Token) || string.IsNullOrEmpty(Email))
        {
            _invalidLink = true;
        }
        else
        {
            // Preremplissage du modèle
            _model.Token = Token;
            _model.Email = Email;
        }
    }

    private async Task HandleReset()
    {
        _isBusy = true;
        _errorMessage = null;

        try
        {
            var result = await ApiService.ResetPasswordAsync(_model);
            if (result)
            {
                _success = true;
            }
            else
            {
                _errorMessage = "Impossible de réinitialiser le mot de passe. Le lien a peut-être expiré.";
            }
        }
        catch
        {
            _errorMessage = "Une erreur technique est survenue.";
        }
        finally
        {
            _isBusy = false;
        }
    }
}