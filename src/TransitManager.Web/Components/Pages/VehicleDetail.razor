@page "/vehicule/edit/{Id:guid}"
@page "/vehicule/detail/{Id:guid}"
@page "/vehicule/create"
@using TransitManager.Core.Entities
@using TransitManager.Core.Enums
@using TransitManager.Web.Components.Shared
@using System.Security.Claims
@using System.IO
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime

<PageTitle>@(IsNew ? "Nouveau V√©hicule" : "D√©tail V√©hicule") - Hippocampe</PageTitle>

<div class="container mt-4 mb-5">
    <!-- En-t√™te -->
    <!-- En-t√™te Sticky -->
    <div class="sticky-top bg-white shadow-sm py-3 px-3 mx-n3 mb-4 border-bottom" style="z-index: 1010;">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <div>
                <h2 class="fw-bold text-primary mb-1">
                    <i class="bi bi-car-front-fill me-2"></i>
                    @(IsNew ? "Nouveau V√©hicule" : "D√©tail du V√©hicule")
                </h2>
                @if (!IsNew)
                {
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge @GetStatusBadgeClass(_vehicule.Statut)">@_vehicule.Statut</span>
                        <span class="text-muted small">Immat: <span class="font-monospace text-dark fw-bold">@_vehicule.Immatriculation</span></span>
                    </div>
                }
            </div>
            <div class="d-flex flex-wrap gap-2 position-relative w-100 w-md-auto">
                <!-- MENU EXPORT -->
                <div class="dropdown">
                    <button class="btn btn-danger dropdown-toggle" type="button" @onclick="ToggleExportMenu">
                        <i class="bi bi-file-earmark-pdf me-2"></i>PDF
                    </button>
                    <ul class="dropdown-menu @(_isExportMenuOpen ? "show" : "")" style="right: auto; left: 0; margin-top: 5px;">
                        <li>
                            <button class="dropdown-item" @onclick="() => ExportPdf(false, false)">
                                üìÑ √âtat des lieux Simple
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item" @onclick="() => ExportPdf(true, false)">
                                üí∞ √âtat des lieux + Prix
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item" @onclick="() => ExportPdf(true, true)">
                                üì∏ Dossier Complet (+ Photos)
                            </button>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <button class="dropdown-item" @onclick="ExportAttestation">
                                ‚öñÔ∏è Attestation de Valeur
                            </button>
                        </li>
                    </ul>
                    @if (_isExportMenuOpen)
                    {
                        <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 900;" @onclick="ToggleExportMenu"></div>
                    }
                </div>
                <button class="btn btn-primary shadow-sm" @onclick="() => SaveVehicle()" disabled="@(!CanEditGlobal)">
                    <i class="bi bi-save me-2"></i> Enregistrer
                </button>
                <a href="/my-vehicles" class="btn btn-dark">Retour</a>
            </div>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
    }
    else
    {
        <!-- TABS NAVIGATION (Floating Pills - 3 par ligne) -->
        <ul class="nav nav-pills mb-4 bg-light p-2 rounded shadow-sm row g-2">
            <li class="nav-item col-4 col-md-4">
                <button class="nav-link w-100 text-truncate @(_activeTab == "infos" ? "active shadow fw-bold" : "")" @onclick='() => _activeTab = "infos"'>
                    <i class="bi bi-info-circle me-2"></i>Infos
                </button>
            </li>
            
            <!-- ONGLET SUIVI (NOUVEAU) -->
            @if (!IsNew)
            {
                <li class="nav-item col-4 col-md-4">
                    <button class="nav-link w-100 text-truncate @(_activeTab == "suivi" ? "active shadow fw-bold" : "")" @onclick='() => _activeTab = "suivi"'>
                        <i class="bi bi-clock-history me-2"></i>Suivi
                    </button>
                </li>
                 <li class="nav-item col-4 col-md-4">
                    <button class="nav-link w-100 text-truncate @(_activeTab == "discussion" ? "active shadow fw-bold" : "")" @onclick='() => _activeTab = "discussion"'>
                        <i class="bi bi-chat-left-text me-2"></i> Chat
                        @if(_unreadMessagesCount > 0 && _activeTab != "discussion")
                        {
                            <span class="badge bg-danger rounded-pill ms-2">@_unreadMessagesCount</span>
                        }
                    </button>
                </li>
            }

             @if (!IsNew)
             {
                <li class="nav-item col-4 col-md-4">
                    <button class="nav-link w-100 text-truncate @(_activeTab == "documents" ? "active shadow fw-bold" : "")" @onclick='() => _activeTab = "documents"'>
                        <i class="bi bi-folder2-open me-2"></i>Docs
                         @if (GetMissingDocumentsCount() > 0)
                        {
                            <span class="badge bg-danger rounded-pill ms-2">@GetMissingDocumentsCount()</span>
                        }
                    </button>
                </li>
             }
            @if(!IsNew)
            {
                 <li class="nav-item col-4 col-md-4">
                    <button class="nav-link w-100 text-truncate @(_activeTab == "sav" ? "active shadow fw-bold" : "")" @onclick='() => _activeTab = "sav"'>
                        <i class="bi bi-shield-check me-2"></i>SAV
                         @if (_receptionControl != null)
                        {
                            <span class="badge rounded-pill ms-2 @(_receptionControl.Status == ReceptionStatus.ReceivedFull ? "bg-success" : "bg-danger")">
                                @(_receptionControl.Status == ReceptionStatus.ReceivedFull ? "OK" : "!")
                            </span>
                        }
                    </button>
                </li>
            }
        </ul>

        <div class="tab-content">
            
            <!-- ONGLET 1 : INFOS (Existant) -->
            <div class="tab-pane fade @(_activeTab == "infos" ? "show active" : "")">
                <div class="row g-4">
                    <div class="col-lg-8">
                        <!-- Propri√©taire & Destinataire -->
                        <div class="card shadow-sm border-0 mb-4">
                            <div class="card-header bg-white"><h5 class="mb-0 text-primary">Propri√©taire & Destinataire</h5></div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label class="form-label fw-bold">Client Propri√©taire</label>
                                        @if (IsAdmin)
                                        {
                                             <select class="form-select" value="@_vehicule.ClientId" @onchange="OnClientChanged">
                                                 <option value="">-- S√©lectionner --</option>
                                                 @foreach (var client in _clients) { <option value="@client.Id">@client.NomComplet</option> }
                                             </select>
                                        }
                                        else { <input type="text" class="form-control" value="@_clientNameDisplay" disabled /> }
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sameRecipient" checked="@_sameAsClient" @onchange="OnSameAsClientCheckedChanged" disabled="@(!CanEditFields)">
                                            <label class="form-check-label" for="sameRecipient">Destinataire identique au propri√©taire</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Nom Destinataire</label>
                                        <input type="text" class="form-control" @bind="_vehicule.Destinataire" disabled="@(_sameAsClient || !CanEditFields)" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">T√©l Destinataire</label>
                                        <input type="text" class="form-control" @bind="_vehicule.TelephoneDestinataire" disabled="@(_sameAsClient || !CanEditFields)" />
                                    </div>

                                    <!-- ADRESSE FRANCE -->
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">Adresse en France</label>
                                            @if (CanEditFields)
                                            {
                                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="CopyAddressFrance" title="Copier l'adresse du profil">
                                                    <i class="bi bi-box-arrow-in-down me-1"></i>Copier du profil
                                                </button>
                                            }
                                        </div>
                                        <textarea class="form-control" rows="3" style="field-sizing: content; min-height: 80px;" @bind="_vehicule.AdresseFrance" disabled="@(!CanEditFields)"></textarea>
                                    </div>

                                    <!-- ADRESSE DESTINATION -->
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">@DestinationLabel</label>
                                            @if (CanEditFields)
                                            {
                                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="CopyAddressDestination" title="Copier l'adresse du profil">
                                                    <i class="bi bi-box-arrow-in-down me-1"></i>Copier du profil
                                                </button>
                                            }
                                        </div>
                                        <textarea class="form-control" rows="3" style="field-sizing: content; min-height: 80px;" @bind="_vehicule.AdresseDestination" disabled="@(!CanEditFields)"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Infos V√©hicule -->
                        <div class="card shadow-sm border-0 mb-4">
                            <div class="card-header bg-white"><h5 class="mb-0 text-primary">V√©hicule</h5></div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Immatriculation *</label>
                                        <input type="text" class="form-control fw-bold" @bind="_vehicule.Immatriculation" disabled="@(!CanEditFields)" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Marque *</label>
                                        <input type="text" class="form-control" @bind="_vehicule.Marque" disabled="@(!CanEditFields)" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Mod√®le *</label>
                                        <input type="text" class="form-control" @bind="_vehicule.Modele" disabled="@(!CanEditFields)" />
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Ann√©e</label>
                                        <input type="number" class="form-control" @bind="_vehicule.Annee" disabled="@(!CanEditFields)" />
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Kilom√©trage</label>
                                        <input type="number" class="form-control" @bind="_vehicule.Kilometrage" disabled="@(!CanEditFields)" />
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Type</label>
                                        <select class="form-select" @bind="_vehicule.Type" disabled="@(!CanEditFields)">
                                            @foreach(var t in Enum.GetValues<TypeVehicule>()) {<option value="@t">@t</option>}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Motorisation</label>
                                        <select class="form-select" @bind="_vehicule.Motorisation" disabled="@(!CanEditFields)">
                                            @foreach(var m in Enum.GetValues<Core.Enums.Motorisation>()) {<option value="@m">@m</option>}
                                        </select>
                                    </div>
                                     <div class="col-md-3">
                                        <label class="form-label">Destination *</label>
                                        <input type="text" class="form-control" value="@_vehicule.DestinationFinale" @oninput="OnDestinationChanged" disabled="@(!CanEditFields)" />
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Commentaires</label>
                                        <textarea class="form-control" rows="2" @bind="_vehicule.Commentaires" disabled="@(!CanEditFields)"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <!-- √âtat des lieux -->
                        <div class="card shadow-sm border-info mb-4">
                            <div class="card-body text-center">
                                <h5 class="text-info mb-3"><i class="bi bi-clipboard-check me-2"></i>√âtat des Lieux</h5>
                                @if(!string.IsNullOrEmpty(_vehicule.SignatureAgent))
                                {
                                    <div class="alert alert-success py-2 small mb-2"><i class="bi bi-check-circle me-1"></i> Sign√© le @_vehicule.DateEtatDesLieux?.ToShortDateString()</div>
                                }
                                else
                                {
                                    <div class="alert alert-warning py-2 small mb-2">Non sign√©</div>
                                }
                                <button class="btn btn-info text-white w-100" @onclick="() => _showInspection = true">
                                    Ouvrir l'inspection
                                </button>
                            </div>
                        </div>
                        <!-- Administration -->
                        <div class="card shadow-sm border-0 mb-4">
                            <div class="card-header bg-light">Administration</div>
                            <div class="card-body">
                                <label class="form-label small fw-bold">STATUT</label>
                                <select class="form-select mb-3" @bind="_vehicule.Statut" disabled="@(!IsAdmin)">
                                     @foreach (var s in Enum.GetValues<StatutVehicule>()) { <option value="@s">@s</option> }
                                </select>
                                
                                <label class="form-label small fw-bold">CONTENEUR</label>
                                @if (IsAdmin)
                                {
                                     <select class="form-select" @bind="_vehicule.ConteneurId">
                                         <option value="">-- Non assign√© --</option>
                                         @foreach(var c in _containers) { <option value="@c.Id">@c.NumeroDossier</option> }
                                     </select>
                                }
                                else
                                {
                                     <input type="text" class="form-control" value="@(_containers.FirstOrDefault(c => c.Id == _vehicule.ConteneurId)?.NumeroDossier ?? "Non assign√©")" disabled />
                                }
                            </div>
                        </div>
                        <!-- Finances -->
                        <div class="card shadow-sm border-success">
                            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                <span class="fw-bold">Finances</span>
                                @if(!IsNew) {
                                    <button class="btn btn-sm btn-light text-success" @onclick="() => _showPayments = true">G√©rer</button>
                                }
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Valeur D√©clar√©e (‚Ç¨)</label>
                                    <input type="number" class="form-control" @bind="_vehicule.ValeurDeclaree" disabled="@(!CanEditFields)" />
                                </div>
                                @if(IsAdmin || IsNew || (_vehicule.Statut == Core.Enums.StatutVehicule.EnAttente && _vehicule.PrixTotal <= 0) || _vehicule.IsPriceCalculated) 
                                {
                                    <div class="mb-3">
                                         <button class="btn btn-sm btn-outline-primary w-100" @onclick="() => _showPriceProposal = true">
                                             <i class="bi bi-calculator me-1"></i> 
                                             @(_vehicule.IsPriceCalculated || (_vehicule.PrixTotal > 0 && !IsAdmin) ? "Voir d√©tail proposition" : "Obtenir une proposition")
                                         </button>
                                    </div>
                                }
                                    <div class="mb-3">
                                        <div class="form-check form-switch p-3 border rounded bg-warning-subtle text-warning-emphasis border-warning mb-2" 
                                             style="@( (_vehicule.ValeurDeclaree > 0 && _vehicule.PrixTotal > 0) ? "" : "opacity: 0.6; cursor: not-allowed;" )">
                                            <input class="form-check-input" type="checkbox" id="assuranceCheck" 
                                                   checked="@_vehicule.HasAssurance" 
                                                   @onchange="OnAssuranceToggle" 
                                                   disabled="@(!CanEditFields || _vehicule.ValeurDeclaree <= 0 || _vehicule.PrixTotal <= 0)">
                                            <label class="form-check-label fw-bold" for="assuranceCheck">
                                                Souscrire √† l'assurance (0.7%)
                                            </label>
                                            @if(_vehicule.ValeurDeclaree <= 0 || _vehicule.PrixTotal <= 0)
                                            {
                                                <div class="small fw-normal mt-1 text-muted">
                                                    * N√©cessite Valeur D√©clar√©e et Prix Total
                                                </div>
                                            }
                                        </div>
                                    </div>

                                @if(_vehicule.HasAssurance)
                                {
                                     <div class="mb-3 p-2 border rounded bg-light">
                                         <div class="d-flex justify-content-between small">
                                             <span>Prix (Hors Douane) :</span>
                                             <span>@_vehicule.PrixTotal.ToString("C2")</span>
                                         </div>
                                         <div class="d-flex justify-content-between small text-warning-emphasis">
                                             <span>Assurance :</span>
                                             <span>+@CalculateAssurance(_vehicule.ValeurDeclaree, _vehicule.PrixTotal).ToString("C2")</span>
                                         </div>
                                         <div class="border-top mt-2 pt-2 d-flex justify-content-between fw-bold text-primary">
                                             <span>TOTAL + ASSURANCE :</span>
                                             <span>@((_vehicule.PrixTotal + CalculateAssurance(_vehicule.ValeurDeclaree, _vehicule.PrixTotal)).ToString("C2"))</span>
                                         </div>
                                     </div>
                                }

                                <div class="mb-3">
                                    <label class="form-label fw-bold text-primary">PRIX TOTAL (HORS DOUANE) (‚Ç¨)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control fw-bold text-primary" @bind="_vehicule.PrixTotal" disabled="@(!IsAdmin)" />
                                        @if(_vehicule.IsPriceCalculated)
                                        {
                                            <span class="input-group-text bg-primary text-white" title="Prix calcul√© automatiquement">
                                                <i class="bi bi-calculator-fill"></i> Calcul√©
                                            </span>
                                        }
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between small mb-2">
                                     <span>Pay√© :</span>
                                     <span class="text-success fw-bold">@_vehicule.SommePayee.ToString("C2")</span>
                                 </div>
                                 <div class="d-flex justify-content-between fw-bold fs-5">
                                     <span>Reste :</span>
                                     <span class="text-danger">@_vehicule.RestantAPayer.ToString("C2")</span>
                                 </div>
                                    <div class="mt-2 text-muted small fst-italic text-center">
                                        Moyens de paiement accept√©s : Esp√®ces, CB, Virement, Paiement en ligne
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ONGLET 2 : SUIVI -->
            @if (!IsNew)
            {
                <div class="tab-pane fade @(_activeTab == "suivi" ? "show active" : "")">
                     <div class="row">
                        <div class="col-12">
                             <Timeline EntityId="@_vehicule.Id" EntityType="Vehicule" />
                        </div>
                    </div>
                </div>
            }

            <!-- ONGLET DISCUSSION -->
            @if (!IsNew)
            {
                <div class="tab-pane fade @(_activeTab == "discussion" ? "show active" : "")">
                     <div class="row">
                        <div class="col-12">
                            <ChatBox EntityId="@_vehicule.Id" 
                                     EntityType="Vehicule" 
                                     OnUnreadCountChanged="UpdateUnreadBadge" 
                                     IsVisible="@(_activeTab == "discussion")" />
                        </div>
                    </div>
                </div>
            }

            <!-- ONGLET 3 : DOCUMENTS (Existant) -->
            @if (!IsNew)
            {
                <div class="tab-pane fade @(_activeTab == "documents" ? "show active" : "")">
                    <DocumentManager EntityId="@_vehicule.Id" EntityType="Vehicule" />
                </div>
            }
        </div>
            
             <!-- ONGLET 5 : SAV -->
            @if (!IsNew)
            {
                <div class="tab-pane fade @(_activeTab == "sav" ? "show active" : "")">
                    <!-- Galerie Photos SAV -->
                    <SavPhotoGallery @ref="_savGallery" EntityId="@_vehicule.Id" EntityType="Vehicule" />

                    @if (_receptionControl == null)
                    {
                        <div class="text-center py-5">
                            <i class="bi bi-car-front fs-1 text-muted mb-3 d-block"></i>
                            <h4 class="fw-bold mb-3">R√©ception du V√©hicule</h4>
                            <p class="text-muted mb-4" style="max-width: 500px; margin: 0 auto;">
                                Avez-vous bien re√ßu ce v√©hicule ? Signalez-nous la bonne r√©ception ou un √©ventuel dommage pour nous aider √† am√©liorer notre service.
                            </p>
                            <button class="btn btn-primary px-5 py-3 rounded-pill shadow-sm" @onclick="() => _showSavWizard = true">
                                <i class="bi bi-ui-checks me-2"></i>Faire l'√©tat des lieux de r√©ception
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                                <h5 class="mb-0 text-primary">Rapport de R√©ception</h5>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge @(_receptionControl.Status == ReceptionStatus.ReceivedFull ? "bg-success" : "bg-danger") fs-6">
                                        @(_receptionControl.Status == ReceptionStatus.ReceivedFull ? "Conforme" : "Probl√®me Signal√©")
                                    </span>
                                    @if(IsAdmin)
                                    {
                                        <button class="btn btn-sm btn-outline-danger" @onclick="DeleteSavReport" title="Supprimer le rapport">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    }
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row g-4">
                                     <div class="col-md-6">
                                         <h6 class="fw-bold text-muted text-uppercase small">√âvaluations</h6>
                                         <div class="d-flex flex-column gap-2 mb-3">
                                             <div class="d-flex justify-content-between align-items-center p-2 rounded bg-light">
                                                 <span>Service Global</span>
                                                 <span class="fw-bold text-primary">@_receptionControl.RateService/10</span>
                                             </div>
                                             <div class="d-flex justify-content-between align-items-center p-2 rounded bg-light">
                                                 <span>√âtat V√©hicule</span>
                                                  <span class="fw-bold text-primary">@_receptionControl.RateCondition/10</span>
                                             </div>
                                         </div>
                                         @if (!string.IsNullOrEmpty(_receptionControl.GlobalComment))
                                         {
                                             <div class="alert alert-light border">
                                                 <i class="bi bi-chat-quote me-2 text-primary"></i>
                                                 <span class="fst-italic">"@_receptionControl.GlobalComment"</span>
                                             </div>
                                         }
                                     </div>
                                     <div class="col-md-6">
                                         @if (_receptionControl.Issues.Any())
                                         {
                                             <h6 class="fw-bold text-danger text-uppercase small">Probl√®mes Signal√©s</h6>
                                             <ul class="list-group list-group-flush">
                                                 @foreach(var issue in _receptionControl.Issues)
                                                 {
                                                     <li class="list-group-item px-0">
                                                         <div class="fw-bold text-danger"><i class="bi bi-exclamation-triangle me-2"></i>@GetTranslatedIssueType(issue.Type)</div>
                                                         <div class="small text-muted">@issue.Description</div>
                                                     </li>
                                                 }
                                             </ul>
                                         }
                                         else
                                         {
                                             <div class="alert alert-success d-flex align-items-center">
                                                 <i class="bi bi-check-circle-fill fs-4 me-3"></i>
                                                 <div>
                                                     <strong>Aucun probl√®me signal√©.</strong>
                                                     <div class="small">Le client a confirm√© la r√©ception conforme.</div>
                                                 </div>
                                             </div>
                                         }
                                     </div>
                                </div>
                                 @if (!string.IsNullOrEmpty(_receptionControl.SavSchemaPointsJson) || !string.IsNullOrEmpty(_receptionControl.SavSchemaStrokesJson))
                                {
                                    <div class="mt-4">
                                        <h6 class="fw-bold text-muted text-uppercase small mb-2">SCH√âMA DES DOMMAGES</h6>
                                        <SavVehicleSchema 
                                            ImageUrl="images/plans/vehicule_plan.png" 
                                            OriginalPointsJson="@_vehicule.EtatDesLieux"
                                            OriginalStrokesJson="@_vehicule.EtatDesLieuxRayures"
                                            PointsJson="@_receptionControl.SavSchemaPointsJson" 
                                            StrokesJson="@_receptionControl.SavSchemaStrokesJson"
                                            IsReadOnly="true" />
                                    </div>
                                }
                                <div class="text-end mt-4 text-muted small">
                                    Soumis le @_receptionControl.CreationDate.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }

    }

    <!-- MODALES -->
    <VehicleInspectionModal IsVisible="_showInspection"
                            Type="@_vehicule.Type"
                            IsReadOnly="@(_vehicule.Statut == Core.Enums.StatutVehicule.Livre || _vehicule.Statut == Core.Enums.StatutVehicule.Retourne)"
                            IsAdmin="@IsAdmin"
                            JsonPoints="@_vehicule.EtatDesLieux"
                            JsonStrokes="@_vehicule.EtatDesLieuxRayures"
                            JsonAccessoires="@_vehicule.AccessoiresJson"
                            SignatureAgent="@_vehicule.SignatureAgent"
                            SignatureClient="@_vehicule.SignatureClient"
                            Lieu="@_vehicule.LieuEtatDesLieux"
                            DateSignature="@_vehicule.DateEtatDesLieux"
                            OnSave="SaveInspection"
                            OnClose="() => _showInspection = false" />
    <PaymentModal IsVisible="_showPayments"
                  IsAdmin="@IsAdmin"
                  ColisId="@Guid.Empty"
                  VehiculeId="@_vehicule.Id"
                  ClientId="@_vehicule.ClientId"
                  TotalAmount="@_vehicule.PrixTotal"
                  OnPaymentsChanged="UpdatePaidAmount"
                  OnClose="() => _showPayments = false" />
    <PriceProposalModal IsVisible="_showPriceProposal"
                        IsReadOnly="@(_vehicule.PrixTotal > 0 && !IsAdmin)"
                        InitialLength="@_vehicule.DimensionsLongueurCm"
                        InitialWidth="@_vehicule.DimensionsLargeurCm"
                        InitialHeight="@_vehicule.DimensionsHauteurCm"
                        InitialPrice="@_vehicule.PrixTotal"
                        OnPriceConfirmed="@(args => UpdatePrice(args))"
                        OnClose="() => _showPriceProposal = false" />
                        
    @if (!IsNew)
    {
        <SavWizard Show="_showSavWizard" ShowChanged="@((v) => { _showSavWizard = v; if(!v) ReloadSav(); })"
               EntityType="Vehicule" EntityId="@_vehicule.Id" ClientId="@_vehicule.ClientId"
               Vehicule="_vehicule" />
    }
</div>

@code {
    [Parameter] public Guid? Id { get; set; }

    [SupplyParameterFromQuery]
    public string? Tab { get; set; }

    [SupplyParameterFromQuery]
    public string? Action { get; set; }

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrEmpty(Tab))
        {
            _activeTab = Tab.ToLower();
        }

        if (!string.IsNullOrEmpty(Action))
        {
            if (Action.ToLower() == "inspection") _showInspection = true;
            if (Action.ToLower() == "payment") _showPayments = true;
            if (Action.ToLower() == "priceproposal") _showPriceProposal = true;
        }
    }
    private Vehicule _vehicule = new() { Statut = StatutVehicule.EnAttente };

    private bool _isLoading = true;
    private bool IsNew => Id == null;
    private bool IsAdmin = false;

    private string _activeTab = "infos";
    private string _clientNameDisplay = "";
    private bool _sameAsClient = false;
    private bool _showInspection = false;
    private bool _showPayments = false;
    private bool _showPriceProposal = false; 
    private bool _isExportMenuOpen = false;
    private bool _showSavWizard = false;
    private ReceptionControl? _receptionControl;

    private int _unreadMessagesCount = 0;

    // --- ASSURANCE LOGIC ---
    private decimal CalculateAssurance(decimal valeurDeclaree, decimal prixTotal)
    {
        var baseAmount = (valeurDeclaree + prixTotal) * 1.2m; // +20%
        var assurance = (baseAmount * 0.007m) + 50m; // 0.7% + 50‚Ç¨
        return assurance < 250m ? 250m : assurance;
    }

    private decimal GetResteAPayer()
    {
        decimal total = _vehicule.PrixTotal;
        if (_vehicule.HasAssurance)
        {
            total += CalculateAssurance(_vehicule.ValeurDeclaree, _vehicule.PrixTotal);
        }
        return total - _vehicule.SommePayee;
    }

    private void OnAssuranceToggle(ChangeEventArgs e)
    {
        if (e.Value is bool val)
        {
            _vehicule.HasAssurance = val;
            StateHasChanged();
        }
    }
    // -----------------------

    private async Task UpdatePrice((decimal Price, int L, int W, int H) result)
    {
        _vehicule.PrixTotal = result.Price;
        _vehicule.DimensionsLongueurCm = result.L;
        _vehicule.DimensionsLargeurCm = result.W;
        _vehicule.DimensionsHauteurCm = result.H;
        _vehicule.IsPriceCalculated = true; 
        _showPriceProposal = false;

        // Auto-save to persist changes
        await SaveVehicle(false);
        StateHasChanged();
    }
    
    private async Task UpdateUnreadBadge(int count)
    {
        _unreadMessagesCount = count;
        await InvokeAsync(StateHasChanged);
    }

    private List<Client> _clients = new();
    private List<Conteneur> _containers = new();
    private bool CanEditGlobal => IsAdmin || (IsNew || _vehicule.Statut == StatutVehicule.EnAttente);
    private bool CanEditFields => IsAdmin || (CanEditGlobal);

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        IsAdmin = authState.User.IsInRole("Administrateur");
        if (IsAdmin)
        {
            var c = await ApiService.GetClientsAsync();
            if (c != null) _clients = c.OrderBy(x => x.Nom).ToList();

            var ct = await ApiService.GetConteneursAsync();
            if (ct != null) _containers = ct.ToList();
        }
        if (!IsNew)
        {
            _vehicule = await ApiService.GetVehiculeByIdAsync(Id.Value) ?? new();
            if (!IsAdmin)
            {
                 var client = await ApiService.GetClientByIdAsync(_vehicule.ClientId);
                 _clientNameDisplay = client?.NomComplet ?? "Client";
            }

            // Check same client
            if (_vehicule.Destinataire == (IsAdmin ? _clients.FirstOrDefault(c=>c.Id == _vehicule.ClientId)?.NomComplet : _clientNameDisplay))
            {
                _sameAsClient = true;
            }
            
            // SAV
            _receptionControl = await ApiService.GetReceptionControlAsync("Vehicule", Id.Value);
        }
        else
        {
            if (!IsAdmin)
            {
                var profile = await ApiService.GetUserProfileAsync();
                if (profile != null)
                {
                    _vehicule.ClientId = profile.ClientId;
                    _clientNameDisplay = $"{profile.Nom} {profile.Prenom}";
                    _sameAsClient = true;
                    await OnSameAsClientCheckedChanged(null);
                }
            }
        }
        _isLoading = false;
    }

    private async Task OnClientChanged(ChangeEventArgs e)
    {
        if (Guid.TryParse(e.Value?.ToString(), out Guid cid))
        {
            _vehicule.ClientId = cid;
            var c = _clients.FirstOrDefault(cl => cl.Id == cid);
            if(c != null) _clientNameDisplay = c.NomComplet;
            if (_sameAsClient) await OnSameAsClientCheckedChanged(null);
        }
    }

    private async Task OnSameAsClientCheckedChanged(ChangeEventArgs? e)
    {
        if(e != null)
        {
             _sameAsClient = (bool)e.Value!;
        }

        if (_sameAsClient)
        {
            Client? c = null;
            if(IsAdmin)
            {
               c = _clients.FirstOrDefault(cl => cl.Id == _vehicule.ClientId);
               // If not found in memory list (should be there), fetch it
               if(c == null) c = await ApiService.GetClientByIdAsync(_vehicule.ClientId);
            }
            else
            {
               // For Client view, fetch profile
               c = await ApiService.GetClientByIdAsync(_vehicule.ClientId);
            }

            if(c != null)
            {
                _vehicule.Destinataire = c.NomComplet;
                _vehicule.TelephoneDestinataire = c.TelephonePrincipal;
            }
        }
    }

    private async Task CopyAddressFrance()
    {
        Client? client = null;
        if(IsAdmin) client = _clients.FirstOrDefault(c => c.Id == _vehicule.ClientId);
        
        if(client == null)
        {
             client = await ApiService.GetClientByIdAsync(_vehicule.ClientId);
        }
        
        if (client != null)
        {
             // Pas de nom
             _vehicule.AdresseFrance = $"{client.AdressePrincipale}\n{client.CodePostal} {client.Ville} {client.Pays}".Trim();
        }
    }

    private async Task CopyAddressDestination()
    {
        Client? client = null;
        if(IsAdmin) client = _clients.FirstOrDefault(c => c.Id == _vehicule.ClientId);
        
        if(client == null)
        {
             client = await ApiService.GetClientByIdAsync(_vehicule.ClientId);
        }
        
        if (client != null)
        {
            if (!string.IsNullOrWhiteSpace(client.AdresseLivraison))
            {
                 // Pas de nom
                 _vehicule.AdresseDestination = $"{client.AdresseLivraison}".Trim();
            }
            else
            {
                 // Pas de nom
                 _vehicule.AdresseDestination = $"{client.AdressePrincipale}\n{client.CodePostal} {client.Ville} {client.Pays}".Trim();
            }
        }
    }

    private void ToggleExportMenu() => _isExportMenuOpen = !_isExportMenuOpen;

    private async Task ExportPdf(bool includeFinancials, bool includePhotos)
    {
        _isExportMenuOpen = false;
        _isLoading = true;
        StateHasChanged();
        try
        {
            var pdfData = await ApiService.ExportVehiculePdfAsync(_vehicule.Id, includeFinancials, includePhotos);
            if (pdfData != null && pdfData.Length > 0)
            {
                var safeImmat = _vehicule.Immatriculation.Replace(" ", "_");
                var fileName = $"Vehicule_{safeImmat}.pdf";
                using var stream = new MemoryStream(pdfData);
                using var streamRef = new DotNetStreamReference(stream);
                await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Erreur: Fichier vide re√ßu.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Erreur: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task UpdatePaidAmount(decimal total)
    {
        _vehicule.SommePayee = total;
        if (!IsNew) await ApiService.UpdateVehiculeAsync(_vehicule.Id, _vehicule);
    }

    // Callback de la modale d'inspection
    private void SaveInspection(VehicleInspectionModal.InspectionResult result)
    {
        _vehicule.EtatDesLieux = result.EtatDesLieuxPoints;
        _vehicule.EtatDesLieuxRayures = result.EtatDesLieuxRayures;
        _vehicule.AccessoiresJson = result.AccessoiresJson;
        _vehicule.SignatureAgent = result.SignatureAgent;
        _vehicule.SignatureClient = result.SignatureClient;
        _vehicule.LieuEtatDesLieux = result.Lieu;
        _vehicule.DateEtatDesLieux = result.Date;

        _showInspection = false;
    }

    private async Task SaveVehicle(bool redirect = true)
    {
        if (string.IsNullOrWhiteSpace(_vehicule.Immatriculation) || string.IsNullOrWhiteSpace(_vehicule.Marque))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Immatriculation et Marque requises.");
            return;
        }

        var toSend = new Vehicule
        {
            Id = _vehicule.Id,
            ClientId = _vehicule.ClientId,
            ConteneurId = _vehicule.ConteneurId,
            Immatriculation = _vehicule.Immatriculation,
            Marque = _vehicule.Marque,
            Modele = _vehicule.Modele,
            Annee = _vehicule.Annee,
            Kilometrage = _vehicule.Kilometrage,
            Type = _vehicule.Type,
            Statut = _vehicule.Statut,
            DestinationFinale = _vehicule.DestinationFinale,
            Destinataire = _vehicule.Destinataire,
            TelephoneDestinataire = _vehicule.TelephoneDestinataire,
            AdresseFrance = _vehicule.AdresseFrance,
            AdresseDestination = _vehicule.AdresseDestination,
            Commentaires = _vehicule.Commentaires,
            ValeurDeclaree = _vehicule.ValeurDeclaree,
            PrixTotal = _vehicule.PrixTotal,
            SommePayee = _vehicule.SommePayee,
            
            // Donn√©es Inspection
            EtatDesLieux = _vehicule.EtatDesLieux,
            EtatDesLieuxRayures = _vehicule.EtatDesLieuxRayures,
            AccessoiresJson = _vehicule.AccessoiresJson,
            SignatureAgent = _vehicule.SignatureAgent,
            SignatureClient = _vehicule.SignatureClient,
            LieuEtatDesLieux = _vehicule.LieuEtatDesLieux,
            DateEtatDesLieux = _vehicule.DateEtatDesLieux,
            Motorisation = _vehicule.Motorisation,
            
            // Dimensions
            DimensionsLongueurCm = _vehicule.DimensionsLongueurCm,
            DimensionsLargeurCm = _vehicule.DimensionsLargeurCm,
            DimensionsHauteurCm = _vehicule.DimensionsHauteurCm,
            IsPriceCalculated = _vehicule.IsPriceCalculated,
            
            // FIX: Assurance Checkbox Persistence
            HasAssurance = _vehicule.HasAssurance,
            RowVersion = _vehicule.RowVersion
        };

        bool success = false;
        if (IsNew)
        {
            toSend.Id = Guid.Empty;
            var createdVehicle = await ApiService.CreateVehiculeAsync(toSend);
            if (createdVehicle != null)
            {
                Navigation.NavigateTo($"/vehicule/detail/{createdVehicle.Id}");
                return;
            }
        }
        else
        {
            success = await ApiService.UpdateVehiculeAsync(toSend.Id, toSend);
             if (success)
            {
                 // Stay on page (Edit Mode)
                 await OnInitializedAsync(); // Refresh data
                 StateHasChanged();
                 await JSRuntime.InvokeVoidAsync("alert", "Modifications enregistr√©es.");
                 return;
            }
        }
        
        if (success)
        {
             if(redirect) Navigation.NavigateTo("/my-vehicles");
        }
        else 
        {
            await JSRuntime.InvokeVoidAsync("alert", "Erreur sauvegarde");
        }
    }

    private string GetStatusBadgeClass(StatutVehicule s) => s switch
    {
        StatutVehicule.EnAttente => "bg-warning text-dark",
        StatutVehicule.Livre => "bg-success",
        StatutVehicule.Probleme => "bg-danger",
        _ => "bg-info text-dark"
    };
	
	private async Task ExportAttestation()
    {
        _isExportMenuOpen = false;
        _isLoading = true;
        StateHasChanged();

        try
        {
            var pdfData = await ApiService.ExportAttestationValeurPdfAsync(_vehicule.Id);

            if (pdfData != null && pdfData.Length > 0)
            {
                var safeImmat = _vehicule.Immatriculation.Replace(" ", "_");
                var fileName = $"Attestation_Valeur_{safeImmat}.pdf";

                using var stream = new MemoryStream(pdfData);
                using var streamRef = new DotNetStreamReference(stream);

                await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Erreur: Fichier vide re√ßu.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Erreur: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
    private int GetMissingDocumentsCount()
    {
        if (_vehicule.Documents == null) return 0;
        return _vehicule.Documents.Count(d => d.Statut == StatutDocument.Manquant);
    }
    
    private void OnDestinationChanged(ChangeEventArgs e)
    {
        _vehicule.DestinationFinale = e.Value?.ToString();
        StateHasChanged();
    }

    private string DestinationLabel => string.IsNullOrWhiteSpace(_vehicule.DestinationFinale) ? "Adresse Destination" : $"Adresse {_vehicule.DestinationFinale}";
    
    private async Task DeleteSavReport()
    {
        if (_receptionControl == null) return;
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "√ätes-vous s√ªr de vouloir supprimer ce rapport SAV ?")) return;

        var success = await ApiService.DeleteControlAsync(_receptionControl.Id);
        if (success)
        {
            _receptionControl = null;
            if (_savGallery != null) await _savGallery.ReloadAsync();
            StateHasChanged();
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", "Erreur lors de la suppression.");
        }
    }
    
    private SavPhotoGallery? _savGallery;

    private async Task ReloadSav()
    {
        if (Id.HasValue)
        {
            _receptionControl = await ApiService.GetReceptionControlAsync("Vehicule", Id.Value);
            if (_savGallery != null) await _savGallery.ReloadAsync();
        }
        StateHasChanged();
    }
    
    private string GetTranslatedIssueType(IssueType type)
    {
        return type switch
        {
            IssueType.Damage => "Dommage",
            IssueType.MissingItem => "Article Manquant",
            IssueType.Other => "Autre",
            _ => type.ToString()
        };
    }
}