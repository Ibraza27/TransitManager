@page "/verify-email"
@attribute [StreamRendering(false)]
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@layout TransitManager.Web.Components.Layout.EmptyLayout
@using TransitManager.Core.DTOs
@using TransitManager.Web.Services
@inject NavigationManager Navigation
@inject IApiService ApiService

<div class="container d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="card shadow border-0 p-5 text-center" style="max-width: 500px;">
        
        @if (_isValidating)
        {
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
            <h4>Vérification en cours...</h4>
            <p class="text-muted">Nous validons votre adresse email, veuillez patienter.</p>
        }
        else if (_success)
        {
            <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
            <h3 class="mt-3">Email Confirmé !</h3>
            <p class="text-muted">Votre compte est maintenant actif et sécurisé.</p>
            <div class="mt-4">
                <a href="login" class="btn btn-primary px-4 py-2">Se connecter</a>
            </div>
        }
        else
        {
            <i class="bi bi-x-circle-fill text-danger" style="font-size: 4rem;"></i>
            <h3 class="mt-3">Échec de la validation</h3>
            <p class="text-muted">Le lien de confirmation est invalide ou a expiré.</p>
            <div class="mt-4">
                <a href="register" class="btn btn-outline-secondary">S'inscrire à nouveau</a>
                <a href="login" class="btn btn-link">Retour à la connexion</a>
            </div>
        }
    </div>
</div>

@code {
    [SupplyParameterFromQuery] public string? Token { get; set; }
    [SupplyParameterFromQuery] public string? Email { get; set; }

    private bool _isValidating = true;
    private bool _success = false;
    private bool _hasRun = false; // Verrou pour éviter la double exécution

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_hasRun)
        {
            _hasRun = true;
            await ValidateEmail();
            StateHasChanged();
        }
    }

    private async Task ValidateEmail()
    {
        await Task.Delay(1000); // Petit délai cosmétique

        if (string.IsNullOrWhiteSpace(Token) || string.IsNullOrWhiteSpace(Email))
        {
            _isValidating = false;
            _success = false;
            return;
        }

        try
        {
            var fixedToken = Token.Replace(" ", "+");
            var dto = new VerifyEmailDto { Email = Email, Token = fixedToken };
            _success = await ApiService.VerifyEmailAsync(dto);
        }
        catch
        {
            _success = false;
        }
        finally
        {
            _isValidating = false;
        }
    }
}