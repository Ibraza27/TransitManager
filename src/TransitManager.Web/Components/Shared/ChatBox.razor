@using Microsoft.AspNetCore.SignalR.Client
@using TransitManager.Core.DTOs
@using TransitManager.Core.Enums
@using System.Security.Claims
@using System.IO
@using Microsoft.AspNetCore.Http
@inject IApiService ApiService
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IConfiguration Configuration
@inject IHttpContextAccessor HttpContextAccessor
@implements IAsyncDisposable

<div class="chat-wrapper shadow-sm">
    <!-- Header -->
    <div class="chat-header d-flex justify-content-between align-items-center p-3 border-bottom bg-white">
        <div>
            <h6 class="fw-bold mb-0 text-primary">
                <i class="bi bi-chat-dots-fill me-2"></i>Discussion
                @if(_isConnected) { <span class="text-success small ms-2" title="Connect√©" style="font-size: 0.8em;">‚óè</span> }
                else { <span class="text-danger small ms-2" title="D√©connect√©" style="font-size: 0.8em;">‚óè</span> }
            </h6>
            <small class="text-muted" style="height: 20px; display: block;">
                @if(_isTyping && !string.IsNullOrEmpty(_typingUserName))
                {
                    <span class="text-success fw-bold fst-italic typing-animate">@_typingUserName √©crit...</span>
                }
                else
                {
                    <span>√âchanges en direct</span>
                }
            </small>
        </div>
        <button class="btn btn-sm btn-light rounded-circle" @onclick="ForceReload" title="Actualiser">
            <i class="bi bi-arrow-clockwise"></i>
        </button>
    </div>

    <!-- Messages Area -->
    <div class="chat-messages p-3 position-relative" id="@_chatContainerId">
        @if (_isLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
            </div>
        }
        else if (!_messages.Any())
        {
            <div class="text-center mt-5">
                <div class="mb-3"><span class="fs-1 opacity-25">üí¨</span></div>
                <p class="text-muted small">Aucun message.<br>Commencez la discussion !</p>
            </div>
        }
        else
        {
            DateTime? lastDate = null;

            @foreach (var group in _messages.GroupBy(m => m.DateEnvoi.ToLocalTime().Date))
            {
                <div class="date-group">
                    <div class="date-sticky-header">
                        <span class="date-badge">@GetDateLabel(group.Key)</span>
                    </div>

                    @foreach (var msg in group)
                    {
                        <div id="msg-@msg.Id" class="d-flex mb-2 @(msg.EstMoi ? "justify-content-end" : "justify-content-start")">
                            <div class="message-bubble @GetBubbleClass(msg)">
                                
                                @if (!msg.EstMoi)
                                {
                                    <div class="fw-bold text-primary small mb-1">
                                        @msg.NomExpediteur
                                        @if(msg.IsInternal) { <span class="badge bg-warning text-dark x-small ms-1">üîí Interne</span> }
                                    </div>
                                }
                                else if (msg.IsInternal) { <div class="fw-bold text-warning small mb-1">üîí Note Interne</div> }

                                <div class="message-text text-break" style="white-space: pre-wrap;">@msg.Contenu</div>

                                @if(msg.HasAttachment)
                                {
                                    <div class="attachment-box mt-2 p-2 rounded bg-light border d-flex align-items-center">
                                        <span class="me-2 fs-5">üìé</span>
                                        <span class="small text-truncate me-2" style="max-width: 150px;">@msg.AttachmentName</span>
                                        <a href="api/documents/@msg.AttachmentId/preview" target="_blank" 
                                           class="btn btn-sm btn-outline-primary ms-auto py-0 px-2" title="Visualiser">
                                            <span class="fs-6">üëÅÔ∏è</span>
                                        </a>
                                    </div>
                                }
                                
                                    <span>@msg.DateEnvoi.ToLocalTime().ToString("HH:mm")</span>
                                    @if(msg.EstMoi)
                                    {
                                        <span class="status-icon @(msg.IsRead ? "text-info" : "text-muted") ms-1 fw-bold">@(msg.IsRead ? "‚úì‚úì" : "‚úì")</span>
                                    }
                                    @if(_isAdmin)
                                    {
                                        <button class="btn btn-link p-0 text-danger ms-2 border-0 align-baseline" title="Supprimer" @onclick="() => ConfirmDelete(msg.Id)">
                                            <i class="bi bi-trash fx-6"></i>
                                        </button>
                                    }
                                </div>
                            </div>

                    }
                </div>
            }
        }
        
        <!-- Bouton Fl√®che Bas -->
        <button id="scroll-down-btn-@_chatContainerId" 
                class="btn btn-light shadow rounded-circle position-absolute bottom-0 end-0 m-3 border-primary"
                style="display: none; z-index: 100;"
                onclick="window.chatHelpers.scrollToBottom('@_chatContainerId')">
            <span class="text-primary fw-bold">‚Üì</span>
            @if(_unreadCountBelow > 0) 
            { 
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                    @_unreadCountBelow
                </span>
            }
        </button>
    </div>

    <!-- Zone Fichier -->
    @if (_selectedFile != null)
    {
        <div class="p-2 bg-light border-top d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <span class="me-2 fs-3">üìÑ</span>
                <div>
                    <div class="small fw-bold text-truncate" style="max-width: 200px;">@_selectedFile.Name</div>
                    <select class="form-select form-select-sm py-0" style="height: 24px; font-size: 0.75rem;" @bind="_selectedDocType">
                        @foreach (var t in Enum.GetValues<TypeDocument>()) { <option value="@t">@t</option> }
                    </select>
                </div>
            </div>
            <button class="btn btn-sm text-danger fs-5" @onclick="() => _selectedFile = null">‚ùå</button>
        </div>
    }

    <!-- Footer -->
    <div class="chat-footer p-3 bg-white border-top">
        @if (_isAdmin)
        {
            <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="internalNoteCheck" @bind="_isInternal">
                <label class="form-check-label small fw-bold text-secondary" for="internalNoteCheck">
                    üîí Note interne <span class="text-muted fw-normal">(invisible client)</span>
                </label>
            </div>
        }
        
        <div class="input-group">
            <label class="btn btn-light border" title="Joindre un fichier" style="cursor: pointer;">
                <span class="fs-5">üìé</span>
                <InputFile OnChange="OnFileSelected" style="display: none;" />
            </label>

            <input type="text" class="form-control border-start-0" 
                   placeholder="√âcrivez un message..." 
                   @bind="_newMessageText" 
                   @bind:event="oninput"
                   @onkeyup="HandleKeyUp"
                   disabled="@_isSending" />
            
            <button class="btn btn-primary px-3" @onclick="SendMessage" 
                    disabled="@( (string.IsNullOrWhiteSpace(_newMessageText) && _selectedFile == null) || _isSending)">
                @if (_isSending) { <span class="spinner-border spinner-border-sm"></span> }
                else { <span class="fs-5">‚û§</span> }
            </button>
        </div>
    </div>
</div>

<script>
    window.chatHelpers = {
        scrollToBottom: (elementId) => {
            var el = document.getElementById(elementId);
            if (el) el.scrollTop = el.scrollHeight;
        },
        scrollToBottomIfNear: (elementId) => {
            var el = document.getElementById(elementId);
            if (!el) return false;
            var isNearBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 150;
            if (isNearBottom) {
                el.scrollTop = el.scrollHeight;
                return true;
            }
            return false;
        },
        scrollToMessage: (containerId, messageId) => {
            var container = document.getElementById(containerId);
            var element = document.getElementById(messageId);
            if (container && element) {
                container.scrollTop = element.offsetTop - container.offsetTop - 50;
            }
        },
        initScrollListener: (elementId, btnId) => {
            var el = document.getElementById(elementId);
            var btn = document.getElementById(btnId);
            if(!el || !btn) return;
            el.onscroll = () => {
                if (el.scrollHeight - el.scrollTop - el.clientHeight > 200) {
                    btn.style.display = 'block';
                } else {
                    btn.style.display = 'none';
                }
            };
        }
    }
</script>

@code {
    [Parameter] public Guid EntityId { get; set; }
    [Parameter] public string EntityType { get; set; } = "Colis";
    [Parameter] public bool IsVisible { get; set; } 
    [Parameter] public EventCallback<int> OnUnreadCountChanged { get; set; }

    private List<MessageDto> _messages = new();
    private string _newMessageText = "";
    private bool _isInternal = false;
    private bool _isLoading = false;
    private bool _isSending = false;
    private bool _isAdmin = false;
    private Guid _currentUserId;
    private string _currentUserName = "";
    private string _chatContainerId = $"chat-{Guid.NewGuid()}";
    
    private int _unreadCountBelow = 0;
    
    private IBrowserFile? _selectedFile;
    private TypeDocument _selectedDocType = TypeDocument.PhotoColis;
    private HubConnection? _hubConnection;
    private bool _isConnected => _hubConnection?.State == HubConnectionState.Connected;
    private System.Timers.Timer? _typingTimer;
    private bool _isTyping = false;
    private string _typingUserName = "";
    
    private Guid _loadedEntityId = Guid.Empty;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        _isAdmin = user.IsInRole("Administrateur") || user.IsInRole("Gestionnaire");
        _currentUserName = user.Identity?.Name ?? "Inconnu";
        var idClaim = user.FindFirst(ClaimTypes.NameIdentifier);
        if (idClaim != null) Guid.TryParse(idClaim.Value, out _currentUserId);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("chatHelpers.initScrollListener", _chatContainerId, $"scroll-down-btn-{_chatContainerId}");
            await InitializeChat(); // On lance l'initialisation compl√®te ici
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (EntityId != Guid.Empty && EntityId != _loadedEntityId)
        {
            _loadedEntityId = EntityId;
            // Si c'est un changement d'entit√©, on recharge tout
            // Note: On √©vite de le faire lors du premier rendu car OnAfterRender s'en charge
            if (_hubConnection != null) await InitializeChat(); 
        }
        
        if (IsVisible && !_isLoading && _messages.Any())
        {
            await ProcessReadAndScroll();
        }
    }

    private async Task InitializeChat()
    {
        _isLoading = true;
        await InvokeAsync(StateHasChanged);

        await LoadData(false); 
        await ConnectToSignalR();

        _isLoading = false;
        await InvokeAsync(StateHasChanged);
        
        if (IsVisible) await ProcessReadAndScroll();
    }

    private async Task ForceReload() => await LoadData(true);

    private async Task LoadData(bool forceScroll)
    {
        Guid? colisId = EntityType == "Colis" ? EntityId : null;
        Guid? vehiculeId = EntityType == "Vehicule" ? EntityId : null;
        Guid? conteneurId = EntityType == "Conteneur" ? EntityId : null;

        try {
            _messages = (await ApiService.GetMessagesAsync(colisId, vehiculeId, conteneurId)).ToList();
            UpdateBadgeCount();
            if (forceScroll && IsVisible) await ScrollToBottom();
        } catch {}
    }

    private async Task ProcessReadAndScroll()
    {
        var firstUnread = _messages.FirstOrDefault(m => !m.EstMoi && !m.IsRead);
        await Task.Delay(100); 

        if (firstUnread != null) await ScrollToMessage(firstUnread.Id);
        else await ScrollToBottom();

        if (_messages.Any(m => !m.EstMoi && !m.IsRead))
        {
            Guid? colisId = EntityType == "Colis" ? EntityId : null;
            Guid? vehiculeId = EntityType == "Vehicule" ? EntityId : null;
            Guid? conteneurId = EntityType == "Conteneur" ? EntityId : null;

            await ApiService.MarkMessagesAsReadAsync(colisId, vehiculeId, conteneurId);
            
            if (_isConnected) await _hubConnection.InvokeAsync("SendReadReceipt", EntityId.ToString());
            
            foreach(var m in _messages.Where(m => !m.EstMoi)) m.IsRead = true;
            UpdateBadgeCount();
        }
    }

    private void UpdateBadgeCount()
    {
        int count = _messages.Count(m => !m.EstMoi && !m.IsRead);
        OnUnreadCountChanged.InvokeAsync(count);
    }

    private async Task ConnectToSignalR()
    {
        // Nettoyage de l'ancienne connexion si elle existe pour une autre entit√©
        if (_hubConnection != null) await _hubConnection.DisposeAsync();

        try 
        {
            var apiBaseUrl = Configuration["ApiBaseUrl"] ?? "https://localhost:7243"; 
            var hubUrl = $"{apiBaseUrl}/appHub";

            var httpContext = HttpContextAccessor.HttpContext;
            string? cookieValue = null;
            if (httpContext != null)
            {
                cookieValue = httpContext.Request.Cookies["TransitManager.AuthCookie"] 
                           ?? httpContext.Request.Cookies[".AspNetCore.Cookies"];
            }

            _hubConnection = new HubConnectionBuilder()
                .WithUrl(hubUrl, options => {
                    // 1. Cookie
                    if (!string.IsNullOrEmpty(cookieValue))
                    {
                        if (options.Headers == null) options.Headers = new Dictionary<string, string>();
                        var cleanCookie = cookieValue.Split(';')[0].Trim();
                        options.Headers["Cookie"] = $"TransitManager.AuthCookie={cleanCookie}";
                    }

                    // 2. Transports Hybrides (WebSockets + LongPolling)
                    options.Transports = Microsoft.AspNetCore.Http.Connections.HttpTransportType.WebSockets | 
                                         Microsoft.AspNetCore.Http.Connections.HttpTransportType.LongPolling;
                    
                    // 3. R√©activation de la n√©gociation
                    options.SkipNegotiation = false;

                    // 4. Bypass SSL
                    options.HttpMessageHandlerFactory = (handler) => {
                        if (handler is HttpClientHandler clientHandler)
                            clientHandler.ServerCertificateCustomValidationCallback = (m, c, ch, e) => true;
                        return handler;
                    };
                })
                .WithAutomaticReconnect()
                .Build();
            
            // Timeouts
            _hubConnection.ServerTimeout = TimeSpan.FromMinutes(4);
            _hubConnection.HandshakeTimeout = TimeSpan.FromSeconds(30);

            _hubConnection.On<MessageDto>("ReceiveMessage", async (msg) =>
            {
                if (msg.NomExpediteur != _currentUserName)
                {
                    if (msg.IsInternal && !_isAdmin) return;

                    _messages.Add(msg);
                    _isTyping = false; 
                    await InvokeAsync(StateHasChanged);

                    if (IsVisible)
                    {
                        bool scrolled = await JSRuntime.InvokeAsync<bool>("chatHelpers.scrollToBottomIfNear", _chatContainerId);
                        
                        if (!scrolled) {
                            _unreadCountBelow++;
                            await InvokeAsync(StateHasChanged);
                        } else {
                            Guid? colisId = EntityType == "Colis" ? EntityId : null;
                            Guid? vehiculeId = EntityType == "Vehicule" ? EntityId : null;
                            Guid? conteneurId = EntityType == "Conteneur" ? EntityId : null;

                            await ApiService.MarkMessagesAsReadAsync(colisId, vehiculeId, conteneurId);
                            await _hubConnection.InvokeAsync("SendReadReceipt", EntityId.ToString());
                            msg.IsRead = true;
                        }
                    }
                    else
                    {
                        UpdateBadgeCount();
                    }
                }
            });

            _hubConnection.On("MessagesRead", async () =>
            {
                bool changed = false;
                foreach(var m in _messages.Where(x => x.EstMoi && !x.IsRead)) { m.IsRead = true; changed = true; }
                if (changed) await InvokeAsync(StateHasChanged);
            });

            _hubConnection.On<string, bool>("UserTyping", async (userName, isInternal) =>
            {
                if (userName.Equals(_currentUserName, StringComparison.OrdinalIgnoreCase)) return;
                if (isInternal && !_isAdmin) return;

                _typingUserName = userName;
                _isTyping = true;
                await InvokeAsync(StateHasChanged);
                
                if (IsVisible) await JSRuntime.InvokeVoidAsync("chatHelpers.scrollToBottomIfNear", _chatContainerId);

                _typingTimer?.Stop();
                _typingTimer = new System.Timers.Timer(3000);
                _typingTimer.Elapsed += (s, e) => { _isTyping = false; InvokeAsync(StateHasChanged); };
                _typingTimer.AutoReset = false;
                _typingTimer.Start();
            });

            _hubConnection.On<Guid>("MessageDeleted", async (id) =>
            {
                var msg = _messages.FirstOrDefault(m => m.Id == id);
                if (msg != null)
                {
                    _messages.Remove(msg);
                    await InvokeAsync(StateHasChanged);
                }
            });

            Console.WriteLine($"üöÄ [Chat] Connexion au groupe {EntityId}...");
            await _hubConnection.StartAsync();
            await _hubConnection.InvokeAsync("JoinGroup", EntityId.ToString());
            Console.WriteLine($"‚úÖ [Chat] Connect√© !");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå [Chat] Erreur Connexion : {ex.Message}");
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_newMessageText) && _selectedFile == null) return;
        _isSending = true;

        Guid? docId = null;
        Guid? cId = EntityType == "Colis" ? EntityId : null;
        Guid? vId = EntityType == "Vehicule" ? EntityId : null;
        Guid? contId = EntityType == "Conteneur" ? EntityId : null;

        if (_selectedFile != null)
        {
             var doc = await ApiService.UploadDocumentAsync(_selectedFile, _selectedDocType, null, vId, cId, contId);
             if (doc != null) docId = doc.Id;
        }

        var tempMsg = new MessageDto { 
            Contenu = _newMessageText, DateEnvoi = DateTime.UtcNow, EstMoi = true, NomExpediteur = "Moi", 
            IsInternal = _isInternal, HasAttachment = docId.HasValue, AttachmentName = _selectedFile?.Name, AttachmentId = docId, IsRead = false
        };
        _messages.Add(tempMsg);
        
        var textToSend = _newMessageText;
        _newMessageText = "";
        _selectedFile = null;
        await ScrollToBottom();

        var dto = new CreateMessageDto
        {
            Contenu = textToSend,
            ColisId = cId,
            VehiculeId = vId,
            ConteneurId = contId,
            IsInternal = _isInternal,
            DocumentId = docId
        };

        var resultId = await ApiService.SendMessageAsync(dto);
        if (resultId.HasValue) 
        { 
            // Update the temporary message with the real ID from server
            if (resultId.Value != Guid.Empty) tempMsg.Id = resultId.Value;
        }
        else 
        { 
            _messages.Remove(tempMsg); 
            _newMessageText = textToSend; 
            await JSRuntime.InvokeVoidAsync("alert", "√âchec envoi"); 
        }
        _isSending = false;
    }

    private async Task ConfirmDelete(Guid messageId)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Voulez-vous vraiment supprimer ce message ?");
        if (confirmed)
        {
            await ApiService.DeleteMessageAsync(messageId);
            // La suppression locale se fera via SignalR pour tout le monde, y compris moi
        }
    }

    private void OnFileSelected(InputFileChangeEventArgs e) { if (e.File.Size > 10 * 1024 * 1024) { JSRuntime.InvokeVoidAsync("alert", "Trop gros"); return; } _selectedFile = e.File; }
    private async Task HandleKeyUp(KeyboardEventArgs e) { if (e.Key == "Enter") await SendMessage(); else if (_isConnected) await _hubConnection.InvokeAsync("SendTyping", EntityId.ToString(), _currentUserName, _isInternal); }
    private async Task ScrollToBottom() { try { await Task.Delay(50); await JSRuntime.InvokeVoidAsync("chatHelpers.scrollToBottom", _chatContainerId); _unreadCountBelow = 0; } catch {} }
    private async Task ScrollToMessage(Guid id) { try { await Task.Delay(50); await JSRuntime.InvokeVoidAsync("chatHelpers.scrollToMessage", _chatContainerId, $"msg-{id}"); } catch {} }
    private string GetBubbleClass(MessageDto msg) => msg.IsInternal ? "message-internal" : (msg.EstMoi ? "message-mine" : "message-other");
    private string GetDateLabel(DateTime date) => date.Date == DateTime.Now.Date ? "Aujourd'hui" : (date.Date == DateTime.Now.AddDays(-1).Date ? "Hier" : date.ToString("dd MMMM yyyy"));
    public async ValueTask DisposeAsync() { if (_hubConnection != null) await _hubConnection.DisposeAsync(); _typingTimer?.Dispose(); }
}