@using TransitManager.Core.Entities
@using TransitManager.Core.Enums
@inject IApiService ApiService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation


    
@using System.Security.Claims
@inject AuthenticationStateProvider AuthStateProvider

<div class="card shadow-sm border-0">
    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
        <h5 class="mb-0 text-primary"><i class="bi bi-folder2-open me-2"></i>Documents (@_filteredDocuments.Count())</h5>
        <div class="d-flex gap-2">
            @if(IsAdmin)
            {
                <button class="btn btn-sm btn-outline-danger" @onclick="() => _showRequestModal = true">
                    <i class="bi bi-plus-circle me-1"></i>Demander Doc
                </button>
            }
            <button class="btn btn-sm btn-outline-primary" @onclick="LoadDocuments" title="Actualiser">
                üîÑ
            </button>
        </div>
    </div>
    
    <div class="card-body">
        <!-- Zone d'Upload -->
        <div class="mb-4 p-3 bg-light rounded border border-dashed">
            <div class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Type de document</label>
                    <select class="form-select form-select-sm" @bind="_selectedType">
                        @foreach (var t in Enum.GetValues<TypeDocument>())
                        {
                            <option value="@t">@t</option>
                        }
                    </select>
                </div>
                <div class="col-md-7">
                    <label class="form-label small fw-bold">S√©lectionner un fichier</label>
                    <!-- Liste d'extensions √©tendue -->
                <InputFile id="@_uploadInputId" OnChange="OnInputFileChange" class="form-control form-control-sm" 
                           accept=".pdf,.doc,.docx,.txt,.rtf,.odf,.odt,.html,.htm,.aac,.mp3,.wav,.wma,.ogg,.jpg,.jpeg,.png,.gif,.tif,.tiff,.mp4,.avi,.mov,.wmv,.mpeg,.mpg,.zip,.rar,.7z,.xls,.xlsx,.ppt,.pptx" />
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success btn-sm w-100" @onclick="UploadFile" disabled="@(_selectedFile == null || _isUploading)">
                        @if (_isUploading) { <span class="spinner-border spinner-border-sm"></span> }
                        else { <span>üì§ Ajouter</span> }
                    </button>
                </div>
            </div>
        </div>

        <!-- Filtres -->
        <div class="row g-2 mb-3">
            <div class="col-md-8">
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" placeholder="Rechercher dans les noms..." 
                           @bind="_searchTerm" @bind:event="oninput" />
                </div>
            </div>
            <div class="col-md-4">
                <select class="form-select form-select-sm" @bind="_filterType">
                    <option value="">Tous les types</option>
                    @foreach (var t in Enum.GetValues<TypeDocument>())
                    {
                        <option value="@t">@t</option>
                    }
                </select>
            </div>
        </div>

        <!-- Liste des documents -->
        @if (_isLoading)
        {
            <div class="text-center text-muted py-4">
                <span class="spinner-border spinner-border-sm me-2"></span>Chargement...
            </div>
        }
        else if (!_documents.Any())
        {
            <div class="text-center text-muted py-4 bg-light rounded">
                <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                Aucun document pour le moment.
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover table-sm align-middle">
                    <thead class="table-light">
                        <tr>
                            <th class="text-start" style="width: 120px;">Actions</th>
                            <th>Type</th>
                            <th>Nom du fichier</th>
                            <th>Taille</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>

                        @foreach (var doc in _filteredDocuments)
                        {
                            <tr class="@GetRowClass(doc.Statut)">
                                <td class="text-start">
                                    @if(doc.Statut == StatutDocument.Manquant)
                                    {
                                        @if(!IsAdmin) 
                                        {
                                             <!-- MODIFICATION MOBILE : Label au lieu de Button pour d√©clenchement natif -->
                                             <label class="btn btn-sm btn-danger text-white shadow-sm" for="@_uploadInputId" @onclick="() => SetMissingType(doc)">
                                                <i class="bi bi-upload me-1"></i>Envoyer
                                             </label>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-link text-danger" @onclick="() => DeleteDocument(doc)" title="Annuler la demande">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        }
                                    }
                                    else
                                    {
                                        <!-- Bouton Visualiser (Oeil) -->
                                        <a href="@GetPreviewUrl(doc.Id)" target="_blank" class="btn btn-sm btn-link text-dark text-decoration-none" title="Visualiser">
                                            üëÅÔ∏è
                                        </a>
                                        
                                        <!-- Bouton T√©l√©charger (Fl√®che bas) -->
                                        <button class="btn btn-sm btn-link text-primary text-decoration-none" @onclick="() => DownloadFile(doc)" title="T√©l√©charger">
                                            ‚¨áÔ∏è
                                        </button>
                                        
                                        <!-- Bouton Supprimer (Poubelle) -->
                                            @if (IsAdmin)
                                            {
                                                <button class="btn btn-sm btn-outline-danger me-1 @(_isLoading ? "disabled" : "")" @onclick="() => DeleteDocument(doc)" title="Supprimer">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            }
                                            @if (IsAdmin || (CurrentClientId.HasValue && doc.ClientId == CurrentClientId))
                                            {
                                                <button class="btn btn-sm btn-outline-primary @(_isLoading ? "disabled" : "")" @onclick="() => OpenEditModal(doc)" title="Modifier">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                            }
                                            @if (!IsAdmin && CurrentClientId.HasValue && doc.ClientId == CurrentClientId)
                                            {
                                                 <button class="btn btn-sm btn-outline-danger @(_isLoading ? "disabled" : "")" @onclick="() => DeleteDocument(doc)" title="Supprimer">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            }
                                    }
                                </td>
                                <td>
                                    <span class="badge @GetBadgeClass(doc.Statut) fw-normal">@doc.Type</span>
                                    @if(doc.Statut == StatutDocument.Manquant)
                                    {
                                        <div class="small text-danger fw-bold mt-1">MANQUANT</div>
                                    }
                                </td>
                                <td>
                                    @if(doc.Statut == StatutDocument.Manquant)
                                    {
                                         <span class="text-muted fst-italic">En attente de r√©ception...</span>
                                    }
                                    else
                                    {
                                        <i class="bi @GetIconClass(doc.Extension) me-2"></i>
                                        <span class="fw-medium" title="@doc.NomFichierOriginal">@doc.Nom</span>
                                    }
                                    @if(!string.IsNullOrEmpty(doc.CommentaireAdmin))
                                    {
                                        <div class="small text-warning mt-1"><i class="bi bi-info-circle me-1"></i>@doc.CommentaireAdmin</div>
                                    }
                                </td>
                                <td class="small text-muted">@doc.TailleFormatee</td>
                                <td class="small text-muted">@doc.DateCreation.ToString("dd/MM/yy HH:mm")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<!-- Modal Demande Document -->
@if (_showRequestModal)
{
    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Demander un document manquant</h5>
                    <button type="button" class="btn-close" @onclick="() => _showRequestModal = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Type de document requis</label>
                        <select class="form-select" @bind="_requestType">
                            @foreach (var t in Enum.GetValues<TypeDocument>()) { <option value="@t">@t</option> }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Note pour le client (optionnel)</label>
                        <textarea class="form-control" rows="3" @bind="_requestComment" placeholder="Ex: Merci de fournir une copie lisible..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => _showRequestModal = false">Annuler</button>
                    <button type="button" class="btn btn-primary" @onclick="SendDocumentRequest">Envoyer la demande</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Modal Edition Document -->
@if (_showEditModal)
{
    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modifier le document</h5>
                    <button type="button" class="btn-close" @onclick="() => _showEditModal = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nom du fichier (sans extension)</label>
                        <input type="text" class="form-control" @bind="_editName" />
                        <div class="form-text text-warning"><i class="bi bi-exclamation-triangle"></i> Attention : Le fichier physique sera renomm√© sur le disque.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type de document</label>
                        <select class="form-select" @bind="_editType">
                            @foreach (var t in Enum.GetValues<TypeDocument>()) { <option value="@t">@t</option> }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => _showEditModal = false">Annuler</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveEdit">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>
}

@using TransitManager.Core.DTOs
@using System.IO
@using System

@code {
    [Parameter] public Guid EntityId { get; set; }
    [Parameter] public string EntityType { get; set; } = "Vehicule";

    private bool IsAdmin = false;
    private Guid? CurrentClientId; // Changed to nullable
    private string _uploadInputId = $"doc-upload-{Guid.NewGuid():N}"; // UNIQUE ID

    // Request Modal
    private bool _showRequestModal = false;
    private TypeDocument _requestType = TypeDocument.Autre;
    private string _requestComment = "";

    // Edit Modal
    private bool _showEditModal = false;
    private Guid _editDocId; // Changed from Document? _editingDoc
    private string _editName = "";
    private TypeDocument _editType = TypeDocument.Autre;

    private List<Document> _documents = new();
    private bool _isLoading = false;
    private bool _isUploading = false;
    private IBrowserFile? _selectedFile;
    private TypeDocument _selectedType = TypeDocument.Autre;
    
    // Filtres
    private string _searchTerm = "";
    private TypeDocument? _filterType = null;

    // Propri√©t√© calcul√©e pour le filtrage
    private IEnumerable<Document> _filteredDocuments
    {
        get
        {
            var query = _documents.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(_searchTerm))
            {
                query = query.Where(d => d.Nom.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) || 
                                         d.NomFichierOriginal.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase));
            }

            if (_filterType.HasValue)
            {
                query = query.Where(d => d.Type == _filterType.Value);
            }

            return query;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        IsAdmin = user.IsInRole("Administrateur");
        
        var profile = await ApiService.GetUserProfileAsync();
        if(profile != null && profile.ClientId != Guid.Empty) CurrentClientId = profile.ClientId;
        // Fallback si admin pour pas planter, mais admin n'upload pas en tant que client normalement
        
        if (EntityId != Guid.Empty) await LoadDocuments();
    }

    private async Task LoadDocuments()
    {
        _isLoading = true;
        _documents = (await ApiService.GetDocumentsByEntityAsync(EntityType, EntityId)).ToList();
        _isLoading = false;
    }

    private void OnInputFileChange(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
    }

    private async Task UploadFile()
    {
        if (_selectedFile == null) return;
        _isUploading = true;

        try
        {
            // D√©terminer le ClientID : Si c'est un client connect√©, c'est lui.
            // Si c'est l'Admin, on essaie de garder le propri√©taire de l'entit√© (compliqu√© ici sans charger l'entit√©)
            // Simplification : On passe null si admin, le backend essaiera de d√©duire.
            
            Guid? clientId = null;
            if (!IsAdmin && CurrentClientId.HasValue) clientId = CurrentClientId;

            Guid? vehiculeId = EntityType == "Vehicule" ? EntityId : null;
            Guid? colisId = EntityType == "Colis" ? EntityId : null;
            Guid? conteneurId = EntityType == "Conteneur" ? EntityId : null;

            var doc = await ApiService.UploadDocumentAsync(_selectedFile, _selectedType, clientId, vehiculeId, colisId, conteneurId);
            
            if (doc != null)
            {
                // Auto-Resolve : Si un doc manquant du m√™me type existait, on le supprime (hack UX)
                var missing = _documents.FirstOrDefault(d => d.Type == _selectedType && d.Statut == StatutDocument.Manquant);
                if(missing != null)
                {
                   await ApiService.DeleteDocumentAsync(missing.Id);
                }

                _selectedFile = null; 
                await LoadDocuments();
            }
            else
            {
                await ShowError("Erreur lors de l'upload. Le serveur n'a pas retourn√© de document.");
            }
        }
        catch (Exception ex)
        {
           await ShowError($"Erreur lors de l'upload: {ex.Message}. V√©rifiez la taille du fichier (Max 500 Mo).");
        }
        finally
        {
            _isUploading = false;
        }
    }
    
    private void SetMissingType(Document missingDoc)
    {
       _selectedType = missingDoc.Type;
    }

    private async Task SendDocumentRequest()
    {
        // On doit connaitre le ClientId de l'entit√© cible... DocumentManager ne l'a pas en param√®tre.
        // Il faudrait le passer en param√®tre du composant ou aller le chercher.
        // Solution rapide : On r√©cup√®re l'entit√© via API pour avoir le ClientId.
        
        Guid targetClientId = Guid.Empty;
        if(EntityType == "Colis") {
             var c = await ApiService.GetColisByIdAsync(EntityId);
             targetClientId = c?.ClientId ?? Guid.Empty;
        } else if(EntityType == "Vehicule") {
             var v = await ApiService.GetVehiculeByIdAsync(EntityId);
             targetClientId = v?.ClientId ?? Guid.Empty;
        }
        
        if(targetClientId == Guid.Empty) {
             await JSRuntime.InvokeVoidAsync("alert", "Impossible de trouver le client associ√© √† ce dossier.");
             return;
        }

        var req = new DocumentRequestDto {
            EntityId = EntityId, // Sert √† rien dans le DTO pour l'instant sauf si on l'ajoute
            Type = _requestType,
            ClientId = targetClientId,
            ColisId = EntityType == "Colis" ? EntityId : null,
            VehiculeId = EntityType == "Vehicule" ? EntityId : null,
            Commentaire = _requestComment
        };

        var res = await ApiService.RequestDocumentAsync(req);
        if(res != null) {
            _showRequestModal = false;
            await LoadDocuments();
        } else {
             await JSRuntime.InvokeVoidAsync("alert", "Erreur lors de la demande.");
        }
    }

    private string GetRowClass(StatutDocument statut) => statut switch {
        StatutDocument.Manquant => "table-danger",
        StatutDocument.EnAttenteValidation => "table-warning",
        StatutDocument.Rejete => "table-secondary text-decoration-line-through",
        _ => ""
    };

    private string GetBadgeClass(StatutDocument statut) => statut switch {
        StatutDocument.Manquant => "bg-danger",
        StatutDocument.Valide => "bg-success",
        StatutDocument.EnAttenteValidation => "bg-warning text-dark",
        _ => "bg-secondary"
    };

    private string GetPreviewUrl(Guid id)
    {
        // On construit l'URL vers notre nouvel endpoint API
        // Note: Assurez-vous que ApiService.HttpClient a la bonne BaseAddress
        // Ici on suppose une URL relative, le navigateur r√©soudra avec l'URL de l'API si c'est le m√™me domaine, 
        // sinon il faut l'URL compl√®te de l'API.
        // Pour Blazor Server, on passe souvent par un contr√¥leur du projet Web ou on pointe vers l'API externe.
        
        // Solution robuste : Pointez vers votre contr√¥leur API directement
        // Remplacez "https://localhost:7243" par votre variable de config si possible, sinon URL relative si proxy
        return $"api/documents/{id}/preview";
    }

    private async Task DownloadFile(Document doc)
    {
        var data = await ApiService.DownloadDocumentAsync(doc.Id);
        if (data.Length > 0)
        {
            using var stream = new MemoryStream(data);
            using var streamRef = new DotNetStreamReference(stream);
            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", doc.NomFichierOriginal, streamRef);
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", "Impossible de t√©l√©charger le fichier.");
        }
    }

    private async Task DeleteDocument(Document doc) // Renamed from DeleteFile
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"Voulez-vous vraiment supprimer '{doc.Nom}' ?"))
        {
            if (await ApiService.DeleteDocumentAsync(doc.Id))
            {
                _documents.Remove(doc);
            }
        }
    }

    private string GetIconClass(string ext) => ext.ToLower() switch
    {
        ".pdf" => "bi-file-earmark-pdf text-danger",
        ".jpg" or ".jpeg" or ".png" or ".gif" => "bi-file-earmark-image text-primary",
        ".doc" or ".docx" => "bi-file-earmark-word text-primary",
        ".xls" or ".xlsx" => "bi-file-earmark-excel text-success",
        ".zip" or ".rar" => "bi-file-earmark-zip text-warning",
        ".mp3" or ".wav" => "bi-file-earmark-music text-info",
        ".mp4" or ".avi" => "bi-file-earmark-play text-danger",
        _ => "bi-file-earmark text-secondary"
    };

    private void OpenEditModal(Document doc)
    {
        _editDocId = doc.Id;
        _editName = Path.GetFileNameWithoutExtension(doc.Nom);
        _editType = doc.Type;
        _showEditModal = true;
    }

    private async Task SaveEdit()
    {
        if (_editDocId == Guid.Empty) return;

        var dto = new UpdateDocumentDto { Nom = _editName, Type = _editType };
        var updated = await ApiService.UpdateDocumentAsync(_editDocId, dto);
        
        if (updated != null)
        {
             var index = _documents.FindIndex(d => d.Id == updated.Id);
             if (index != -1) _documents[index] = updated;
             _showEditModal = false;
        }
        else
        {
             await JSRuntime.InvokeVoidAsync("alert", "Erreur lors de la mise √† jour (Nom invalide ou fichier verrouill√© ?).");
        }
    }
    private async Task ShowError(string message)
    {
        await JSRuntime.InvokeVoidAsync("alert", message);
    }
}