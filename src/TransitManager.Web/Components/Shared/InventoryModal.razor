@using System.Text.Json
@using TransitManager.Core.Entities
@inject IJSRuntime JSRuntime

@if (IsVisible)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-clipboard-check me-2"></i>Inventaire & Validation</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="Close"></button>
                </div>
                
                <div class="modal-body p-0">
                    <!-- Onglets -->
                    <ul class="nav nav-tabs nav-fill bg-light" role="tablist">
                        <li class="nav-item">
                            <button class='nav-link @(_activeTab == "items" ? "active fw-bold" : "")' @onclick='() => ChangeTab("items")'>
                                <i class="bi bi-list-check me-2"></i>Articles
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class='nav-link @(_activeTab == "signature" ? "active fw-bold" : "")' @onclick='() => ChangeTab("signature")'>
                                <i class="bi bi-pen me-2"></i>Validation
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content p-3">
                        
                        <!-- ONGLET 1 : ARTICLES -->
                        <div class='tab-pane fade @(_activeTab == "items" ? "show active" : "")'>
                            @if (IsReadOnly)
                            {
                                <div class="alert alert-info small py-2 mb-3">
                                    <i class="bi bi-lock me-2"></i>Mode lecture seule.
                                </div>
                            }
                            else
                            {
                                <!-- Formulaire d'ajout -->
                                <div class="card bg-light mb-3 border-0">
                                    <div class="card-body p-3">
                                        <div class="row g-2 align-items-end">
                                            <div class="col-md-4">
                                                <label class="small text-muted fw-bold">D√©signation</label>
                                                <input type="text" class="form-control form-control-sm" @bind="_newItem.Designation" placeholder="Ex: carton, canap√©, frigo..." />
                                            </div>
                                            <div class="col-md-2">
                                                <label class="small text-muted fw-bold">Quantit√©</label>
                                                <input type="number" class="form-control form-control-sm" @bind="_newItem.Quantite" min="1" />
                                            </div>
                                            <div class="col-md-2">
                                                <label class="small text-muted fw-bold">Valeur (‚Ç¨)</label>
                                                <input type="number" class="form-control form-control-sm" @bind="_newItem.Valeur" min="0" step="0.01" />
                                            </div>
                                            <div class="col-md-3">
                                                <label class="small text-muted fw-bold">Date</label>
                                                <input type="date" class="form-control form-control-sm" @bind="_newItem.Date" />
                                            </div>
                                            <div class="col-md-1">
                                                <button class="btn btn-sm @(_editingItem != null ? "btn-warning" : "btn-success") w-100 fw-bold" @onclick="AddItem" disabled="@string.IsNullOrWhiteSpace(_newItem.Designation)" title="@(_editingItem != null ? "Modifier" : "Ajouter")">
                                                    @(_editingItem != null ? "üíæ" : "‚ûï")
                                                </button>
                                            </div>
                                        </div>
                                        @if(_newItem.Quantite > 0)
                                        {
                                            <div class="text-end mt-1">
                                                <small class="text-muted fst-italic">P.U. : <strong>@((_newItem.Valeur / _newItem.Quantite).ToString("C2"))</strong></small>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            
                            <!-- Tableau -->
                            <div class="table-responsive">
                                <table class="table table-sm table-hover table-bordered mb-0 align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            @if (!IsReadOnly) { <th style="width: 80px;" class="text-center">Actions</th> }
                                            <th>D√©signation</th>
                                            <th class="text-center">Qt√©</th>
                                            <th class="text-end">Valeur</th>
                                            <th class="text-end text-muted">P.U.</th>
                                            <th>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in _items.OrderByDescending(i => i.Date))
                                        {
                                            <tr>
                                                @if (!IsReadOnly)
                                                {
                                                    <td class="text-center">
                                                        <div class="d-flex justify-content-center gap-2">
                                                            <button class="btn btn-outline-primary btn-sm border-0" @onclick="() => EditItem(item)">‚úèÔ∏è</button>
                                                            <button class="btn btn-outline-danger btn-sm border-0" @onclick="() => RemoveItem(item)">üóëÔ∏è</button>
                                                        </div>
                                                    </td>
                                                }
                                                <td>@item.Designation</td>
                                                <td class="text-center fw-bold">@item.Quantite</td>
                                                <td class="text-end fw-bold text-primary">@item.Valeur.ToString("C2")</td>
                                                <td class="text-end text-muted small">@(item.Quantite > 0 ? (item.Valeur / item.Quantite).ToString("C2") : "-")</td>
                                                <td>@item.Date.ToString("dd/MM/yy")</td>
                                            </tr>
                                        }
                                        @if (!_items.Any()) { <tr><td colspan="6" class="text-center text-muted fst-italic py-3">Aucun article</td></tr> }
                                    </tbody>
                                    <tfoot class="fw-bold bg-light">
                                        <tr>
                                            <td colspan="2" class="text-end">TOTAUX :</td>
                                            <td class="text-center">@_items.Sum(i => i.Quantite)</td>
                                            <td class="text-end text-primary">@_items.Sum(i => i.Valeur).ToString("C2")</td>
                                            <td colspan="@(IsReadOnly ? 1 : 2)"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <!-- ONGLET 2 : SIGNATURE -->
                        <div class='tab-pane fade @(_activeTab == "signature" ? "show active" : "")'>
                            <div class="row g-3">
                                <div class="col-12 mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text">Fait √†</span>
                                        <input type="text" class="form-control" @bind="_lieu" placeholder="Ville..." disabled="@IsReadOnly">
                                        <span class="input-group-text">Le</span>
                                        <input type="date" class="form-control" @bind="_dateSignature" disabled="@IsReadOnly">
                                    </div>
                                </div>
                                <div class="col-12">
                                     <!-- Decharge Juridique (AJOUT URGENT) -->
                                     @if(!IsReadOnly)
                                     {
                                         <div class="form-check bg-white p-3 border rounded mb-3 shadow-sm mx-1">
                                             <input class="form-check-input" type="checkbox" id="legalDisclaimer" @bind="_isDisclaimed">
                                             <label class="form-check-label small text-muted" for="legalDisclaimer" style="line-height: 1.2;">
                                                 <strong>Je certifie que mes effets personnels m'appartiennent.</strong><br/>
                                                 Important : en tant que responsable du chargement de mes effets personnels dans les cartons, je certifie l'exactitude de
                                                 ma liste et que mes colis ne contiennent aucun produit dangereux au sens du code IMDG qui peut comprendre des produits tels que :
                                                 <span class="fw-bold text-danger">ARTICLES EXPLOSIFS, GAZ COMPRIM√â, RECHARGE DE GAZ, A√âROSOLS, PRODUITS CORROSIFS, PRODUITS TOXIQUES OU MATI√àRES RADIOACTIVES.</span><br/>
                                                 La non observation de cette r√®gle de s√©curit√© engagera ma responsabilit√© civile et p√©nale en cas de litige.
                                                 L'entreprise ne peut pas √™tre tenue responsable en cas de dommage ou de l'√©tat des colis des commandes internet.
                                             </label>
                                         </div>
                                     }

                                    <div class="card">
                                        <div class="card-header bg-light fw-bold text-center">Signature du Client (Validation Inventaire)</div>
                                        <div class="card-body p-0 position-relative" style="height: 250px; background-color: #fff;">
                                            @if (!string.IsNullOrEmpty(_signatureBase64))
                                            {
                                                <img src="@_signatureBase64" style="width:100%; height:100%; object-fit:contain;" />
                                                @if(!IsReadOnly) {
                                                    <button class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2" @onclick="ReSign">Re-signer</button>
                                                }
                                            }
                                            else if (!IsReadOnly)
                                            {
                                                <!-- On masque le canvas si pas check√© pour forcer la lecture ? Non, on laisse signer mais on bloque la validation. -->
                                                <div style="@(_isDisclaimed ? "" : "pointer-events:none; opacity:0.5;")" class="h-100 w-100">
                                                     <canvas id="sig-canvas-inventory" style="width:100%; height:100%; cursor:crosshair;"></canvas>
                                                </div>
                                                @if(!_isDisclaimed)
                                                {
                                                     <div class="position-absolute top-50 start-50 translate-middle text-center w-75">
                                                         <span class="badge bg-warning text-dark shadow p-2"><i class="bi bi-exclamation-triangle me-2"></i>Veuillez cocher la case ci-dessus<br/>pour activer la signature</span>
                                                     </div>
                                                }
                                                <div class="position-absolute bottom-0 end-0 m-2">
                                                    <button class="btn btn-sm btn-light border" @onclick="ClearCanvas" disabled="@(!_isDisclaimed)">Effacer</button>
                                                </div>
                                            }
                                            else { <div class="d-flex h-100 align-items-center justify-content-center text-muted">Non sign√©</div> }
                                        </div>
                                    </div>
                                    <div class="form-text text-muted mt-2 text-center">
                                        En signant, le client atteste de l'exactitude de l'inventaire ci-dessus.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" @onclick="Close">Annuler</button>
                    @if (!IsReadOnly)
                    {
                        <button type="button" class="btn btn-primary px-4" @onclick="SaveAndClose">
                            <i class="bi bi-check-lg me-2"></i>Valider et Enregistrer
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public bool IsReadOnly { get; set; }
    [Parameter] public string? JsonData { get; set; }
    [Parameter] public string? Signature { get; set; }
    [Parameter] public string? Lieu { get; set; }
    [Parameter] public DateTime? Date { get; set; }
    
    [Parameter] public EventCallback<InventoryResult> OnSave { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    public class InventoryResult
    {
        public string Json { get; set; } = "";
        public string Signature { get; set; } = "";
        public string Lieu { get; set; } = "";
        public DateTime? Date { get; set; }
    }

    private string _activeTab = "items";
    private List<InventaireItem> _items = new();
    private InventaireItem _newItem = new() { Date = DateTime.Now, Quantite = 1 };
    
    private bool _isDisclaimed = false; // Validation Checkbox state

    private string? _signatureBase64;
    private string? _lieu;
    private DateTime _dateSignature;

	protected override void OnParametersSet()
    {
        if (IsVisible)
        {
            _activeTab = "items"; // Revenir au premier onglet par d√©faut
            
            // 1. Chargement de l'inventaire JSON
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            
            if (!string.IsNullOrEmpty(JsonData) && JsonData != "[]" && JsonData != "null")
            {
                try { _items = JsonSerializer.Deserialize<List<InventaireItem>>(JsonData, options) ?? new(); }
                catch { _items = new(); }
            }
            else if (!_items.Any()) 
            { 
                _items = new List<InventaireItem>(); 
            }

            // Reset nouvel item
            _newItem = new InventaireItem { Date = DateTime.Now, Quantite = 1 };
            
            // 2. --- CORRECTION : Chargement des donn√©es de signature ---
            // On √©crase les variables locales avec les donn√©es venant de la BDD (via le Parent)
            _signatureBase64 = Signature;
            
            // Si le lieu est vide en BDD, on met une valeur par d√©faut, sinon on prend la valeur BDD
            _lieu = string.IsNullOrEmpty(Lieu) ? "Tresses" : Lieu;
            
            // Si la date est null, on met aujourd'hui
            _dateSignature = Date ?? DateTime.Now;
            
            // Reset disclaimer logic: if signature exists, we assume it was disclaimed
            _isDisclaimed = !string.IsNullOrEmpty(_signatureBase64);
        }
    }

    private async Task ChangeTab(string tab)
    {
        _activeTab = tab;
        if (tab == "signature")
        {
            await Task.Delay(200);
            if (!IsReadOnly && string.IsNullOrEmpty(_signatureBase64))
            {
                await JSRuntime.InvokeVoidAsync("signaturePad.init", "sig-canvas-inventory");
            }
        }
    }

    private InventaireItem? _editingItem; // Track item being edited

    private void AddItem()
    {
        if (_editingItem != null)
        {
            // UPDATE existing item
            _editingItem.Designation = _newItem.Designation;
            _editingItem.Quantite = _newItem.Quantite;
            _editingItem.Valeur = _newItem.Valeur;
            _editingItem.Date = _newItem.Date;
            
            _editingItem = null; // Exit edit mode
        }
        else
        {
            // CREATE new item
            _items.Add(new InventaireItem { Designation = _newItem.Designation, Quantite = _newItem.Quantite, Valeur = _newItem.Valeur, Date = _newItem.Date });
        }
        
        // Reset form
        _newItem = new InventaireItem { Date = DateTime.Now, Quantite = 1 };
    }

    private void EditItem(InventaireItem item)
    {
        _editingItem = item; // Mark as editing
        // Load into form
        _newItem = new InventaireItem { Designation = item.Designation, Quantite = item.Quantite, Valeur = item.Valeur, Date = item.Date };
        // DO NOT remove from list
    }

    private void RemoveItem(InventaireItem item) 
    {
        _items.Remove(item);
        if (_editingItem == item) 
        {
            _editingItem = null;
            _newItem = new InventaireItem { Date = DateTime.Now, Quantite = 1 };
        }
    }

    private async Task ClearCanvas() => await JSRuntime.InvokeVoidAsync("signaturePad.clear", "sig-canvas-inventory");

    private async Task ReSign()
    {
        _signatureBase64 = null;
        await Task.Delay(50);
        await JSRuntime.InvokeVoidAsync("signaturePad.init", "sig-canvas-inventory");
    }


    private async Task SaveAndClose()
    {
        // 1. R√©cup√©rer la signature du canvas si on est d√©j√† sur l'onglet signature
        if (_activeTab == "signature" && string.IsNullOrEmpty(_signatureBase64))
        {
             try {
                 _signatureBase64 = await JSRuntime.InvokeAsync<string>("signaturePad.getImage", "sig-canvas-inventory");
             } catch {}
             // Check if empty canvas
             if(string.IsNullOrEmpty(_signatureBase64) || _signatureBase64.Length < 500) _signatureBase64 = null;
        }
        
        // 2. V√©rifier si l'inventaire contient des articles
        bool hasItems = _items.Any();
        
        if (hasItems)
        {
            // 3. Si articles pr√©sents, la signature est obligatoire
            if (string.IsNullOrEmpty(_signatureBase64) || !_isDisclaimed)
            {
                // Redirection vers l'anglet validation
                await ChangeTab("signature");
                
                // Petit d√©lai pour l'affichage
                await Task.Delay(100);
                
                // Alerte utilisateur (Pourrait √™tre un Toast plus joli, ou juste le focus)
                // Ici on redirige, l'utilisateur verra qu'il doit signer.
                // Alerte utilisateur explicite
                await JSRuntime.InvokeVoidAsync("alert", "Veuillez cocher la d√©charge et signer pour valider l'inventaire.");
                return;
            }
        }
        
        // Nettoyage si vide (cas limite)
        if (_signatureBase64 != null && _signatureBase64.Length < 500) _signatureBase64 = null;

        var result = new InventoryResult
        {
            Json = JsonSerializer.Serialize(_items),
            Signature = _signatureBase64 ?? "",
            Lieu = _lieu ?? "",
            Date = _dateSignature
        };
        
        await OnSave.InvokeAsync(result);
    }
	
    private async Task Close() => await OnClose.InvokeAsync();
}