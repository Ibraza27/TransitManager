@using TransitManager.Core.Entities
@using TransitManager.Core.Enums
@inject IApiService ApiService

@if (IsVisible)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-cash-coin me-2"></i>Gestion des Paiements</h5>
                    <button type="button" class="btn-close" @onclick="Close"></button>
                </div>
                <div class="modal-body">
                    
                    <!-- R√©capitulatif -->
                    <div class="d-flex justify-content-between mb-3 p-3 bg-light rounded shadow-sm">
                        <div>
                            <span class="text-muted small text-uppercase">Total √† payer</span><br/>
                            <span class="fw-bold fs-5">@TotalAmount.ToString("C2")</span>
                        </div>
                        <div>
                            <span class="text-muted small text-uppercase">D√©j√† pay√©</span><br/>
                            <span class="fw-bold fs-5 text-success">@_payments.Sum(p => p.Montant).ToString("C2")</span>
                        </div>
                        <div>
                            <span class="text-muted small text-uppercase">Restant</span><br/>
                            <span class="fw-bold fs-5 text-danger">@((TotalAmount - _payments.Sum(p => p.Montant)).ToString("C2"))</span>
                        </div>
                    </div>

                    @if (IsAdmin)
                    {
                         <!-- Formulaire -->
                         <div class="card mb-4 border-primary">
                             <div class="card-header bg-primary text-white py-1 px-2 d-flex justify-content-between align-items-center">
                                 <small class="fw-bold">@(_isEditing ? "MODIFIER LE PAIEMENT" : "AJOUTER UN PAIEMENT")</small>
                                 @if (_isEditing)
                                 {
                                     <button class="btn btn-sm btn-link text-white text-decoration-none p-0" @onclick="ResetForm">
                                         <i class="bi bi-x-circle"></i> Annuler
                                     </button>
                                 }
                             </div>
                             <div class="card-body p-2">
                                 <div class="row g-2">
                                     <div class="col-md-2">
                                         <select class="form-select form-select-sm" @bind="_currentPayment.ModePaiement">
                                             @foreach (var type in Enum.GetValues<TypePaiement>())
                                             {
                                                 <option value="@type">@type</option>
                                             }
                                         </select>
                                     </div>
                                     <div class="col-md-3">
                                         <input type="date" class="form-control form-control-sm" @bind="_currentPayment.DatePaiement" />
                                     </div>
                                     <div class="col-md-2">
                                         <input type="number" class="form-control form-control-sm" @bind="_currentPayment.Montant" placeholder="Montant" step="0.01" />
                                     </div>
                                     <div class="col-md-3">
                                         <input type="text" class="form-control form-control-sm" @bind="_currentPayment.Commentaires" placeholder="R√©f / Note" />
                                     </div>
                                     <div class="col-md-2">
                                         <button class="btn btn-sm @(_isEditing ? "btn-warning" : "btn-success") w-100" @onclick="SavePayment">
                                             <i class="bi @(_isEditing ? "bi-pencil-square" : "bi-plus-lg")"></i> @(_isEditing ? "Modifier" : "Ajouter")
                                         </button>
                                     </div>
                                 </div>
                             </div>
                         </div>
                    }

                    <!-- Liste -->
                    <div class="table-responsive">
                        <table class="table table-hover align-middle table-sm">
                            <thead class="table-light">
                                <tr>

                                    @if(IsAdmin) { <th class="text-center" style="width:100px">Actions</th> }
                                    <th>Mode</th>
                                    <th>R√©f.</th>
                                    <th class="text-end">Montant</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var p in _payments.OrderByDescending(x => x.DatePaiement))
                                {
                                    <tr class="@(p.Id == _currentPayment.Id ? "table-active" : "")">
                                        @if (IsAdmin)
                                        {
                                            <td class="text-center">
                                                <div class="d-flex justify-content-center gap-2">
                                                    <button class="btn btn-outline-primary btn-sm" @onclick="() => EditPayment(p)" title="Modifier">
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button class="btn btn-outline-danger btn-sm" @onclick="() => DeletePayment(p)" title="Supprimer">
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </td>
                                        }
                                        <td><span class="badge bg-secondary">@p.ModePaiement</span></td>
                                        <td><small class="text-muted">@p.Commentaires</small></td>
                                        <td class="text-end fw-bold text-success">@p.Montant.ToString("C2")</td>
                                        <td>@p.DatePaiement.ToString("dd/MM/yyyy")</td>
                                    </tr>
                                }
                                @if(!_payments.Any())
                                {
                                    <tr><td colspan="5" class="text-center text-muted py-3">Aucun paiement enregistr√©.</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="Close">Fermer</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public bool IsAdmin { get; set; }
    [Parameter] public Guid ColisId { get; set; }
    [Parameter] public Guid? VehiculeId { get; set; } // AJOUT√â
    [Parameter] public Guid ClientId { get; set; }
    [Parameter] public decimal TotalAmount { get; set; }
    [Parameter] public EventCallback<decimal> OnPaymentsChanged { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private List<Paiement> _payments = new();
    private Paiement _currentPayment = new() { DatePaiement = DateTime.Now };
    private bool _isEditing = false;

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible)
        {
            await LoadPayments();
            ResetForm();
        }
    }

    private async Task LoadPayments()
    {
        // Logique conditionnelle Colis / V√©hicule
        if (ColisId != Guid.Empty)
        {
            var result = await ApiService.GetPaiementsForColisAsync(ColisId);
            if (result != null) _payments = result.ToList();
        }
        else if (VehiculeId.HasValue && VehiculeId.Value != Guid.Empty)
        {
            var result = await ApiService.GetPaiementsForVehiculeAsync(VehiculeId.Value);
            if (result != null) _payments = result.ToList();
        }
    }

    private void ResetForm()
    {
        _currentPayment = new Paiement { 
            DatePaiement = DateTime.Now, 
            ClientId = ClientId,
            ColisId = ColisId != Guid.Empty ? ColisId : null,
            VehiculeId = (VehiculeId.HasValue && VehiculeId.Value != Guid.Empty) ? VehiculeId : null
        };
        _isEditing = false;
    }

    private void EditPayment(Paiement p)
    {
        _currentPayment = new Paiement 
        { 
            Id = p.Id,
            ColisId = p.ColisId,
            VehiculeId = p.VehiculeId,
            ClientId = p.ClientId,
            DatePaiement = p.DatePaiement,
            Montant = p.Montant,
            ModePaiement = p.ModePaiement,
            Commentaires = p.Commentaires,
            NumeroRecu = p.NumeroRecu,
            Statut = p.Statut
        };
        _isEditing = true;
    }

    private async Task SavePayment()
    {
        if (_currentPayment.Montant <= 0) return;

        bool success;
        
        if (_isEditing)
        {
            success = await ApiService.UpdatePaiementAsync(_currentPayment.Id, _currentPayment);
        }
        else
        {
            // On s'assure que les IDs sont bien sett√©s (par s√©curit√©)
            _currentPayment.ClientId = ClientId;
            if (ColisId != Guid.Empty) _currentPayment.ColisId = ColisId;
            if (VehiculeId.HasValue) _currentPayment.VehiculeId = VehiculeId;
            
            var result = await ApiService.CreatePaiementAsync(_currentPayment);
            success = result != null;
        }

        if (success)
        {
            await LoadPayments();
            await OnPaymentsChanged.InvokeAsync(_payments.Sum(p => p.Montant));
            ResetForm();
        }
    }

    private async Task DeletePayment(Paiement p)
    {
        var success = await ApiService.DeletePaiementAsync(p.Id);
        if (success)
        {
            _payments.Remove(p);
            await OnPaymentsChanged.InvokeAsync(_payments.Sum(p => p.Montant));
            if (_isEditing && _currentPayment.Id == p.Id) ResetForm();
        }
    }

    private async Task Close() => await OnClose.InvokeAsync();
}