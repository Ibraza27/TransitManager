@using global::TransitManager.Infrastructure.Services
@inject ISettingsService SettingsService

@if (IsVisible)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-calculator me-2"></i>Proposition de Prix</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="Close"></button>
                </div>
                <div class="modal-body">
                    
                    <div class="alert alert-info small mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        Si vous ne connaissez pas les dimensions de votre véhicule, vous pouvez les consulter sur 
                        <a href="https://www.lacentrale.fr/fiche-technique-auto.php" target="_blank" class="fw-bold">La Centrale</a>.
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label small">Longueur (cm)</label>
                            <input type="number" class="form-control" @bind="_lengthCm" placeholder="ex: 450" disabled="@IsReadOnly" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Largeur (cm)</label>
                            <input type="number" class="form-control" @bind="_widthCm" placeholder="ex: 180" disabled="@IsReadOnly" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Hauteur (cm)</label>
                            <input type="number" class="form-control" @bind="_heightCm" placeholder="ex: 150" disabled="@IsReadOnly" />
                        </div>
                    </div>

                    @if (!IsReadOnly)
                    {
                        <div class="d-grid gap-2 mb-3">
                            <button class="btn btn-outline-primary" @onclick="CalculatePrice">
                                <i class="bi bi-arrow-clockwise me-2"></i>Calculer
                            </button>
                        </div>
                    }

                    @if (_calculatedPrice > 0)
                    {
                        <div class="card bg-light border-primary mb-3">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-1">Volume Estimé</h6>
                                <p class="fw-bold mb-2">@_volumeM3.ToString("N3") m³</p>
                                <h6 class="text-muted mb-1">Prix Proposé</h6>
                                <h3 class="text-primary fw-bold mb-0">@_calculatedPrice.ToString("C2")</h3>
                                <small class="text-muted">Basé sur un tarif de @_pricePerM3.ToString("C2")/m³</small>
                            </div>
                        </div>

                        <div class="form-check p-3 border rounded bg-warning-subtle text-warning-emphasis border-warning mb-3">
                            <input class="form-check-input mt-1" type="checkbox" id="checkAccuracy" @bind="_disclaimerAccepted" disabled="@IsReadOnly">
                            <label class="form-check-label small" for="checkAccuracy">
                                Je certifie l'exactitude des informations renseignées par rapport aux données du constructeur et que l'entreprise se réserve le droit de faire un contrôle et de modifier le prix proposé lorsque ce dernier est erroné.
                            </label>
                        </div>
                    }

                </div>
                <div class="modal-footer">
                    @if (IsReadOnly)
                    {
                        <button type="button" class="btn btn-secondary" @onclick="Close">Fermer</button>
                    }
                    else
                    {
                        <button type="button" class="btn btn-secondary" @onclick="Close">Annuler</button>
                        <button type="button" class="btn btn-success" disabled="@(!_disclaimerAccepted || _calculatedPrice <= 0)" @onclick="ConfirmPrice">
                            <i class="bi bi-check-lg me-2"></i>Valider ce prix
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public bool IsReadOnly { get; set; }
    [Parameter] public int? InitialLength { get; set; }
    [Parameter] public int? InitialWidth { get; set; }
    [Parameter] public int? InitialHeight { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<(decimal Price, int L, int W, int H)> OnPriceConfirmed { get; set; }

    private int _lengthCm;
    private int _widthCm;
    private int _heightCm;
    private decimal _pricePerM3 = 150;
    private decimal _calculatedPrice = 0;
    private double _volumeM3 = 0;
    private bool _disclaimerAccepted = false;

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible)
        {
            var pInfo = await SettingsService.GetSettingAsync("PricePerCubicMeter", "150");
            if(decimal.TryParse(pInfo, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var p)) 
            {
               _pricePerM3 = p; 
            }

            // Initialize from parameters
            if (InitialLength.HasValue && InitialLength > 0) _lengthCm = InitialLength.Value;
            if (InitialWidth.HasValue && InitialWidth > 0) _widthCm = InitialWidth.Value;
            if (InitialHeight.HasValue && InitialHeight > 0) _heightCm = InitialHeight.Value;

            if (IsReadOnly || (InitialLength > 0 && InitialWidth > 0 && InitialHeight > 0))
            {
                CalculatePrice();
                _disclaimerAccepted = true; // Show as accepted if already calculated/saved
            }
        }
    }

    private void CalculatePrice()
    {
        if (_lengthCm > 0 && _widthCm > 0 && _heightCm > 0)
        {
            _volumeM3 = (_lengthCm * _widthCm * _heightCm) / 1_000_000.0;
            _calculatedPrice = (decimal)_volumeM3 * _pricePerM3;
            if (!IsReadOnly) _disclaimerAccepted = false; 
        }
    }

    private async Task ConfirmPrice()
    {
        if (_disclaimerAccepted && _calculatedPrice > 0)
        {
            await OnPriceConfirmed.InvokeAsync((_calculatedPrice, _lengthCm, _widthCm, _heightCm));
            await Close();
        }
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }
}
