@using System.Timers
@using TransitManager.Core.DTOs.Commerce
@using TransitManager.Core.Enums
@using TransitManager.Web.Services
@inject IApiService ApiService

<div class="position-relative">
    <textarea 
           class="form-control form-control-sm" 
           placeholder="Description" 
           rows="1"
           style="resize: none; overflow-y: hidden; min-height: 31px; height: auto;"
           value="@Description"
           @oninput="OnInputWithResize"
           @onfocusin="() => ShowDropdown = true" 
           @onfocusout="OnFocusOut"></textarea>

    @if (ShowDropdown)
    {
        <!-- Using position: fixed to break out of all containers. 
             Ideally we would use JS to calculate top/left, but for now we set a high z-index.
             However since the input moves, fixed needs coords from JS.
             Actually, if we removed table-responsive and overflow-hidden from parents, position: absolute should work.
             Let's try position: absolute but with NO transform and cleaner style. -->
        <div class="dropdown-menu show shadow-lg border-0 rounded-0" 
             style="min-width: 800px; max-height: 500px; overflow-y: auto; z-index: 10000; position: absolute; top: 100%; left: 0;">
            @if (Results.Any())
            {
                @foreach (var p in Results)
                {
                    <button class="dropdown-item p-2 border-bottom" @onclick="() => SelectProduct(p)" @onmousedown:preventDefault>
                        <div class="d-flex justify-content-between">
                            <strong>@p.Name</strong>
                            <span class="fw-bold">@p.UnitPrice.ToString("N2")€</span>
                        </div>
                        <div class="small text-muted d-flex justify-content-between">
                            <span>@p.Type</span>
                            <span>(@p.Unit) TVA: @p.VATRate%</span>
                        </div>
                    </button>
                }
            }
            else if (!string.IsNullOrWhiteSpace(Description) && Description.Length >= 2)
            {
                <div class="p-2 text-muted text-center small">Aucun produit trouvé</div>
            }

            <div class="border-top p-1 sticky-bottom bg-white">
                <button class="dropdown-item fw-bold text-primary" @onclick="CreateNewProduct" @onmousedown:preventDefault>
                    <i class="bi bi-plus-circle me-2"></i>Ajouter un nouveau produit
                </button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public string Description { get; set; } = "";
    [Parameter] public EventCallback<string> DescriptionChanged { get; set; }
    [Parameter] public EventCallback<ProductDto> OnProductSelected { get; set; }
    [Parameter] public EventCallback OnCreateNew { get; set; }

    private List<ProductDto> Results { get; set; } = new();
    private bool ShowDropdown { get; set; }
    private Timer _debounceTimer;

    protected override void OnInitialized()
    {
        _debounceTimer = new Timer(300);
        _debounceTimer.AutoReset = false;
        _debounceTimer.Elapsed += async (sender, args) => await SearchAsync();
    }

    private async Task OnInputWithResize(ChangeEventArgs e)
    {
        var val = e.Value?.ToString() ?? "";
        Description = val;
        await DescriptionChanged.InvokeAsync(val);

        _debounceTimer.Stop();
        if (val.Length >= 2) _debounceTimer.Start();
        else Results.Clear();
        
        ShowDropdown = true;
    }

    private async Task OnInput(ChangeEventArgs e)
    {
        await OnInputWithResize(e);
    }

    private async Task SearchAsync()
    {
        if (string.IsNullOrWhiteSpace(Description) || Description.Length < 2) return;

        var result = await ApiService.GetProductsAsync(Description, 1, 10);
        Results = result.Items.ToList();
        await InvokeAsync(StateHasChanged);
    }

    private async Task SelectProduct(ProductDto p)
    {
        Description = p.Name;
        await DescriptionChanged.InvokeAsync(Description);
        await OnProductSelected.InvokeAsync(p);
        
        ShowDropdown = false;
        Results.Clear();
    }
    
    private async Task CreateNewProduct()
    {
        ShowDropdown = false;
        await OnCreateNew.InvokeAsync();
    }

    private async Task OnFocusOut()
    {
        await Task.Delay(200);
        ShowDropdown = false;
    }
}
