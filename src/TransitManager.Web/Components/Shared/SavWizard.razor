@using TransitManager.Core.Entities
@using TransitManager.Core.Enums
@using TransitManager.Web.Services
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@using System.Text.Json

@if (Show)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                <!-- Header with Progress -->
                <div class="modal-header bg-primary text-white p-4 position-relative">
                    <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" @onclick="Close"></button>
                    <div class="w-100 text-center">
                        <h4 class="modal-title fw-bold mb-3">Contrôle de Réception</h4>
                        <!-- Stepper -->
                        <div class="d-flex justify-content-center align-items-center position-relative" style="z-index: 1;">
                            @foreach (var step in new[] { 1, 2, 3, 4 })
                            {
                                bool active = _currentStep >= step;
                                bool current = _currentStep == step;
                                <div class="d-flex flex-column align-items-center mx-3" style="width: 40px;">
                                    <div class="rounded-circle d-flex align-items-center justify-content-center fw-bold transition-all @(active ? "bg-white text-primary scale-110" : "bg-white-50 text-white")"
                                         style="width: 32px; height: 32px; font-size: 14px; border: 2px solid white;">
                                        @if (active && !current) { <i class="bi bi-check-lg"></i> } else { @step }
                                    </div>
                                    <span class="small mt-1 text-white-50 @(current ? "fw-bold text-white" : "")" style="font-size: 10px;">
                                        @(step switch { 1 => "État", 2 => "Détails", 3 => "Avis", 4 => "Photos", _ => "" })
                                    </span>
                                </div>
                                @if (step < 4)
                                {
                                    <div class="flex-grow-1 bg-white-50" style="height: 2px; width: 40px; margin-top: -20px;">
                                        <div class="bg-white h-100 transition-all" style="width: @(active ? "100%" : "0%")"></div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>

                <!-- Body -->
                <div class="modal-body p-0 bg-light">
                    <div class="p-4" style="min-height: 400px;">
                        @if (_currentStep == 1)
                        {
                            <div class="text-center py-4 fade-in">
                                <h5 class="mb-4 text-muted">Dans quel état avez-vous reçu votre @(EntityType == "Colis" ? "colis" : "véhicule") ?</h5>
                                <div class="d-grid gap-3" style="max-width: 400px; margin: 0 auto;">
                                    <button class="btn btn-lg btn-outline-success p-3 d-flex align-items-center justify-content-between shadow-sm hover-scale @(_status == ReceptionStatus.ReceivedFull ? "active" : "")" 
                                            @onclick="() => SetStatus(ReceptionStatus.ReceivedFull)">
                                        <span class="d-flex align-items-center"><i class="bi bi-check-circle-fill fs-4 me-3"></i> Tout est conforme</span>
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                    
                                    <button class="btn btn-lg btn-outline-warning p-3 d-flex align-items-center justify-content-between shadow-sm hover-scale @(_status == ReceptionStatus.ReceivedPartial ? "active" : "")" 
                                            @onclick="() => SetStatus(ReceptionStatus.ReceivedPartial)">
                                        <span class="d-flex align-items-center"><i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i> Il manque des articles</span>
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                    
                                    <button class="btn btn-lg btn-outline-danger p-3 d-flex align-items-center justify-content-between shadow-sm hover-scale @(_status == ReceptionStatus.ReceivedDamaged ? "active" : "")" 
                                            @onclick="() => SetStatus(ReceptionStatus.ReceivedDamaged)">
                                        <span class="d-flex align-items-center"><i class="bi bi-x-octagon-fill fs-4 me-3"></i> C'est endommagé</span>
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        }
                        else if (_currentStep == 2)
                        {
                             <div class="fade-in">
                                @if (_status == ReceptionStatus.ReceivedFull)
                                {
                                    <div class="text-center py-5">
                                        <i class="bi bi-emoji-smile fs-1 text-success mb-3 d-block"></i>
                                        <h5>Excellente nouvelle !</h5>
                                        <p class="text-muted">Merci de confirmer que tout est en ordre.</p>
                                    </div>
                                }
                                else if (EntityType == "Colis" && _status == ReceptionStatus.ReceivedPartial)
                                {
                                    <h6 class="fw-bold mb-3"><i class="bi bi-list-check me-2"></i>Sélectionnez les articles manquants :</h6>
                                    @if (InventoryItems != null && InventoryItems.Any())
                                    {
                                        <div class="list-group shadow-sm" style="max-height: 300px; overflow-y: auto;">
                                            @foreach (var item in InventoryItems)
                                            {
                                                <label class="list-group-item list-group-item-action d-flex align-items-center gap-3 cursor-pointer @(_selectedMissingItems.Contains(item.Designation) ? "bg-warning-subtle border-warning" : "")">
                                                    <input class="form-check-input flex-shrink-0" type="checkbox" 
                                                           checked="@_selectedMissingItems.Contains(item.Designation)"
                                                           @onchange="(e) => ToggleMissingItem(item.Designation, e.Value)">
                                                    <div class="flex-grow-1">
                                                        <div class="fw-bold">@item.Designation</div>
                                                        <small class="text-muted">Valeur: @item.Valeur €</small>
                                                    </div>
                                                </label>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="text-muted fst-italic">Aucun inventaire détaillé disponible. Veuillez décrire les manquants ci-dessous.</p>
                                    }
                                    
                                    <div class="mt-3">
                                        <label class="form-label small text-muted">Précisions (Optionnel)</label>
                                        <textarea class="form-control" @bind="_issueDescription" rows="3" placeholder="Ex: Carton ouvert, article abîmé..."></textarea>
                                    </div>
                                }
                                else if (EntityType == "Vehicule" && _status == ReceptionStatus.ReceivedDamaged)
                                {
                                     <div class="mb-3">
                                         <SavVehicleSchema @ref="_schemaComponent"
                                            ImageUrl="@GetVehicleImage(Vehicule?.Type)"
                                            OriginalPointsJson="@Vehicule?.EtatDesLieux"
                                            OriginalStrokesJson="@Vehicule?.EtatDesLieuxRayures"
                                            @bind-PointsJson="_savPointsJson"
                                            @bind-StrokesJson="_savStrokesJson" />
                                     </div>
                                     <textarea class="form-control" @bind="_issueDescription" rows="4" placeholder="Décrivez les dommages constatés..."></textarea>
                                }
                                else
                                {
                                    <label class="form-label">Description du problème</label>
                                    <textarea class="form-control" @bind="_issueDescription" rows="5" placeholder="Détaillez le problème rencontré..."></textarea>
                                }
                             </div>
                        }
                        else if (_currentStep == 3)
                        {
                            <div class="fade-in">
                                <h5 class="text-center mb-4">Votre avis nous intéresse</h5>
                                
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <RatingInput Label="Qualité du Service" @bind-Value="_control.RateService" Icon="bi-person-badge" />
                                    </div>
                                    <div class="col-md-6">
                                        <RatingInput Label="État de la marchandise" @bind-Value="_control.RateCondition" Icon="bi-box-seam" />
                                    </div>
                                    <div class="col-md-6">
                                        <RatingInput Label="Communication" @bind-Value="_control.RateCommunication" Icon="bi-chat-dots" />
                                    </div>
                                    <div class="col-md-6">
                                        <RatingInput Label="Recommandation" @bind-Value="_control.RateRecommendation" Icon="bi-hand-thumbs-up" Color="text-primary" />
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <label class="form-label fw-bold">Commentaire global</label>
                                    <textarea class="form-control" @bind="_control.GlobalComment" rows="3" placeholder="Racontez-nous votre expérience..."></textarea>
                                </div>
                            </div>
                        }
                        else if (_currentStep == 4)
                        {
                             <div class="text-center fade-in">
                                 <h5 class="mb-3">Ajouter des photos (Optionnel)</h5>
                                 <p class="text-muted small">Particulièrement utile en cas de dommage ou de produit manquant.</p>
                                 
                                 <div class="border dashed-border rounded-4 p-5 bg-white cursor-pointer hover-bg-light transition-all">
                                     <i class="bi bi-cloud-arrow-up fs-1 text-primary mb-3 d-block"></i>
                                     <label for="savFileUpload" class="stretched-link">Cliquez pour ajouter des photos</label>
                                     <InputFile id="savFileUpload" OnChange="HandleFileSelected" multiple accept="image/*" class="d-none" />
                                 </div>
                                 
                                 @if (_uploadedFiles.Any())
                                 {
                                     <div class="d-flex gap-2 mt-3 overflow-auto pb-2">
                                         @foreach (var file in _uploadedFiles)
                {
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="position-relative border rounded overflow-hidden" style="padding-top: 100%;">
                             <img src="@file.PreviewUrl" class="position-absolute top-0 start-0 w-100 h-100 object-fit-cover" />
                             <button class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1 rounded-circle d-flex align-items-center justify-content-center p-0" 
                                     style="width: 24px; height: 24px; z-index: 100;" 
                                     @onclick="() => RemoveFile(file)"
                                     @onclick:stopPropagation="true">
                                 <i class="bi bi-x"></i>
                             </button>
                        </div>
                    </div>
                }                         </div>
                                 }
                             </div>
                        }
                    </div>
                </div>

                <!-- Footer -->
                <div class="modal-footer border-0 bg-light p-4">
                    @if (_currentStep > 1)
                    {
                        <button type="button" class="btn btn-outline-secondary px-4 rounded-pill" @onclick="PrevStep">Précédent</button>
                    }
                    
                    @if (_currentStep < 4)
                    {
                        <button type="button" class="btn btn-primary px-5 rounded-pill shadow-sm" @onclick="NextStep" disabled="@(!CanProceed())">Suivant</button>
                    }
                    else
                    {
                        <button type="button" class="btn btn-success px-5 rounded-pill shadow w-100" @onclick="SubmitAsync">
                            @if (_isSubmitting) { <span class="spinner-border spinner-border-sm me-2"></span> }
                            Envoyer mon avis
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool Show { get; set; }
    [Parameter] public EventCallback<bool> ShowChanged { get; set; }
    
    [Parameter] public string EntityType { get; set; } // "Colis" or "Vehicule"
    [Parameter] public Guid EntityId { get; set; }
    [Parameter] public Guid ClientId { get; set; }
    
    // For Parcel Missing Items
    [Parameter] public List<InventaireItem>? InventoryItems { get; set; }
    [Parameter] public Vehicule? Vehicule { get; set; }

    private int _currentStep = 1;
    private ReceptionStatus _status = ReceptionStatus.ReceivedFull;
    private ReceptionControl _control = new();
    private List<string> _selectedMissingItems = new();
    private string _issueDescription = string.Empty;
    private bool _isSubmitting = false;
    
    // SAV Schema
    private string _savPointsJson = "";
    private string _savStrokesJson = "";
    private SavVehicleSchema? _schemaComponent;
    
    private List<FileUploadModel> _uploadedFiles = new();
    
    private class FileUploadModel { public string Name { get; set; } public string PreviewUrl { get; set; } public IBrowserFile File { get; set; } }

    protected override void OnInitialized()
    {
        _control = new ReceptionControl();
        // Defaults
        _control.RateService = 10;
        _control.RateCondition = 10;
        _control.RateCommunication = 10;
        _control.RateRecommendation = 10;
    }

    private void SetStatus(ReceptionStatus status)
    {
        _status = status;
        // If full, skip description step? No, keep flow consistent or auto-advance.
        NextStep();
    }

    private void ToggleMissingItem(string itemDesc, object checkedValue)
    {
        if (checkedValue is bool isChecked && isChecked)
            _selectedMissingItems.Add(itemDesc);
        else
            _selectedMissingItems.Remove(itemDesc);
    }
    
    private bool CanProceed()
    {
        if (_currentStep == 1) return true; // Selection made via button
        if (_currentStep == 2) 
        {
            if (_status == ReceptionStatus.ReceivedFull) return true;
            if (_status == ReceptionStatus.ReceivedPartial && !_selectedMissingItems.Any() && string.IsNullOrWhiteSpace(_issueDescription)) return false; // Need at least one item or desc
            if (_status == ReceptionStatus.ReceivedDamaged && string.IsNullOrWhiteSpace(_issueDescription)) return false;
        }
        return true;
    }

    private void NextStep() => _currentStep++;
    private void PrevStep() => _currentStep--;

    private async Task SubmitAsync()
    {
        _isSubmitting = true;
        try
        {
            _control.ClientId = ClientId;
            if (EntityType == "Colis") _control.ColisId = EntityId;
            else _control.VehiculeId = EntityId;
            
            _control.Status = _status;
            
            // Save Schema if Damaged Vehicle
            if (EntityType == "Vehicule" && _status == ReceptionStatus.ReceivedDamaged && _schemaComponent != null)
            {
                await _schemaComponent.SaveDataAsync();
                _control.SavSchemaPointsJson = _savPointsJson;
                _control.SavSchemaStrokesJson = _savStrokesJson;
            }

            _control.CreationDate = DateTime.UtcNow;

            // Add Issues
            if (_status != ReceptionStatus.ReceivedFull)
            {
                if (_status == ReceptionStatus.ReceivedPartial)
                {
                    foreach (var item in _selectedMissingItems)
                    {
                        _control.Issues.Add(new ReceptionIssue 
                        { 
                            Type = IssueType.MissingItem, 
                            Description = "Article manquant déclaré par le client",
                            InventoryItemName = item
                        });
                    }
                    if (!string.IsNullOrWhiteSpace(_issueDescription))
                    {
                         _control.Issues.Add(new ReceptionIssue { Type = IssueType.Other, Description = _issueDescription });
                    }
                }
                else if (_status == ReceptionStatus.ReceivedDamaged)
                {
                    _control.Issues.Add(new ReceptionIssue 
                    { 
                        Type = IssueType.Damage, 
                        Description = _issueDescription 
                    });
                }
            }
            
            // POST Control using specific method
            await ApiService.CreateReceptionControlAsync(_control);
            
            // Upload Photos
            if (_uploadedFiles.Any())
            {
                try
                {
                    foreach (var fileModel in _uploadedFiles)
                    {
                         Guid? vehiculeId = EntityType == "Vehicule" ? EntityId : null;
                         Guid? colisId = EntityType == "Colis" ? EntityId : null;
                         
                         // We await individually. If one fails, we log and continue or stop? 
                         // Better to try all.
                         try 
                         {
                            await ApiService.UploadDocumentAsync(fileModel.File, TypeDocument.SAV, ClientId, vehiculeId, colisId, null);
                         }
                         catch (Exception ex)
                         {
                             Console.WriteLine($"Error uploading file {fileModel.Name}: {ex.Message}");
                             // Continue to next file
                         }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Global Upload Error: {ex.Message}");
                }
            }

            // Always close the wizard even if uploads had partial failures
            await ShowChanged.InvokeAsync(false);
            // Show Success Toast
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void Close() { Show = false; ShowChanged.InvokeAsync(false); }
    
    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
             // Simple preview logic (would require more code for real preview, skipping for brevity)
             _uploadedFiles.Add(new FileUploadModel { File = file, Name = file.Name, PreviewUrl = "" }); 
        }
    }
    
    private void RemoveFile(FileUploadModel file) => _uploadedFiles.Remove(file);

    private string GetVehicleImage(TypeVehicule? type) => type switch
    {
        TypeVehicule.Moto => "images/plans/moto_plan.png",
        TypeVehicule.Camion => "images/plans/camion_plan.png",
        TypeVehicule.Quad => "images/plans/quad_plan.png",
        TypeVehicule.Van => "images/plans/van_plan.png",
        TypeVehicule.Scooter => "images/plans/scooter_plan.png",
        TypeVehicule.Bateau => "images/plans/bateau_plan.png",
        TypeVehicule.JetSki => "images/plans/jet_ski_plan.png",
        TypeVehicule.Pickup => "images/plans/pickup_plan.png",
        _ => "images/plans/vehicule_plan.png"
    };
}
