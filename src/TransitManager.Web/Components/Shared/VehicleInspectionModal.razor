@using System.Text.Json
@using TransitManager.Core.Entities
@inject IJSRuntime JSRuntime
@if (IsVisible)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.8);" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="bi bi-car-front me-2"></i>√âtat des Lieux & Validation</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="Close"></button>
                </div>

                <div class="modal-body p-0">
                    <ul class="nav nav-tabs nav-fill bg-light" role="tablist">
                        <li class="nav-item">
                            <button class='nav-link @(_activeTab == "schema" ? "active fw-bold" : "")' @onclick='() => ChangeTab("schema")'>
                                <i class="bi bi-pencil-square me-2"></i>Sch√©ma
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class='nav-link @(_activeTab == "accessoires" ? "active fw-bold" : "")' @onclick='() => ChangeTab("accessoires")'>
                                <i class="bi bi-tools me-2"></i>√âquipements
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class='nav-link @(_activeTab == "signature" ? "active fw-bold" : "")' @onclick='() => ChangeTab("signature")'>
                                <i class="bi bi-pen me-2"></i>Signatures
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content p-3">

                        <!-- ONGLET 1 : SCH√âMA -->
                        <div class='tab-pane fade @(_activeTab == "schema" ? "show active" : "")'>

                            <!-- Barre d'outils -->
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded border">

                                <!-- Outils d'√©dition (Visible seulement si Admin et Mode √âdition activ√©) -->
                                @if (_isEditingSchema && !IsReadOnly)
                                {
                                    <div class="btn-group">
                                        <button class='btn btn-outline-primary @(_currentTool == "pen" ? "active" : "")' @onclick='() => SetTool("pen")' title="Crayon">
                                            ‚úèÔ∏è Dessin
                                        </button>
                                        <button class='btn btn-outline-danger @(_currentTool == "eraser" ? "active" : "")' @onclick='() => SetTool("eraser")' title="Gomme">
                                            üßº Gomme
                                        </button>
                                        <button class='btn btn-outline-secondary @(_currentTool == "hand" ? "active" : "")' @onclick='() => SetTool("hand")' title="D√©placer">
                                            ‚úã D√©placer
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <!-- En mode lecture, on indique qu'on est en mode d√©placement -->
                                    <div class="text-muted small">
                                        <i class="bi bi-arrows-move me-1"></i> D√©placez et zoomez pour inspecter
                                    </div>
                                }
                                <!-- Boutons Zoom (Toujours visibles) -->
                                <div class="btn-group mx-2">
                                    <button class="btn btn-outline-dark" @onclick="ZoomIn">‚ûï Zoomer</button>
                                    <button class="btn btn-outline-dark" @onclick="ZoomOut">‚ûñ Zoomer</button>
                                </div>
                                <!-- Bouton Action Droite -->
                                @if (!IsReadOnly)
                                {
                                    @if (_isEditingSchema)
                                    {
                                        <button class="btn btn-success" @onclick="SaveSchemaChanges">
                                            <i class="bi bi-check-lg"></i> Terminer
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-primary" @onclick="EnableSchemaEditing">
                                            <i class="bi bi-pencil me-2"></i>Modifier
                                        </button>
                                    }
                                }
                            </div>
                            <!-- CANVAS UNIQUE (Pour lecture et √©criture) -->
                            <div class="text-center bg-dark p-0 rounded position-relative overflow-hidden" style="height: 60vh;">
                                <canvas id="vehicle-schema-canvas" style="width:100%; height:100%; cursor: grab; touch-action: none;"></canvas>
                            </div>
                        </div>

                        <!-- ONGLET 2 : ACCESSOIRES -->
                        <div class='tab-pane fade @(_activeTab == "accessoires" ? "show active" : "")'>
                            <div class="row g-4 p-2">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header fw-bold">Inventaire Accessoires</div>
                                        <div class="card-body">
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" @bind="_accessoires.CarteGrise" disabled="@IsReadOnly">
                                                <label class="form-check-label">Carte Grise Originale</label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" @bind="_accessoires.Antenne" disabled="@IsReadOnly">
                                                <label class="form-check-label">Antenne</label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" @bind="_accessoires.Radio" disabled="@IsReadOnly">
                                                <label class="form-check-label">Radio / Fa√ßade</label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" @bind="_accessoires.RoueSecours" disabled="@IsReadOnly">
                                                <label class="form-check-label">Roue de secours / Galette</label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" @bind="_accessoires.Cric" disabled="@IsReadOnly">
                                                <label class="form-check-label">Cric / Manivelle</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header fw-bold">Quantit√©s & √âtat</div>
                                        <div class="card-body">
                                            <div class="mb-3 row align-items-center">
                                                <label class="col-sm-6 col-form-label">Nombre de Cl√©s</label>
                                                <div class="col-sm-6">
                                                    <input type="number" class="form-control" @bind="_accessoires.NombreClefs" min="0" max="10" disabled="@IsReadOnly">
                                                </div>
                                            </div>
                                            <div class="mb-3 row align-items-center">
                                                <label class="col-sm-6 col-form-label">Enjoliveurs (0-4)</label>
                                                <div class="col-sm-6">
                                                    <input type="number" class="form-control" @bind="_accessoires.NombreEnjoliveurs" min="0" max="4" disabled="@IsReadOnly">
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Autres Observations</label>
                                                <textarea class="form-control" rows="3" @bind="_accessoires.AutresObservations" placeholder="Rayures, impacts non visibles sur sch√©ma..." disabled="@IsReadOnly"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ONGLET 3 : SIGNATURES -->
                        <div class='tab-pane fade @(_activeTab == "signature" ? "show active" : "")'>

                            <div class="row g-3 p-2">
                                <div class="col-12 mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text">Fait √†</span>
                                        <input type="text" class="form-control" @bind="_lieu" placeholder="Ville..." disabled="@IsReadOnly">
                                        <span class="input-group-text">Le</span>
                                        <input type="date" class="form-control" @bind="_dateSignature" disabled="@IsReadOnly">
                                    </div>
                                </div>
                                <!-- Agent -->
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light fw-bold text-center">Signature Agent (Transit)</div>
                                        <div class="card-body p-0 position-relative" style="height: 200px; background-color: #fff;">
                                            @if (!string.IsNullOrEmpty(_signatureAgentBase64))
                                            {
                                                <img src="@_signatureAgentBase64" style="width:100%; height:100%; object-fit:contain;" />
                                                @if(!IsReadOnly) {
                                                    <button class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2" @onclick='() => ClearSignature("agent")'>Re-signer</button>
                                                }
                                            }
                                            else if (!IsReadOnly)
                                            {
                                                <canvas id="sig-canvas-agent" style="width:100%; height:100%; cursor:crosshair;"></canvas>
                                                <div class="position-absolute bottom-0 end-0 m-2">
                                                    <button class="btn btn-sm btn-light border" @onclick='() => ClearCanvas("sig-canvas-agent")'>Effacer</button>
                                                </div>
                                            }
                                            else { <div class="d-flex h-100 align-items-center justify-content-center text-muted">Non sign√©</div> }
                                        </div>
                                    </div>
                                </div>
                                <!-- Client -->
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light fw-bold text-center">Signature Client / Livreur</div>
                                        <div class="card-body p-0 position-relative" style="height: 200px; background-color: #fff;">
                                            @if (!string.IsNullOrEmpty(_signatureClientBase64))
                                            {
                                                <img src="@_signatureClientBase64" style="width:100%; height:100%; object-fit:contain;" />
                                                @if(!IsReadOnly) {
                                                    <button class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2" @onclick='() => ClearSignature("client")'>Re-signer</button>
                                                }
                                            }
                                            else if (!IsReadOnly)
                                            {
                                                <canvas id="sig-canvas-client" style="width:100%; height:100%; cursor:crosshair;"></canvas>
                                                <div class="position-absolute bottom-0 end-0 m-2">
                                                    <button class="btn btn-sm btn-light border" @onclick='() => ClearCanvas("sig-canvas-client")'>Effacer</button>
                                                </div>
                                            }
                                            else { <div class="d-flex h-100 align-items-center justify-content-center text-muted">Non sign√©</div> }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" @onclick="Close">Fermer</button>
                    @if (!IsReadOnly)
                    {
                        <button type="button" class="btn btn-success fw-bold" @onclick="SaveAndClose">
                            <i class="bi bi-check-lg me-2"></i>Valider l'√âtat des Lieux
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}
@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public Core.Enums.TypeVehicule Type { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;

    [Parameter] public string? JsonPoints { get; set; }
    [Parameter] public string? JsonStrokes { get; set; }
    [Parameter] public string? JsonAccessoires { get; set; }
    [Parameter] public string? SignatureAgent { get; set; }
    [Parameter] public string? SignatureClient { get; set; }
    [Parameter] public string? Lieu { get; set; }
    [Parameter] public DateTime? DateSignature { get; set; }

    [Parameter] public EventCallback<InspectionResult> OnSave { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    // Structures de donn√©es
    public class InspectionResult
    {
        public string EtatDesLieuxPoints { get; set; } = "";
        public string EtatDesLieuxRayures { get; set; } = "";
        public string AccessoiresJson { get; set; } = "";
        public string SignatureAgent { get; set; } = "";
        public string SignatureClient { get; set; } = "";
        public string Lieu { get; set; } = "";
        public DateTime? Date { get; set; }
    }

    public class VehiculeAccessoires
    {
        public int NombreClefs { get; set; } = 1;
        public bool Antenne { get; set; }
        public bool Radio { get; set; }
        public int NombreEnjoliveurs { get; set; }
        public bool RoueSecours { get; set; }
        public bool Cric { get; set; }
        public bool CarteGrise { get; set; }
        public string? AutresObservations { get; set; }
    }

    // √âtat UI
    private string _activeTab = "schema";
    private bool _isEditingSchema = false;
    private string _currentTool = "pen"; // pen, eraser, hand

    // Donn√©es
    private List<SerializablePoint> _damagePoints = new();
    private List<List<SerializablePoint>> _strokes = new();
    private VehiculeAccessoires _accessoires = new();
    private string? _signatureAgentBase64;
    private string? _signatureClientBase64;
    private string? _lieu;
    private DateTime _dateSignature;

    protected override void OnParametersSet()
    {
        if (IsVisible)
        {
            // Reset UI
            _activeTab = "schema";
            _isEditingSchema = false;

            // Chargement Donn√©es
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            try { _damagePoints = !string.IsNullOrEmpty(JsonPoints) ? JsonSerializer.Deserialize<List<SerializablePoint>>(JsonPoints, options) ?? new() : new(); } catch { _damagePoints = new(); }
            try { _strokes = !string.IsNullOrEmpty(JsonStrokes) ? JsonSerializer.Deserialize<List<List<SerializablePoint>>>(JsonStrokes, options) ?? new() : new(); } catch { _strokes = new(); }
            try { _accessoires = !string.IsNullOrEmpty(JsonAccessoires) ? JsonSerializer.Deserialize<VehiculeAccessoires>(JsonAccessoires, options) ?? new() : new(); } catch { _accessoires = new(); }
            _signatureAgentBase64 = SignatureAgent;
            _signatureClientBase64 = SignatureClient;
            _lieu = string.IsNullOrEmpty(Lieu) ? "Tresses" : Lieu;
            _dateSignature = DateSignature ?? DateTime.Now;
        }
    }

	private bool _isCanvasInitialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsVisible && _activeTab == "schema")
        {
            // Si on vient de changer d'onglet ou d'ouvrir la modale, on init.
            // Mais si on a juste cliqu√© sur un bouton outil (qui a fait un StateHasChanged), on ne touche √† rien !
            if (!_isCanvasInitialized)
            {
                await InitSchemaCanvas();
                _isCanvasInitialized = true;
            }
        }
    }

	private async Task InitSchemaCanvas()
    {
        var imgUrl = GetImageSource();
        var pointsJson = JsonSerializer.Serialize(_damagePoints);
        var strokesJson = JsonSerializer.Serialize(_strokes);

        // Initialisation
        await JSRuntime.InvokeVoidAsync("vehicleSchemaEditor.init",
            "vehicle-schema-canvas", imgUrl, pointsJson, strokesJson, !_isEditingSchema);

        // Si on est en mode √©dition, on r√©applique l'outil courant pour √™tre s√ªr
        if (_isEditingSchema)
        {
            await SetTool(_currentTool);
        }
    }

    private async Task ChangeTab(string tab)
    {
        _activeTab = tab;
        _isCanvasInitialized = false; // On force la r√©init quand on change d'onglet
        StateHasChanged();
        
        if (tab == "schema")
        {
            await Task.Delay(100);
            await InitSchemaCanvas();
            _isCanvasInitialized = true;
        }
        else if (tab == "signature")
        {
            await Task.Delay(100);
            if (!IsReadOnly)
            {
                if (string.IsNullOrEmpty(_signatureAgentBase64)) await JSRuntime.InvokeVoidAsync("signaturePad.init", "sig-canvas-agent");
                if (string.IsNullOrEmpty(_signatureClientBase64)) await JSRuntime.InvokeVoidAsync("signaturePad.init", "sig-canvas-client");
            }
        }
    }

	private async Task EnableSchemaEditing()
    {
        _isEditingSchema = true;
        _currentTool = "pen"; // Outil par d√©faut au d√©but de l'√©dition
        StateHasChanged();    // Force l'affichage de la toolbar
        await Task.Delay(50);

        // On r√©initialise le canvas en mode √©dition (readOnly = false)
        await InitSchemaCanvas();
        
        // IMPORTANT : On force l'application de l'outil APR√àS l'init
        await SetTool(_currentTool); 
    }

	private async Task SetTool(string tool)
    {
        _currentTool = tool;
        // On appelle juste le JS pour changer le curseur et la logique interne
        await JSRuntime.InvokeVoidAsync("vehicleSchemaEditor.setTool", tool);
        
        // On ne fait PAS de StateHasChanged() ici si possible, 
        // sauf si n√©cessaire pour mettre √† jour la classe "active" du bouton.
        // Si on le fait, il faut s'assurer que OnAfterRenderAsync ne r√©initialise pas tout.
    }

    private async Task ZoomIn() => await JSRuntime.InvokeVoidAsync("vehicleSchemaEditor.zoom", 1);
    private async Task ZoomOut() => await JSRuntime.InvokeVoidAsync("vehicleSchemaEditor.zoom", -1);

    private async Task SaveSchemaChanges()
    {
        // R√©cup√©rer le JSON du JS
        var jsonResult = await JSRuntime.InvokeAsync<string>("vehicleSchemaEditor.getData");
        var data = JsonSerializer.Deserialize<SchemaData>(jsonResult);

        if (data != null)
        {
            _damagePoints = JsonSerializer.Deserialize<List<SerializablePoint>>(data.Points) ?? new();
            _strokes = JsonSerializer.Deserialize<List<List<SerializablePoint>>>(data.Strokes) ?? new();
        }
        _isEditingSchema = false;
    }

    // Classe temporaire pour le parsing
    class SchemaData
    {
        [System.Text.Json.Serialization.JsonPropertyName("points")] public string Points { get; set; } = "";
        [System.Text.Json.Serialization.JsonPropertyName("strokes")] public string Strokes { get; set; } = "";
    }

    // --- Gestion Signatures ---
    private async Task ClearCanvas(string canvasId) => await JSRuntime.InvokeVoidAsync("signaturePad.clear", canvasId);

    private async Task ClearSignature(string type)
    {
        if (type == "agent") { _signatureAgentBase64 = null; await Task.Delay(50); await JSRuntime.InvokeVoidAsync("signaturePad.init", "sig-canvas-agent"); }
        else { _signatureClientBase64 = null; await Task.Delay(50); await JSRuntime.InvokeVoidAsync("signaturePad.init", "sig-canvas-client"); }
    }

    // --- Global Save ---
    private async Task SaveAndClose()
    {
        // Sauvegarde du sch√©ma si encore en √©dition
        if (_isEditingSchema) await SaveSchemaChanges();

        // Sauvegarde des signatures
        if (_activeTab == "signature")
        {
             if (string.IsNullOrEmpty(_signatureAgentBase64)) _signatureAgentBase64 = await JSRuntime.InvokeAsync<string>("signaturePad.getImage", "sig-canvas-agent");
             if (string.IsNullOrEmpty(_signatureClientBase64)) _signatureClientBase64 = await JSRuntime.InvokeAsync<string>("signaturePad.getImage", "sig-canvas-client");
        }

        // Nettoyage canvas vides
        if (_signatureAgentBase64 != null && _signatureAgentBase64.Length < 500) _signatureAgentBase64 = null;
        if (_signatureClientBase64 != null && _signatureClientBase64.Length < 500) _signatureClientBase64 = null;

        var result = new InspectionResult
        {
            EtatDesLieuxPoints = JsonSerializer.Serialize(_damagePoints),
            EtatDesLieuxRayures = JsonSerializer.Serialize(_strokes),
            AccessoiresJson = JsonSerializer.Serialize(_accessoires),
            SignatureAgent = _signatureAgentBase64 ?? "",
            SignatureClient = _signatureClientBase64 ?? "",
            Lieu = _lieu ?? "",
            Date = _dateSignature
        };
        await OnSave.InvokeAsync(result);
    }

    private async Task Close() => await OnClose.InvokeAsync();

    private string GetImageSource() => Type switch
    {
        Core.Enums.TypeVehicule.Moto => "images/plans/moto_plan.png",
        Core.Enums.TypeVehicule.Camion => "images/plans/camion_plan.png",
        Core.Enums.TypeVehicule.Quad => "images/plans/quad_plan.png",
        Core.Enums.TypeVehicule.Van => "images/plans/van_plan.png",
        _ => "images/plans/vehicule_plan.png"
    };

    private string GetSvgPoints(List<SerializablePoint> points)
    {
        return string.Join(" ", points.Select(p => $"{p.X.ToString(System.Globalization.CultureInfo.InvariantCulture)},{p.Y.ToString(System.Globalization.CultureInfo.InvariantCulture)}"));
    }
}
